<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatRAG Configuration</title>
    
    <!-- Config UI Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚öôÔ∏è</text></svg>" type="image/svg+xml">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    
    <!-- TailwindCSS first, then DaisyUI to override -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.24/dist/full.min.css" rel="stylesheet" type="text/css" />
    
    <!-- Custom theme configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'chatrag-primary': '#FF6417',
                        'chatrag-primary-light': '#FF8A4D',
                        'chatrag-primary-dark': '#E05A15'
                    }
                }
            }
        }
    </script>
    
    <script src="floating-chat-widget.js"></script>
    <script src="mcp-config.js"></script>
    <script src="document-processing/document-manager.js"></script>
    
    <style>
        /* Tab content visibility */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Document table height constraint */
        #documents-table-container .overflow-y-auto {
            max-height: 24rem; /* 384px = 96 * 0.25rem */
        }
        
        /* Force table display - override any DaisyUI responsive styles */
        #documents-table-container table {
            display: table !important;
        }
        
        #documents-table-container thead {
            display: table-header-group !important;
        }
        
        #documents-table-container tbody {
            display: table-row-group !important;
        }
        
        #documents-table-container tr {
            display: table-row !important;
        }
        
        #documents-table-container th,
        #documents-table-container td {
            display: table-cell !important;
        }
        
        /* Ensure table is not transformed into cards on any screen size */
        @media (max-width: 768px) {
            #documents-table-container table {
                display: table !important;
            }
            #documents-table-container thead {
                display: table-header-group !important;
            }
            #documents-table-container th {
                display: table-cell !important;
            }
        }
        /* Menu item styling and spacing */
        .menu-item {
            font-size: 0.9375rem; /* 15px - slightly smaller for sidebar */
            padding: 0.625rem 1rem; /* Good click targets */
            margin-bottom: 0.125rem; /* Subtle spacing */
            border-radius: 0.375rem; /* Rounded corners */
            font-weight: 500; /* Slightly bolder for better readability */
            transition: all 0.2s ease;
        }
        
        /* Menu spacing */
        .menu li {
            margin-bottom: 0.25rem;
        }
        
        /* Menu item active state */
        .menu-item.active {
            background-color: #FF6417;
            color: white;
            font-weight: 600;
        }
        
        /* Menu item hover state */
        .menu-item:hover:not(.active) {
            background-color: rgba(0, 0, 0, 0.05);
            transform: translateX(2px);
        }
        
        /* Light mode specific menu styling */
        [data-theme="light"] .menu-item {
            color: rgba(0, 0, 0, 0.8);
        }
        
        [data-theme="light"] .menu-item:hover:not(.active) {
            color: rgba(0, 0, 0, 0.95);
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        /* Loading animation for chat */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* MCP Configuration Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-dialog {
            background: oklch(var(--b1));
            border-radius: 0.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-width: 42rem;
            width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 1.5rem 1.5rem 0 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid oklch(var(--b3));
            margin-bottom: 1rem;
            padding-bottom: 1rem;
        }

        .modal-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: oklch(var(--bc) / 0.6);
            padding: 0.25rem;
        }

        .modal-body {
            padding: 0 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem 1.5rem 1.5rem;
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            border-top: 1px solid oklch(var(--b3));
            margin-top: 1rem;
            padding-top: 1rem;
        }

        .server-card {
            background: oklch(var(--b2));
            border-radius: 0.5rem;
            padding: 1rem;
            border: 1px solid oklch(var(--b3));
            transition: all 0.2s;
            word-wrap: break-word;
            overflow-wrap: break-word;
            min-width: 0; /* Ensures flex items can shrink */
        }

        .server-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* Drag and Drop Model Styles */
        .model-item {
            transition: all 0.2s ease;
            cursor: grab;
        }
        
        .model-item:active {
            cursor: grabbing;
        }
        
        .model-item.dragging {
            opacity: 0.5;
            transform: scale(0.98);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        
        .model-item.drag-over {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(255, 100, 23, 0.3);
        }
        
        .drag-handle {
            cursor: grab;
            opacity: 0.4;
            transition: opacity 0.2s;
        }
        
        .model-item:hover .drag-handle {
            opacity: 1;
        }
        
        .drag-handle:active {
            cursor: grabbing;
        }
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .server-card.server-disabled {
            opacity: 0.6;
            border-color: oklch(var(--er));
        }

        .server-card.server-enabled {
            border-color: oklch(var(--su));
        }

        .server-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
            gap: 1rem;
        }

        .server-info {
            flex: 1;
            min-width: 0; /* Allows text to wrap in flex container */
            overflow: hidden;
        }

        .server-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .server-description {
            color: oklch(var(--bc) / 0.7);
            font-size: 0.875rem;
        }

        .server-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0; /* Prevents action buttons from shrinking */
            flex-wrap: wrap;
        }

        .server-details {
            font-size: 0.875rem;
            color: oklch(var(--bc) / 0.8);
        }

        .server-endpoint {
            margin-bottom: 0.5rem;
            word-break: break-all; /* Forces long URLs to break */
        }

        .server-stats {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .server-stats .stat {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .server-stats .stat.enabled {
            background: oklch(var(--su) / 0.2);
            color: oklch(var(--su));
        }

        .server-stats .stat.disabled {
            background: oklch(var(--er) / 0.2);
            color: oklch(var(--er));
        }

        .builtin-badge {
            background: oklch(var(--in));
            color: oklch(var(--inc));
            padding: 0.125rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .form-section {
            margin: 1.5rem 0;
            padding: 1rem 0;
            border-top: 1px solid oklch(var(--b3));
        }

        .form-section h4 {
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid oklch(var(--b3));
            border-radius: 0.375rem;
            background: oklch(var(--b1));
            color: oklch(var(--bc));
        }

        .form-group small {
            color: oklch(var(--bc) / 0.6);
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: block;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .checkbox-label {
            display: flex !important;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .checkbox-label input[type="checkbox"] {
            width: auto !important;
        }

        .auth-none {
            color: oklch(var(--bc) / 0.6);
            font-style: italic;
            padding: 1rem;
            text-align: center;
            background: oklch(var(--b2));
            border-radius: 0.375rem;
        }

        .notification {
            background: oklch(var(--b1));
            border: 1px solid oklch(var(--b3));
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .notification-success {
            background: oklch(var(--su) / 0.1);
            border-color: oklch(var(--su));
            color: oklch(var(--su));
        }

        .notification-error {
            background: oklch(var(--er) / 0.1);
            border-color: oklch(var(--er));
            color: oklch(var(--er));
        }

        .notification-info {
            background: oklch(var(--in) / 0.1);
            border-color: oklch(var(--in));
            color: oklch(var(--in));
        }

        .notification-close {
            background: none;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            opacity: 0.7;
        }

        .loading-state {
            text-align: center;
            padding: 2rem;
            color: oklch(var(--bc) / 0.6);
        }

        .spinner {
            width: 2rem;
            height: 2rem;
            border: 2px solid oklch(var(--b3));
            border-top: 2px solid oklch(var(--p));
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: oklch(var(--bc) / 0.6);
        }

        .empty-state .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: oklch(var(--bc));
        }

        .empty-state p {
            margin-bottom: 1.5rem;
        }

        .server-section {
            margin-bottom: 2rem;
        }

        .server-section h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: oklch(var(--bc));
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .server-list {
            display: grid;
            gap: 1rem;
            width: 100%;
            min-width: 0;
        }

        .no-custom-servers {
            text-align: center;
            padding: 2rem;
            color: oklch(var(--bc) / 0.6);
            background: oklch(var(--b2));
            border-radius: 0.5rem;
            border: 2px dashed oklch(var(--b3));
        }

        /* Responsive design for server cards */
        @media (max-width: 768px) {
            .server-header {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .server-actions {
                align-self: flex-start;
                width: 100%;
                justify-content: flex-start;
            }
            
            .server-stats {
                gap: 0.5rem;
            }
            
            .server-stats .stat {
                font-size: 0.65rem;
                padding: 0.125rem 0.375rem;
            }
        }

        /* Built-in Server Configuration Styles */
        .builtin-server-config {
            padding: 1rem 0;
        }

        .config-description {
            background: oklch(var(--b2));
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid oklch(var(--in));
        }

        .config-description p {
            margin: 0 0 0.75rem 0;
            color: oklch(var(--bc));
        }

        .env-var-info {
            background: oklch(var(--b1));
            padding: 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }

        .env-var-info code {
            background: oklch(var(--b3));
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: oklch(var(--bc));
        }

        .builtin-server-config .form-group {
            margin-bottom: 1.25rem;
        }

        .builtin-server-config .form-group:last-child {
            margin-bottom: 0;
        }

        .builtin-server-config .checkbox-label small {
            margin-left: 1.5rem;
            margin-top: 0.25rem;
            display: block;
            color: oklch(var(--bc) / 0.6);
            font-size: 0.75rem;
        }
        
        /* Custom Mobile Drawer Styles (replacing DaisyUI) */
        .mobile-drawer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999; /* Highest to overlay everything including header */
            /* Ensure it's completely hidden on desktop */
            visibility: hidden;
        }
        
        .mobile-drawer.open {
            pointer-events: auto;
            visibility: visible;
        }
        
        /* Only show on mobile screens */
        @media (max-width: 1279px) {
            .mobile-drawer {
                visibility: visible;
            }
        }
        
        .drawer-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            z-index: 9998;
        }
        
        .mobile-drawer.open .drawer-backdrop {
            opacity: 1;
        }
        
        .drawer-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 240px;
            height: 100%;
            background: oklch(var(--b2));
            z-index: 9999;
            border-right: 1px solid oklch(var(--b3));
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .mobile-drawer.open .drawer-panel {
            transform: translateX(0);
        }
        
        /* Dark mode drawer */
        [data-theme="dark"] .drawer-panel {
            background-color: rgb(30, 30, 35);
            border-right-color: rgba(255, 255, 255, 0.1);
        }
        
        /* Hide drawer on desktop (xl breakpoint = 1280px) */
        @media (min-width: 1280px) {
            .mobile-drawer {
                display: none !important;
            }
        }
        
        /* Navigation scroll container */
        .nav-scroll-container {
            overflow-y: auto;
            overflow-x: hidden;
            flex: 1;
            padding: 0 0.75rem;
        }
        
        /* Desktop nav specific height */
        nav .nav-scroll-container {
            max-height: calc(100vh - 80px);
        }
        
        /* Mobile nav scroll container specific height */
        .drawer-panel .nav-scroll-container {
            max-height: calc(100vh - 64px); /* Account for Menu header + close button */
        }
        
        /* Custom scrollbar styling */
        .nav-scroll-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .nav-scroll-container::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .nav-scroll-container::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.15);
            border-radius: 3px;
        }
        
        [data-theme="dark"] .nav-scroll-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .nav-scroll-container::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.25);
        }
        
        [data-theme="dark"] .nav-scroll-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.25);
        }
        
        /* Firefox scrollbar */
        .nav-scroll-container {
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 0, 0, 0.15) transparent;
        }
        
        [data-theme="dark"] .nav-scroll-container {
            scrollbar-color: rgba(255, 255, 255, 0.15) transparent;
        }
        
        /* Desktop Sidebar Styles */
        .desktop-sidebar {
            position: fixed;
            left: 0;
            top: 0; /* Start from the very top */
            width: 15rem; /* 240px */
            height: 100vh; /* Full viewport height */
            background-color: #f3f4f6; /* Light theme fallback */
            border-right: 1px solid #e5e7eb;
            z-index: 40; /* Below header (50) so header overlays it */
            display: none;
            /* Remove overflow from here, add to container */
            padding: 0 !important;
            padding-top: 0 !important;
        }

        /* Show sidebar on desktop (xl breakpoint = 1280px) */
        @media (min-width: 1280px) {
            .desktop-sidebar {
                display: block !important;
            }
        }

        /* Dark theme colors */
        [data-theme="dark"] .desktop-sidebar {
            background-color: #2a2e37;
            border-right-color: #3f4451;
        }

        /* Ensure proper background in DaisyUI themes */
        [data-theme="light"] .desktop-sidebar,
        [data-theme="cupcake"] .desktop-sidebar {
            background-color: #f3f4f6;
        }

        [data-theme="dark"] .desktop-sidebar,
        [data-theme="night"] .desktop-sidebar,
        [data-theme="forest"] .desktop-sidebar {
            background-color: #1f2937;
        }
        
        /* Desktop Sidebar Menu Styling - Custom without DaisyUI */
        .desktop-sidebar .nav-scroll-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 0;
            padding-top: 32px; /* Very minimal padding above MENU */
            padding-bottom: 0; /* No bottom padding */
            margin: 0;
            overflow-y: auto;
        }
        
        /* Sidebar header styling */
        .desktop-sidebar .sidebar-header {
            margin-top: 0;
            padding: 0.25rem 1rem; /* Very tight padding */
            font-weight: 600;
            font-size: 0.875rem; /* Readable size (14px) */
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: inherit;
            opacity: 0.7;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            margin-bottom: 0; /* No bottom margin */
            position: relative;
            top: 0;
        }
        
        /* Dark theme header border */
        [data-theme="dark"] .desktop-sidebar .sidebar-header {
            border-bottom-color: rgba(255, 255, 255, 0.1);
        }
        
        /* Custom sidebar menu - no DaisyUI dependencies */
        .desktop-sidebar .sidebar-menu {
            list-style: none;
            padding: 0;
            padding-bottom: 0; /* Ensure no bottom padding */
            margin: 0;
            margin-bottom: 0; /* Ensure no bottom margin */
            width: 100%;
            display: block;
        }
        
        .desktop-sidebar .sidebar-menu li {
            margin: 0;
            padding: 0;
            display: block;
        }

        .desktop-sidebar .menu-item {
            color: inherit;
            padding: 0.5rem 1rem; /* More compact padding */
            display: block;
            transition: background-color 0.2s, border-radius 0.2s;
            text-decoration: none;
            cursor: pointer;
            line-height: 1.4; /* Slightly tighter line height */
            margin: 0.125rem 0.5rem; /* Minimal margin for spacing */
            border-radius: 0.375rem; /* Slight rounding by default */
        }
        
        /* First menu item uses same padding as others */
        .desktop-sidebar .sidebar-menu li:first-child .menu-item {
            padding-top: 0.5rem; /* Same compact padding as other items */
        }

        .desktop-sidebar .menu-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 0.75rem; /* 12px - moderately rounded on hover */
        }

        [data-theme="dark"] .desktop-sidebar .menu-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .desktop-sidebar .menu-item.active {
            background-color: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            font-weight: 600;
            border-radius: 0.75rem; /* 12px - moderately rounded for active state */
            padding: 0.5rem 1rem; /* Keep same compact padding as other items */
        }
        
        /* Responsive container adjustments */
        @media (max-width: 640px) {
            .max-w-7xl {
                padding: 1rem;
            }
            
            .navbar {
                padding: 0.5rem;
            }
            
            .btn {
                min-height: 2.5rem;
                height: 2.5rem;
                padding-left: 0.75rem;
                padding-right: 0.75rem;
                font-size: 0.875rem;
            }
            
            /* Stack cards vertically on mobile */
            .card {
                margin-bottom: 1rem;
            }
            
            /* Full width inputs on mobile */
            .input, .select, .textarea {
                width: 100%;
            }
            
            /* Responsive modals */
            .modal-box {
                margin: 1rem;
                max-height: calc(100vh - 2rem);
            }
        }
        
        /* Remove tablet adjustments - handled by drawer now */
        
        /* Responsive grid utilities */
        .responsive-grid {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
        
        /* Main content wrapper styling */
        .main-content-wrapper {
            min-height: 100vh;
            background-color: oklch(var(--b1));
            position: relative;
            padding-top: 96px; /* Account for two-row mobile header (48px + 48px) */
        }
        
        /* Adjust padding for single-row desktop header */
        @media (min-width: 640px) {
            .main-content-wrapper {
                padding-top: 64px; /* Account for single-row desktop header */
            }
        }
        
        /* Desktop: Add left padding for sidebar (xl breakpoint = 1280px) */
        @media (min-width: 1280px) {
            .main-content-wrapper {
                margin-left: 15rem; /* 60 * 0.25rem = 15rem for w-60 sidebar */
            }
            
            /* Header should also start after sidebar on desktop */
            #config-header {
                left: 15rem !important;
                right: 0;
            }
        }
        
        /* On mobile and tablets, header spans full width */
        @media (max-width: 1279px) {
            #config-header {
                left: 0 !important;
                right: 0;
            }
        }
        
        @media (max-width: 640px) {
            .responsive-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Responsive input groups */
        @media (max-width: 640px) {
            .input-group {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .input-group > * {
                width: 100%;
            }
        }
        
        /* Very narrow screens (smallest laptop sizes) */
        @media (max-width: 480px) {
            #config-header .flex {
                gap: 0.5rem;
            }
            
            #save-indicator {
                display: none !important;
            }
            
            .btn-circle {
                width: 2.25rem;
                height: 2.25rem;
                padding: 0;
            }
            
            .main-content-wrapper .p-6 {
                padding: 1rem;
            }
        }
        
        /* Touch-friendly enhancements */
        @media (hover: none) and (pointer: coarse) {
            /* Larger touch targets */
            .btn {
                min-height: 44px;
            }
            
            .input, .select, .textarea {
                min-height: 44px;
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            .toggle {
                transform: scale(1.1);
            }
            
            /* Better spacing for touch */
            .card-body {
                padding: 1.25rem;
            }
            
            /* Visual feedback for touch */
            .btn:active {
                transform: scale(0.98);
            }
        }
        
        /* Restart notification styles */
        .restart-notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: oklch(var(--wa));
            color: oklch(var(--wac));
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-1rem);
            transition: all 0.3s ease;
        }
        
        .restart-notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .restart-notification-icon {
            font-size: 1.25rem;
        }
        
        .restart-notification-close {
            margin-left: auto;
            background: none;
            border: none;
            color: oklch(var(--wac));
            cursor: pointer;
            font-size: 1.25rem;
            padding: 0;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        .restart-notification-close:hover {
            opacity: 1;
        }
        
        /* Settings that require restart indicator */
        .requires-restart {
            position: relative;
        }
        
        .requires-restart::after {
            content: "‚ö†Ô∏è Requires restart";
            position: absolute;
            top: -1.5rem;
            right: 0;
            font-size: 0.75rem;
            color: oklch(var(--wa));
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .requires-restart.changed::after {
            opacity: 1;
        }
        
        a:active, .menu-item:active {
            background-color: oklch(var(--b3));
        }
        
        /* Smooth transitions */
        .btn, .input, .card, .menu-item {
            transition: all 0.2s ease;
        }
        
        /* Notification styles */
        .notification {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: oklch(var(--b2));
            color: oklch(var(--bc));
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
            z-index: 1000;
            animation: slideInUp 0.3s ease;
        }
        
        .notification.success {
            background: oklch(var(--su));
            color: oklch(var(--suc));
        }
        
        .notification.error {
            background: oklch(var(--er));
            color: oklch(var(--erc));
        }
        
        .notification.warning {
            background: oklch(var(--wa));
            color: oklch(var(--wac));
        }
        
        @keyframes slideInUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* RAG Config Manager Styles */
        .rag-config-manager {
            padding: 1rem;
        }
        
        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .config-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .config-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .config-label {
            font-weight: 600;
            color: oklch(var(--bc) / 0.8);
            font-size: 0.875rem;
        }
        
        .config-value {
            font-size: 1rem;
            color: oklch(var(--bc));
        }
        
        .config-value.enabled {
            color: oklch(var(--su));
        }
        
        .config-value.disabled {
            color: oklch(var(--er));
        }
        
        .config-form {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .slider-value {
            font-size: 0.875rem;
            color: oklch(var(--bc) / 0.7);
            text-align: right;
        }
        
        .validation-feedback {
            margin-top: 0.5rem;
        }
        
        .validation-success {
            color: oklch(var(--su));
            font-size: 0.875rem;
        }
        
        .validation-errors {
            background: oklch(var(--er) / 0.1);
            border: 1px solid oklch(var(--er) / 0.3);
            border-radius: 0.375rem;
            padding: 0.75rem;
        }
        
        .error-title {
            color: oklch(var(--er));
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .error-item {
            color: oklch(var(--er));
            font-size: 0.875rem;
            margin-left: 1rem;
        }
        
        .config-info {
            background: oklch(var(--b3));
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1.5rem;
        }
        
        .info-section h4 {
            margin-bottom: 0.75rem;
            font-weight: 600;
        }
        
        .description-item {
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
        }
        
        .description-item strong {
            display: inline-block;
            margin-bottom: 0.25rem;
        }
        
        .description-item ul {
            margin-left: 1.5rem;
            margin-top: 0.25rem;
        }
        
        .description-item code {
            background: oklch(var(--b1));
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.8125rem;
        }
        
        /* Warning styles for embedding model */
        .bg-warning\/10 {
            background-color: oklch(var(--wa) / 0.1);
        }
        
        .border-warning {
            border-color: oklch(var(--wa));
        }
        
        .bg-info\/10 {
            background-color: oklch(var(--in) / 0.1);
        }
        
        .border-info {
            border-color: oklch(var(--in));
        }
        
        .mt-2 {
            margin-top: 0.5rem;
        }
        
        .p-3 {
            padding: 0.75rem;
        }
        
        .rounded-lg {
            border-radius: 0.5rem;
        }
        
        .text-sm {
            font-size: 0.875rem;
        }
        
        /* Dark mode styles for SVG images */
        [data-theme="dark"] .text-base-content img[src$=".svg"] {
            filter: invert(1) brightness(0.9);
        }
        
        /* Dark mode styles for code elements in alerts */
        [data-theme="dark"] .alert-info code {
            background-color: rgb(64 64 64 / 0.8) !important;
            color: rgb(255 255 255 / 0.9) !important;
        }
        
        /* Enhanced dark mode text contrast for better readability */
        [data-theme="dark"] .menu-item {
            color: rgba(255, 255, 255, 0.85);
        }
        
        [data-theme="dark"] .menu-item:hover:not(.active) {
            color: rgba(255, 255, 255, 0.95);
            background-color: rgba(255, 255, 255, 0.08);
            transform: translateX(2px); /* Subtle hover effect */
        }
        
        [data-theme="dark"] .menu-item.active {
            color: white;
            font-weight: 600; /* Make active item more prominent */
        }
        
        /* Brighter card headings in dark mode */
        [data-theme="dark"] .card h3,
        [data-theme="dark"] .card h4,
        [data-theme="dark"] .card h5 {
            color: rgba(255, 255, 255, 0.95);
        }
        
        /* Brighter labels and form text */
        [data-theme="dark"] .label-text {
            color: rgba(255, 255, 255, 0.85);
        }
        
        [data-theme="dark"] .label-text-alt {
            color: rgba(255, 255, 255, 0.7);
        }
        
        /* Improve body text readability */
        [data-theme="dark"] .text-base-content\/70 {
            color: rgba(255, 255, 255, 0.75);
        }
        
        [data-theme="dark"] .text-base-content\/60 {
            color: rgba(255, 255, 255, 0.65);
        }
        
        /* Brighter text in cards */
        [data-theme="dark"] .card-body {
            color: rgba(255, 255, 255, 0.85);
        }
        
        [data-theme="dark"] .card-body p {
            color: rgba(255, 255, 255, 0.75);
        }
        
        /* Divider text in dark mode */
        [data-theme="dark"] .divider {
            color: rgba(255, 255, 255, 0.8);
        }
        
        /* Button text in dark mode */
        [data-theme="dark"] .btn:not(.btn-primary):not(.btn-secondary):not(.btn-accent) {
            color: rgba(255, 255, 255, 0.85);
        }
        
        /* Input placeholders */
        [data-theme="dark"] input::placeholder,
        [data-theme="dark"] textarea::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }
        
        /* Select and input text */
        [data-theme="dark"] .select,
        [data-theme="dark"] .input,
        [data-theme="dark"] .textarea {
            color: rgba(255, 255, 255, 0.9);
        }
        
        /* Tab headers and section titles */
        [data-theme="dark"] h2.text-2xl,
        [data-theme="dark"] .text-xl {
            color: rgba(255, 255, 255, 0.95);
        }
        
        /* Save indicator styling */
        #save-indicator {
            padding: 0.5rem 1rem;
            min-height: auto;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            animation: slideIn 0.3s ease-out;
        }
        
        /* New Header Styles */
        .config-header-responsive {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: oklch(var(--b1) / 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--bc, #e5e5e5);
            z-index: 50;
        }
        
        /* Mobile Header Styles */
        .mobile-header {
            display: none;
        }
        
        .mobile-header-row-1 {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            height: 48px;
        }
        
        .mobile-header-row-2 {
            display: flex;
            align-items: center;
            padding: 0 12px 8px 12px;
            gap: 8px;
        }
        
        .mobile-hamburger-btn {
            width: 36px;
            height: 36px;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .mobile-hamburger-btn svg {
            width: 24px;
            height: 24px;
        }
        
        .mobile-title {
            font-size: 18px;
            font-weight: bold;
            margin: 0 0 0 8px;
        }
        
        .mobile-spacer {
            flex: 1;
        }
        
        .mobile-theme-btn {
            width: 36px;
            height: 36px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .mobile-save-btn {
            padding: 8px 16px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        
        .mobile-save-btn:hover {
            background: #2563eb;
        }
        
        .mobile-indicator {
            margin-left: auto;
            padding: 4px 12px;
            background: #10b981;
            color: white;
            border-radius: 6px;
            font-size: 13px;
        }
        
        /* Desktop Header Styles */
        .desktop-header {
            display: none;
            align-items: center;
            padding: 0 24px;
            height: 64px;
            gap: 16px;
        }
        
        .desktop-hamburger-btn {
            width: 40px;
            height: 40px;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .desktop-hamburger-btn svg {
            width: 24px;
            height: 24px;
        }
        
        .desktop-title {
            font-size: 24px;
            font-weight: bold;
            margin: 0;
        }
        
        .desktop-theme-btn {
            width: 40px;
            height: 40px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .desktop-save-btn {
            padding: 8px 20px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        
        .desktop-save-btn:hover {
            background: #2563eb;
        }
        
        .desktop-spacer {
            flex: 1;
        }
        
        .desktop-indicator {
            padding: 6px 16px;
            background: #10b981;
            color: white;
            border-radius: 6px;
            font-size: 14px;
        }
        
        /* Hide hamburger on xl screens */
        @media (min-width: 1280px) {
            .desktop-hamburger-btn {
                display: none !important;
            }
        }
        
        /* Show mobile layout on small screens */
        @media (max-width: 639px) {
            .mobile-header {
                display: flex;
                flex-direction: column;
            }
            .desktop-header {
                display: none !important;
            }
            .main-content-wrapper {
                padding-top: 96px; /* Account for two-row mobile header */
            }
        }
        
        /* Show desktop layout on larger screens */
        @media (min-width: 640px) {
            .mobile-header {
                display: none !important;
            }
            .desktop-header {
                display: flex;
            }
        }
        
        /* Ensure hidden indicators stay hidden */
        .hidden {
            display: none !important;
        }
        
        /* Button hover effects */
        #config-header button {
            cursor: pointer;
            transition: opacity 0.2s ease;
        }
        
        #config-header button:hover {
            opacity: 0.9;
        }
        
        #config-header button:active {
            opacity: 0.75;
        }
        
        #save-indicator.hidden {
            display: none !important;
        }
        
        #save-indicator.text-warning {
            background-color: rgb(251, 189, 35, 0.2);
            color: rgb(251, 189, 35);
            border: 1px solid rgb(251, 189, 35, 0.3);
        }
        
        #save-indicator.text-success {
            background-color: rgb(34, 197, 94, 0.2);
            color: rgb(34, 197, 94);
            border: 1px solid rgb(34, 197, 94, 0.3);
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Hover states for logo selection cards */
        .logo-selection-card {
            cursor: pointer;
        }
        
        .logo-selection-card:hover {
            border-color: oklch(var(--p) / 0.5);
            background-color: oklch(var(--b2));
        }
    </style>
</head>
<body class="min-h-screen bg-base-100">
    <script>
    // Immediate initialization for critical UI functions
    (function() {
        'use strict';
        
        // Core app actions available globally
        window.appActions = {
            toggleTheme: function() {
                const html = document.documentElement;
                const currentTheme = html.getAttribute('data-theme') || 'dark';
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                html.setAttribute('data-theme', newTheme);
                localStorage.setItem('config-ui-theme', newTheme);
                
                // Update all theme icons
                document.querySelectorAll('[data-theme-icon]').forEach(icon => {
                    icon.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
                });
                
                console.log('Theme switched to:', newTheme);
            },
            
            saveConfig: async function() {
                // Show save indicators
                const desktopIndicator = document.getElementById('desktop-save-indicator');
                const mobileIndicator = document.getElementById('mobile-save-indicator');
                
                if (desktopIndicator) {
                    desktopIndicator.classList.remove('hidden');
                    desktopIndicator.textContent = 'Saving...';
                }
                if (mobileIndicator) {
                    mobileIndicator.classList.remove('hidden');
                    mobileIndicator.textContent = 'Saving...';
                }
                
                // Use config manager if available
                if (window.configManager && window.configManager.saveConfig) {
                    await window.configManager.saveConfig();
                } else {
                    console.error('Config manager not ready yet');
                    if (desktopIndicator) {
                        desktopIndicator.textContent = 'Error: Config manager not ready';
                        setTimeout(() => desktopIndicator.classList.add('hidden'), 3000);
                    }
                    if (mobileIndicator) {
                        mobileIndicator.textContent = 'Error!';
                        setTimeout(() => mobileIndicator.classList.add('hidden'), 3000);
                    }
                }
            },
            
            toggleDrawer: function() {
                // Use the new custom drawer implementation
                if (window.mobileDrawer) {
                    window.mobileDrawer.toggle();
                }
            }
        };
        
        
        // Event delegation for all button clicks - Set up after DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Setting up button event delegation');
            
            // Simple, single event delegation
            document.addEventListener('click', function(e) {
                // Find the closest element with data-action attribute
                const actionElement = e.target.closest('[data-action]');
                if (!actionElement) return;
                
                // Prevent default and stop propagation
                e.preventDefault();
                e.stopPropagation();
                
                // Get the action and execute it
                const action = actionElement.getAttribute('data-action');
                console.log('Action triggered:', action);
                
                switch(action) {
                    case 'toggle-theme':
                        window.appActions.toggleTheme();
                        break;
                    case 'save-config':
                        window.appActions.saveConfig();
                        break;
                    case 'toggle-drawer':
                        console.log('Toggling drawer');
                        window.appActions.toggleDrawer();
                        break;
                    default:
                        console.warn('Unknown action:', action);
                }
            });
        });
        
        // Initialize theme on page load
        const savedTheme = localStorage.getItem('config-ui-theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        
        // Update theme icons on load
        setTimeout(() => {
            document.querySelectorAll('[data-theme-icon]').forEach(icon => {
                icon.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            });
        }, 100);
        
    })();
    
    // Add the missing hideRestartNotification function
    function hideRestartNotification() {
        const notification = document.getElementById('restartNotification');
        if (notification) {
            notification.style.display = 'none';
        }
    }
    </script>
    
    <!-- Restart Notification -->
    <div id="restartNotification" class="restart-notification">
        <span class="restart-notification-icon">‚ö†Ô∏è</span>
        <span>Server restart required for changes to take effect</span>
        <button class="restart-notification-close" onclick="hideRestartNotification()">√ó</button>
    </div>
    
    <!-- First-time Setup Modal -->
    <div id="firstTimeSetup" class="modal" style="display: none;">
            <div class="modal-box max-w-2xl">
                <h3 class="font-bold text-lg mb-4">üöÄ Welcome to ChatRAG!</h3>
                <p class="mb-6">Let's set up your configuration to get started with ChatRAG.</p>
                
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">Choose a starting configuration:</span>
                    </label>
                    
                    <div class="space-y-3">
                        <label class="cursor-pointer label border rounded-lg p-4 hover:bg-base-200">
                            <input type="radio" name="template" value="minimal" class="radio radio-primary" checked>
                            <div class="ml-3">
                                <div class="font-semibold">Minimal Setup</div>
                                <div class="text-sm text-base-content/70">Basic configuration with just the essentials</div>
                            </div>
                        </label>
                        
                        <label class="cursor-pointer label border rounded-lg p-4 hover:bg-base-200">
                            <input type="radio" name="template" value="standard" class="radio radio-primary">
                            <div class="ml-3">
                                <div class="font-semibold">Standard Setup</div>
                                <div class="text-sm text-base-content/70">Recommended configuration with common features</div>
                            </div>
                        </label>
                        
                        <label class="cursor-pointer label border rounded-lg p-4 hover:bg-base-200">
                            <input type="radio" name="template" value="advanced" class="radio radio-primary">
                            <div class="ml-3">
                                <div class="font-semibold">Advanced Setup</div>
                                <div class="text-sm text-base-content/70">Full configuration with all features enabled</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div class="modal-action">
                    <button id="setupFromTemplate" class="btn btn-primary">Continue with Selected Template</button>
                    <button id="setupManually" class="btn btn-outline">Manual Setup</button>
                </div>
            </div>
        </div>

    <!-- Main content (no longer wrapped in drawer) -->
    <div id="main-wrapper">
        <!-- Desktop Navigation Sidebar (hidden on mobile and tablets) -->
        <nav id="desktop-sidebar" class="desktop-sidebar">
            <div class="nav-scroll-container">
                <div class="sidebar-header">Menu</div>
                <ul class="sidebar-menu">
                    <li><a class="menu-item active" data-tab="features">Features</a></li>
                    <li><a class="menu-item" data-tab="ai">AI Models</a></li>
                    <li><a class="menu-item" data-tab="media">Media Generation</a></li>
                    <li><a class="menu-item" data-tab="database">Database</a></li>
                    <li><a class="menu-item" data-tab="auth">Authentication</a></li>
                    <li><a class="menu-item" data-tab="rag-settings">RAG Settings</a></li>
                    <li><a class="menu-item" data-tab="document-processing">Document Processing</a></li>
                    <li><a class="menu-item" data-tab="rag-prompt">System Prompt</a></li>
                    <li><a class="menu-item" data-tab="admin">Admin</a></li>
                    <li><a class="menu-item" data-tab="branding">Branding & UI</a></li>
                    <li><a class="menu-item" data-tab="saved-chats">Saved Chats</a></li>
                    <li><a class="menu-item" data-tab="suggestions">Suggestions</a></li>
                    <li><a class="menu-item" data-tab="embed">Embed Widget</a></li>
                    <li><a class="menu-item" data-tab="audio">Audio</a></li>
                    <li><a class="menu-item" data-tab="payment">Payment</a></li>
                    <li><a class="menu-item" data-tab="email">Email</a></li>
                    <li><a class="menu-item" data-tab="whatsapp">WhatsApp</a></li>
                    <li><a class="menu-item" data-tab="advanced">MCP Config</a></li>
                </ul>
            </div>
        </nav>
        
                <!-- Main Configuration UI -->
                <div id="configApp">
                    <!-- Main Content Wrapper -->
                    <div class="main-content-wrapper">
                        <!-- Redesigned Header with Proper Responsive Layout -->
                        <header id="config-header" class="config-header-responsive">
                            <!-- Mobile Layout (single row) -->
                            <div class="mobile-header">
                                <div class="mobile-header-row-1">
                                    <button class="mobile-hamburger-btn" data-action="toggle-drawer">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                                        </svg>
                                    </button>
                                    <h1 class="mobile-title">‚öôÔ∏è Config</h1>
                                </div>
                                <div class="mobile-header-row-2">
                                    <button class="mobile-theme-btn" data-action="toggle-theme" aria-label="Toggle theme">
                                        <span data-theme-icon>‚òÄÔ∏è</span>
                                    </button>
                                    <button class="mobile-save-btn" data-action="save-config">
                                        Save
                                    </button>
                                    <div class="mobile-spacer"></div>
                                    <div id="mobile-save-indicator" class="mobile-indicator hidden">
                                        Saved!
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Desktop Layout (single row) -->
                            <div class="desktop-header">
                                <button class="desktop-hamburger-btn" data-action="toggle-drawer">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                                    </svg>
                                </button>
                                <h1 class="desktop-title">‚öôÔ∏è ChatRAG Configuration</h1>
                                <button class="desktop-theme-btn" data-action="toggle-theme" aria-label="Toggle theme">
                                    <span data-theme-icon>‚òÄÔ∏è</span>
                                </button>
                                <button class="desktop-save-btn" data-action="save-config">
                                    Save All Changes
                                </button>
                                <div class="desktop-spacer"></div>
                                <div id="desktop-save-indicator" class="desktop-indicator hidden">
                                    Changes saved!
                                </div>
                            </div>
                        </header>
                        
                        <!-- Main Content -->
                        <div class="p-6">
                    
                    <!-- Features Tab -->
                    <div class="tab-content active" id="features">
                        <div class="card bg-base-100 shadow-lg">
                            <div class="card-body p-4 lg:p-6">
                                <h2 class="card-title text-xl lg:text-2xl text-chatrag-primary mb-6">‚ú® Feature Configuration</h2>
                                
                                <div class="responsive-grid">
                                    <!-- Authentication Feature -->
                                    <div class="card bg-base-200 shadow-md">
                                    <div class="card-body">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="text-lg font-semibold">Authentication</h3>
                                            <input type="checkbox" id="NEXT_PUBLIC_AUTH_ENABLED" class="toggle toggle-primary">
                                        </div>
                                        <p class="text-base-content/70">Enable user authentication. When enabled, users will need to create accounts to use the chatbot.</p>
                                    </div>
                                </div>

                                    <!-- Web Search Feature -->
                                    <div class="card bg-base-200 shadow-md">
                                    <div class="card-body">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="text-lg font-semibold">Web Search</h3>
                                            <input type="checkbox" id="NEXT_PUBLIC_WEB_SEARCH_ENABLED" class="toggle toggle-primary">
                                        </div>
                                        <p class="text-base-content/70">Allow the chatbot to search the web for up-to-date information.</p>
                                    </div>
                                </div>

                                    <!-- Image Generation -->
                                    <div class="card bg-base-200 shadow-md">
                                    <div class="card-body">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="text-lg font-semibold">Image Generation</h3>
                                            <input type="checkbox" id="NEXT_PUBLIC_IMAGE_GENERATION_ENABLED" class="toggle toggle-primary">
                                        </div>
                                        <p class="text-base-content/70">Enable AI image generation capabilities.</p>
                                    </div>
                                </div>

                                    <!-- Video Generation -->
                                    <div class="card bg-base-200 shadow-md">
                                    <div class="card-body">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="text-lg font-semibold">Video Generation</h3>
                                            <input type="checkbox" id="NEXT_PUBLIC_VIDEO_GENERATION_ENABLED" class="toggle toggle-primary">
                                        </div>
                                        <p class="text-base-content/70">Enable AI video generation capabilities.</p>
                                    </div>
                                </div>

                                    <!-- 3D Model Generation -->
                                    <div class="card bg-base-200 shadow-md">
                                    <div class="card-body">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="text-lg font-semibold">3D Model Generation</h3>
                                            <input type="checkbox" id="NEXT_PUBLIC_3D_GENERATION_ENABLED" class="toggle toggle-primary">
                                        </div>
                                        <p class="text-base-content/70">Enable AI 3D model generation capabilities.</p>
                                    </div>
                                </div>

                                    <!-- MCP Tools -->
                                    <div class="card bg-base-200 shadow-md">
                                    <div class="card-body">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="text-lg font-semibold">MCP Tools List</h3>
                                            <input type="checkbox" id="NEXT_PUBLIC_MCP_TOOLS_LIST_ENABLED" class="toggle toggle-primary">
                                        </div>
                                        <p class="text-base-content/70">Show tools list button and modal in chat UI (when MCP system is enabled).</p>
                                    </div>
                                </div>
                                </div> <!-- End responsive-grid -->
                            </div>
                        </div>
                    </div>

                    <!-- AI Models Tab -->
                    <div class="tab-content" id="ai">
                        <div class="card bg-base-100 shadow-lg">
                            <div class="card-body p-4 lg:p-6">
                                <h2 class="card-title text-xl lg:text-2xl text-chatrag-primary mb-6">ü§ñ AI Model Configuration</h2>
                                
                                <!-- OpenAI -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">OpenAI</h3>
                                        <p class="text-base-content/70 mb-4">Required for embeddings and optional model access.</p>
                                        
                                        <div class="form-control">
                                            <label class="label">
                                                <span class="label-text">API Key</span>
                                                <span class="label-text-alt">
                                                    <a href="https://platform.openai.com/api-keys" target="_blank" class="link link-primary">Get API Key</a>
                                                </span>
                                            </label>
                                            <div class="flex gap-2">
                                                <input type="password" id="OPENAI_API_KEY" 
                                                       placeholder="sk-..." 
                                                       class="input input-bordered flex-1 w-full">
                                                <button class="btn btn-square btn-outline" data-for="OPENAI_API_KEY">üëÅÔ∏è</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- OpenRouter -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">OpenRouter</h3>
                                        <p class="text-base-content/70 mb-4">Required for accessing various AI models.</p>
                                        
                                        <div class="form-control">
                                            <label class="label">
                                                <span class="label-text">API Key</span>
                                                <span class="label-text-alt">
                                                    <a href="https://openrouter.ai/settings/keys" target="_blank" class="link link-primary">Get API Key</a>
                                                </span>
                                            </label>
                                            <div class="flex gap-2">
                                                <input type="password" id="OPENROUTER_API_KEY" 
                                                       placeholder="sk-or-..." 
                                                       class="input input-bordered flex-1 w-full">
                                                <button class="btn btn-square btn-outline" data-for="OPENROUTER_API_KEY">üëÅÔ∏è</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- LlamaCloud -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">LlamaCloud</h3>
                                        <p class="text-base-content/70 mb-4">Used for document parsing.</p>
                                        
                                        <div class="form-control">
                                            <label class="label">
                                                <span class="label-text">API Key</span>
                                                <span class="label-text-alt">
                                                    <a href="https://cloud.llamaindex.ai" target="_blank" class="link link-primary">Get API Key</a>
                                                </span>
                                            </label>
                                            <div class="flex gap-2">
                                                <input type="password" id="NEXT_PUBLIC_LLAMA_CLOUD_API_KEY" 
                                                       placeholder="llx-..." 
                                                       class="input input-bordered flex-1 w-full">
                                                <button class="btn btn-square btn-outline" data-for="NEXT_PUBLIC_LLAMA_CLOUD_API_KEY">üëÅÔ∏è</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Model Provider Configuration -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">Model Provider Configuration</h3>
                                        <p class="text-base-content/70 mb-4">Select the AI provider and manage available models.</p>
                                        
                                        <!-- Provider Selector -->
                                        <div class="form-control mb-6">
                                            <label class="label">
                                                <span class="label-text">AI Provider</span>
                                            </label>
                                            <select id="ai-provider-select" class="select select-bordered w-full">
                                                <option value="openrouter">OpenRouter</option>
                                                <option value="openai">OpenAI</option>
                                            </select>
                                            <p class="text-sm text-base-content/70 mt-2">Choose which provider to use for AI model access. This will filter available models in the chat interface.</p>
                                        </div>

                                        <!-- Model Management -->
                                        <div class="divider">Available Models</div>
                                        
                                        <!-- Models List Container -->
                                        <div id="models-container" class="space-y-2 mb-4">
                                            <!-- Models will be dynamically loaded here -->
                                        </div>

                                        <!-- Add Model Form -->
                                        <div class="card bg-base-300 p-4 mb-4">
                                            <h4 class="font-semibold mb-2">Add New Model</h4>
                                            
                                            <!-- Model ID with Auto-Fetch -->
                                            <div class="flex gap-2 mb-2">
                                                <input type="text" id="new-model-id" placeholder="Model ID (e.g., z-ai/glm-4.5)" class="input input-sm input-bordered flex-1">
                                                <button onclick="fetchModelInfo()" class="btn btn-sm btn-secondary" id="fetch-model-btn">
                                                    <span id="fetch-btn-text">üîç Auto-Fill</span>
                                                </button>
                                                <button onclick="testOpenRouterConnection()" class="btn btn-sm btn-ghost" title="Test OpenRouter API Connection">
                                                    üîß
                                                </button>
                                            </div>
                                            
                                            <!-- Auto-fetch Status -->
                                            <div id="model-fetch-status" class="mb-2 text-sm" style="display: none;"></div>
                                            
                                            <!-- Basic Model Info -->
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
                                                <input type="text" id="new-model-name" placeholder="Display Name (e.g., GPT-4)" class="input input-sm input-bordered">
                                                <input type="number" id="new-model-context" placeholder="Context Length" class="input input-sm input-bordered">
                                            </div>
                                            
                                            <!-- Model Properties -->
                                            <div class="flex gap-4 mb-3">
                                                <label class="cursor-pointer label">
                                                    <input type="checkbox" id="new-model-free" class="checkbox checkbox-sm">
                                                    <span class="label-text ml-2">üéÅ Free Model</span>
                                                </label>
                                                <label class="cursor-pointer label">
                                                    <input type="checkbox" id="new-model-opensource" class="checkbox checkbox-sm">
                                                    <span class="label-text ml-2">üîì Open Source</span>
                                                </label>
                                                <label class="cursor-pointer label">
                                                    <input type="checkbox" id="new-model-uncensored" class="checkbox checkbox-sm">
                                                    <span class="label-text ml-2">‚õìÔ∏è‚Äçüí• Uncensored</span>
                                                </label>
                                                <label class="cursor-pointer label">
                                                    <input type="checkbox" id="new-model-reasoning" class="checkbox checkbox-sm" onchange="toggleReasoningConfig()">
                                                    <span class="label-text ml-2">üß† Supports Reasoning</span>
                                                </label>
                                            </div>
                                            
                                            <!-- Reasoning Configuration (collapsible) -->
                                            <div id="reasoning-config" class="card bg-base-200 p-3 mb-3" style="display: none;">
                                                <h5 class="font-medium mb-2">‚öôÔ∏è Reasoning Configuration</h5>
                                                
                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
                                                    <select id="reasoning-method" class="select select-sm select-bordered">
                                                        <option value="max_tokens">Max Tokens (Anthropic, Gemini style)</option>
                                                        <option value="effort">Effort (OpenAI o-series style)</option>
                                                        <option value="both">Both Methods (DeepSeek style)</option>
                                                    </select>
                                                    <select id="default-effort" class="select select-sm select-bordered">
                                                        <option value="low">Low Effort</option>
                                                        <option value="medium" selected>Medium Effort</option>
                                                        <option value="high">High Effort</option>
                                                    </select>
                                                </div>
                                                
                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                                    <input type="number" id="max-tokens-limit" placeholder="Max Reasoning Tokens (e.g., 16000)" class="input input-sm input-bordered">
                                                    <input type="number" id="min-tokens" placeholder="Min Reasoning Tokens (e.g., 1000)" class="input input-sm input-bordered">
                                                </div>
                                                
                                                <div class="text-xs text-base-content/70 mt-2">
                                                    üí° These settings control how reasoning tokens are allocated for this model
                                                </div>
                                            </div>
                                            
                                            <!-- Description (auto-filled) -->
                                            <textarea id="new-model-description" placeholder="Model description (auto-filled from OpenRouter)" class="textarea textarea-sm textarea-bordered mb-2" rows="2"></textarea>
                                            
                                            <!-- Action Buttons -->
                                            <div class="flex gap-2">
                                                <button onclick="resetModelForm()" class="btn btn-sm btn-ghost">Reset</button>
                                                <button onclick="addModel()" class="btn btn-sm btn-primary ml-auto">Add Model</button>
                                            </div>
                                        </div>

                                        <!-- Save Configuration Button -->
                                        <button onclick="saveModelConfiguration()" class="btn btn-primary w-full">Save Model Configuration</button>
                                        
                                    </div>
                                </div>

                                <!-- Token Limit Configuration -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">Token Limit Configuration</h3>
                                        <p class="text-base-content/70 mb-4">Control the maximum tokens for AI model responses. This helps manage costs and prevent token limit errors.</p>
                                        
                                        <div class="form-control mb-4">
                                            <label class="cursor-pointer label">
                                                <span class="label-text">Use Custom Token Limit</span>
                                                <input type="checkbox" id="USE_CUSTOM_TOKEN_LIMIT" class="toggle toggle-primary" onchange="toggleTokenLimitSettings()">
                                            </label>
                                            <p class="text-sm text-base-content/70 mt-2">Enable to override the default model-specific token limits.</p>
                                        </div>
                                        
                                        <div id="token-limit-settings" style="display: none;">
                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Maximum Completion Tokens</span>
                                                </label>
                                                <input type="number" id="MAX_COMPLETION_TOKENS" 
                                                       placeholder="4096" 
                                                       min="100"
                                                       max="128000"
                                                       class="input input-bordered w-full">
                                                <p class="text-sm text-base-content/70 mt-2">
                                                    Default limits: Claude models: 4,096 tokens, GPT-5 Mini: 8,192 tokens, GPT-5: 4,096 tokens
                                                </p>
                                                <p class="text-sm text-base-content/70 mt-1">
                                                    Higher values allow longer responses but increase costs. 1,000 tokens ‚âà 750 words.
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Exa Web Search -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">Exa Web Search</h3>
                                        <p class="text-base-content/70 mb-4">AI-powered web search API for real-time information retrieval. Used when web search is enabled in chat.</p>
                                        
                                        <div class="form-control">
                                            <label class="label">
                                                <span class="label-text">API Key</span>
                                            </label>
                                            <div class="flex gap-2">
                                                <input type="password" id="EXA_API_KEY" 
                                                       placeholder="Enter your Exa API key..." 
                                                       class="input input-bordered flex-1 w-full">
                                                <button class="btn btn-square btn-outline" data-for="EXA_API_KEY">üëÅÔ∏è</button>
                                            </div>
                                            <label class="label">
                                                <span class="label-text-alt">Get your API key from <a href="https://dashboard.exa.ai/api-keys" target="_blank" class="link link-primary">dashboard.exa.ai/api-keys</a></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Global Reasoning Settings -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">Global Reasoning Settings</h3>
                                        <p class="text-base-content/70 mb-4">Configure reasoning/thinking tokens for compatible AI models like OpenAI o-series, Anthropic Claude 3.7+, DeepSeek R1, and Google Gemini Thinking.</p>
                                        
                                        <!-- Enable Reasoning Feature -->
                                        <div class="form-control mb-4">
                                            <label class="cursor-pointer label justify-start gap-3">
                                                <input type="checkbox" id="NEXT_PUBLIC_REASONING_ENABLED" class="toggle toggle-primary" checked>
                                                <span class="label-text">Enable Reasoning Feature</span>
                                            </label>
                                            <p class="text-sm text-base-content/70 mt-1">Master switch for reasoning tokens. When disabled, the reasoning button will be hidden.</p>
                                        </div>
                                        
                                        <!-- Default Reasoning Effort -->
                                        <div class="form-control mb-4">
                                            <label class="label">
                                                <span class="label-text">Default Reasoning Effort</span>
                                            </label>
                                            <select id="NEXT_PUBLIC_DEFAULT_REASONING_EFFORT" class="select select-bordered">
                                                <option value="low">Low</option>
                                                <option value="medium" selected>Medium</option>
                                                <option value="high">High</option>
                                            </select>
                                            <p class="text-sm text-base-content/70 mt-2">Sets the initial effort level for OpenAI o-series and similar models</p>
                                        </div>
                                        
                                        <!-- Maximum Reasoning Tokens -->
                                        <div class="form-control mb-4">
                                            <label class="label">
                                                <span class="label-text">Maximum Reasoning Tokens</span>
                                                <span class="label-text-alt" id="reasoning-tokens-display">8000 tokens</span>
                                            </label>
                                            <input type="range" id="NEXT_PUBLIC_MAX_REASONING_TOKENS" 
                                                   class="range range-primary" 
                                                   min="1000" max="32000" step="1000" value="8000">
                                            <div class="w-full flex justify-between text-xs px-2 mb-2">
                                                <span>1k</span>
                                                <span>8k</span>
                                                <span>16k</span>
                                                <span>24k</span>
                                                <span>32k</span>
                                            </div>
                                            <div class="alert alert-warning" id="reasoning-cost-warning">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                                </svg>
                                                <span id="reasoning-cost-estimate">Estimated cost: ~$0.12 per message at 8000 tokens</span>
                                            </div>
                                        </div>
                                        
                                        <!-- Show Reasoning by Default -->
                                        <div class="form-control mb-4">
                                            <label class="cursor-pointer label justify-start gap-3">
                                                <input type="checkbox" id="NEXT_PUBLIC_SHOW_REASONING_BY_DEFAULT" class="toggle toggle-primary">
                                                <span class="label-text">Show Reasoning by Default</span>
                                            </label>
                                            <p class="text-sm text-base-content/70 mt-1">Automatically expand reasoning content in chat messages</p>
                                        </div>
                                        
                                        <!-- Enable RAG + Reasoning -->
                                        <div class="form-control mb-4">
                                            <label class="cursor-pointer label justify-start gap-3">
                                                <input type="checkbox" id="NEXT_PUBLIC_RAG_REASONING_ENABLED" class="toggle toggle-primary" checked>
                                                <span class="label-text">Enable RAG + Reasoning</span>
                                            </label>
                                            <p class="text-sm text-base-content/70 mt-1">Use reasoning tokens for enhanced document retrieval and analysis</p>
                                            <div class="alert alert-info mt-2">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                                <span>When enabled, the AI will use reasoning tokens to better understand and analyze your documents</span>
                                            </div>
                                        </div>
                                        
                                        <!-- Advanced Settings -->
                                        <details class="collapse collapse-arrow bg-base-100 mb-4">
                                            <summary class="collapse-title text-base font-medium">Advanced Settings</summary>
                                            <div class="collapse-content">
                                                <!-- Cost Multiplier -->
                                                <div class="form-control">
                                                    <label class="label">
                                                        <span class="label-text">Cost Multiplier</span>
                                                        <span class="label-text-alt" id="cost-multiplier-display">1.5x</span>
                                                    </label>
                                                    <input type="range" id="REASONING_COST_MULTIPLIER" 
                                                           class="range range-primary" 
                                                           min="0.5" max="5" step="0.1" value="1.5">
                                                    <div class="w-full flex justify-between text-xs px-2">
                                                        <span>0.5x</span>
                                                        <span>1.5x</span>
                                                        <span>2.5x</span>
                                                        <span>3.5x</span>
                                                        <span>5x</span>
                                                    </div>
                                                    <p class="text-sm text-base-content/70 mt-2">Multiplier for cost warnings. Adjust based on your actual reasoning token pricing.</p>
                                                </div>
                                            </div>
                                        </details>
                                        
                                        <!-- Preset Buttons -->
                                        <div class="flex flex-wrap gap-2">
                                            <button class="btn btn-sm" onclick="setReasoningPreset('cost')">
                                                üí∞ Cost Optimized
                                            </button>
                                            <button class="btn btn-sm btn-primary" onclick="setReasoningPreset('balanced')">
                                                ‚öñÔ∏è Balanced
                                            </button>
                                            <button class="btn btn-sm" onclick="setReasoningPreset('performance')">
                                                üöÄ Performance
                                            </button>
                                        </div>
                                        <p class="text-xs text-base-content/60 mt-2">Quick presets: Cost (Low/2k), Balanced (Medium/8k), Performance (High/16k)</p>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                    <!-- Media Generation Tab -->
                    <div class="tab-content" id="media">
                        <div class="card bg-base-100 shadow-lg">
                            <div class="card-body p-4 lg:p-6">
                                <h2 class="card-title text-xl lg:text-2xl text-chatrag-primary mb-6">üßë‚Äçüé® Media Generation Configuration</h2>
                                <p class="text-base-content/70 mb-6">Configure AI-powered generation for images, videos, and 3D models. Manage providers, models, and API keys all in one place.</p>

                                <!-- Image Generation Section -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">üñºÔ∏è Image Generation</h3>
                                        
                                        <!-- Provider Selection -->
                                        <div class="form-control mb-4">
                                            <label class="label">
                                                <span class="label-text">Image Generation Provider</span>
                                            </label>
                                            <select id="IMAGE_GENERATION_PROVIDER" class="select select-bordered w-full" onchange="updateImageProviderSettings()">
                                                <option value="openai">OpenAI Images API</option>
                                                <option value="fal">Fal.ai</option>
                                                <option value="replicate">Replicate</option>
                                            </select>
                                        </div>
                                        
                                        <!-- OpenAI Image Settings -->
                                        <div id="openai-image-settings" class="provider-settings">
                                            <div class="divider">OpenAI Images API Settings</div>
                                            <div class="form-control mb-4">
                                                <label class="label">
                                                    <span class="label-text">Model</span>
                                                </label>
                                                <input type="text" id="OPENAI_IMAGE_MODEL" value="gpt-image-1" placeholder="e.g., gpt-image-1, dall-e-3, dall-e-2" class="input input-bordered">
                                                <label class="label">
                                                    <span class="label-text-alt">OpenAI image generation model to use</span>
                                                </label>
                                            </div>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div class="form-control">
                                                    <label class="label">
                                                        <span class="label-text">Quality</span>
                                                    </label>
                                                    <select id="OPENAI_IMAGE_QUALITY" class="select select-bordered select-sm">
                                                        <option value="auto">Auto</option>
                                                        <option value="high">High</option>
                                                        <option value="medium">Medium</option>
                                                        <option value="low">Low</option>
                                                    </select>
                                                </div>
                                                
                                                <div class="form-control">
                                                    <label class="label">
                                                        <span class="label-text">Background</span>
                                                    </label>
                                                    <select id="OPENAI_IMAGE_BACKGROUND" class="select select-bordered select-sm">
                                                        <option value="auto">Auto</option>
                                                        <option value="transparent">Transparent</option>
                                                        <option value="opaque">Opaque</option>
                                                    </select>
                                                </div>
                                                
                                                <div class="form-control">
                                                    <label class="label">
                                                        <span class="label-text">Format</span>
                                                    </label>
                                                    <select id="OPENAI_IMAGE_FORMAT" class="select select-bordered select-sm">
                                                        <option value="png">PNG</option>
                                                        <option value="webp">WebP</option>
                                                        <option value="jpeg">JPEG</option>
                                                    </select>
                                                </div>
                                                
                                                <div class="form-control">
                                                    <label class="label">
                                                        <span class="label-text">Moderation</span>
                                                    </label>
                                                    <select id="OPENAI_IMAGE_MODERATION" class="select select-bordered select-sm">
                                                        <option value="auto">Auto</option>
                                                        <option value="low">Low (Less Restrictive)</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="alert alert-info mt-4">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                                <span>Uses your OpenAI API key from the AI Models section</span>
                                            </div>
                                        </div>
                                        
                                        <!-- Fal.ai Image Settings -->
                                        <div id="fal-image-settings" class="provider-settings" style="display: none;">
                                            <div class="divider">Fal.ai Settings</div>
                                            <div class="form-control mb-4">
                                                <label class="label">
                                                    <span class="label-text">Text-to-Image Model</span>
                                                </label>
                                                <input type="text" id="FAL_IMAGE_MODEL" placeholder="e.g., fal-ai/bytedance/seedream/v4/text-to-image" class="input input-bordered">
                                                <label class="label">
                                                    <span class="label-text-alt">Enter the Fal.ai model ID for text-to-image generation</span>
                                                </label>
                                            </div>
                                            <div class="form-control mb-4">
                                                <label class="label">
                                                    <span class="label-text">Image Editing Model</span>
                                                </label>
                                                <input type="text" id="FAL_IMAGE_TO_IMAGE_MODEL" placeholder="e.g., fal-ai/nano-banana/edit" class="input input-bordered">
                                                <label class="label">
                                                    <span class="label-text-alt">Enter the Fal.ai model ID for image editing</span>
                                                </label>
                                            </div>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div class="form-control">
                                                    <label class="label">
                                                        <span class="label-text">Inference Steps</span>
                                                    </label>
                                                    <input type="number" id="FAL_INFERENCE_STEPS" value="28" min="1" max="50" class="input input-bordered input-sm">
                                                </div>
                                                <div class="form-control">
                                                    <label class="label">
                                                        <span class="label-text">Guidance Scale</span>
                                                    </label>
                                                    <input type="number" id="FAL_GUIDANCE_SCALE" value="3.5" min="1" max="20" step="0.5" class="input input-bordered input-sm">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Replicate Image Settings -->
                                        <div id="replicate-image-settings" class="provider-settings" style="display: none;">
                                            <div class="divider">Replicate Settings</div>
                                            <div class="form-control mb-4">
                                                <label class="label">
                                                    <span class="label-text">Model ID</span>
                                                </label>
                                                <input type="text" id="REPLICATE_IMAGE_MODEL" placeholder="e.g., stability-ai/sdxl:version" class="input input-bordered">
                                                <label class="label">
                                                    <span class="label-text-alt">Format: owner/model:version</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Video Generation Section -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">üé¨ Video Generation</h3>
                                        
                                        <!-- Provider Selection -->
                                        <div class="form-control mb-4">
                                            <label class="label">
                                                <span class="label-text">Video Generation Provider</span>
                                            </label>
                                            <select id="VIDEO_GENERATION_PROVIDER" class="select select-bordered w-full" onchange="updateVideoProviderSettings()">
                                                <option value="fal">Fal.ai</option>
                                                <option value="replicate">Replicate</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Fal.ai Video Settings -->
                                        <div id="fal-video-settings" class="provider-settings">
                                            <div class="divider">Fal.ai Video Settings</div>

                                            <!-- Text-to-Video Models -->
                                            <div class="mb-6">
                                                <h4 class="text-lg font-medium mb-3">Text-to-Video Models</h4>
                                                <div class="grid grid-cols-1 gap-4">
                                                    <div class="form-control">
                                                        <label class="label">
                                                            <span class="label-text">Default Model (Legacy)</span>
                                                        </label>
                                                        <input type="text" id="FAL_VIDEO_MODEL" value="fal-ai/veo3/fast" placeholder="e.g., fal-ai/veo3/fast" class="input input-bordered">
                                                        <label class="label">
                                                            <span class="label-text-alt">Legacy video model for backward compatibility</span>
                                                        </label>
                                                    </div>
                                                    <div class="form-control">
                                                        <label class="label">
                                                            <span class="label-text">Text-to-Video Standard</span>
                                                        </label>
                                                        <input type="text" id="FAL_VIDEO_TEXT_MODEL" value="fal-ai/veo3/fast" placeholder="e.g., fal-ai/veo3/fast" class="input input-bordered">
                                                        <label class="label">
                                                            <span class="label-text-alt">Standard quality text-to-video generation</span>
                                                        </label>
                                                    </div>
                                                    <div class="form-control">
                                                        <label class="label">
                                                            <span class="label-text">Text-to-Video Fast</span>
                                                        </label>
                                                        <input type="text" id="FAL_VIDEO_TEXT_FAST_MODEL" value="fal-ai/veo3/fast" placeholder="e.g., fal-ai/veo3/fast" class="input input-bordered">
                                                        <label class="label">
                                                            <span class="label-text-alt">Fast text-to-video generation</span>
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Image-to-Video Models -->
                                            <div class="mb-6">
                                                <h4 class="text-lg font-medium mb-3">Image-to-Video Models</h4>
                                                <div class="grid grid-cols-1 gap-4">
                                                    <div class="form-control">
                                                        <label class="label">
                                                            <span class="label-text">Image-to-Video Standard</span>
                                                        </label>
                                                        <input type="text" id="FAL_VIDEO_IMAGE_MODEL" value="fal-ai/veo3/image-to-video" placeholder="e.g., fal-ai/veo3/image-to-video" class="input input-bordered">
                                                        <label class="label">
                                                            <span class="label-text-alt">Standard quality image-to-video generation</span>
                                                        </label>
                                                    </div>
                                                    <div class="form-control">
                                                        <label class="label">
                                                            <span class="label-text">Image-to-Video Fast</span>
                                                        </label>
                                                        <input type="text" id="FAL_VIDEO_IMAGE_FAST_MODEL" value="fal-ai/veo3/fast/image-to-video" placeholder="e.g., fal-ai/veo3/fast/image-to-video" class="input input-bordered">
                                                        <label class="label">
                                                            <span class="label-text-alt">Fast image-to-video generation</span>
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                <div class="form-control">
                                                    <label class="label">
                                                        <span class="label-text">Duration (seconds)</span>
                                                    </label>
                                                    <input type="number" id="FAL_VIDEO_DURATION" value="5" min="1" max="10" class="input input-bordered input-sm">
                                                </div>
                                                <div class="form-control">
                                                    <label class="label">
                                                        <span class="label-text">FPS</span>
                                                    </label>
                                                    <select id="FAL_VIDEO_FPS" class="select select-bordered select-sm">
                                                        <option value="24">24</option>
                                                        <option value="30" selected>30</option>
                                                        <option value="60">60</option>
                                                    </select>
                                                </div>
                                                <div class="form-control">
                                                    <label class="label">
                                                        <span class="label-text">Resolution</span>
                                                    </label>
                                                    <select id="FAL_VIDEO_RESOLUTION" class="select select-bordered select-sm">
                                                        <option value="512">512p</option>
                                                        <option value="720" selected>720p</option>
                                                        <option value="1080">1080p</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Replicate Video Settings -->
                                        <div id="replicate-video-settings" class="provider-settings" style="display: none;">
                                            <div class="divider">Replicate Video Settings</div>
                                            <div class="form-control mb-4">
                                                <label class="label">
                                                    <span class="label-text">Model ID</span>
                                                </label>
                                                <input type="text" id="REPLICATE_VIDEO_MODEL" value="zsxkib/animate-3d" placeholder="e.g., owner/model:version" class="input input-bordered">
                                                <label class="label">
                                                    <span class="label-text-alt">Format: owner/model:version</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 3D Model Generation Section -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">üé≤ 3D Model Generation</h3>
                                        
                                        <!-- Provider Selection -->
                                        <div class="form-control mb-4">
                                            <label class="cursor-pointer label justify-start gap-3">
                                                <input type="checkbox" id="USE_REPLICATE_PROVIDER" class="toggle toggle-primary" onchange="update3DProviderSettings()">
                                                <span class="label-text">Use Fal.ai Provider (unchecked = Replicate)</span>
                                            </label>
                                        </div>
                                        
                                        <!-- 3D Model Settings -->
                                        <div id="3d-model-settings" class="provider-settings">
                                            <!-- Fal.ai 3D Settings -->
                                            <div id="fal-3d-settings" class="provider-settings">
                                                <div class="divider">Fal.ai 3D Model Settings</div>
                                                <div class="form-control mb-4">
                                                    <label class="label">
                                                        <span class="label-text">Model ID</span>
                                                    </label>
                                                    <input type="text" id="FAL_3D_MODEL" value="fal-ai/trellis" placeholder="e.g., fal-ai/trellis" class="input input-bordered">
                                                    <label class="label">
                                                        <span class="label-text-alt">Enter the Fal.ai model ID for 3D generation</span>
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <!-- Replicate 3D Settings -->
                                            <div id="replicate-3d-settings" class="provider-settings" style="display: none;">
                                                <div class="divider">Replicate 3D Model Settings</div>
                                                <div class="form-control mb-4">
                                                    <label class="label">
                                                        <span class="label-text">Model ID</span>
                                                    </label>
                                                    <input type="text" id="REPLICATE_3D_MODEL" value="firtoz/trellis:4876f2a8da1c544772dffa32e8889da4a1bab3a1f5c1937bfcfccb99ae347251" placeholder="e.g., firtoz/trellis:version" class="input input-bordered">
                                                    <label class="label">
                                                        <span class="label-text-alt">Format: owner/model:version</span>
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <!-- Common 3D Settings -->
                                            <div class="divider">3D Generation Parameters</div>
                                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                <div class="form-control">
                                                    <label class="label">
                                                        <span class="label-text">Texture Size</span>
                                                    </label>
                                                    <select id="3D_TEXTURE_SIZE" class="select select-bordered select-sm">
                                                        <option value="512">512</option>
                                                        <option value="1024">1024</option>
                                                        <option value="2048" selected>2048</option>
                                                        <option value="4096">4096</option>
                                                    </select>
                                                </div>
                                                <div class="form-control">
                                                    <label class="label">
                                                        <span class="label-text">Mesh Simplification</span>
                                                    </label>
                                                    <input type="range" id="3D_MESH_SIMPLIFY" min="0.5" max="1" step="0.1" value="0.9" class="range range-primary range-sm">
                                                    <div class="w-full flex justify-between text-xs px-2">
                                                        <span>0.5</span>
                                                        <span>0.7</span>
                                                        <span>0.9</span>
                                                        <span>1.0</span>
                                                    </div>
                                                </div>
                                                <div class="form-control">
                                                    <label class="label">
                                                        <span class="label-text">Sampling Steps</span>
                                                    </label>
                                                    <input type="number" id="3D_SAMPLING_STEPS" value="38" min="10" max="100" class="input input-bordered input-sm">
                                                </div>
                                            </div>
                                            <div class="form-control mt-4">
                                                <label class="label">
                                                    <span class="label-text">Output Format</span>
                                                </label>
                                                <select id="3D_OUTPUT_FORMAT" class="select select-bordered">
                                                    <option value="glb" selected>GLB (Binary)</option>
                                                    <option value="gltf">GLTF (Text + Textures)</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- API Keys Section -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">üîë Media Generation API Keys</h3>
                                        <p class="text-base-content/70 mb-4">Configure API keys for media generation providers. OpenAI API key is managed in the AI Models section.</p>
                                        
                                        <!-- Fal.ai API Key -->
                                        <div class="form-control mb-4">
                                            <label class="label">
                                                <span class="label-text">Fal.ai API Key</span>
                                                <span class="label-text-alt">
                                                    <a href="https://fal.ai" target="_blank" class="link link-primary">Get API Key</a>
                                                </span>
                                            </label>
                                            <div class="flex gap-2">
                                                <input type="password" id="FAL_API_KEY" placeholder="fal-..." class="input input-bordered flex-1 w-full">
                                                <button class="btn btn-square btn-outline" data-for="FAL_API_KEY">üëÅÔ∏è</button>
                                                <button class="btn btn-outline" onclick="testAPIKey('fal')">Test</button>
                                            </div>
                                        </div>
                                        
                                        <!-- Replicate API Token -->
                                        <div class="form-control mb-4">
                                            <label class="label">
                                                <span class="label-text">Replicate API Token</span>
                                                <span class="label-text-alt">
                                                    <a href="https://replicate.com/account" target="_blank" class="link link-primary">Get API Token</a>
                                                </span>
                                            </label>
                                            <div class="flex gap-2">
                                                <input type="password" id="REPLICATE_API_TOKEN" placeholder="r8_..." class="input input-bordered flex-1 w-full">
                                                <button class="btn btn-square btn-outline" data-for="REPLICATE_API_TOKEN">üëÅÔ∏è</button>
                                                <button class="btn btn-outline" onclick="testAPIKey('replicate')">Test</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>


                            </div>
                        </div>
                    </div>

                    <!-- Audio Tab -->
                    <div class="tab-content" id="audio">
                        <div class="card bg-base-100 shadow-lg">
                            <div class="card-body p-4 lg:p-6">
                                <h2 class="card-title text-2xl text-chatrag-primary mb-6">üîä Audio Configuration</h2>
                                
                                <!-- Refresh Notice -->
                                <div class="alert alert-warning mb-6">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                    </svg>
                                    <span>Audio settings require a page refresh to take effect. After saving changes, please refresh your browser.</span>
                                </div>
                                
                                <!-- Text-to-Speech Section -->
                                <div class="form-section">
                                    <h3 class="text-xl font-semibold mb-4">Text-to-Speech (TTS)</h3>
                                    
                                    <div class="form-control">
                                        <label class="cursor-pointer label justify-start gap-3">
                                            <span class="label-text">Disable Text-to-Speech</span>
                                            <input type="checkbox" id="NEXT_PUBLIC_TTS_DISABLED" name="NEXT_PUBLIC_TTS_DISABLED" class="toggle toggle-primary">
                                        </label>
                                        <div class="text-sm text-base-content/70 mt-2">Hide the play button for reading AI responses aloud</div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="NEXT_PUBLIC_VOICE_PROVIDER">Voice Provider</label>
                                        <select name="NEXT_PUBLIC_VOICE_PROVIDER" id="NEXT_PUBLIC_VOICE_PROVIDER" class="select select-bordered w-full">
                                            <option value="openai">OpenAI</option>
                                            <option value="elevenlabs">ElevenLabs</option>
                                        </select>
                                        <small>Choose which service to use for voice generation</small>
                                    </div>
                                    
                                    <!-- OpenAI TTS Settings -->
                                    <div id="openai-tts-settings" class="mt-4">
                                        <div class="alert alert-info mb-4">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                            <span>OpenAI TTS uses your OpenAI API key configured in the AI Models section</span>
                                        </div>
                                    </div>
                                    
                                    <!-- ElevenLabs TTS Settings -->
                                    <div id="elevenlabs-tts-settings" class="mt-4" style="display: none;">
                                        <div class="form-group">
                                            <label for="ELEVENLABS_API_KEY">ElevenLabs API Key</label>
                                            <input type="password" name="ELEVENLABS_API_KEY" id="ELEVENLABS_API_KEY" class="input input-bordered w-full" placeholder="Enter your ElevenLabs API key">
                                            <small>Get your API key from <a href="https://elevenlabs.io/api" target="_blank" class="link link-primary">elevenlabs.io/api</a></small>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="ELEVENLABS_VOICE_ID">Default Voice</label>
                                            <input type="text" name="ELEVENLABS_VOICE_ID" id="ELEVENLABS_VOICE_ID" class="input input-bordered w-full" placeholder="Voice ID (e.g., EXAVITQu4vr4xnSDxMaL)">
                                            <small>Enter a voice ID or leave blank to use the default (Sarah)</small>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="ELEVENLABS_MODEL_ID">Model</label>
                                            <select name="ELEVENLABS_MODEL_ID" id="ELEVENLABS_MODEL_ID" class="select select-bordered w-full">
                                                <option value="eleven_multilingual_v2">Multilingual v2</option>
                                                <option value="eleven_turbo_v2_5">Turbo v2.5</option>
                                                <option value="eleven_flash_v2_5">Flash v2.5</option>
                                            </select>
                                            <small>Choose the ElevenLabs model for voice generation</small>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="ELEVENLABS_VOICE_SPEED">Voice Speed <span id="speed-value" class="text-sm text-base-content/70">(1.0)</span></label>
                                            <input type="range" name="ELEVENLABS_VOICE_SPEED" id="ELEVENLABS_VOICE_SPEED" 
                                                class="range range-primary" min="0" max="2" step="0.1" value="1.0">
                                            <div class="w-full flex justify-between text-xs px-2">
                                                <span>Slower</span>
                                                <span>Faster</span>
                                            </div>
                                        </div>
                                        
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="ELEVENLABS_VOICE_STABILITY">Voice Stability <span id="stability-value" class="text-sm text-base-content/70">(0.5)</span></label>
                                                <input type="range" name="ELEVENLABS_VOICE_STABILITY" id="ELEVENLABS_VOICE_STABILITY" 
                                                    class="range range-primary" min="0" max="1" step="0.1" value="0.5">
                                                <div class="w-full flex justify-between text-xs px-2">
                                                    <span>Variable</span>
                                                    <span>Stable</span>
                                                </div>
                                            </div>
                                            
                                            <div class="form-group">
                                                <label for="ELEVENLABS_SIMILARITY_BOOST">Similarity Boost <span id="similarity-value" class="text-sm text-base-content/70">(0.5)</span></label>
                                                <input type="range" name="ELEVENLABS_SIMILARITY_BOOST" id="ELEVENLABS_SIMILARITY_BOOST" 
                                                    class="range range-primary" min="0" max="1" step="0.1" value="0.5">
                                                <div class="w-full flex justify-between text-xs px-2">
                                                    <span>Low</span>
                                                    <span>High</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="form-control">
                                            <label class="cursor-pointer label justify-start gap-3">
                                                <span class="label-text">Enable Speaker Boost</span>
                                                <input type="checkbox" id="ELEVENLABS_SPEAKER_BOOST" name="ELEVENLABS_SPEAKER_BOOST" class="toggle toggle-primary">
                                            </label>
                                            <div class="text-sm text-base-content/70 mt-2">Enhance voice clarity and presence</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Speech-to-Text Section -->
                                <div class="form-section">
                                    <h3 class="text-xl font-semibold mb-4">Speech-to-Text (STT)</h3>
                                    
                                    <div class="form-control">
                                        <label class="cursor-pointer label justify-start gap-3">
                                            <span class="label-text">Disable Speech-to-Text</span>
                                            <input type="checkbox" id="NEXT_PUBLIC_STT_DISABLED" name="NEXT_PUBLIC_STT_DISABLED" class="toggle toggle-primary">
                                        </label>
                                        <div class="text-sm text-base-content/70 mt-2">Hide the microphone button and only show the send button</div>
                                    </div>
                                    
                                    <div class="alert alert-info mt-4">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        <span>Speech-to-Text uses the same provider as Text-to-Speech</span>
                                    </div>
                                </div>
                                
                                <!-- Audio Playback Section -->
                                <div class="form-section">
                                    <h3 class="text-xl font-semibold mb-4">Audio Playback</h3>
                                    
                                    <div class="form-control">
                                        <label class="cursor-pointer label justify-start gap-3">
                                            <span class="label-text">Auto-play AI Responses</span>
                                            <input type="checkbox" id="NEXT_PUBLIC_AUDIO_AUTOPLAY" name="NEXT_PUBLIC_AUDIO_AUTOPLAY" class="toggle toggle-primary">
                                        </label>
                                        <div class="text-sm text-base-content/70 mt-2">Automatically play audio when AI responds</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Database Tab -->
                    <div class="tab-content" id="database">
                        <div class="card bg-base-100 shadow-lg">
                            <div class="card-body">
                                <h2 class="card-title text-2xl text-chatrag-primary mb-6">üóÑÔ∏è Database Configuration</h2>
                                
                                <!-- Supabase -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">Supabase Configuration</h3>
                                        <p class="text-base-content/70 mb-4">Configure your Supabase database connection.</p>
                                        <div class="text-sm text-base-content/70 mb-6">
                                            <a href="https://supabase.com/dashboard/project/_/settings/api" target="_blank" class="link link-primary">Get your API keys from Supabase Dashboard</a>
                                        </div>
                                        
                                        <div class="space-y-4">
                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Supabase URL</span>
                                                </label>
                                                <input type="url" id="NEXT_PUBLIC_SUPABASE_URL" 
                                                       placeholder="https://your-project.supabase.co" 
                                                       class="input input-bordered w-full">
                                            </div>

                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Supabase Anon Key</span>
                                                </label>
                                                <div class="flex gap-2">
                                                    <input type="password" id="NEXT_PUBLIC_SUPABASE_ANON_KEY" 
                                                           placeholder="eyJ..." 
                                                           class="input input-bordered flex-1 w-full">
                                                    <button class="btn btn-square btn-outline" data-for="NEXT_PUBLIC_SUPABASE_ANON_KEY">üëÅÔ∏è</button>
                                                </div>
                                            </div>

                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Supabase Service Role Key (Keep Secret!)</span>
                                                </label>
                                                <div class="flex gap-2">
                                                    <input type="password" id="SUPABASE_SERVICE_ROLE_KEY" 
                                                           placeholder="eyJ..." 
                                                           class="input input-bordered flex-1 w-full">
                                                    <button class="btn btn-square btn-outline" data-for="SUPABASE_SERVICE_ROLE_KEY">üëÅÔ∏è</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Authentication Tab -->
                    <div class="tab-content" id="auth">
                        <div class="card bg-base-100 shadow-lg">
                            <div class="card-body">
                                <h2 class="card-title text-2xl text-chatrag-primary mb-6">üîê Authentication Configuration</h2>
                                
                                <!-- Site URL -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">Site URL</h3>
                                        <p class="text-base-content/70 mb-4">The URL where your application is hosted (required for auth callbacks).</p>
                                        
                                        <div class="form-control">
                                            <label class="label">
                                                <span class="label-text">Site URL</span>
                                            </label>
                                            <input type="url" id="NEXT_PUBLIC_SITE_URL" 
                                                   placeholder="https://your-domain.com" 
                                                   class="input input-bordered w-full">
                                        </div>
                                    </div>
                                </div>

                                <!-- GitHub OAuth -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">GitHub OAuth</h3>
                                        <p class="text-base-content/70 mb-6">Enable GitHub login for your application.</p>
                                        
                                        <div class="space-y-4">
                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">GitHub Client ID</span>
                                                </label>
                                                <input type="text" id="NEXT_PUBLIC_GITHUB_CLIENT_ID" 
                                                       placeholder="Iv1.16B3c0dd3b55c5b9" 
                                                       class="input input-bordered w-full">
                                            </div>

                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">GitHub Client Secret</span>
                                                </label>
                                                <div class="flex gap-2">
                                                    <input type="password" id="GITHUB_CLIENT_SECRET" 
                                                           placeholder="your-github-client-secret" 
                                                           class="input input-bordered flex-1 w-full">
                                                    <button class="btn btn-square btn-outline" data-for="GITHUB_CLIENT_SECRET">üëÅÔ∏è</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Tab -->
                    <div class="tab-content" id="payment">
                        <div class="card bg-base-100 shadow-lg">
                            <div class="card-body">
                                <h2 class="card-title text-2xl text-chatrag-primary mb-6">üí≥ Payment Configuration</h2>
                                
                                <!-- Stripe -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">Stripe</h3>
                                        <p class="text-base-content/70 mb-6">Configure Stripe for payments.</p>
                                        
                                        <div class="space-y-4">
                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Publishable Key</span>
                                                </label>
                                                <input type="text" id="NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY" 
                                                       placeholder="pk_test_..." 
                                                       class="input input-bordered w-full">
                                            </div>

                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Secret Key</span>
                                                </label>
                                                <div class="flex gap-2">
                                                    <input type="password" id="STRIPE_SECRET_KEY" 
                                                           placeholder="sk_test_..." 
                                                           class="input input-bordered flex-1 w-full">
                                                    <button class="btn btn-square btn-outline" data-for="STRIPE_SECRET_KEY">üëÅÔ∏è</button>
                                                </div>
                                            </div>

                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Webhook Secret</span>
                                                </label>
                                                <div class="flex gap-2">
                                                    <input type="password" id="STRIPE_WEBHOOK_SECRET" 
                                                           placeholder="whsec_..." 
                                                           class="input input-bordered flex-1 w-full">
                                                    <button class="btn btn-square btn-outline" data-for="STRIPE_WEBHOOK_SECRET">üëÅÔ∏è</button>
                                                </div>
                                            </div>

                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Pro Plan Price ID</span>
                                                </label>
                                                <input type="text" id="NEXT_PUBLIC_STRIPE_PRICE_ID_PRO" 
                                                       placeholder="price_..." 
                                                       class="input input-bordered w-full">
                                            </div>

                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Enterprise Plan Price ID</span>
                                                </label>
                                                <input type="text" id="NEXT_PUBLIC_STRIPE_PRICE_ID_ENTERPRISE" 
                                                       placeholder="price_..." 
                                                       class="input input-bordered w-full">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Polar -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">Polar</h3>
                                        <p class="text-base-content/70 mb-6">Configure Polar for payments.</p>
                                        
                                        <div class="space-y-4">
                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Access Token</span>
                                                </label>
                                                <div class="flex gap-2">
                                                    <input type="password" id="POLAR_ACCESS_TOKEN" 
                                                           placeholder="polar_pat_..." 
                                                           class="input input-bordered flex-1 w-full">
                                                    <button class="btn btn-square btn-outline" data-for="POLAR_ACCESS_TOKEN">üëÅÔ∏è</button>
                                                </div>
                                            </div>

                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Organization ID</span>
                                                </label>
                                                <input type="text" id="POLAR_ORGANIZATION_ID" 
                                                       placeholder="Organization ID" 
                                                       class="input input-bordered w-full">
                                            </div>

                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Webhook Secret</span>
                                                </label>
                                                <div class="flex gap-2">
                                                    <input type="password" id="POLAR_WEBHOOK_SECRET" 
                                                           placeholder="polar_whsec_..." 
                                                           class="input input-bordered flex-1 w-full">
                                                    <button class="btn btn-square btn-outline" data-for="POLAR_WEBHOOK_SECRET">üëÅÔ∏è</button>
                                                </div>
                                            </div>

                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Organization Slug</span>
                                                </label>
                                                <input type="text" id="POLAR_ORGANIZATION_SLUG" 
                                                       placeholder="your-org-slug" 
                                                       class="input input-bordered w-full">
                                            </div>

                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Pro Plan Price ID</span>
                                                </label>
                                                <input type="text" id="NEXT_PUBLIC_POLAR_PRICE_ID_PRO" 
                                                       placeholder="Polar Pro Price ID" 
                                                       class="input input-bordered w-full">
                                            </div>

                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Enterprise Plan Price ID</span>
                                                </label>
                                                <input type="text" id="NEXT_PUBLIC_POLAR_PRICE_ID_ENTERPRISE" 
                                                       placeholder="Polar Enterprise Price ID" 
                                                       class="input input-bordered w-full">
                                            </div>

                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Pro Checkout Link</span>
                                                </label>
                                                <input type="url" id="NEXT_PUBLIC_POLAR_CHECKOUT_PRO" 
                                                       placeholder="https://polar.sh/your-org/checkout/..." 
                                                       class="input input-bordered w-full">
                                            </div>

                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Enterprise Checkout Link</span>
                                                </label>
                                                <input type="url" id="NEXT_PUBLIC_POLAR_CHECKOUT_ENTERPRISE" 
                                                       placeholder="https://polar.sh/your-org/checkout/..." 
                                                       class="input input-bordered w-full">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Email Tab -->
                    <div class="tab-content" id="email">
                        <div class="card bg-base-100 shadow-lg">
                            <div class="card-body">
                                <h2 class="card-title text-2xl text-chatrag-primary mb-6">üìß Email Configuration</h2>
                                
                                <!-- Email Settings -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">Email Settings</h3>
                                        <p class="text-base-content/70 mb-6">Configure email settings for notifications and authentication.</p>
                                        
                                        <div class="space-y-4">
                                            <div class="form-control">
                                                <label class="cursor-pointer label justify-start gap-3">
                                                    <span class="label-text">Enable Custom SMTP</span>
                                                    <input type="checkbox" id="NEXT_PUBLIC_CUSTOM_SMTP_ENABLED" class="toggle toggle-primary">
                                                </label>
                                                <div class="text-sm text-base-content/70 mt-2">When disabled, uses Supabase's default email service</div>
                                            </div>

                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">From Name</span>
                                                </label>
                                                <input type="text" id="NEXT_PUBLIC_SMTP_FROM_NAME" 
                                                       placeholder="ChatRAG Support" 
                                                       class="input input-bordered w-full">
                                            </div>

                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">From Email</span>
                                                </label>
                                                <input type="email" id="NEXT_PUBLIC_SMTP_FROM_EMAIL" 
                                                       placeholder="support@example.com" 
                                                       class="input input-bordered w-full">
                                            </div>

                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Resend API Key</span>
                                                </label>
                                                <div class="flex gap-2">
                                                    <input type="password" id="RESEND_API_KEY" 
                                                           placeholder="re_..." 
                                                           class="input input-bordered flex-1 w-full">
                                                    <button class="btn btn-square btn-outline" data-for="RESEND_API_KEY">üëÅÔ∏è</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Branding Tab -->
                    <div class="tab-content" id="branding">
                        <div class="card bg-base-100 shadow-lg">
                            <div class="card-body">
                                <h2 class="card-title text-2xl text-chatrag-primary mb-6">üé® Branding & UI Configuration</h2>
                                
                                <!-- Application Name -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">Application Name</h3>
                                        <p class="text-base-content/70 mb-4">Configure the name of your application that appears in the UI, browser title, and footer.</p>
                                        
                                        <div class="form-control">
                                            <label class="label">
                                                <span class="label-text">Application Name</span>
                                            </label>
                                            <input type="text" id="NEXT_PUBLIC_APP_NAME" 
                                                   placeholder="ChatRAG" 
                                                   class="input input-bordered w-full">
                                            <div class="text-sm text-base-content/70 mt-2">
                                                This name will be used throughout the application, including in the browser title, chat interface, and disclaimer footer.
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Header Logo -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">Header Logo</h3>
                                        <p class="text-base-content/70 mb-4">Configure the appearance of the logo in the header.</p>
                                        
                                        <div class="space-y-4">
                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Logo Type</span>
                                                </label>
                                                <select id="NEXT_PUBLIC_HEADER_LOGO_TYPE" class="select select-bordered w-full">
                                                    <option value="text">Text</option>
                                                    <option value="svg">SVG Image</option>
                                                    <option value="png">PNG Image</option>
                                                </select>
                                            </div>

                                            <div class="form-control" id="headerLogoTextGroup">
                                                <label class="label">
                                                    <span class="label-text">Logo Text</span>
                                                </label>
                                                <input type="text" id="NEXT_PUBLIC_HEADER_LOGO_TEXT" 
                                                       placeholder="ChatRAG" 
                                                       class="input input-bordered w-full">
                                            </div>

                                            <div class="form-control hidden" id="headerLogoUrlGroup">
                                                <label class="label">
                                                    <span class="label-text">Logo URL</span>
                                                </label>
                                                <div class="flex gap-2">
                                                    <input type="url" id="NEXT_PUBLIC_HEADER_LOGO_URL" 
                                                           placeholder="https://example.com/logo.svg" 
                                                           class="input input-bordered flex-1 w-full">
                                                    <div class="divider divider-horizontal">OR</div>
                                                    <input type="file" id="headerLogoFile" accept=".svg,.png" 
                                                           class="file-input file-input-bordered">
                                                </div>
                                                <div class="text-sm text-base-content/70 mt-2">
                                                    For best results, use an SVG file. PNG files should be 2x resolution (180px width).
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Sidebar Button Configuration -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">Sidebar Button</h3>
                                        <p class="text-base-content/70 mb-4">Configure the text and URL for the button that appears at the bottom of the sidebar.</p>
                                        
                                        <div class="space-y-4">
                                            <!-- Button Text -->
                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Button Text</span>
                                                </label>
                                                <input type="text" id="NEXT_PUBLIC_SIDEBAR_BUTTON_TEXT" 
                                                       placeholder="ChatRAG" 
                                                       class="input input-bordered w-full">
                                                <div class="text-sm text-base-content/70 mt-2">
                                                    This text will appear on the button at the bottom of the sidebar.
                                                </div>
                                            </div>

                                            <!-- Button URL -->
                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Button URL</span>
                                                </label>
                                                <input type="url" id="NEXT_PUBLIC_SIDEBAR_BUTTON_URL" 
                                                       placeholder="https://www.chatrag.ai/" 
                                                       class="input input-bordered w-full">
                                                <div class="text-sm text-base-content/70 mt-2">
                                                    The URL that the sidebar button will link to. Opens in a new tab.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Favicon Configuration -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">Favicon & Site Title</h3>
                                        <p class="text-base-content/70 mb-4">Configure the browser favicon and site title that appears in browser tabs.</p>
                                        
                                        <div class="space-y-4">
                                            <!-- Site Title -->
                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Browser Title</span>
                                                </label>
                                                <input type="text" id="NEXT_PUBLIC_SITE_TITLE" 
                                                       placeholder="ChatRAG - AI Assistant" 
                                                       class="input input-bordered w-full">
                                                <div class="text-sm text-base-content/70 mt-2">
                                                    This title appears in the browser tab. If left empty, it will use the Application Name.
                                                </div>
                                            </div>

                                            <!-- Favicon Upload -->
                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Favicon</span>
                                                </label>
                                                <div class="flex gap-2 items-center">
                                                    <input type="file" id="faviconFile" accept=".ico,.png,.svg" 
                                                           class="file-input file-input-bordered flex-1">
                                                    <div id="faviconPreview" class="w-8 h-8 border rounded flex items-center justify-center">
                                                        <img src="/favicon.svg" alt="Current favicon" class="w-6 h-6">
                                                    </div>
                                                </div>
                                                <div class="text-sm text-base-content/70 mt-2">
                                                    Upload a .ico, .png, or .svg file. Recommended size: 32x32px or 16x16px for .ico files.
                                                </div>
                                            </div>

                                            <!-- Current Favicon URL (hidden, for storing) -->
                                            <input type="hidden" id="NEXT_PUBLIC_FAVICON_URL" value="/favicon.svg">
                                        </div>
                                    </div>
                                </div>

                                <!-- Welcome Text Customization -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">Welcome Text Customization</h3>
                                        <p class="text-base-content/70 mb-4">Manage dynamic welcome messages that rotate on each page refresh.</p>
                                        
                                        <!-- Hidden inputs for config values -->
                                        <input type="hidden" id="NEXT_PUBLIC_WELCOME_TEXT_MODE" value="">
                                        <input type="hidden" id="NEXT_PUBLIC_WELCOME_TEXT_TRANSLATIONS" value="{}">
                                        <input type="hidden" id="NEXT_PUBLIC_WELCOME_MESSAGES" value="[]">
                                        <input type="hidden" id="NEXT_PUBLIC_WELCOME_MESSAGES_TRANSLATIONS" value="{}">
                                        
                                        <div class="space-y-4">
                                            <!-- Mode Selector -->
                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Welcome Text Mode</span>
                                                </label>
                                                <select id="welcomeTextModeSelect" class="select select-bordered">
                                                    <option value="custom" selected>Custom Single Message</option>
                                                    <option value="dynamic">Dynamic Messages (Rotating)</option>
                                                </select>
                                            </div>
                                            
                                            <!-- Manual Username Override (for dynamic mode) -->
                                            <div class="form-control" id="manualUsernameSection" style="display: none;">
                                                <label class="label">
                                                    <span class="label-text">Manual Username Override</span>
                                                    <span class="label-text-alt">
                                                        <span class="text-xs text-info">Optional</span>
                                                    </span>
                                                </label>
                                                <input type="text" id="NEXT_PUBLIC_MANUAL_USERNAME" 
                                                       placeholder="e.g., John (leave empty for automatic extraction)" 
                                                       class="input input-bordered w-full">
                                                <div class="text-sm text-base-content/70 mt-2">
                                                    Override the automatically extracted username from email. This name will replace {Username} in welcome messages.
                                                </div>
                                            </div>
                                            
                                            <!-- Single Welcome Text Input (for custom mode) -->
                                            <div class="form-control" id="singleWelcomeTextSection" style="display: none;">
                                                <label class="label">
                                                    <span class="label-text">Welcome Message</span>
                                                    <span id="welcomeTextModeIndicator" class="badge badge-sm badge-primary">Default</span>
                                                </label>
                                                <input type="text" id="NEXT_PUBLIC_WELCOME_TEXT" 
                                                       placeholder="What can I help with?"
                                                       value="What can I help with?"
                                                       class="input input-bordered w-full">
                                                <div class="text-sm text-base-content/70 mt-2">
                                                    This text appears when users first open the chat.
                                                </div>
                                            </div>
                                            
                                            <!-- Dynamic Messages Section (for dynamic mode) -->
                                            <div class="form-control" id="dynamicMessagesSection">
                                                <label class="label">
                                                    <span class="label-text">Welcome Messages</span>
                                                    <span class="badge badge-sm badge-info" id="messagesCountBadge">10 messages</span>
                                                </label>
                                                
                                                <!-- Messages List -->
                                                <div class="max-h-64 overflow-y-auto border border-base-300 rounded-lg p-2 space-y-2" id="welcomeMessagesList">
                                                    <!-- Messages will be dynamically added here -->
                                                </div>
                                                
                                                <!-- Add New Message -->
                                                <div class="flex gap-2 mt-2">
                                                    <input type="text" id="newWelcomeMessageInput" 
                                                        placeholder="Add new message (use {Username} for name)..." 
                                                        class="input input-bordered flex-1 w-full">
                                                    <button id="addWelcomeMessageBtn" class="btn btn-primary">Add</button>
                                                </div>
                                                
                                                <div class="text-sm text-base-content/70 mt-2">
                                                    Use {Username} to include the user's name. Messages rotate randomly on each page refresh.
                                                </div>
                                            </div>
                                            
                                            <!-- Action Buttons -->
                                            <div class="flex gap-2 flex-wrap">
                                                <button id="resetWelcomeMessagesBtn" class="btn btn-sm btn-outline">
                                                    Reset to Defaults
                                                </button>
                                                <button id="generateWelcomeMessagesBtn" class="btn btn-sm btn-success">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1">
                                                        <path d="M12 2v10m0 0l4-4m-4 4l-4-4"></path>
                                                        <path d="M3 12a9 9 0 0 0 9 9 9 9 0 0 0 9-9"></path>
                                                    </svg>
                                                    Generate New
                                                </button>
                                                <button id="translateWelcomeMessagesBtn" class="btn btn-sm btn-primary">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1">
                                                        <path d="m5 8 6 6"></path>
                                                        <path d="m4 14 6-6 2-3"></path>
                                                        <path d="M2 5h12"></path>
                                                        <path d="M7 2v3"></path>
                                                        <path d="m22 22-5-10-5 10"></path>
                                                        <path d="m14 18 6 0"></path>
                                                    </svg>
                                                    Translate All
                                                </button>
                                            </div>
                                            
                                            <!-- Status Messages -->
                                            <div id="welcomeMessagesStatus" class="hidden">
                                                <div class="alert" id="welcomeMessagesStatusAlert">
                                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                    </svg>
                                                    <span id="welcomeMessagesStatusText">Processing...</span>
                                                </div>
                                            </div>
                                            
                                            <!-- Gradient Style Selection -->
                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Gradient Style</span>
                                                </label>
                                                <select id="NEXT_PUBLIC_WELCOME_TEXT_GRADIENT" class="select select-bordered w-full">
                                                    <option value="none">Default (No Gradient)</option>
                                                    <option value="sunset">Sunset - Warm orange to pink</option>
                                                    <option value="ocean">Ocean - Deep blue to purple</option>
                                                    <option value="aurora">Aurora - Mystical multi-color</option>
                                                    <option value="neon">Neon - Bright cyan to magenta</option>
                                                    <option value="solar">Solar - Golden yellow to red</option>
                                                    <option value="chatbuttons">Chat Buttons - Blue, yellow, orange, red, purple</option>
                                                </select>
                                                <div class="text-sm text-base-content/70 mt-2">
                                                    Choose a gradient that works well in both light and dark modes.
                                                </div>
                                            </div>
                                            
                                            <!-- Live Preview -->
                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Preview</span>
                                                    <button id="refreshPreviewBtn" class="btn btn-xs btn-ghost">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                            <path d="M21 2v6h-6"></path>
                                                            <path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path>
                                                            <path d="M3 22v-6h6"></path>
                                                            <path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path>
                                                        </svg>
                                                        Refresh
                                                    </button>
                                                </label>
                                                <div class="card bg-base-100 border-2 border-base-300">
                                                    <div class="card-body flex items-center justify-center py-8">
                                                        <h1 id="welcomeTextPreview" class="text-2xl lg:text-4xl font-semibold text-gray-700 dark:text-gray-200 text-center">
                                                            What can I help with?
                                                        </h1>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- AI Response Logo -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">AI Response Logo</h3>
                                        <p class="text-base-content/70 mb-4">Configure the icon displayed next to AI responses in chat.</p>
                                        
                                        <div class="space-y-4">
                                            <!-- Logo Type Selection -->
                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Logo Selection</span>
                                                </label>
                                                <input type="hidden" id="NEXT_PUBLIC_AI_LOGO_TYPE" value="chat-bubble">
                                                <input type="hidden" id="NEXT_PUBLIC_AI_RESPONSE_LOGO_URL" value="">
                                                
                                                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                                    <!-- Chat Bubble Option -->
                                                    <label class="cursor-pointer">
                                                        <input type="radio" name="aiLogoType" value="chat-bubble" class="sr-only peer" checked>
                                                        <div class="border-2 border-base-300 rounded-lg p-4 peer-checked:border-primary peer-checked:bg-primary/10 transition-all hover:border-primary/50 hover:bg-base-200">
                                                            <div class="flex flex-col items-center gap-2">
                                                                <div class="w-12 h-12 text-base-content">
                                                                    <img src="/logos/defaults/chat-bubble.svg" alt="Chat Bubble" class="w-full h-full filter grayscale(100%) brightness(0) dark:brightness-100 dark:invert">
                                                                </div>
                                                                <span class="text-sm font-medium">Chat Bubble</span>
                                                            </div>
                                                        </div>
                                                    </label>
                                                    
                                                    <!-- Robot Option -->
                                                    <label class="cursor-pointer">
                                                        <input type="radio" name="aiLogoType" value="robot" class="sr-only peer">
                                                        <div class="border-2 border-base-300 rounded-lg p-4 peer-checked:border-primary peer-checked:bg-primary/10 transition-all hover:border-primary/50 hover:bg-base-200">
                                                            <div class="flex flex-col items-center gap-2">
                                                                <div class="w-12 h-12 text-base-content">
                                                                    <img src="/logos/defaults/robot.svg" alt="Robot" class="w-full h-full filter grayscale(100%) brightness(0) dark:brightness-100 dark:invert">
                                                                </div>
                                                                <span class="text-sm font-medium">Robot</span>
                                                            </div>
                                                        </div>
                                                    </label>
                                                    
                                                    <!-- Brain Option -->
                                                    <label class="cursor-pointer">
                                                        <input type="radio" name="aiLogoType" value="brain" class="sr-only peer">
                                                        <div class="border-2 border-base-300 rounded-lg p-4 peer-checked:border-primary peer-checked:bg-primary/10 transition-all hover:border-primary/50 hover:bg-base-200">
                                                            <div class="flex flex-col items-center gap-2">
                                                                <div class="w-12 h-12 text-base-content">
                                                                    <img src="/logos/defaults/brain.svg" alt="Brain" class="w-full h-full filter grayscale(100%) brightness(0) dark:brightness-100 dark:invert">
                                                                </div>
                                                                <span class="text-sm font-medium">Brain</span>
                                                            </div>
                                                        </div>
                                                    </label>
                                                    
                                                    <!-- Sparkle Option -->
                                                    <label class="cursor-pointer">
                                                        <input type="radio" name="aiLogoType" value="sparkle" class="sr-only peer">
                                                        <div class="border-2 border-base-300 rounded-lg p-4 peer-checked:border-primary peer-checked:bg-primary/10 transition-all hover:border-primary/50 hover:bg-base-200">
                                                            <div class="flex flex-col items-center gap-2">
                                                                <div class="w-12 h-12 text-base-content">
                                                                    <img src="/logos/defaults/sparkle.svg" alt="Sparkle" class="w-full h-full filter grayscale(100%) brightness(0) dark:brightness-100 dark:invert">
                                                                </div>
                                                                <span class="text-sm font-medium">Sparkle</span>
                                                            </div>
                                                        </div>
                                                    </label>
                                                    
                                                    <!-- Custom Option -->
                                                    <label class="cursor-pointer">
                                                        <input type="radio" name="aiLogoType" value="custom" class="sr-only peer">
                                                        <div class="border-2 border-base-300 rounded-lg p-4 peer-checked:border-primary peer-checked:bg-primary/10 transition-all hover:border-primary/50 hover:bg-base-200">
                                                            <div class="flex flex-col items-center gap-2">
                                                                <div class="w-12 h-12 flex items-center justify-center text-base-content/50">
                                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8">
                                                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                                                        <line x1="12" y1="8" x2="12" y2="16"></line>
                                                                        <line x1="8" y1="12" x2="16" y2="12"></line>
                                                                    </svg>
                                                                </div>
                                                                <span class="text-sm font-medium">Custom</span>
                                                            </div>
                                                        </div>
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <!-- Custom Logo Upload (shown only when custom is selected) -->
                                            <div class="form-control hidden" id="customAiLogoGroup">
                                                <label class="label">
                                                    <span class="label-text">Custom Logo</span>
                                                </label>
                                                <div class="flex gap-2">
                                                    <input type="url" id="customAiLogoUrl" 
                                                           placeholder="https://example.com/ai-logo.svg" 
                                                           class="input input-bordered flex-1 w-full">
                                                    <div class="divider divider-horizontal">OR</div>
                                                    <input type="file" id="aiLogoFile" accept=".svg,.png" 
                                                           class="file-input file-input-bordered">
                                                </div>
                                                <div class="text-sm text-base-content/70 mt-2">
                                                    For best results, use an SVG file. PNG files should be square and at least 40x40px in size.
                                                </div>
                                            </div>

                                            <!-- Hidden checkbox for backward compatibility -->
                                            <input type="checkbox" id="NEXT_PUBLIC_USE_DEFAULT_AI_LOGO" class="hidden">

                                            <div class="form-control">
                                                <label class="cursor-pointer label">
                                                    <span class="label-text">Show Border Around AI Logo</span>
                                                    <input type="checkbox" id="NEXT_PUBLIC_AI_RESPONSE_LOGO_BORDER" class="toggle toggle-primary" checked>
                                                </label>
                                                <div class="text-sm text-base-content/70 mt-2">
                                                    When enabled, a thin border will appear around the AI logo in chat messages.
                                                </div>
                                            </div>

                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">AI Logo Size</span>
                                                </label>
                                                <div class="w-full">
                                                    <input type="range" 
                                                           min="1" 
                                                           max="5" 
                                                           step="1" 
                                                           value="3"
                                                           id="NEXT_PUBLIC_AI_RESPONSE_LOGO_SIZE" 
                                                           class="range range-primary">
                                                    <div class="w-full flex justify-between text-xs px-2 mt-2">
                                                        <span>XS</span>
                                                        <span>S</span>
                                                        <span>M</span>
                                                        <span>L</span>
                                                        <span>XL</span>
                                                    </div>
                                                </div>
                                                <div class="text-sm text-base-content/70 mt-2">
                                                    Adjust the size of the AI logo in chat messages.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Chat Interface Settings -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">Chat Interface Settings</h3>
                                        <p class="text-base-content/70 mb-4">Customize the appearance and behavior of the chat interface.</p>
                                        
                                        <div class="space-y-4">
                                            <!-- Chat Input Text Size -->
                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Chat Input Text Size</span>
                                                    <span class="text-sm text-base-content/60" id="chatInputTextSizeValue">18px</span>
                                                </label>
                                                <div class="w-full">
                                                    <input type="range" 
                                                           min="14" 
                                                           max="24" 
                                                           step="1" 
                                                           value="18"
                                                           id="NEXT_PUBLIC_CHAT_INPUT_TEXT_SIZE" 
                                                           class="range range-primary">
                                                    <div class="w-full flex justify-between text-xs px-2 mt-2">
                                                        <span>14px</span>
                                                        <span>16px</span>
                                                        <span>18px</span>
                                                        <span>20px</span>
                                                        <span>22px</span>
                                                        <span>24px</span>
                                                    </div>
                                                </div>
                                                <div class="text-sm text-base-content/70 mt-2">
                                                    Adjust the text size in the chat input field for better readability. Default is 18px.
                                                </div>
                                                
                                                <!-- Live Preview -->
                                                <div class="mt-4 p-4 border border-base-300 rounded-lg bg-base-100">
                                                    <label class="text-xs text-base-content/60 mb-2 block">Preview:</label>
                                                    <div class="relative">
                                                        <textarea 
                                                            id="chatInputPreview"
                                                            placeholder="Ask anything..."
                                                            class="w-full resize-none bg-transparent px-3 py-2 border border-base-300 rounded-lg focus:outline-none focus:border-primary"
                                                            style="font-size: 18px; line-height: 1.5;"
                                                            rows="2"
                                                            readonly>This is how your chat input text will look.</textarea>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Saved Chats Tab -->
                    <div class="tab-content" id="saved-chats">
                        <div class="card bg-base-100 shadow-lg">
                            <div class="card-body p-4 lg:p-6">
                                <h2 class="card-title text-xl lg:text-2xl text-chatrag-primary mb-6">üíæ Saved Chats Configuration</h2>
                                <p class="text-base-content/70 mb-6">Configure how chat titles are generated using AI for better organization and searchability.</p>
                                
                                <!-- Title Generation Model -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">Title Generation Model</h3>
                                        <p class="text-base-content/70 mb-6">Choose the AI model used to generate descriptive titles for saved chats.</p>
                                        
                                        <div class="space-y-4">
                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">AI Model for Title Generation</span>
                                                </label>
                                                <select id="CHAT_TITLE_MODEL" class="select select-bordered w-full">
                                                    <option value="openai/gpt-5-nano">GPT-5 Nano (Fast & Efficient)</option>
                                                    <option value="openai/gpt-5-mini">GPT-5 Mini (Balanced)</option>
                                                    <option value="openai/gpt-5">GPT-5 (Most Capable)</option>
                                                    <option value="anthropic/claude-3.7-haiku">Claude 3.7 Haiku (Fast)</option>
                                                    <option value="anthropic/claude-3.7-sonnet">Claude 3.7 Sonnet (Balanced)</option>
                                                    <option value="google/gemini-2.5-flash">Gemini 2.5 Flash (Fast)</option>
                                                    <option value="deepseek/deepseek-chat-v3-0324:free">DeepSeek Chat V3 (Free)</option>
                                                </select>
                                                <div class="text-sm text-base-content/70 mt-2">
                                                    Smaller models like GPT-5 Nano are recommended for fast and cost-effective title generation.
                                                </div>
                                            </div>

                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Temperature</span>
                                                    <span class="label-text-alt text-base-content/70" id="chat-title-temperature-value">0.3</span>
                                                </label>
                                                <input type="range" 
                                                       id="CHAT_TITLE_TEMPERATURE" 
                                                       min="0" 
                                                       max="1" 
                                                       step="0.1" 
                                                       value="0.3"
                                                       class="range range-primary"
                                                       oninput="document.getElementById('chat-title-temperature-value').textContent = this.value">
                                                <div class="text-sm text-base-content/70 mt-2">
                                                    Lower values (0.0-0.3) produce more focused and consistent titles. Higher values create more creative variations.
                                                </div>
                                            </div>

                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Max Tokens</span>
                                                </label>
                                                <input type="number" 
                                                       id="CHAT_TITLE_MAX_TOKENS" 
                                                       min="10" 
                                                       max="100"
                                                       value="50"
                                                       class="input input-bordered w-full">
                                                <div class="text-sm text-base-content/70 mt-2">
                                                    Maximum number of tokens for the generated title. Optimal range is 40-60 for descriptive titles.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Advanced Title Generation Settings -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">Advanced Title Generation</h3>
                                        <p class="text-base-content/70 mb-6">Enhanced features for better title generation across different content types.</p>

                                        <div class="space-y-4">
                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Multimodal Model (for image analysis)</span>
                                                </label>
                                                <select id="CHAT_TITLE_MULTIMODAL_MODEL" class="select select-bordered w-full">
                                                    <option value="openai/gpt-4o">GPT-4o Vision (Best)</option>
                                                    <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Vision</option>
                                                    <option value="google/gemini-pro-vision">Gemini Pro Vision</option>
                                                </select>
                                                <div class="text-sm text-base-content/70 mt-2">
                                                    Used to analyze images when generating titles for image-based conversations.
                                                </div>
                                            </div>

                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Multimodal Max Tokens</span>
                                                </label>
                                                <input type="number"
                                                       id="CHAT_TITLE_MULTIMODAL_TOKENS"
                                                       min="50"
                                                       max="150"
                                                       value="75"
                                                       class="input input-bordered w-full">
                                                <div class="text-sm text-base-content/70 mt-2">
                                                    Token limit for multimodal title generation (image analysis requires more tokens).
                                                </div>
                                            </div>

                                            <div class="form-control">
                                                <label class="cursor-pointer label justify-start gap-3">
                                                    <span class="label-text">Enable Vision Analysis</span>
                                                    <input type="checkbox" id="CHAT_TITLE_ENABLE_VISION" class="toggle toggle-primary" checked>
                                                </label>
                                                <div class="text-sm text-base-content/70 mt-2">
                                                    Analyze images to create more descriptive titles for image-based workflows.
                                                </div>
                                            </div>

                                            <div class="form-control">
                                                <label class="cursor-pointer label justify-start gap-3">
                                                    <span class="label-text">Use Specialized Handlers</span>
                                                    <input type="checkbox" id="CHAT_TITLE_SPECIALIZED_HANDLERS" class="toggle toggle-primary" checked>
                                                </label>
                                                <div class="text-sm text-base-content/70 mt-2">
                                                    Enable content-specific title generation for images, videos, and 3D models.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Title Generation Stats -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">Title Generation Information</h3>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <p class="text-sm text-base-content/70 mb-2">How it works:</p>
                                                <ul class="text-sm text-base-content/70 space-y-1 list-disc list-inside">
                                                    <li>AI analyzes the conversation context</li>
                                                    <li>Generates descriptive, context-aware titles</li>
                                                    <li>Supports multimodal content analysis</li>
                                                    <li>Specialized handlers for creative content</li>
                                                    <li>Updates asynchronously with smart fallbacks</li>
                                                </ul>
                                            </div>
                                            <div>
                                                <p class="text-sm text-base-content/70 mb-2">Best practices:</p>
                                                <ul class="text-sm text-base-content/70 space-y-1 list-disc list-inside">
                                                    <li>Use fast models to minimize latency</li>
                                                    <li>Use vision models for image content</li>
                                                    <li>Enable specialized handlers for accuracy</li>
                                                    <li>Balance tokens for detail vs brevity</li>
                                                    <li>Consider costs for high-volume usage</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Suggestions Tab -->
                    <div class="tab-content" id="suggestions">
                        <div class="card bg-base-100 shadow-lg">
                            <div class="card-body p-4 lg:p-6">
                                <h2 class="card-title text-xl lg:text-2xl text-chatrag-primary mb-6">üí° Suggestion Customization</h2>
                                <p class="text-base-content/70 mb-6">Customize the suggestion buttons that help users start conversations.</p>
                                

                                <!-- Enable/Disable Suggestions -->
                                <div class="card bg-base-200 shadow-md mb-8">
                                    <div class="card-body">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <h3 class="font-semibold text-lg">Enable Suggestions</h3>
                                                <p class="text-base-content/70 text-sm mt-1">Show suggestion buttons to help users start conversations.</p>
                                            </div>
                                            <input type="checkbox" id="NEXT_PUBLIC_SHOW_SUGGESTIONS" class="toggle toggle-primary">
                                        </div>
                                    </div>
                                </div>

                                <!-- Translation Controls -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="font-semibold text-lg mb-4">AI Translation</h3>
                                        <p class="text-base-content/70 text-sm mb-4">Translate all suggestion groups and items to any language using AI.</p>
                                        
                                        <div class="flex flex-col gap-4">
                                            <!-- Language Input -->
                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Target Language</span>
                                                </label>
                                                <input type="text" 
                                                       id="translationTargetLanguage" 
                                                       placeholder="e.g., Spanish, French, Japanese, etc."
                                                       class="input input-bordered w-full"
                                                       list="commonLanguages">
                                                <datalist id="commonLanguages">
                                                    <option value="Spanish">
                                                    <option value="French">
                                                    <option value="German">
                                                    <option value="Italian">
                                                    <option value="Portuguese">
                                                    <option value="Japanese">
                                                    <option value="Korean">
                                                    <option value="Chinese (Simplified)">
                                                    <option value="Chinese (Traditional)">
                                                    <option value="Arabic">
                                                    <option value="Russian">
                                                    <option value="Hindi">
                                                    <option value="Dutch">
                                                    <option value="Swedish">
                                                    <option value="Norwegian">
                                                </datalist>
                                            </div>
                                            
                                            <!-- Provider Selection -->
                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">AI Provider</span>
                                                </label>
                                                <select id="translationProvider" class="select select-bordered w-full">
                                                    <option value="openai" selected>OpenAI</option>
                                                    <option value="openrouter">OpenRouter</option>
                                                </select>
                                            </div>
                                            
                                            <!-- Action Buttons -->
                                            <div class="flex gap-2 flex-wrap">
                                                <button id="translateAllBtn" class="btn btn-primary flex-1">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                                                        <path d="m5 8 6 6"></path>
                                                        <path d="m4 14 6-6 2-3"></path>
                                                        <path d="M2 5h12"></path>
                                                        <path d="M7 2v3"></path>
                                                        <path d="m22 22-5-10-5 10"></path>
                                                        <path d="m14 18 6 0"></path>
                                                    </svg>
                                                    Translate All
                                                </button>
                                                <button id="setAsDefaultBtn" class="btn btn-outline btn-info flex-1" disabled>
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                                                        <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"></path>
                                                        <path d="m9 12 2 2 4-4"></path>
                                                    </svg>
                                                    Set as Default
                                                </button>
                                                <button id="revertTranslationBtn" class="btn btn-outline btn-secondary flex-1" disabled>
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                                                        <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                                                        <path d="M3 3v5h5"></path>
                                                    </svg>
                                                    <span id="revertBtnText">Revert to Original</span>
                                                </button>
                                            </div>
                                            
                                            <!-- Default Language Display -->
                                            <div id="defaultLanguageInfo" class="text-sm text-base-content/70">
                                                Default language: <span id="defaultLanguageText" class="font-semibold">English</span>
                                            </div>
                                            
                                            <!-- Translation Status -->
                                            <div id="translationStatus" class="hidden">
                                                <div class="alert alert-info">
                                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                                    <span id="translationStatusText">Ready to translate</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Suggestion Groups Management -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="font-semibold text-lg mb-6">Suggestion Groups</h3>
                                        
                                        <div id="suggestionGroupsList" class="space-y-4">
                                            <!-- Groups will be dynamically populated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Embed Widget Tab -->
                    <div class="tab-content" id="embed">
                        <div class="card bg-base-100 shadow-lg">
                            <div class="card-body">
                                <h2 class="card-title text-2xl text-chatrag-primary mb-6">üí¨ Embed Widget Configuration</h2>
                                
                                <!-- Enable Embed Widget -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="text-lg font-semibold">Enable Embed Widget</h3>
                                            <input type="checkbox" id="NEXT_PUBLIC_EMBED_ENABLED" class="toggle toggle-primary">
                                        </div>
                                        <p class="text-base-content/70">Enable the chat widget to be embedded on external websites. When disabled, embed endpoints will return an error.</p>
                                    </div>
                                </div>
                                
                                <!-- Widget Appearance -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">Widget Appearance</h3>
                                        <p class="text-base-content/70 mb-6">Configure how your chat widget appears when embedded on external websites.</p>
                                        
                                        <div class="space-y-4">
                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Widget Title</span>
                                                </label>
                                                <input type="text" id="NEXT_PUBLIC_EMBED_TITLE" 
                                                       placeholder="ChatRAG Assistant" 
                                                       class="input input-bordered w-full">
                                                <div class="text-sm text-base-content/70 mt-2">
                                                    The title displayed in the chat widget header.
                                                </div>
                                            </div>
                                            
                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Primary Color</span>
                                                </label>
                                                <input type="color" id="NEXT_PUBLIC_EMBED_PRIMARY_COLOR" 
                                                       value="#FF6417" 
                                                       class="input input-bordered w-full h-12">
                                                <div class="text-sm text-base-content/70 mt-2">
                                                    The primary color used for the chat button and interface elements.
                                                </div>
                                            </div>

                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Button Position</span>
                                                </label>
                                                <select id="NEXT_PUBLIC_EMBED_POSITION" class="select select-bordered w-full">
                                                    <option value="bottom-right">Bottom Right</option>
                                                    <option value="bottom-left">Bottom Left</option>
                                                    <option value="top-right">Top Right</option>
                                                    <option value="top-left">Top Left</option>
                                                </select>
                                                <div class="text-sm text-base-content/70 mt-2">
                                                    Where the chat button appears on the host website.
                                                </div>
                                            </div>

                                            <div class="form-control">
                                                <label class="cursor-pointer label">
                                                    <span class="label-text">Auto-Open Chat</span>
                                                    <input type="checkbox" id="NEXT_PUBLIC_EMBED_AUTO_OPEN" class="toggle toggle-primary">
                                                </label>
                                                <div class="text-sm text-base-content/70 mt-2">
                                                    When enabled, the chat window will open automatically after a few seconds instead of waiting for user interaction.
                                                </div>
                                            </div>

                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Welcome Message</span>
                                                </label>
                                                <input type="text" id="NEXT_PUBLIC_EMBED_GREETING" 
                                                       placeholder="Hello! Development help you today?" 
                                                       class="input input-bordered w-full">
                                                <div class="text-sm text-base-content/70 mt-2">
                                                    The initial greeting message shown when the chat opens.
                                                </div>
                                            </div>

                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">AI Model for Embed Widget</span>
                                                    <span class="label-text-alt text-warning">Separate from main app</span>
                                                </label>
                                                <select id="NEXT_PUBLIC_EMBED_MODEL" class="select select-bordered w-full">
                                                    <option value="openai/gpt-4o-mini">GPT-4o Mini (Recommended)</option>
                                                    <option value="openai/gpt-5">GPT-5 (Most Capable)</option>
                                                    <option value="openai/gpt-5-mini">GPT-5 Mini (Faster, Lower Cost)</option>
                                                    <option value="anthropic/claude-3.7-sonnet">Claude 3.7 Sonnet</option>
                                                    <option value="google/gemini-2.5-pro-preview">Gemini 2.5 Pro</option>
                                                    <option value="deepseek/deepseek-chat-v3-0324:free">DeepSeek Chat V3 (Free)</option>
                                                </select>
                                                <div class="text-sm text-base-content/70 mt-2">
                                                    The AI model to use for the embedded chat widget. This is separate from your main ChatRAG model, allowing you to optimize costs (e.g., use GPT-5 for main app, GPT-5 Mini for widget).
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Security & Access Control -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">Security & Access Control</h3>
                                        <p class="text-base-content/70 mb-6">Control which websites can embed your chat widget and usage limits.</p>
                                        
                                        <div class="space-y-4">
                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Allowed Domains</span>
                                                </label>
                                                <input type="text" id="NEXT_PUBLIC_EMBED_ALLOWED_DOMAINS" 
                                                       placeholder="example.com,*.mysite.com,localhost" 
                                                       class="input input-bordered w-full">
                                                <div class="text-sm text-base-content/70 mt-2">
                                                    Comma-separated list of domains that can embed the widget. Use * for wildcards or leave empty to allow all domains.
                                                </div>
                                            </div>
                                            
                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Rate Limit (requests per hour)</span>
                                                </label>
                                                <input type="number" id="EMBED_RATE_LIMIT" 
                                                       placeholder="100" 
                                                       min="1" max="10000" 
                                                       class="input input-bordered w-full">
                                                <div class="text-sm text-base-content/70 mt-2">
                                                    Maximum number of chat requests per hour from embedded widgets.
                                                </div>
                                            </div>

                                            <div class="form-control">
                                                <label class="cursor-pointer label">
                                                    <span class="label-text">Require Authentication</span>
                                                    <input type="checkbox" id="EMBED_REQUIRE_AUTH" class="toggle toggle-primary">
                                                </label>
                                                <div class="text-sm text-base-content/70 mt-2">
                                                    When enabled, users must authenticate before using the embedded chat widget.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Suggestion Pills Configuration -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">üí° Suggestion Prompts</h3>
                                        <p class="text-base-content/70 mb-6">Configure quick-start suggestion prompts that appear in the embedded chat widget to help users get started.</p>
                                        
                                        <div class="space-y-4">
                                            <!-- Enable/Disable Suggestions Toggle -->
                                            <div class="form-control">
                                                <label class="cursor-pointer label">
                                                    <span class="label-text">Enable Suggestion Prompts</span>
                                                    <input type="checkbox" id="NEXT_PUBLIC_EMBED_SUGGESTIONS_ENABLED" class="toggle toggle-primary">
                                                </label>
                                                <div class="text-sm text-base-content/70 mt-2">
                                                    When enabled, users will see clickable suggestion pills below the chat messages to quickly start conversations.
                                                </div>
                                            </div>
                                            
                                            <!-- Suggestions List -->
                                            <div id="embed-suggestions-container" class="space-y-3">
                                                <label class="label">
                                                    <span class="label-text font-semibold">Suggestion Prompts</span>
                                                    <button id="add-embed-suggestion-btn" class="btn btn-sm btn-primary" onclick="addEmbedSuggestion()">
                                                        ‚ûï Add Suggestion
                                                    </button>
                                                </label>
                                                <div id="embed-suggestions-list" class="space-y-2">
                                                    <!-- Suggestion items will be dynamically added here -->
                                                </div>
                                            </div>
                                            
                                            <div class="text-sm text-base-content/70">
                                                üí° <strong>Tip:</strong> Keep suggestions short and action-oriented. Examples: "Get started", "View pricing", "Contact support".
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Embed Code -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">Embed Code</h3>
                                        <p class="text-base-content/70 mb-6">Copy this code and paste it into any website where you want the chat widget to appear.</p>
                                        
                                        <!-- Script Tag -->
                                        <div class="mb-6">
                                            <label class="label">
                                                <span class="label-text font-semibold">Script Tag (Recommended)</span>
                                            </label>
                                            <div class="mockup-code">
                                                <pre id="embedScriptCode"><code>&lt;script src="https://your-domain.com/embed/chat.js"&gt;&lt;/script&gt;</code></pre>
                                            </div>
                                            <button id="copyScriptBtn" class="btn btn-outline btn-sm mt-2">
                                                üìã Copy Script
                                            </button>
                                            <div class="text-sm text-base-content/70 mt-2">
                                                Creates a floating chat button in the corner of your website. Clicking opens a chat popup.
                                                <br>Works on any website including WordPress, Shopify, etc.
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Live Preview -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">Live Preview</h3>
                                        <p class="text-base-content/70 mb-4">Preview how your embed widget will look and behave. Click the chat button to open the widget.</p>
                                        
                                        <div class="border-2 border-dashed border-base-300 rounded-lg p-5 bg-base-100 relative overflow-hidden" style="height: 600px;">
                                            <div class="text-center text-base-content/50 mt-32">
                                                <div class="text-6xl mb-4">üñ•Ô∏è</div>
                                                <p class="text-lg font-medium mb-2">Your website content would appear here</p>
                                                <p class="text-sm">The chat button will appear in the selected position</p>
                                            </div>
                                            
                                            <!-- Chat Button Preview -->
                                            <button 
                                                id="embedPreviewButton" 
                                                onclick="toggleInlineChat()"
                                                onmouseover="this.style.transform='scale(1.1)'"
                                                onmouseout="this.style.transform='scale(1)'"
                                                style="
                                                    position: absolute; 
                                                    bottom: 20px; 
                                                    right: 20px; 
                                                    width: 60px; 
                                                    height: 60px; 
                                                    border-radius: 50%; 
                                                    background: #FF6417; 
                                                    color: white; 
                                                    border: none; 
                                                    font-size: 28px; 
                                                    cursor: pointer; 
                                                    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
                                                    transition: transform 0.2s;
                                                    z-index: 10;
                                                "
                                                class="hover:shadow-xl"
                                            >
                                                üí¨
                                            </button>

                                            <!-- Inline Chat Widget -->
                                            <div id="inlineChatWidget" style="
                                                position: absolute;
                                                bottom: 90px;
                                                right: 20px;
                                                width: 350px;
                                                height: 500px;
                                                background: white;
                                                border-radius: 12px;
                                                box-shadow: 0 8px 32px rgba(0,0,0,0.2);
                                                display: none;
                                                flex-direction: column;
                                                z-index: 20;
                                                overflow: hidden;
                                            ">
                                                <!-- Chat Header -->
                                                <div id="chatHeader" style="
                                                    background: #FF6417;
                                                    color: white;
                                                    padding: 16px;
                                                    display: flex;
                                                    align-items: center;
                                                    justify-content: space-between;
                                                    font-weight: 600;
                                                ">
                                                    <span id="chatTitle">ChatRAG</span>
                                                    <button onclick="toggleInlineChat()" style="
                                                        background: none;
                                                        border: none;
                                                        color: white;
                                                        font-size: 20px;
                                                        cursor: pointer;
                                                        width: 24px;
                                                        height: 24px;
                                                        display: flex;
                                                        align-items: center;
                                                        justify-content: center;
                                                        padding: 0;
                                                    ">√ó</button>
                                                </div>

                                                <!-- Messages Container -->
                                                <div id="chatMessages" style="
                                                flex: 1;
                                                overflow-y: auto;
                                                padding: 16px;
                                                background: #f9f9f9;
                                                ">
                                                <!-- Top group (greeting + suggestions) -->
                                                <div id="preview-top-group" style="
                                                display: flex;
                                                    flex-direction: column;
                                                gap: 8px;
                                                margin-bottom: 8px;
                                                ">
                                                <!-- Initial greeting message -->
                                                <div style="margin-bottom: 0;">
                                                <div style="color: #666; font-size: 12px; margin-bottom: 4px;">Assistant</div>
                                                <div style="
                                                    display: inline-block;
                                                    max-width: 80%;
                                                    padding: 12px 16px;
                                                    border-radius: 18px;
                                                    font-size: 14px;
                                                        line-height: 1.4;
                                                    background: white;
                                                        color: #333;
                                                            border: 1px solid #eee;
                                                                border-bottom-left-radius: 4px;
                                                            ">
                                                                <span id="welcomeMessage">Hello! Development help you today?</span>
                                                            </div>
                                                    </div>

                                                    <!-- Suggestions row wrapper -->
                                                    <div class="preview-suggestions-row" style="
                                                        width: 100%;
                                                        display: flex;
                                                            justify-content: flex-end;
                                                        margin: 4px 0 8px;
                                                        ">
                                                            <div id="preview-suggestions" style="
                                                            width: fit-content;
                                                            max-width: 80%;
                                                            display: none;
                                                            flex-wrap: wrap;
                                                            gap: 8px;
                                                            justify-content: flex-end;
                                                                background: transparent;
                                                            ">
                                                                <!-- Suggestion pills will be dynamically added here -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Chat Input -->
                                                <div style="
                                                    padding: 16px;
                                                    border-top: 1px solid #eee;
                                                    background: white;
                                                ">
                                                    <div style="
                                                        display: flex;
                                                        gap: 8px;
                                                        align-items: flex-end;
                                                    ">
                                                        <textarea 
                                                            id="chatInput" 
                                                            placeholder="Type your message..."
                                                            style="
                                                                flex: 1;
                                                                border: 1px solid #ddd;
                                                                border-radius: 20px;
                                                                padding: 12px 16px;
                                                                resize: none;
                                                                font-family: inherit;
                                                                font-size: 14px;
                                                                max-height: 100px;
                                                                min-height: 40px;
                                                                outline: none;
                                                            "
                                                            rows="1"
                                                            onkeydown="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); sendPreviewMessage(); }"
                                                        ></textarea>
                                                        <button 
                                                            onclick="sendPreviewMessage()"
                                                            style="
                                                                width: 40px;
                                                                height: 40px;
                                                                border-radius: 50%;
                                                                background: #FF6417;
                                                                color: white;
                                                                border: none;
                                                                font-size: 18px;
                                                                cursor: pointer;
                                                                display: flex;
                                                                align-items: center;
                                                                justify-content: center;
                                                                transition: opacity 0.2s;
                                                            "
                                                        >
                                                            ‚Üó
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- WhatsApp Tab -->
                    <div class="tab-content" id="whatsapp">
                        <div class="card bg-base-100 shadow-lg">
                            <div class="card-body p-4 lg:p-6">
                                <h2 class="card-title text-xl lg:text-2xl text-chatrag-primary mb-6">üí¨ WhatsApp Configuration</h2>
                                
                                <!-- Basic Settings -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">Basic Settings</h3>
                                        <p class="text-base-content/70 mb-4">Configure WhatsApp integration with your ChatRAG instance.</p>
                                        
                                        <div class="space-y-4">
                                            <!-- Enable WhatsApp -->
                                            <div class="form-control">
                                                <label class="label cursor-pointer justify-start">
                                                    <input type="checkbox" class="toggle toggle-primary mr-4" id="whatsapp-enabled" data-key="NEXT_PUBLIC_WHATSAPP_ENABLED">
                                                    <div>
                                                        <span class="label-text text-base font-medium">Enable WhatsApp Integration</span>
                                                        <p class="text-sm text-base-content/70 mt-1">Allow users to interact with ChatRAG through WhatsApp</p>
                                                    </div>
                                                </label>
                                            </div>
                                            
                                            <!-- Provider Selection -->
                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">WhatsApp Provider</span>
                                                </label>
                                                <select class="select select-bordered" id="whatsapp-provider" data-key="WHATSAPP_PROVIDER">
                                                    <option value="koyeb">Koyeb</option>
                                                    <option value="flyio">Fly.io</option>
                                                </select>
                                                <label class="label">
                                                    <span class="label-text-alt text-base-content/70">Choose your WhatsApp hosting provider</span>
                                                </label>
                                            </div>
                                            
                                            <!-- Koyeb Configuration -->
                                            <div id="koyeb-config" class="space-y-4">
                                                <div class="form-control">
                                                    <label class="label">
                                                        <span class="label-text">Koyeb Baileys URL</span>
                                                    </label>
                                                    <input type="url" class="input input-bordered" id="koyeb-baileys-url" data-key="KOYEB_BAILEYS_URL" placeholder="https://your-instance.koyeb.app">
                                                    <label class="label">
                                                        <span class="label-text-alt text-base-content/70">Your Koyeb WhatsApp instance URL</span>
                                                    </label>
                                                </div>
                                                
                                                <div class="form-control">
                                                    <label class="label">
                                                        <span class="label-text">Koyeb API Key (Optional)</span>
                                                    </label>
                                                    <div class="flex gap-2">
                                                        <input type="password" class="input input-bordered flex-1 w-full" id="koyeb-api-key" data-key="KOYEB_API_KEY" placeholder="Enter Koyeb API key">
                                                        <button class="btn btn-square btn-outline" data-for="koyeb-api-key">üëÅÔ∏è</button>
                                                    </div>
                                                    <label class="label">
                                                        <span class="label-text-alt text-base-content/70">Optional API key for Koyeb authentication</span>
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <!-- Fly.io Configuration -->
                                            <div id="flyio-config" class="space-y-4 hidden">
                                                <div class="form-control">
                                                    <label class="label">
                                                        <span class="label-text">Fly.io Baileys URL</span>
                                                    </label>
                                                    <input type="url" class="input input-bordered" id="flyio-baileys-url" data-key="FLYIO_BAILEYS_URL" placeholder="https://baileys-chatrag.fly.dev">
                                                    <label class="label">
                                                        <span class="label-text-alt text-base-content/70">Your Fly.io WhatsApp instance URL</span>
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <!-- Common Webhook Configuration -->
                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">
                                                        Webhook Secret
                                                        <span class="tooltip tooltip-right" data-tip="Optional but recommended. Used to verify webhook requests are from your Baileys instance, preventing unauthorized access.">
                                                            <span class="text-info cursor-help ml-1">‚ìò</span>
                                                        </span>
                                                    </span>
                                                </label>
                                                <div class="flex gap-2">
                                                    <input type="password" class="input input-bordered flex-1 w-full" id="whatsapp-webhook-secret" data-key="WHATSAPP_WEBHOOK_SECRET" placeholder="Enter webhook secret (optional but recommended)">
                                                    <button class="btn btn-square btn-outline" data-for="whatsapp-webhook-secret">üëÅÔ∏è</button>
                                                </div>
                                                <label class="label">
                                                    <span class="label-text-alt text-base-content/70">Secret key for webhook authentication - see guide below</span>
                                                </label>
                                            </div>
                                            
                                            <!-- Webhook Secret Generation Guide -->
                                            <details class="collapse collapse-arrow bg-base-100 mb-4">
                                                <summary class="collapse-title text-sm font-medium">üìñ How to Generate a Webhook Secret</summary>
                                                <div class="collapse-content">
                                                    <div class="alert alert-info mb-3">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                        </svg>
                                                        <div>
                                                            <p class="font-semibold">What is a Webhook Secret?</p>
                                                            <p class="text-sm mt-1">A webhook secret is used to verify that incoming webhook requests are legitimate. Your Baileys instance will sign each request with this secret using HMAC-SHA256, and ChatRAG will verify the signature to ensure security.</p>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="space-y-3">
                                                        <div>
                                                            <p class="font-semibold text-sm mb-2">üîß Generation Methods:</p>
                                                            
                                                            <div class="bg-base-200 p-3 rounded-lg mb-2">
                                                                <p class="text-sm font-mono mb-1">Command Line (Recommended):</p>
                                                                <code class="text-xs bg-base-300 px-2 py-1 rounded">openssl rand -hex 32</code>
                                                            </div>
                                                            
                                                            <div class="bg-base-200 p-3 rounded-lg mb-2">
                                                                <p class="text-sm font-mono mb-1">Node.js:</p>
                                                                <code class="text-xs bg-base-300 px-2 py-1 rounded">require('crypto').randomBytes(32).toString('hex')</code>
                                                            </div>
                                                            
                                                            <div class="bg-base-200 p-3 rounded-lg mb-2">
                                                                <p class="text-sm font-mono mb-1">Python:</p>
                                                                <code class="text-xs bg-base-300 px-2 py-1 rounded">import secrets; print(secrets.token_hex(32))</code>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="alert alert-warning">
                                                            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                                            </svg>
                                                            <div>
                                                                <p class="text-sm">‚ö†Ô∏è <strong>Security Note:</strong> Avoid using online generators for production secrets as they may log or store your generated values.</p>
                                                            </div>
                                                        </div>
                                                        
                                                        <div>
                                                            <p class="text-sm mb-1"><strong>Example valid webhook secret:</strong></p>
                                                            <code class="text-xs bg-base-300 px-2 py-1 rounded block break-all">e6cff8cd6752c81bb58718052175c4bfda4a3f7ea5ed13bd208d7473bc6157ab</code>
                                                        </div>
                                                        
                                                        <div class="alert">
                                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-info shrink-0 w-6 h-6">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                            </svg>
                                                            <div>
                                                                <p class="text-sm"><strong>Note:</strong> While optional, using a webhook secret is highly recommended for production environments to prevent unauthorized webhook calls.</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </details>
                                            
                                            <!-- Webhook URL -->
                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Webhook URL</span>
                                                </label>
                                                <input type="url" class="input input-bordered" id="whatsapp-webhook-url" data-key="WHATSAPP_WEBHOOK_URL" placeholder="https://your-domain.com/api/whatsapp/webhook">
                                                <label class="label">
                                                    <span class="label-text-alt text-base-content/70">Your public webhook URL for receiving WhatsApp messages</span>
                                                </label>
                                            </div>
                                            
                                            <!-- Fly.io API Key - moved after webhook config -->
                                            <div id="flyio-api-key-section" class="form-control hidden">
                                                <label class="label">
                                                    <span class="label-text">Fly.io API Key (Optional)</span>
                                                </label>
                                                <div class="flex gap-2">
                                                    <input type="password" class="input input-bordered flex-1 w-full" id="flyio-api-key" data-key="FLYIO_API_KEY" placeholder="Enter Fly.io API key">
                                                    <button class="btn btn-square btn-outline" data-for="flyio-api-key">üëÅÔ∏è</button>
                                                </div>
                                                <label class="label">
                                                    <span class="label-text-alt text-base-content/70">Optional API key for Fly.io authentication</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- AI Behavior Settings -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">AI Behavior</h3>
                                        <p class="text-base-content/70 mb-4">Configure how the AI responds in WhatsApp conversations.</p>
                                        
                                        <!-- Tip about WhatsApp template -->
                                        <div class="alert alert-info mb-4">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                            <span>üí° <strong>Tip:</strong> Use the "WhatsApp Conversational" template in <a href="#" onclick="document.querySelector('[data-tab=&quot;rag-prompt&quot;]').click(); return false;" class="link link-primary">System Prompt</a> settings for optimized mobile responses</span>
                                        </div>
                                        
                                        <div class="space-y-4">
                                            <!-- Enable MCP Tools -->
                                            <div class="form-control">
                                                <label class="label cursor-pointer justify-start">
                                                    <input type="checkbox" class="toggle toggle-primary mr-4" id="whatsapp-enable-mcp" data-key="WHATSAPP_ENABLE_MCP">
                                                    <div>
                                                        <span class="label-text text-base font-medium">Enable MCP Tools</span>
                                                        <p class="text-sm text-base-content/70 mt-1">Allow WhatsApp users to access MCP tools (email, calendar, etc.)</p>
                                                    </div>
                                                </label>
                                            </div>
                                            
                                            <!-- Enable Web Search -->
                                            <div class="form-control">
                                                <label class="label cursor-pointer justify-start">
                                                    <input type="checkbox" class="toggle toggle-primary mr-4" id="whatsapp-enable-web-search" data-key="WHATSAPP_ENABLE_WEB_SEARCH">
                                                    <div>
                                                        <span class="label-text text-base font-medium">Enable Web Search</span>
                                                        <p class="text-sm text-base-content/70 mt-1">Allow WhatsApp users to search the web for current information</p>
                                                    </div>
                                                </label>
                                            </div>
                                            
                                            <!-- Default Model -->
                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Default AI Model</span>
                                                </label>
                                                <select class="select select-bordered" id="whatsapp-default-model" data-key="WHATSAPP_DEFAULT_MODEL">
                                                    <option value="openai/gpt-5">GPT-5</option>
                                                    <option value="openai/gpt-5-mini">GPT-5 Mini</option>
                                                    <option value="anthropic/claude-3.7-sonnet">Claude 3.7 Sonnet</option>
                                                    <option value="google/gemini-2.5-pro-preview">Gemini 2.5 Pro</option>
                                                    <option value="deepseek/deepseek-chat-v3-0324:free">DeepSeek Chat V3</option>
                                                </select>
                                                <label class="label">
                                                    <span class="label-text-alt text-base-content/70">AI model used for WhatsApp conversations</span>
                                                </label>
                                            </div>
                                            
                                            <!-- Max Tokens -->
                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Max Response Tokens</span>
                                                </label>
                                                <input type="number" class="input input-bordered" id="whatsapp-max-tokens" data-key="WHATSAPP_MAX_TOKENS" placeholder="4096" min="256" max="16384">
                                                <label class="label">
                                                    <span class="label-text-alt text-base-content/70">Maximum tokens for AI responses (affects response length)</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Session Management -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">Session Management</h3>
                                        <p class="text-base-content/70 mb-4">Configure WhatsApp session limits and queue settings.</p>
                                        
                                        <div class="space-y-4">
                                            <!-- Max Sessions Per User -->
                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Max Sessions Per User</span>
                                                </label>
                                                <input type="number" class="input input-bordered" id="whatsapp-max-sessions" data-key="WHATSAPP_MAX_SESSIONS_PER_USER" placeholder="1" min="1" max="10">
                                                <label class="label">
                                                    <span class="label-text-alt text-base-content/70">Maximum concurrent WhatsApp sessions per user</span>
                                                </label>
                                            </div>
                                            
                                            <!-- Message Queue Size -->
                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Message Queue Size</span>
                                                </label>
                                                <input type="number" class="input input-bordered" id="whatsapp-queue-size" data-key="WHATSAPP_MESSAGE_QUEUE_SIZE" placeholder="100" min="10" max="1000">
                                                <label class="label">
                                                    <span class="label-text-alt text-base-content/70">Maximum messages in processing queue</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Save Button -->
                                <div class="form-control mt-6">
                                    <button class="btn btn-primary" onclick="saveWhatsAppConfig()">Save WhatsApp Configuration</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- RAG Settings Tab -->
                    <div class="tab-content" id="rag-settings">
                        <div class="card bg-base-100 shadow-lg">
                            <div class="card-body">
                                <h2 class="card-title text-2xl text-chatrag-primary mb-6">üîç RAG Configuration</h2>
                                <p class="text-base-content/70 mb-6">Configure how documents are parsed, chunked, and embedded for retrieval.</p>
                                
                                <!-- RAG Mode Selection -->
                                <div class="card bg-gradient-to-br from-primary/10 to-secondary/10 border-2 border-primary shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">üöÄ Intelligent RAG Configuration</h3>
                                        <p class="text-base-content/70 mb-4">Configure the unified optimized retrieval system. Features can be toggled individually for optimal performance.</p>
                                        
                                        <div class="space-y-6">
                                            <!-- Core RAG Features -->
                                            <div>
                                                <div class="divider">Core RAG Features</div>
                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <!-- Multi-Pass Retrieval -->
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" id="RAG_MULTI_PASS" class="checkbox checkbox-primary" checked>
                                                        <span class="label-text">Multi-Pass Retrieval</span>
                                                    </label>
                                                    
                                                    <!-- Adaptive Retrieval -->
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" id="RAG_ADAPTIVE_RETRIEVAL" class="checkbox checkbox-primary" checked>
                                                        <span class="label-text">Adaptive Multi-Stage Retrieval ‚≠ê</span>
                                                    </label>
                                                    
                                                    <!-- Query Enhancement -->
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" id="RAG_QUERY_ENHANCEMENT" class="checkbox checkbox-primary">
                                                        <span class="label-text">Query Enhancement</span>
                                                    </label>
                                                    
                                                    <!-- Adjacent Chunks -->
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" id="RAG_ADJACENT_CHUNKS" class="checkbox checkbox-primary" checked>
                                                        <span class="label-text">Include Adjacent Chunks</span>
                                                    </label>
                                                    
                                                    <!-- Re-ranking -->
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" id="RAG_RERANKING" class="checkbox checkbox-primary" checked>
                                                        <span class="label-text">Result Re-ranking</span>
                                                    </label>
                                                    
                                                    <!-- Cache Results -->
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" id="RAG_CACHE_ENABLED" class="checkbox checkbox-primary" checked>
                                                        <span class="label-text">Cache Search Results</span>
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <!-- Performance Information -->
                                            <div class="alert alert-info">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                                <div>
                                                    <h4 class="font-semibold">Optimized for Speed & Accuracy</h4>
                                                    <p class="text-sm">This unified RAG system combines the best features for fast (~7-18s) and accurate document retrieval. All features are optimized to work together efficiently.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Temporal Intelligence Configuration -->
                                <div class="card bg-gradient-to-br from-success/10 to-info/10 border-2 border-success shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">‚è∞ Temporal Intelligence</h3>
                                        <p class="text-base-content/70 mb-4">
                                            Enhanced query analysis for temporal data (dates, quarters, years, timelines). 
                                            Intelligently detects and prioritizes time-based information in your documents.
                                            <br><br>
                                            <strong>Particularly effective for:</strong><br>
                                            ‚Ä¢ <strong>Financial documents</strong> (quarterly reports, fiscal years, earnings)<br>
                                            ‚Ä¢ <strong>Legal documents</strong> (case dates, contract terms, deadlines)<br>
                                            ‚Ä¢ <strong>Medical records</strong> (treatment timelines, patient histories)<br>
                                            ‚Ä¢ <strong>Research papers</strong> (publication dates, study periods)<br>
                                            ‚Ä¢ <strong>News articles</strong> (event chronologies, historical context)<br>
                                            ‚Ä¢ <strong>Project documentation</strong> (milestones, release schedules)<br>
                                            ‚Ä¢ <strong>Regulatory compliance</strong> (effective dates, audit trails)
                                        </p>
                                        
                                        <div class="space-y-6">
                                            <!-- Intelligence Features -->
                                            <div>
                                                <div class="divider">Intelligence Features</div>
                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <!-- Temporal Boost -->
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" id="RAG_TEMPORAL_BOOST" class="checkbox checkbox-success" checked>
                                                        <span class="label-text">Temporal Query Boost</span>
                                                    </label>
                                                    
                                                    <!-- Financial/Domain Boost -->
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" id="RAG_FINANCIAL_BOOST" class="checkbox checkbox-success" checked>
                                                        <span class="label-text">Domain-Specific Query Boost</span>
                                                    </label>
                                                    
                                                    <!-- Extract Key Terms -->
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" id="RAG_EXTRACT_KEY_TERMS" class="checkbox checkbox-success" checked>
                                                        <span class="label-text">Extract Key Terms</span>
                                                    </label>
                                                    
                                                    <!-- Semantic Classification -->
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" id="RAG_SEMANTIC_CLASSIFICATION" class="checkbox checkbox-success" checked>
                                                        <span class="label-text">Semantic Content Classification</span>
                                                    </label>
                                                    
                                                    <!-- Fallback to Lower Threshold -->
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" id="RAG_FALLBACK_LOWER_THRESHOLD" class="checkbox checkbox-success" checked>
                                                        <span class="label-text">Fallback to Lower Threshold</span>
                                                    </label>
                                                    
                                                    <!-- Temporal Matching -->
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" id="RAG_TEMPORAL_MATCHING" class="checkbox checkbox-success">
                                                        <span class="label-text">Require Temporal Matching</span>
                                                    </label>
                                                </div>
                                            </div>

                                            <!-- Query Analysis Thresholds -->
                                            <div>
                                                <div class="divider">Query Analysis Thresholds</div>
                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                    <!-- Exact Threshold -->
                                                    <div class="form-control">
                                                        <div class="flex items-center gap-2 mb-2">
                                                            <label class="label-text font-medium">Exact Match Threshold</label>
                                                            <span id="exact-threshold-value" class="text-sm text-base-content/70">(0.75)</span>
                                                        </div>
                                                        <input type="range" id="RAG_EXACT_THRESHOLD" class="range range-success" 
                                                               min="0.5" max="0.9" step="0.05" value="0.75">
                                                        <div class="w-full flex justify-between text-xs px-2">
                                                            <span>0.5</span>
                                                            <span>0.9</span>
                                                        </div>
                                                    </div>

                                                    <!-- High Threshold -->
                                                    <div class="form-control">
                                                        <div class="flex items-center gap-2 mb-2">
                                                            <label class="label-text font-medium">High Precision Threshold</label>
                                                            <span id="high-threshold-value" class="text-sm text-base-content/70">(0.65)</span>
                                                        </div>
                                                        <input type="range" id="RAG_HIGH_THRESHOLD" class="range range-success" 
                                                               min="0.4" max="0.8" step="0.05" value="0.65">
                                                        <div class="w-full flex justify-between text-xs px-2">
                                                            <span>0.4</span>
                                                            <span>0.8</span>
                                                        </div>
                                                    </div>

                                                    <!-- Medium Threshold -->
                                                    <div class="form-control">
                                                        <div class="flex items-center gap-2 mb-2">
                                                            <label class="label-text font-medium">Medium Precision Threshold</label>
                                                            <span id="medium-threshold-value" class="text-sm text-base-content/70">(0.55)</span>
                                                        </div>
                                                        <input type="range" id="RAG_MEDIUM_THRESHOLD" class="range range-success" 
                                                               min="0.3" max="0.7" step="0.05" value="0.55">
                                                        <div class="w-full flex justify-between text-xs px-2">
                                                            <span>0.3</span>
                                                            <span>0.7</span>
                                                        </div>
                                                    </div>

                                                    <!-- Low Threshold -->
                                                    <div class="form-control">
                                                        <div class="flex items-center gap-2 mb-2">
                                                            <label class="label-text font-medium">Low Precision Threshold</label>
                                                            <span id="low-threshold-value" class="text-sm text-base-content/70">(0.45)</span>
                                                        </div>
                                                        <input type="range" id="RAG_LOW_THRESHOLD" class="range range-success" 
                                                               min="0.2" max="0.6" step="0.05" value="0.45">
                                                        <div class="w-full flex justify-between text-xs px-2">
                                                            <span>0.2</span>
                                                            <span>0.6</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Advanced Settings -->
                                            <div>
                                                <div class="divider">Advanced Settings</div>
                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                    <!-- Max Key Terms -->
                                                    <div class="form-control">
                                                        <label class="label">
                                                            <span class="label-text font-medium">Max Key Terms</span>
                                                        </label>
                                                        <input type="number" id="RAG_MAX_KEY_TERMS" class="input input-bordered" 
                                                               min="5" max="20" value="10">
                                                        <div class="text-xs text-base-content/60 mt-1">
                                                            Maximum number of key terms to extract per document chunk
                                                        </div>
                                                    </div>

                                                    <!-- Temporal Confidence Min -->
                                                    <div class="form-control">
                                                        <div class="flex items-center gap-2 mb-2">
                                                            <label class="label-text font-medium">Temporal Confidence Min</label>
                                                            <span id="temporal-confidence-value" class="text-sm text-base-content/70">(0.6)</span>
                                                        </div>
                                                        <input type="range" id="RAG_TEMPORAL_CONFIDENCE_MIN" class="range range-success" 
                                                               min="0.3" max="0.9" step="0.05" value="0.6">
                                                        <div class="w-full flex justify-between text-xs px-2">
                                                            <span>0.3</span>
                                                            <span>0.9</span>
                                                        </div>
                                                    </div>

                                                    <!-- Domain Content Confidence Min -->
                                                    <div class="form-control">
                                                        <div class="flex items-center gap-2 mb-2">
                                                            <label class="label-text font-medium">Domain Content Confidence Min</label>
                                                            <span id="financial-confidence-value" class="text-sm text-base-content/70">(0.7)</span>
                                                        </div>
                                                        <input type="range" id="RAG_FINANCIAL_CONFIDENCE_MIN" class="range range-success" 
                                                               min="0.4" max="0.9" step="0.05" value="0.7">
                                                        <div class="w-full flex justify-between text-xs px-2">
                                                            <span>0.4</span>
                                                            <span>0.9</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Information Alert -->
                                            <div class="alert alert-success">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                                <div>
                                                    <h4 class="font-semibold">Enhanced Temporal Document Analysis</h4>
                                                    <p class="text-sm">These settings improve accuracy for time-based queries like dates (March 2023), quarters (Q3 2023), case timelines, project milestones, publication periods, and historical events across all document types.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Document Processing Configuration -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">üìÑ Document Processing Configuration</h3>
                                        
                                        <div class="space-y-6">
                                            <!-- LlamaCloud Parse Mode -->
                                            <div class="form-control">
                                                <div class="flex items-center gap-2 mb-2">
                                                    <label class="label">
                                                        <span class="label-text font-medium">Parse Mode</span>
                                                    </label>
                                                    <button class="btn btn-circle btn-xs btn-ghost tooltip-trigger" data-tooltip="parse-mode">
                                                        <span class="text-xs">?</span>
                                                    </button>
                                                </div>
                                                <select id="LLAMACLOUD_PARSE_MODE" class="select select-bordered w-full">
                                                    <option value="parse_page_with_agent" selected>Parse with Agent (10-90 credits/page)</option>
                                                    <option value="parse_page_with_llm">Parse with LLM (3 credits/page)</option>
                                                </select>
                                                <div class="text-xs text-base-content/60 mt-1" id="parse-mode-description">
                                                    AI-powered parsing with OCR, plus image and table extraction. Default mode for complex documents.
                                                </div>
                                            </div>

                                            <!-- Parse Model Selection -->
                                            <div class="form-control">
                                                <div class="flex items-center gap-2 mb-2">
                                                    <label class="label">
                                                        <span class="label-text font-medium">Parse Model</span>
                                                    </label>
                                                    <button class="btn btn-circle btn-xs btn-ghost tooltip-trigger" data-tooltip="parse-model">
                                                        <span class="text-xs">?</span>
                                                    </button>
                                                </div>
                                                <select id="LLAMACLOUD_PARSE_MODEL" class="select select-bordered w-full">
                                                    <option value="openai-gpt-4-1-mini" selected>OpenAI GPT-4.1 Mini (10 credits/page) üí∞ Most Economical</option>
                                                    <option value="gemini-2.0-flash">Gemini 2.0 Flash (30 credits/page) ‚ö° Fast & Affordable</option>
                                                    <option value="openai-gpt-4-1">OpenAI GPT-4.1 (45 credits/page) üéØ Balanced</option>
                                                    <option value="anthropic-sonnet-3.5">Anthropic Sonnet 3.5 (45 credits/page) üöÄ High Performance</option>
                                                    <option value="gemini-2.5-pro">Gemini 2.5 Pro (45 credits/page) ‚≠ê Premium</option>
                                                    <option value="anthropic-sonnet-4.0">Anthropic Sonnet 4.0 (90 credits/page) üîÆ Most Advanced</option>
                                                </select>
                                                <div class="text-xs text-base-content/60 mt-1 model-cost-display">
                                                    <span id="model-cost-display" class="font-medium">Cost: 10 credits/page</span> ¬∑ 
                                                    <span id="model-quality-display">Most economical choice</span>
                                                </div>
                                            </div>

                                            <!-- Advanced Parsing Features -->
                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text font-medium">Advanced Parsing Features</span>
                                                </label>
                                                <div class="space-y-3 pl-2">
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" id="LLAMACLOUD_HIGH_RES_OCR" class="checkbox checkbox-primary" checked>
                                                        <span class="label-text">High-Resolution OCR (Better for scanned documents)</span>
                                                    </label>
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" id="LLAMACLOUD_ADAPTIVE_LONG_TABLE" class="checkbox checkbox-primary" checked>
                                                        <span class="label-text">Adaptive Long Table Detection</span>
                                                    </label>
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" id="LLAMACLOUD_OUTLINED_TABLE_EXTRACTION" class="checkbox checkbox-primary" checked>
                                                        <span class="label-text">Extract Outlined Tables</span>
                                                    </label>
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" id="LLAMACLOUD_OUTPUT_TABLES_AS_HTML" class="checkbox checkbox-primary" checked>
                                                        <span class="label-text">Output Tables as HTML</span>
                                                    </label>
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" id="LLAMACLOUD_MULTIMODAL_PARSING" class="checkbox checkbox-primary" checked>
                                                        <span class="label-text">Multimodal Processing (Extract images)</span>
                                                    </label>
                                                </div>
                                            </div>

                                            <!-- Chunking Strategy -->
                                            <div class="form-control">
                                                <div class="flex items-center gap-2 mb-2">
                                                    <label class="label">
                                                        <span class="label-text font-medium">Chunking Strategy</span>
                                                    </label>
                                                    <button class="btn btn-circle btn-xs btn-ghost tooltip-trigger" data-tooltip="chunking-strategy">
                                                        <span class="text-xs">?</span>
                                                    </button>
                                                </div>
                                                <select id="LLAMACLOUD_CHUNK_STRATEGY" class="select select-bordered w-full">
                                                    <option value="sentence">Sentence-based (General purpose)</option>
                                                    <option value="element">Element-based (Best for tables)</option>
                                                    <option value="basic">Basic (Fixed-size)</option>
                                                </select>
                                            </div>

                                            <!-- Chunk Size Slider -->
                                            <div class="form-control">
                                                <div class="flex items-center gap-2 mb-2">
                                                    <label class="label">
                                                        <span class="label-text font-medium">Chunk Size</span>
                                                    </label>
                                                    <button class="btn btn-circle btn-xs btn-ghost tooltip-trigger" data-tooltip="chunk-size">
                                                        <span class="text-xs">?</span>
                                                    </button>
                                                    <span id="chunk-size-value" class="badge badge-primary ml-auto">1000</span>
                                                </div>
                                                <input type="range" id="LLAMACLOUD_CHUNK_SIZE" 
                                                       min="256" max="4500" value="1000" step="64"
                                                       class="range range-primary">
                                                <div class="w-full flex justify-between text-xs text-base-content/60 mt-1">
                                                    <span>256</span>
                                                    <span>2378</span>
                                                    <span>4500</span>
                                                </div>
                                            </div>

                                            <!-- Chunk Overlap Slider -->
                                            <div class="form-control">
                                                <div class="flex items-center gap-2 mb-2">
                                                    <label class="label">
                                                        <span class="label-text font-medium">Chunk Overlap</span>
                                                    </label>
                                                    <button class="btn btn-circle btn-xs btn-ghost tooltip-trigger" data-tooltip="chunk-overlap">
                                                        <span class="text-xs">?</span>
                                                    </button>
                                                    <span id="chunk-overlap-value" class="badge badge-secondary ml-auto">300</span>
                                                </div>
                                                <input type="range" id="LLAMACLOUD_CHUNK_OVERLAP" 
                                                       min="0" max="1500" value="300" step="32"
                                                       class="range range-secondary">
                                                <div class="w-full flex justify-between text-xs text-base-content/60 mt-1">
                                                    <span>0</span>
                                                    <span>750</span>
                                                    <span>1500</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- OpenAI Embedding Model -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">OpenAI Embedding Model</h3>
                                        
                                        <!-- Model Selection -->
                                        <div class="form-control mb-6">
                                            <label class="label">
                                                <span class="label-text font-medium">Embedding Model</span>
                                            </label>
                                            <select id="OPENAI_EMBEDDING_MODEL" class="select select-bordered w-full">
                                                <option value="text-embedding-3-small">text-embedding-3-small (Recommended)</option>
                                                <option value="text-embedding-3-large">text-embedding-3-large (Highest Quality)</option>
                                                <option value="text-embedding-ada-002">text-embedding-ada-002 (Legacy)</option>
                                            </select>
                                        </div>

                                        <!-- Model Comparison Cards -->
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                            <div class="model-card card bg-base-100 border-2 border-primary shadow-sm" data-model="text-embedding-3-small">
                                                <div class="card-body p-4">
                                                    <h4 class="font-semibold text-sm">3-Small</h4>
                                                    <div class="space-y-1 text-xs text-base-content/70">
                                                        <div>1536 dimensions</div>
                                                        <div class="font-medium text-success">~$0.02/1M tokens</div>
                                                        <div>Best cost/performance</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="model-card card bg-base-100 border-2 border-base-300 shadow-sm" data-model="text-embedding-3-large">
                                                <div class="card-body p-4">
                                                    <h4 class="font-semibold text-sm">3-Large</h4>
                                                    <div class="space-y-1 text-xs text-base-content/70">
                                                        <div>3072 dimensions</div>
                                                        <div class="font-medium text-warning">~$0.13/1M tokens</div>
                                                        <div>Highest accuracy</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="model-card card bg-base-100 border-2 border-base-300 shadow-sm" data-model="text-embedding-ada-002">
                                                <div class="card-body p-4">
                                                    <h4 class="font-semibold text-sm">Ada-002</h4>
                                                    <div class="space-y-1 text-xs text-base-content/70">
                                                        <div>1536 dimensions</div>
                                                        <div class="font-medium text-error">~$0.10/1M tokens</div>
                                                        <div>Legacy model</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Configuration Impact Summary -->
                                <div class="card bg-gradient-to-br from-primary/5 to-secondary/5 border border-primary/20 shadow-md">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">Configuration Impact Summary</h3>
                                        
                                        <!-- Current Configuration Preview -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                            <div class="space-y-3">
                                                <h4 class="font-medium text-base-content/80">Current Configuration</h4>
                                                <div class="space-y-2 text-sm">
                                                    <div class="flex justify-between">
                                                        <span>Parsing Mode:</span>
                                                        <span id="config-preview-parsing" class="font-medium">Balanced</span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span>Chunking Strategy:</span>
                                                        <span id="config-preview-strategy" class="font-medium">Sentence-based</span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span>Chunk Size:</span>
                                                        <span id="config-preview-size" class="font-medium">768 chars</span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span>Chunk Overlap:</span>
                                                        <span id="config-preview-overlap" class="font-medium">416 chars</span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span>Embedding Model:</span>
                                                        <span id="config-preview-model" class="font-medium">3-small</span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Performance Indicators -->
                                            <div class="space-y-3">
                                                <h4 class="font-medium text-base-content/80">Performance Indicators</h4>
                                                <div class="space-y-3">
                                                    <div>
                                                        <div class="flex justify-between items-center mb-1">
                                                            <span class="text-sm">Processing Speed</span>
                                                            <span id="speed-indicator" class="text-xs font-medium">85%</span>
                                                        </div>
                                                        <div class="w-full bg-base-300 rounded-full h-2">
                                                            <div id="speed-bar" class="bg-success h-2 rounded-full transition-all duration-300" style="width: 85%"></div>
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <div class="flex justify-between items-center mb-1">
                                                            <span class="text-sm">Retrieval Precision</span>
                                                            <span id="precision-indicator" class="text-xs font-medium">78%</span>
                                                        </div>
                                                        <div class="w-full bg-base-300 rounded-full h-2">
                                                            <div id="precision-bar" class="bg-info h-2 rounded-full transition-all duration-300" style="width: 78%"></div>
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <div class="flex justify-between items-center mb-1">
                                                            <span class="text-sm">Cost Efficiency</span>
                                                            <span id="cost-indicator" class="text-xs font-medium">92%</span>
                                                        </div>
                                                        <div class="w-full bg-base-300 rounded-full h-2">
                                                            <div id="cost-bar" class="bg-warning h-2 rounded-full transition-all duration-300" style="width: 92%"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Debug Settings -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">üêõ Debug Settings</h3>
                                        <p class="text-base-content/70 mb-4">Enable debug logging for RAG operations during development.</p>
                                        
                                        <div class="space-y-4">
                                            <label class="flex items-center gap-3 cursor-pointer">
                                                <input type="checkbox" id="DEBUG_RAG" class="toggle toggle-primary">
                                                <div class="flex-1">
                                                    <span class="label-text font-medium">Enable RAG Debug Logging</span>
                                                    <div class="text-sm text-base-content/60 mt-1">
                                                        Shows detailed RAG retrieval logs in console for troubleshooting
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                        
                                        <div class="alert alert-warning mt-4">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="m21 21-6-6m6 6v-4.8m0 4.8h-4.8"/>
                                                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                                                <line x1="12" y1="9" x2="12" y2="13"/>
                                                <line x1="12" y1="17" x2="12.01" y2="17"/>
                                            </svg>
                                            <span class="text-sm"><strong>Note:</strong> Debug logging may impact performance and should be disabled in production environments.</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tooltip Content (Hidden) -->
                        <div class="hidden">
                            <!-- Parsing Mode Tooltip -->
                            <div id="tooltip-parse-mode" class="tooltip-content max-w-sm">
                                <div class="space-y-3">
                                    <div><strong>Fast Mode (~$0.045/page):</strong> Text-only extraction for simple documents. No multimodal processing, LLM, or table detection. Outputs raw layered text only. Best for plain text documents.</div>
                                    <div><strong>Balanced Mode (~$0.003/page):</strong> LLM-powered structure recognition with basic table support. Good for most documents with mixed content. Balances cost and quality for standard use cases.</div>
                                    <div><strong>Premium Mode (~$0.075/page):</strong> Full multimodal parsing with Large Vision Models (LVM). Advanced image, table, and diagram extraction. Converts equations to LaTeX and diagrams to Mermaid. Best for complex visual documents.</div>
                                </div>
                            </div>
                            
                            <!-- Chunking Strategy Tooltip -->
                            <div id="tooltip-chunking-strategy" class="tooltip-content max-w-sm">
                                <div class="space-y-2">
                                    <div><strong>Sentence-based:</strong> Intelligently splits text at sentence boundaries, preserving semantic meaning. Better for Q&A and fact retrieval.</div>
                                    <div><strong>Basic:</strong> Simple fixed-size splitting. Faster processing but may break sentences mid-way, potentially reducing context quality.</div>
                                </div>
                            </div>
                            
                            <!-- Chunk Size Tooltip -->
                            <div id="tooltip-chunk-size" class="tooltip-content max-w-sm">
                                <div class="space-y-2">
                                    <div><strong>Small chunks (256-512):</strong> More precise retrieval, ideal for specific facts and Q&A</div>
                                    <div><strong>Medium chunks (768-1024):</strong> Balanced approach for most use cases</div>
                                    <div><strong>Large chunks (1280-2048):</strong> Better context preservation, ideal for summarization and complex topics</div>
                                </div>
                            </div>
                            
                            <!-- Chunk Overlap Tooltip -->
                            <div id="tooltip-chunk-overlap" class="tooltip-content max-w-sm">
                                <div class="space-y-2">
                                    <div><strong>No overlap (0):</strong> Fastest processing, but may lose context at chunk boundaries</div>
                                    <div><strong>Low overlap (32-128):</strong> Good balance of performance and context preservation</div>
                                    <div><strong>High overlap (256-512):</strong> Maximum context preservation, but slower processing and higher storage costs</div>
                                </div>
                            </div>
                            
                            
                            <!-- Embedding Model Info Tooltip -->
                            <div id="tooltip-embedding-info" class="tooltip-content max-w-sm">
                                <div class="space-y-2">
                                    <div><strong>text-embedding-3-small:</strong> Best cost-performance ratio. 1536 dimensions, ~5x cheaper than ada-002 with better accuracy</div>
                                    <div><strong>text-embedding-3-large:</strong> Highest accuracy available. 3072 dimensions, premium cost but state-of-the-art performance</div>
                                    <div><strong>text-embedding-ada-002:</strong> Legacy model. Still functional but outdated and more expensive than 3-small</div>
                                </div>
                            </div>
                        </div>
                    </div> <!-- Close Document Processing Tab -->
                    
                    <!-- System Prompt Tab -->
                    <div class="tab-content" id="rag-prompt">
                        <div class="card bg-base-100 shadow-lg">
                            <div class="card-body">
                                <h2 class="card-title text-2xl text-chatrag-primary mb-6">üìù System Prompt</h2>
                                
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">üìù System Prompt Configuration</h3>
                                        <p class="text-base-content/70 mb-4">Configure how your AI assistant behaves by customizing different sections of the system prompt. The context section is automatically protected to ensure RAG functionality.</p>
                                        
                                        <!-- Restart Notice -->
                                        <div class="alert alert-info mb-4">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <circle cx="12" cy="12" r="10"/>
                                                <line x1="12" y1="16" x2="12" y2="12"/>
                                                <line x1="12" y1="8" x2="12.01" y2="8"/>
                                            </svg>
                                            <span class="text-sm"><strong>Note:</strong> Server restart required for system prompt changes to take effect. After saving, restart your Next.js server with <code class="bg-base-300 px-1">npm run dev</code></span>
                                        </div>
                                        
                                        <!-- Pre-Context Instructions Section -->
                                        <div class="form-control mb-6">
                                            <label class="label">
                                                <span class="label-text font-semibold">Pre-Context Instructions</span>
                                                <span class="label-text-alt text-base-content/60">Main behavioral rules</span>
                                            </label>
                                            <textarea id="RAG_PRE_CONTEXT" 
                                                      class="textarea textarea-bordered h-32" 
                                                      placeholder="You are a helpful AI assistant with access to a knowledge base. When answering questions:

1. If the context contains relevant information, use it to provide accurate and specific answers
2. If information is not available in the context, say so clearly and suggest alternative approaches
3. Always cite your sources when referencing specific documents
4. Provide balanced, objective information rather than opinions
5. For technical topics, include practical steps or examples when appropriate"></textarea>
                                            <div class="label">
                                                <span class="label-text-alt text-base-content/60">Define the main behavior, tone, and instructions for your AI assistant.</span>
                                            </div>
                                        </div>
                                        
                                        <!-- Protected Context Section -->
                                        <div class="form-control mb-6">
                                            <label class="label">
                                                <span class="label-text font-semibold">Context Insertion</span>
                                                <span class="label-text-alt text-success">Protected & Automatic</span>
                                            </label>
                                            <div class="card bg-base-300 border border-success/30">
                                                <div class="card-body py-4">
                                                    <div class="flex items-center gap-2 mb-2">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-success">
                                                            <path d="M9 12l2 2 4-4"/>
                                                            <circle cx="12" cy="12" r="10"/>
                                                        </svg>
                                                        <span class="text-sm font-medium">Context:</span>
                                                    </div>
                                                    <code class="text-sm bg-base-100 px-2 py-1 rounded">{{context}}</code>
                                                    <div class="mt-2 text-xs text-base-content/60">
                                                        This section is automatically included and cannot be accidentally removed
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="label">
                                                <span class="label-text-alt text-base-content/60">The <code>{{context}}</code> placeholder is where relevant document content will be inserted at runtime.</span>
                                            </div>
                                        </div>
                                        
                                        <!-- Post-Context Instructions Section -->
                                        <div class="form-control mb-6">
                                            <label class="label">
                                                <span class="label-text font-semibold">Post-Context Instructions</span>
                                                <span class="label-text-alt text-base-content/60">Additional rules (optional)</span>
                                            </label>
                                            <textarea id="RAG_POST_CONTEXT" 
                                                      class="textarea textarea-bordered h-20" 
                                                      placeholder="If the context doesn't contain relevant information, clearly state this and suggest alternative approaches."></textarea>
                                            <div class="label">
                                                <span class="label-text-alt text-base-content/60">Optional additional instructions that will be applied after the context is provided.</span>
                                            </div>
                                        </div>
                                        
                                        <!-- Live Preview Section -->
                                        <div class="form-control mb-6">
                                            <label class="label">
                                                <span class="label-text font-semibold">Live Preview</span>
                                                <span class="label-text-alt text-base-content/60">Complete assembled prompt</span>
                                            </label>
                                            <div class="card bg-base-300 border">
                                                <div class="card-body py-4">
                                                    <pre id="PROMPT_LIVE_PREVIEW" class="text-sm whitespace-pre-wrap overflow-auto max-h-48">Loading preview...</pre>
                                                </div>
                                            </div>
                                            <div class="label">
                                                <span class="label-text-alt text-base-content/60">This shows exactly how your complete system prompt will look when assembled.</span>
                                            </div>
                                        </div>
                                        
                                        <!-- Action Buttons -->
                                        <div class="flex flex-wrap gap-2 mt-6">
                                            <button id="savePromptBtn" class="btn btn-primary">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17,21 17,13 7,13 7,21"/><polyline points="7,3 7,8 15,8"/></svg>
                                                Save Prompt
                                            </button>
                                            <button id="resetPromptBtn" class="btn btn-outline">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                                                Reset to Default
                                            </button>
                                            <button id="loadTemplateBtn" class="btn btn-outline">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><folder-plus/><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg>
                                                Load Template
                                            </button>
                                            <button id="saveTemplateBtn" class="btn btn-success">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10,9 9,9 8,9"/></svg>
                                                Save as Template
                                            </button>
                                            
                                            <!-- Dropdown Menu for Advanced Options -->
                                            <div class="dropdown dropdown-end">
                                                <label tabindex="0" class="btn btn-ghost btn-sm">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
                                                </label>
                                                <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52">
                                                    <li><a id="exportTemplatesBtn">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                                        Export Templates
                                                    </a></li>
                                                    <li><a id="importTemplatesBtn">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                                                        Import Templates
                                                    </a></li>
                                                    <li><a id="shareCurrentBtn">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
                                                        Share Current Prompt
                                                    </a></li>
                                                </ul>
                                            </div>
                                        </div>
                                        
                                        <!-- Translation Section -->
                                        <div class="card bg-base-200 shadow-md mt-6">
                                            <div class="card-body">
                                                <h4 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="m5 8 6 6"></path>
                                                        <path d="m4 14 6-6 2-3"></path>
                                                        <path d="M2 5h12"></path>
                                                        <path d="M7 2v5"></path>
                                                        <path d="M22 22l-5-10-5 10"></path>
                                                        <path d="M14 18h6"></path>
                                                    </svg>
                                                    AI Translation
                                                </h4>
                                                <p class="text-base-content/70 mb-4">Translate your current system prompt to another language using AI</p>
                                                
                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                                    <!-- Target Language Input -->
                                                    <div class="form-control">
                                                        <label class="label">
                                                            <span class="label-text">Target Language</span>
                                                        </label>
                                                        <input type="text" 
                                                               id="promptTranslationLanguage" 
                                                               class="input input-bordered" 
                                                               placeholder="e.g., Spanish, French, Japanese"
                                                               list="commonLanguages">
                                                        <datalist id="commonLanguages">
                                                            <option value="Spanish">
                                                            <option value="French">
                                                            <option value="German">
                                                            <option value="Italian">
                                                            <option value="Portuguese">
                                                            <option value="Russian">
                                                            <option value="Chinese (Simplified)">
                                                            <option value="Chinese (Traditional)">
                                                            <option value="Japanese">
                                                            <option value="Korean">
                                                            <option value="Arabic">
                                                            <option value="Hindi">
                                                            <option value="Dutch">
                                                            <option value="Swedish">
                                                            <option value="Polish">
                                                        </datalist>
                                                    </div>
                                                    
                                                    <!-- Provider Selection -->
                                                    <div class="form-control">
                                                        <label class="label">
                                                            <span class="label-text">AI Provider</span>
                                                        </label>
                                                        <select id="promptTranslationProvider" class="select select-bordered">
                                                            <option value="openai" selected>OpenAI (GPT-4o-mini)</option>
                                                            <option value="openrouter">OpenRouter (GPT-4o-mini)</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                
                                                <!-- Translation Preview -->
                                                <div id="promptTranslationPreview" class="hidden">
                                                    <div class="divider">Translation Preview</div>
                                                    <div class="card bg-base-300 mb-4">
                                                        <div class="card-body">
                                                            <pre id="promptTranslationResult" class="text-sm whitespace-pre-wrap overflow-auto max-h-48"></pre>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Translation Actions -->
                                                <div class="flex gap-2">
                                                    <button id="translatePromptBtn" class="btn btn-primary">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                            <path d="m5 8 6 6"></path>
                                                            <path d="m4 14 6-6 2-3"></path>
                                                            <path d="M2 5h12"></path>
                                                            <path d="M7 2v5"></path>
                                                            <path d="M22 22l-5-10-5 10"></path>
                                                            <path d="M14 18h6"></path>
                                                        </svg>
                                                        Translate
                                                    </button>
                                                    <button id="applyTranslationBtn" class="btn btn-success hidden">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                            <polyline points="20 6 9 17 4 12"></polyline>
                                                        </svg>
                                                        Apply Translation
                                                    </button>
                                                    <button id="cancelTranslationBtn" class="btn btn-outline hidden">
                                                        Cancel
                                                    </button>
                                                </div>
                                                
                                                <!-- Translation Status -->
                                                <div id="promptTranslationStatus" class="mt-4 hidden">
                                                    <div class="alert">
                                                        <span id="promptTranslationMessage"></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Hidden file input for import -->
                                        <input type="file" id="importTemplateFile" accept=".json" style="display: none;">
                                        
                                        <!-- Template Selection Modal -->
                                        <div id="templateModal" class="modal">
                                            <div class="modal-box max-w-2xl">
                                                <h3 class="font-bold text-lg mb-4">Choose a Template</h3>
                                                <div id="templateOptionsContainer">
                                                    <!-- Built-in templates -->
                                                    <div class="mb-6">
                                                        <h4 class="font-semibold mb-3">Built-in Templates</h4>
                                                        <div class="space-y-2">
                                                            <div class="template-option card bg-base-200 cursor-pointer hover:bg-base-300 transition-colors" data-template="helpful">
                                                                <div class="card-body py-3">
                                                                    <div class="font-medium">Helpful Assistant</div>
                                                                    <div class="text-sm text-base-content/70">Friendly, informative, and always tries to help</div>
                                                                </div>
                                                            </div>
                                                            <div class="template-option card bg-base-200 cursor-pointer hover:bg-base-300 transition-colors" data-template="professional">
                                                                <div class="card-body py-3">
                                                                    <div class="font-medium">Professional Expert</div>
                                                                    <div class="text-sm text-base-content/70">Formal, precise, and business-oriented responses</div>
                                                                </div>
                                                            </div>
                                                            <div class="template-option card bg-base-200 cursor-pointer hover:bg-base-300 transition-colors" data-template="educational">
                                                                <div class="card-body py-3">
                                                                    <div class="font-medium">Educational Tutor</div>
                                                                    <div class="text-sm text-base-content/70">Teaching-focused with explanations and examples</div>
                                                                </div>
                                                            </div>
                                                            <div class="template-option card bg-base-200 cursor-pointer hover:bg-base-300 transition-colors" data-template="technical">
                                                                <div class="card-body py-3">
                                                                    <div class="font-medium">Technical Specialist</div>
                                                                    <div class="text-sm text-base-content/70">Code-focused with technical accuracy</div>
                                                                </div>
                                                            </div>
                                                            <div class="template-option card bg-base-200 cursor-pointer hover:bg-base-300 transition-colors" data-template="chatragSales">
                                                                <div class="card-body py-3">
                                                                    <div class="font-medium">ChatRAG Sales Assistant</div>
                                                                    <div class="text-sm text-base-content/70">Enthusiastic sales support for ChatRAG platform</div>
                                                                </div>
                                                            </div>
                                                            <div class="template-option card bg-base-200 cursor-pointer hover:bg-base-300 transition-colors" data-template="customerSupport">
                                                                <div class="card-body py-3">
                                                                    <div class="font-medium">Customer Support Specialist</div>
                                                                    <div class="text-sm text-base-content/70">Empathetic support focused on issue resolution</div>
                                                                </div>
                                                            </div>
                                                            <div class="template-option card bg-base-200 cursor-pointer hover:bg-base-300 transition-colors" data-template="researchAssistant">
                                                                <div class="card-body py-3">
                                                                    <div class="font-medium">Research Assistant</div>
                                                                    <div class="text-sm text-base-content/70">Academic research with critical analysis</div>
                                                                </div>
                                                            </div>
                                                            <div class="template-option card bg-base-200 cursor-pointer hover:bg-base-300 transition-colors" data-template="codeAssistant">
                                                                <div class="card-body py-3">
                                                                    <div class="font-medium">Code Assistant</div>
                                                                    <div class="text-sm text-base-content/70">Expert programming help with best practices</div>
                                                                </div>
                                                            </div>
                                                            <div class="template-option card bg-base-200 cursor-pointer hover:bg-base-300 transition-colors" data-template="legalAnalyst">
                                                                <div class="card-body py-3">
                                                                    <div class="font-medium">Legal Document Analyst</div>
                                                                    <div class="text-sm text-base-content/70">Legal document analysis (not legal advice)</div>
                                                                </div>
                                                            </div>
                                                            <div class="template-option card bg-base-200 cursor-pointer hover:bg-base-300 transition-colors" data-template="medicalInformation">
                                                                <div class="card-body py-3">
                                                                    <div class="font-medium">Medical Information Specialist</div>
                                                                    <div class="text-sm text-base-content/70">Health education (not medical advice)</div>
                                                                </div>
                                                            </div>
                                                            <div class="template-option card bg-base-200 cursor-pointer hover:bg-base-300 transition-colors" data-template="whatsappConversational">
                                                                <div class="card-body py-3">
                                                                    <div class="font-medium">WhatsApp Conversational</div>
                                                                    <div class="text-sm text-base-content/70">Short, mobile-friendly responses for WhatsApp</div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <!-- Custom templates section -->
                                                    <div id="customTemplatesSection" class="hidden">
                                                        <h4 class="font-semibold mb-3">Custom Templates</h4>
                                                        <div id="customTemplatesContainer" class="space-y-2"></div>
                                                    </div>
                                                </div>
                                                <div class="modal-action">
                                                    <button id="applyTemplateBtn" class="btn btn-primary">Apply Template</button>
                                                    <button id="cancelTemplateBtn" class="btn btn-outline">Cancel</button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Save Template Modal -->
                                        <div id="saveTemplateModal" class="modal">
                                            <div class="modal-box">
                                                <h3 class="font-bold text-lg mb-4">Save as Template</h3>
                                                <div class="form-control mb-4">
                                                    <label class="label">
                                                        <span class="label-text">Template Name</span>
                                                    </label>
                                                    <input type="text" id="templateName" class="input input-bordered" placeholder="Enter a name for your template" maxlength="50">
                                                </div>
                                                <div class="form-control mb-6">
                                                    <label class="label">
                                                        <span class="label-text">Description (optional)</span>
                                                    </label>
                                                    <input type="text" id="templateDescription" class="input input-bordered" placeholder="Brief description of this template" maxlength="100">
                                                </div>
                                                <div class="modal-action">
                                                    <button id="confirmSaveTemplateBtn" class="btn btn-primary">Save Template</button>
                                                    <button id="cancelSaveTemplateBtn" class="btn btn-outline">Cancel</button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Translate Template Modal -->
                                        <div id="translateTemplateModal" class="modal">
                                            <div class="modal-box">
                                                <h3 class="font-bold text-lg mb-4">Translate System Prompt Template</h3>
                                                
                                                <div class="mb-4">
                                                    <div class="text-sm text-base-content/70 mb-2">Translating: <span id="translatingTemplateLabel" class="font-semibold">Template Name</span></div>
                                                </div>
                                                
                                                <div class="space-y-4">
                                                    <!-- Target Language -->
                                                    <div class="form-control">
                                                        <label class="label">
                                                            <span class="label-text">Target Language</span>
                                                        </label>
                                                        <input type="text" 
                                                               id="translateTargetLanguage" 
                                                               class="input input-bordered" 
                                                               list="translate-languages-list"
                                                               placeholder="e.g., Spanish, French, Chinese">
                                                        <datalist id="translate-languages-list">
                                                            <option value="Spanish">
                                                            <option value="Portuguese">
                                                            <option value="French">
                                                            <option value="German">
                                                            <option value="Russian">
                                                            <option value="Lithuanian">
                                                            <option value="Chinese">
                                                            <option value="Japanese">
                                                            <option value="Korean">
                                                            <option value="Hindi">
                                                            <option value="Arabic">
                                                            <option value="Italian">
                                                            <option value="Dutch">
                                                            <option value="Polish">
                                                            <option value="Turkish">
                                                            <option value="Swedish">
                                                            <option value="Norwegian">
                                                            <option value="Danish">
                                                            <option value="Finnish">
                                                        </datalist>
                                                    </div>
                                                    
                                                    <!-- AI Provider -->
                                                    <div class="form-control">
                                                        <label class="label">
                                                            <span class="label-text">AI Provider</span>
                                                        </label>
                                                        <select id="translateProvider" class="select select-bordered w-full">
                                                            <option value="openai" selected>OpenAI (GPT-4o-mini)</option>
                                                            <option value="openrouter">OpenRouter (GPT-4o-mini)</option>
                                                        </select>
                                                        <label class="label">
                                                            <span class="label-text-alt text-base-content/60">Choose which AI provider to use for translation</span>
                                                        </label>
                                                    </div>
                                                    
                                                    <!-- Translation Status -->
                                                    <div id="translateStatus" class="hidden">
                                                        <div class="alert">
                                                            <span id="translateStatusText">Ready to translate...</span>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Translation Preview -->
                                                    <div id="translatePreview" class="hidden">
                                                        <label class="label">
                                                            <span class="label-text">Translation Preview</span>
                                                        </label>
                                                        <div class="card bg-base-300 border">
                                                            <div class="card-body py-4">
                                                                <pre id="translatedPromptPreview" class="text-sm whitespace-pre-wrap overflow-auto max-h-48"></pre>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="modal-action">
                                                    <button id="performTranslateBtn" class="btn btn-primary">
                                                        <span id="performTranslateBtnText">Translate</span>
                                                    </button>
                                                    <button id="applyTranslationBtn" class="btn btn-success hidden">Apply Translation</button>
                                                    <button id="cancelTranslateBtn" class="btn btn-outline">Cancel</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Document Processing Tab -->
                    <div class="tab-content" id="document-processing">
                        <div class="card bg-base-100 shadow-lg">
                            <div class="card-body p-4 lg:p-6">
                                <h2 class="card-title text-xl lg:text-2xl text-chatrag-primary mb-6">üìö Document Processing Hub</h2>
                                <p class="text-base-content/70 mb-6">Upload, process, and manage documents for your ChatRAG knowledge base. Configure RAG settings and monitor processing status in real-time.</p>
                                
                                <!-- Document Dashboard Visibility -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="text-lg font-semibold">Hide Document Dashboard in Header</h3>
                                            <input type="checkbox" id="NEXT_PUBLIC_HIDE_DOCUMENT_DASHBOARD" class="toggle toggle-primary">
                                        </div>
                                        <p class="text-base-content/70">When enabled, the document dashboard button will be hidden from the ChatRAG header for all users including admins. Documents can still be managed through this config interface.</p>
                                    </div>
                                </div>

                                <!-- Status Overview -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">üìä Processing Status</h3>
                                        
                                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                            <div class="stat">
                                                <div class="stat-title text-xs">Queue Status</div>
                                                <div id="queue-status" class="stat-value text-sm">Ready</div>
                                            </div>
                                            <div class="stat">
                                                <div class="stat-title text-xs">Files in Queue</div>
                                                <div id="files-in-queue" class="stat-value text-sm">0</div>
                                            </div>
                                            <div class="stat">
                                                <div class="stat-title text-xs">Processed Today</div>
                                                <div id="processed-today" class="stat-value text-sm">0</div>
                                            </div>
                                            <div class="stat">
                                                <div class="stat-title text-xs">Success Rate</div>
                                                <div id="success-rate" class="stat-value text-sm">100%</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Upload Documents -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">üìÅ Upload Documents</h3>
                                        
                                        <!-- Drop Zone -->
                                        <div id="drop-zone" class="border-2 border-dashed border-base-300 rounded-lg p-8 text-center transition-all duration-200 hover:border-primary hover:bg-primary/5">
                                            <div class="mb-4">
                                                <div class="text-4xl mb-2">üìÑ</div>
                                            </div>
                                            <p class="text-lg font-medium mb-2">Drop files here or click to browse</p>
                                            <p class="text-sm text-base-content/60 mb-4">Supports PDF, DOC, DOCX, TXT, MD, and more</p>
                                            <input type="file" id="file-input" multiple class="hidden" accept=".pdf,.doc,.docx,.txt,.md,.rtf,.odt">
                                        </div>
                                        
                                        <!-- Upload Actions -->
                                        <div class="flex flex-col sm:flex-row gap-3 mt-4">
                                            <button id="select-files-btn" class="btn btn-outline">
                                                üìÅ Select Files
                                            </button>
                                            <button id="start-processing-btn" class="btn btn-primary" disabled>
                                                üöÄ Start Processing
                                            </button>
                                            <button id="clear-queue-btn" class="btn btn-outline" disabled>
                                                üóëÔ∏è Clear Queue
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Processing Queue -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="text-lg font-semibold">üìã Processing Queue</h3>
                                            <div class="flex gap-2">
                                                <button id="pause-btn" class="btn btn-sm btn-outline hidden">
                                                    ‚è∏Ô∏è Pause
                                                </button>
                                                <button id="resume-btn" class="btn btn-sm btn-outline hidden">
                                                    ‚ñ∂Ô∏è Resume
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div id="queue-container">
                                            <!-- Empty State -->
                                            <div id="queue-empty-state" class="text-center py-8">
                                                <div class="text-4xl mb-4">üìù</div>
                                                <p class="text-base-content/70 mb-2">No files in queue</p>
                                                <p class="text-sm text-base-content/50">Upload documents above to get started</p>
                                            </div>
                                            
                                            <!-- Queue Items -->
                                            <div id="queue-items" class="space-y-3 hidden">
                                                <!-- Queue items will be dynamically added here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Live Processing Monitor -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="text-lg font-semibold">üìà Live Processing Monitor</h3>
                                            <button id="toggle-monitor" class="btn btn-sm btn-outline">
                                                üìä Hide Details
                                            </button>
                                        </div>
                                        
                                        <div id="monitor-panel">
                                            <!-- Current Processing - Simplified -->
                                            <div id="current-processing" class="mb-6 hidden">
                                                <h4 class="font-medium mb-2">Currently Processing:</h4>
                                                <div class="bg-base-100 p-4 rounded-lg">
                                                    <div class="flex items-center gap-3">
                                                        <span class="loading loading-spinner loading-sm text-primary"></span>
                                                        <span id="current-file-name" class="font-medium">filename.pdf</span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Activity Log with Enhanced Features -->
                                            <div class="mb-4">
                                                <div class="flex justify-between items-center mb-2">
                                                    <h4 class="font-medium">Activity Log:</h4>
                                                    <div class="flex gap-2">
                                                        <span id="webhook-status" class="badge badge-sm" title="Webhook Status">
                                                            <span class="w-2 h-2 rounded-full bg-gray-400 mr-1"></span>
                                                            Disconnected
                                                        </span>
                                                        <button id="export-log-btn" class="btn btn-xs btn-ghost" title="Export Log">
                                                            üì•
                                                        </button>
                                                        <button id="clear-log-btn" class="btn btn-xs btn-ghost" title="Clear Log">
                                                            üóëÔ∏è
                                                        </button>
                                                    </div>
                                                </div>
                                                <div id="activity-log" class="bg-base-100 p-4 rounded-lg max-h-48 overflow-y-auto">
                                                    <div class="text-sm text-base-content/60">No activity yet</div>
                                                </div>
                                                <div class="flex justify-between items-center mt-2 text-xs text-base-content/50">
                                                    <span id="processing-speed">Speed: --</span>
                                                    <span id="last-update">Last update: Never</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Processing Results -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="text-lg font-semibold">üìä Processing Results</h3>
                                            <button id="clear-history-btn" class="btn btn-sm btn-outline">
                                                üóëÔ∏è Clear History
                                            </button>
                                        </div>
                                        
                                        <div id="results-container">
                                            <!-- Empty State -->
                                            <div id="results-empty-state" class="text-center py-8">
                                                <div class="text-4xl mb-4">üìã</div>
                                                <p class="text-base-content/70 mb-2">No processing results yet</p>
                                                <p class="text-sm text-base-content/50">Results will appear here after processing documents</p>
                                            </div>
                                            
                                            <!-- Results List -->
                                            <div id="results-list" class="space-y-3 hidden">
                                                <!-- Results will be dynamically added here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Document Management -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="text-lg font-semibold">üìö Document Management</h3>
                                            <div class="flex gap-2">
                                                <input type="text" id="document-search" placeholder="Search documents..." 
                                                       class="input input-bordered input-sm w-48">
                                                <button id="refresh-documents-btn" class="btn btn-sm btn-outline">
                                                    üîÑ Refresh
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <p class="text-sm text-base-content/60 mb-4">View and manage all documents in your vector database</p>
                                        
                                        <div id="document-management-container">
                                            <!-- Loading State -->
                                            <div id="documents-loading" class="text-center py-8">
                                                <div class="loading loading-spinner loading-lg"></div>
                                                <p class="text-base-content/70 mt-2">Loading documents...</p>
                                            </div>
                                            
                                            <!-- Empty State -->
                                            <div id="documents-empty-state" class="text-center py-8 hidden">
                                                <div class="text-4xl mb-4">üìÑ</div>
                                                <p class="text-base-content/70 mb-2">No documents found</p>
                                                <p class="text-sm text-base-content/50">Upload documents above to get started</p>
                                            </div>
                                            
                                            <!-- Documents Table -->
                                            <div id="documents-table-container" class="hidden">
                                                <div class="overflow-x-auto max-h-96 overflow-y-auto">
                                                    <table class="table table-sm table-pin-rows table-fixed w-full">
                                                        <thead>
                                                            <tr>
                                                                <th class="w-2/5 min-w-0">
                                                                    <span class="truncate block">Document Name</span>
                                                                </th>
                                                                <th class="w-1/6 text-center">Upload Date</th>
                                                                <th class="w-1/6 text-center">Status</th>
                                                                <th class="w-1/12 text-center">Chunks</th>
                                                                <th class="w-1/6 text-center">Actions</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="documents-table-body">
                                                            <!-- Document rows will be dynamically added here -->
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Admin Tab -->
                    <div class="tab-content" id="admin">
                        <div class="card bg-base-100 shadow-lg">
                            <div class="card-body p-4 lg:p-6">
                                <h2 class="card-title text-xl lg:text-2xl text-chatrag-primary mb-6">üë§ Admin Configuration</h2>
                                
                                <!-- Primary Admin Account -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">Primary Admin Account</h3>
                                        <p class="text-base-content/70 mb-6">Set up your primary admin account for managing the application.</p>
                                        
                                        <div class="space-y-4">
                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Admin Email</span>
                                                </label>
                                                <input type="email" id="ADMIN_EMAIL" 
                                                       placeholder="admin@example.com" 
                                                       class="input input-bordered w-full">
                                            </div>

                                            <div class="form-control">
                                                <label class="label">
                                                    <span class="label-text">Admin Password</span>
                                                </label>
                                                <div class="flex gap-2">
                                                    <input type="password" id="ADMIN_PASSWORD" 
                                                           placeholder="Strong password" 
                                                           class="input input-bordered flex-1 w-full">
                                                    <button class="btn btn-square btn-outline" data-for="ADMIN_PASSWORD">üëÅÔ∏è</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Read-only Document Dashboard -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="text-lg font-semibold">Read-only Document Dashboard</h3>
                                            <input type="checkbox" id="NEXT_PUBLIC_READ_ONLY_DOCUMENTS_ENABLED" class="toggle toggle-primary">
                                        </div>
                                        <p class="text-base-content/70">Allow users to view documents in read-only mode. When enabled, all users will be able to view documents in the RAG system, but only admins can upload or delete documents.</p>
                                    </div>
                                </div>

                                <!-- Admin Management -->
                                <div class="card bg-base-200 shadow-md mb-6">
                                    <div class="card-body">
                                        <h3 class="text-lg font-semibold mb-4">Admin Management</h3>
                                        <p class="text-base-content/70 mb-6">Manage multiple admin users and run admin operations.</p>
                                        
                                        <!-- Status Indicators -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                            <div class="stat bg-base-100 rounded-lg shadow">
                                                <div class="stat-title">Admin Setup</div>
                                                <div id="adminSetupStatus" class="stat-value text-sm">
                                                    <span class="loading loading-spinner loading-xs"></span>
                                                    <span class="ml-2">Checking...</span>
                                                </div>
                                            </div>
                                            <div class="stat bg-base-100 rounded-lg shadow">
                                                <div class="stat-title">Admin Count</div>
                                                <div id="adminCountStatus" class="stat-value text-sm">
                                                    <span class="loading loading-spinner loading-xs"></span>
                                                    <span class="ml-2">Checking...</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Admin Operations -->
                                        <div class="mb-6">
                                            <h4 class="font-semibold mb-3">Admin Operations</h4>
                                            <div class="flex">
                                                <button id="checkAdminBtn" class="btn btn-outline btn-sm">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                                                    Check Admin Setup
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Action Result -->
                                        <div id="adminActionResult" class="hidden p-4 bg-base-100 rounded-lg border">
                                            <!-- Results will appear here -->
                                        </div>
                                        
                                        <!-- Current Admin Users -->
                                        <div class="mb-6">
                                            <h4 class="font-semibold mb-3">Current Admin Users</h4>
                                            <div id="adminUsersList" class="space-y-2">
                                                <div class="flex items-center gap-2 text-sm text-base-content/60">
                                                    <span class="loading loading-spinner loading-xs"></span>
                                                    Loading admin users...
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Add New Admin -->
                                        <div class="card bg-base-100">
                                            <div class="card-body py-4">
                                                <h4 class="font-semibold mb-3">Add New Admin</h4>
                                                <form id="addAdminForm" class="space-y-4">
                                                    <div class="form-control">
                                                        <label class="label">
                                                            <span class="label-text">Email</span>
                                                        </label>
                                                        <input type="email" id="newAdminEmail" 
                                                               placeholder="new-admin@example.com" 
                                                               class="input input-bordered input-sm"
                                                               required>
                                                        <p class="text-xs text-base-content/70 mt-1">User must be registered in the system before adding as admin</p>
                                                    </div>
                                                    <button type="submit" class="btn btn-primary btn-sm">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>
                                                        Add Admin
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- MCP Config Tab -->
                    <div class="tab-content" id="advanced">
                        <div class="card bg-base-100 shadow-lg">
                            <div class="card-body">
                                <h2 class="card-title text-2xl text-chatrag-primary mb-6">üîß MCP Configuration</h2>
                                <p class="text-base-content/70 mb-6">Manage MCP (Model Context Protocol) servers to extend ChatRAG with custom tools and integrations.</p>

                                <!-- MCP System Toggle -->
                                <div class="card bg-gradient-to-r from-blue-500/10 to-purple-500/10 border border-blue-500/20 mb-6">
                                    <div class="card-body p-6">
                                        <div class="flex items-start justify-between gap-6">
                                            <div class="flex items-start gap-3 flex-grow">
                                                <div class="text-2xl mt-1">üîå</div>
                                                <div class="flex-grow">
                                                    <h3 class="font-bold text-lg mb-2 text-base-content">Enable MCP System</h3>
                                                    <p class="text-sm text-base-content/70 leading-relaxed">Enable the entire Model Context Protocol system for tool execution. When disabled, ChatRAG will focus on RAG functionality only.</p>
                                                </div>
                                            </div>
                                            <div class="flex-shrink-0 pt-1">
                                                <input type="checkbox" id="NEXT_PUBLIC_MCP_SYSTEM_ENABLED" class="toggle toggle-primary toggle-lg">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Notification container -->
                                <div id="notification-container" class="mb-4"></div>

                                <!-- MCP Status Overview -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                    <div class="stat bg-base-200 rounded-lg shadow">
                                        <div class="stat-title">Total Servers</div>
                                        <div id="mcp-total-servers" class="stat-value text-2xl">0</div>
                                        <div class="stat-desc">Configured MCP servers</div>
                                    </div>
                                    <div class="stat bg-base-200 rounded-lg shadow">
                                        <div class="stat-title">Active Servers</div>
                                        <div id="mcp-active-servers" class="stat-value text-2xl text-success">0</div>
                                        <div class="stat-desc">Currently enabled</div>
                                    </div>
                                    <div class="stat bg-base-200 rounded-lg shadow">
                                        <div class="stat-title">Built-in Servers</div>
                                        <div id="mcp-builtin-servers" class="stat-value text-2xl text-info">0</div>
                                        <div class="stat-desc">Zapier, etc.</div>
                                    </div>
                                </div>

                                <!-- Quick Actions -->
                                <div class="flex gap-2 mb-6">
                                    <button class="btn btn-primary" onclick="mcpConfig?.showAddServerDialog()">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                        Add MCP Server
                                    </button>
                                    <button class="btn btn-outline" onclick="mcpConfig?.loadServers(); mcpConfig?.renderServerList()">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="m3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                                        Refresh Servers
                                    </button>
                                    <button class="btn btn-outline" onclick="mcpConfig?.discoverBuiltinServers()">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>
                                        Discover Built-in
                                    </button>
                                </div>
                                
                                <!-- MCP Servers List -->
                                <div id="mcp-servers-list" class="space-y-4 overflow-hidden">
                                    <!-- Content will be populated by JavaScript -->
                                    <div class="text-center text-base-content/60 py-12 border-2 border-dashed border-base-300 rounded-lg">
                                        <div class="text-6xl mb-4">üîß</div>
                                        <h3 class="text-lg font-semibold mb-2">No MCP Servers Configured</h3>
                                        <p class="mb-4">Add your first MCP server to enable advanced tool integrations.</p>
                                        <button class="btn btn-primary" onclick="mcpConfig?.showAddServerDialog()">
                                            Get Started
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
                <!-- End of all tab contents -->
                
                        </div>
                        <!-- End of Main Content -->
                        
                        <!-- Footer -->
                        <footer class="px-6 py-8 text-center text-base-content/60 border-t border-base-300">
                            <p class="mb-2">Changes are automatically saved to your <code class="bg-base-200 px-2 py-1 rounded">.env.local</code> file.</p>
                            <p><small>ChatRAG Configuration Tool v1.0.0</small></p>
                        </footer>
                    </div>
                    <!-- End of main-content-wrapper -->
                </div>
                <!-- End of configApp -->
            </div>
    </div>
    <!-- End of main wrapper -->
    
    <!-- Custom Mobile Drawer (separate from main content) -->
    <div id="mobile-drawer" class="mobile-drawer">
        <div class="drawer-backdrop"></div>
        <div class="drawer-panel">
            <div class="flex items-center justify-between p-4">
                <h2 class="text-lg font-bold">Menu</h2>
                <button class="btn btn-square btn-ghost" onclick="mobileDrawer.close()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="nav-scroll-container">
                <ul class="menu menu-vertical w-full">
                    <li><a class="menu-item active" data-tab="features">Features</a></li>
                    <li><a class="menu-item" data-tab="ai">AI Models</a></li>
                    <li><a class="menu-item" data-tab="media">Media Generation</a></li>
                    <li><a class="menu-item" data-tab="database">Database</a></li>
                    <li><a class="menu-item" data-tab="auth">Authentication</a></li>
                    <li><a class="menu-item" data-tab="rag-settings">RAG Settings</a></li>
                    <li><a class="menu-item" data-tab="document-processing">Document Processing</a></li>
                    <li><a class="menu-item" data-tab="rag-prompt">System Prompt</a></li>
                    <li><a class="menu-item" data-tab="admin">Admin</a></li>
                    <li><a class="menu-item" data-tab="branding">Branding & UI</a></li>
                    <li><a class="menu-item" data-tab="saved-chats">Saved Chats</a></li>
                    <li><a class="menu-item" data-tab="suggestions">Suggestions</a></li>
                    <li><a class="menu-item" data-tab="embed">Embed Widget</a></li>
                    <li><a class="menu-item" data-tab="audio">Audio</a></li>
                    <li><a class="menu-item" data-tab="payment">Payment</a></li>
                    <li><a class="menu-item" data-tab="email">Email</a></li>
                    <li><a class="menu-item" data-tab="whatsapp">WhatsApp</a></li>
                    <li><a class="menu-item" data-tab="advanced">MCP Config</a></li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Toast notification -->
    <div id="toast" class="toast toast-top toast-end hidden" style="z-index: 1100;">
        <div class="alert alert-info">
            <span id="toastMessage"></span>
        </div>
    </div>

    <script>
        // Toast notification function - needs to be available globally
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            if (!toast || !toastMessage) {
                console.warn('[showToast] Toast elements not found');
                return;
            }
            
            // Update message
            toastMessage.textContent = message;
            
            // Update alert type
            const alert = toast.querySelector('.alert');
            if (alert) {
                // Remove all type classes
                alert.classList.remove('alert-info', 'alert-success', 'alert-error', 'alert-warning');
                // Add appropriate type class
                alert.classList.add(`alert-${type}`);
            }
            
            // Show toast
            toast.classList.remove('hidden');
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }
        
        // Wrapper functions for backward compatibility
        function showSuccess(message) {
            showToast(message, 'success');
        }
        
        function showError(message) {
            showToast(message, 'error');
        }
        
        // Make wrapper functions available globally
        window.showSuccess = showSuccess;
        window.showError = showError;

        // Configuration Manager
        class ConfigManager {
            constructor() {
                this.config = {};
                this.hasChanges = false;
                this.listenersInitialized = false;
                // Note: init() is called explicitly after instantiation to properly handle async
            }

            async init() {
                await this.loadConfig();
                this.setupEventListeners();
                this.populateFields();
            }

            async loadConfig() {
                try {
                    const response = await fetch('/api/config');
                    const data = await response.json();
                    this.config = data.config || {};
                    console.log('Config loaded:', this.config);
                } catch (error) {
                    console.error('Failed to load config:', error);
                }
            }

            populateFields() {
                // Populate all form fields with config values
                Object.entries(this.config).forEach(([key, value]) => {
                    // Skip RAG prompt fields, template modal fields, translation input, and temporary form variables
                    if (key === 'RAG_PRE_CONTEXT' || key === 'RAG_POST_CONTEXT' || key === 'templateName' || key === 'templateDescription' || key === 'translationTargetLanguage' || 
                        key === 'new-model-id' || key === 'new-model-name' || key === 'ai-provider-select') {
                        return;
                    }
                    
                    // No special handling needed for unified RAG system
                    
                    const field = document.getElementById(key);
                    if (field) {
                        if (field.type === 'checkbox') {
                            field.checked = value === 'true' || value === true;
                        } else {
                            field.value = value || '';
                        }
                    }
                });
                
                // Update favicon preview with actual value
                const faviconUrl = this.config.NEXT_PUBLIC_FAVICON_URL || '/favicon.svg';
                const faviconPreview = document.getElementById('faviconPreview');
                if (faviconPreview) {
                    faviconPreview.innerHTML = `<img src="${faviconUrl}" alt="Current favicon" class="w-6 h-6" onerror="this.src='/favicon.svg'">`;
                }
                
                // Update model cards after config is loaded
                if (typeof updateModelCards === 'function') {
                    updateModelCards();
                }
                
                // Initialize RAG slider values from config
                const chunkSizeSlider = document.getElementById('LLAMACLOUD_CHUNK_SIZE');
                const chunkSizeValue = document.getElementById('chunk-size-value');
                if (chunkSizeSlider && this.config.LLAMACLOUD_CHUNK_SIZE) {
                    chunkSizeSlider.value = this.config.LLAMACLOUD_CHUNK_SIZE;
                    if (chunkSizeValue) {
                        chunkSizeValue.textContent = this.config.LLAMACLOUD_CHUNK_SIZE;
                    }
                }
                
                const chunkOverlapSlider = document.getElementById('LLAMACLOUD_CHUNK_OVERLAP');
                const chunkOverlapValue = document.getElementById('chunk-overlap-value');
                if (chunkOverlapSlider && this.config.LLAMACLOUD_CHUNK_OVERLAP) {
                    chunkOverlapSlider.value = this.config.LLAMACLOUD_CHUNK_OVERLAP;
                    if (chunkOverlapValue) {
                        chunkOverlapValue.textContent = this.config.LLAMACLOUD_CHUNK_OVERLAP;
                    }
                }
                
                // Initialize voice provider settings visibility
                const voiceProvider = this.config.NEXT_PUBLIC_VOICE_PROVIDER || 'openai';
                const openaiSettings = document.getElementById('openai-tts-settings');
                const elevenLabsSettings = document.getElementById('elevenlabs-tts-settings');
                
                if (voiceProvider === 'elevenlabs') {
                    openaiSettings.style.display = 'none';
                    elevenLabsSettings.style.display = 'block';
                } else {
                    openaiSettings.style.display = 'block';
                    elevenLabsSettings.style.display = 'none';
                }
                
                // Initialize image generation provider dropdown based on legacy toggles
                const imageProviderSelect = document.getElementById('IMAGE_GENERATION_PROVIDER');
                if (imageProviderSelect) {
                    // Check legacy toggles first
                    if (this.config.USE_OPENAI_IMAGE === 'true' || this.config.USE_OPENAI_IMAGE === true) {
                        imageProviderSelect.value = 'openai';
                    } else if (this.config.USE_REPLICATE_PROVIDER === 'true' || this.config.USE_REPLICATE_PROVIDER === true) {
                        imageProviderSelect.value = 'fal';
                    } else if (this.config.IMAGE_GENERATION_PROVIDER) {
                        imageProviderSelect.value = this.config.IMAGE_GENERATION_PROVIDER;
                    } else {
                        imageProviderSelect.value = 'openai'; // default
                    }
                    
                    // Update provider settings visibility
                    if (typeof updateImageProviderSettings === 'function') {
                        updateImageProviderSettings();
                    }
                }
                
                // Initialize Video Generation provider
                const videoProviderSelect = document.getElementById('VIDEO_GENERATION_PROVIDER');
                if (videoProviderSelect) {
                    if (this.config.VIDEO_GENERATION_PROVIDER) {
                        videoProviderSelect.value = this.config.VIDEO_GENERATION_PROVIDER;
                    } else {
                        // Default based on USE_REPLICATE_PROVIDER
                        videoProviderSelect.value = (this.config.USE_REPLICATE_PROVIDER === 'true') ? 'fal' : 'replicate';
                    }
                    
                    if (typeof updateVideoProviderSettings === 'function') {
                        updateVideoProviderSettings();
                    }
                }
                
                // Initialize 3D Generation provider (USE_REPLICATE_PROVIDER checkbox)
                const useFalProviderCheckbox = document.getElementById('USE_REPLICATE_PROVIDER');
                if (useFalProviderCheckbox) {
                    // Set checkbox based on config
                    useFalProviderCheckbox.checked = (this.config.USE_REPLICATE_PROVIDER === 'true' || this.config.USE_REPLICATE_PROVIDER === true);
                    
                    if (typeof update3DProviderSettings === 'function') {
                        update3DProviderSettings();
                    }
                }
                
                // Initialize AI Logo Type based on existing configuration
                const aiLogoType = this.config.NEXT_PUBLIC_AI_LOGO_TYPE;
                const aiLogoUrl = this.config.NEXT_PUBLIC_AI_RESPONSE_LOGO_URL;
                const useDefaultLogo = this.config.NEXT_PUBLIC_USE_DEFAULT_AI_LOGO === 'true' || this.config.NEXT_PUBLIC_USE_DEFAULT_AI_LOGO === true;
                
                // Determine which radio button to check
                let logoTypeToSelect = 'chat-bubble'; // default
                
                if (aiLogoType) {
                    logoTypeToSelect = aiLogoType;
                } else if (aiLogoUrl) {
                    // If there's a URL but no type, check if it's one of our defaults
                    if (aiLogoUrl.includes('/logos/defaults/')) {
                        const match = aiLogoUrl.match(/\/logos\/defaults\/(.+)\.svg/);
                        if (match) {
                            logoTypeToSelect = match[1];
                        } else {
                            logoTypeToSelect = 'custom';
                        }
                    } else {
                        logoTypeToSelect = 'custom';
                    }
                }
                
                // Select the appropriate radio button
                const radioToSelect = document.querySelector(`input[name="aiLogoType"][value="${logoTypeToSelect}"]`);
                if (radioToSelect) {
                    radioToSelect.checked = true;
                    radioToSelect.dispatchEvent(new Event('change'));
                }
                
                // If custom, populate the custom URL field
                if (logoTypeToSelect === 'custom' && aiLogoUrl) {
                    const customAiLogoUrl = document.getElementById('customAiLogoUrl');
                    if (customAiLogoUrl) {
                        customAiLogoUrl.value = aiLogoUrl;
                    }
                }
                
                // Initialize Token Limit Configuration
                const useCustomTokenLimit = document.getElementById('USE_CUSTOM_TOKEN_LIMIT');
                const maxCompletionTokens = document.getElementById('MAX_COMPLETION_TOKENS');
                const tokenLimitSettings = document.getElementById('token-limit-settings');
                
                if (this.config.MAX_COMPLETION_TOKENS) {
                    // If MAX_COMPLETION_TOKENS is set, enable custom limit
                    if (useCustomTokenLimit) {
                        useCustomTokenLimit.checked = true;
                    }
                    if (maxCompletionTokens) {
                        maxCompletionTokens.value = this.config.MAX_COMPLETION_TOKENS;
                    }
                    if (tokenLimitSettings) {
                        tokenLimitSettings.style.display = 'block';
                    }
                } else {
                    // Otherwise, use default limits
                    if (useCustomTokenLimit) {
                        useCustomTokenLimit.checked = false;
                    }
                    if (tokenLimitSettings) {
                        tokenLimitSettings.style.display = 'none';
                    }
                }
                
                // Initialize Welcome Text Customization
                const welcomeTextInput = document.getElementById('NEXT_PUBLIC_WELCOME_TEXT');
                const welcomeTextGradient = document.getElementById('NEXT_PUBLIC_WELCOME_TEXT_GRADIENT');
                const welcomeTextPreview = document.getElementById('welcomeTextPreview');
                const welcomeTextMode = this.config.NEXT_PUBLIC_WELCOME_TEXT_MODE || 'default';
                
                // Set initial preview text
                if (welcomeTextInput && welcomeTextPreview) {
                    welcomeTextPreview.textContent = welcomeTextInput.value || 'What can I help with?';
                }
                
                // Update mode indicator
                if (typeof updateModeIndicator === 'function') {
                    updateModeIndicator(welcomeTextMode);
                }
                
                // Update preview if updateWelcomeTextPreview is available
                if (typeof updateWelcomeTextPreview === 'function') {
                    updateWelcomeTextPreview();
                }
                
                // Initialize suggestions if we're on that tab
                const suggestionsTab = document.getElementById('suggestions');
                if (suggestionsTab && suggestionsTab.classList.contains('active')) {
                    setTimeout(() => {
                        suggestionsManager.init();
                        
                        // Initialize translation event listeners
                        const translateBtn = document.getElementById('translateAllBtn');
                        const revertBtn = document.getElementById('revertTranslationBtn');
                        const setDefaultBtn = document.getElementById('setAsDefaultBtn');
                        
                        if (translateBtn && !translateBtn.hasAttribute('data-initialized')) {
                            translateBtn.setAttribute('data-initialized', 'true');
                            translateBtn.addEventListener('click', () => {
                                suggestionsManager.translateAll();
                            });
                        }
                        
                        if (revertBtn && !revertBtn.hasAttribute('data-initialized')) {
                            revertBtn.setAttribute('data-initialized', 'true');
                            revertBtn.addEventListener('click', () => {
                                suggestionsManager.revertTranslation();
                            });
                        }
                        
                        if (setDefaultBtn && !setDefaultBtn.hasAttribute('data-initialized')) {
                            setDefaultBtn.setAttribute('data-initialized', 'true');
                            setDefaultBtn.addEventListener('click', () => {
                                suggestionsManager.setAsDefault();
                            });
                        }
                    }, 100);
                }
            }

            async saveConfig() {
                console.log('SaveConfig called - showing save indicator');
                
                // Show saving indicator immediately - handle both desktop and mobile
                const desktopIndicator = document.getElementById('desktop-save-indicator');
                const mobileIndicator = document.getElementById('mobile-save-indicator');
                
                if (desktopIndicator) {
                    desktopIndicator.classList.remove('hidden');
                    desktopIndicator.textContent = 'Saving...';
                    desktopIndicator.classList.add('alert-info');
                    desktopIndicator.classList.remove('alert-success', 'alert-error');
                }
                
                if (mobileIndicator) {
                    mobileIndicator.classList.remove('hidden');
                    mobileIndicator.textContent = 'Saving...';
                    mobileIndicator.classList.add('alert-info');
                    mobileIndicator.classList.remove('alert-success', 'alert-error');
                }
                
                try {
                    // First save the main config
                    const response = await fetch('/api/config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ config: this.config }),
                    });

                    if (!response.ok) {
                        console.error('Failed to save config');
                        if (desktopIndicator) {
                            desktopIndicator.textContent = 'Failed to save configuration';
                            desktopIndicator.classList.remove('alert-info', 'alert-success');
                            desktopIndicator.classList.add('alert-error');
                            setTimeout(() => desktopIndicator.classList.add('hidden'), 3000);
                        }
                        if (mobileIndicator) {
                            mobileIndicator.textContent = 'Failed to save';
                            mobileIndicator.classList.remove('alert-info', 'alert-success');
                            mobileIndicator.classList.add('alert-error');
                            setTimeout(() => mobileIndicator.classList.add('hidden'), 3000);
                        }
                        showToast('Failed to save configuration', 'error');
                        return;
                    }

                    // Also save RAG system prompt if we're on that tab
                    const systemPromptTab = document.getElementById('system-prompt');
                    const ragPreContextArea = document.getElementById('RAG_PRE_CONTEXT');
                    const ragPostContextArea = document.getElementById('RAG_POST_CONTEXT');
                    
                    if (systemPromptTab && systemPromptTab.classList.contains('active') && 
                        ragPreContextArea && ragPostContextArea) {
                        // Save RAG prompt
                        const ragSaved = await saveRagPrompt(false); // false = don't show toast
                        if (!ragSaved) {
                            showToast('Configuration saved but RAG prompt failed to save', 'warning');
                            return;
                        }
                    }

                    this.hasChanges = false;
                    
                    // Update indicators to show success
                    if (desktopIndicator) {
                        desktopIndicator.textContent = 'Configuration saved successfully!';
                        desktopIndicator.classList.remove('alert-info', 'alert-error', 'hidden');
                        desktopIndicator.classList.add('alert-success');
                        
                        // Hide after 3 seconds
                        setTimeout(() => {
                            desktopIndicator.classList.add('hidden');
                        }, 3000);
                    }
                    
                    if (mobileIndicator) {
                        mobileIndicator.textContent = 'Saved!';
                        mobileIndicator.classList.remove('alert-info', 'alert-error', 'hidden');
                        mobileIndicator.classList.add('alert-success');
                        
                        // Hide after 3 seconds
                        setTimeout(() => {
                            mobileIndicator.classList.add('hidden');
                        }, 3000);
                    }
                    
                    this.showSaveIndicator();
                    console.log('Config saved successfully');
                } catch (error) {
                    console.error('Error saving config:', error);
                    
                    // Update indicators to show error
                    if (desktopIndicator) {
                        desktopIndicator.textContent = 'Error saving configuration';
                        desktopIndicator.classList.remove('alert-info', 'alert-success');
                        desktopIndicator.classList.add('alert-error');
                        setTimeout(() => desktopIndicator.classList.add('hidden'), 3000);
                    }
                    
                    if (mobileIndicator) {
                        mobileIndicator.textContent = 'Error!';
                        mobileIndicator.classList.remove('alert-info', 'alert-success');
                        mobileIndicator.classList.add('alert-error');
                        setTimeout(() => mobileIndicator.classList.add('hidden'), 3000);
                    }
                    
                    showToast('Error saving configuration', 'error');
                }
            }

            updateConfig(key, value) {
                this.config[key] = value;
                this.hasChanges = true;
                
                // Update localStorage immediately for real-time UI updates
                if (typeof value === 'boolean') {
                    localStorage.setItem(key, value.toString());
                } else {
                    localStorage.setItem(key, value || '');
                }
                
                // Broadcast the change for real-time updates
                try {
                    const bc = new BroadcastChannel('chatrag-config');
                    bc.postMessage({ key, value });
                    bc.close();
                } catch (e) {
                    // BroadcastChannel might not be supported
                }
            }

            showSaveIndicator() {
                const desktopIndicator = document.getElementById('desktop-save-indicator');
                const mobileIndicator = document.getElementById('mobile-save-indicator');
                
                if (this.showRestartRequired) {
                    if (desktopIndicator) {
                        desktopIndicator.innerHTML = 'Configuration saved! <strong>Important:</strong> Run <code class="bg-base-300 px-1 rounded">rm -rf .next</code> then restart the app.';
                        desktopIndicator.classList.add('text-warning');
                        desktopIndicator.classList.remove('text-success', 'alert-success', 'hidden');
                    }
                    if (mobileIndicator) {
                        mobileIndicator.textContent = 'Saved! (Restart required)';
                        mobileIndicator.classList.add('text-warning');
                        mobileIndicator.classList.remove('text-success', 'alert-success', 'hidden');
                    }
                } else {
                    if (desktopIndicator) {
                        desktopIndicator.textContent = 'Configuration saved!';
                        desktopIndicator.classList.add('text-success', 'alert-success');
                        desktopIndicator.classList.remove('text-warning', 'hidden');
                    }
                    if (mobileIndicator) {
                        mobileIndicator.textContent = 'Saved!';
                        mobileIndicator.classList.add('text-success', 'alert-success');
                        mobileIndicator.classList.remove('text-warning', 'hidden');
                    }
                }
                
                setTimeout(() => {
                    if (desktopIndicator) desktopIndicator.classList.add('hidden');
                    if (mobileIndicator) mobileIndicator.classList.add('hidden');
                    this.showRestartRequired = false;
                }, 7000); // Increased to 7 seconds for the longer message
            }

            setupEventListeners() {
                // Prevent duplicate event listener registration
                if (this.listenersInitialized) {
                    console.log('Event listeners already initialized, skipping...');
                    return;
                }
                this.listenersInitialized = true;
                
                // Save buttons - handle both with better event binding
                const saveHandler = () => this.saveConfig();
                
                // Function to initialize save buttons
                const initSaveButtons = () => {
                    const saveBtn = document.getElementById('saveAllBtn');
                    const saveBtn2 = document.getElementById('saveAllBtn2');
                    
                    if (saveBtn) {
                        // Remove existing listeners by cloning
                        const newSaveBtn = saveBtn.cloneNode(true);
                        saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
                        newSaveBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            saveHandler();
                        });
                    }
                    
                    if (saveBtn2) {
                        // Remove existing listeners by cloning
                        const newSaveBtn2 = saveBtn2.cloneNode(true);
                        saveBtn2.parentNode.replaceChild(newSaveBtn2, saveBtn2);
                        newSaveBtn2.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            saveHandler();
                        });
                        // Also add onclick for redundancy
                        newSaveBtn2.onclick = function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            saveHandler();
                        };
                        console.log('Save button 2 initialized');
                    }
                };
                
                // Initialize immediately and with a delay
                initSaveButtons();
                setTimeout(initSaveButtons, 500);

                // MCP System toggle dependency - when MCP System is toggled, also toggle MCP Tools List
                const mcpSystemToggle = document.getElementById('NEXT_PUBLIC_MCP_SYSTEM_ENABLED');
                const mcpToolsListToggle = document.getElementById('NEXT_PUBLIC_MCP_TOOLS_LIST_ENABLED');

                if (mcpSystemToggle && mcpToolsListToggle) {
                    mcpSystemToggle.addEventListener('change', (e) => {
                        const isEnabled = e.target.checked;
                        console.log('[Config] MCP System toggled:', isEnabled);

                        // Update MCP Tools List to match MCP System state
                        mcpToolsListToggle.checked = isEnabled;

                        // Update the config for MCP Tools List
                        this.updateConfig('NEXT_PUBLIC_MCP_TOOLS_LIST_ENABLED', isEnabled);
                        console.log('[Config] MCP Tools List updated to match:', isEnabled);
                    });
                }

                // Handle image generation provider changes
                const imageProviderSelect = document.getElementById('IMAGE_GENERATION_PROVIDER');
                if (imageProviderSelect) {
                    imageProviderSelect.addEventListener('change', (e) => {
                        const provider = e.target.value;
                        console.log('[Config] Image generation provider changed to:', provider);
                        
                        // Update the main provider setting
                        this.updateConfig('IMAGE_GENERATION_PROVIDER', provider);
                        
                        // Update legacy toggles for backward compatibility
                        this.updateConfig('USE_OPENAI_IMAGE', provider === 'openai' ? 'true' : 'false');
                        
                        // Update the hidden legacy checkboxes
                        const useOpenAICheckbox = document.getElementById('USE_OPENAI_IMAGE');
                        if (useOpenAICheckbox) useOpenAICheckbox.checked = provider === 'openai';
                        
                        // Update UI
                        updateImageProviderSettings();
                        this.saveConfig();
                    });
                }
                
                // Handle video generation provider changes
                const videoProviderSelect = document.getElementById('VIDEO_GENERATION_PROVIDER');
                if (videoProviderSelect) {
                    videoProviderSelect.addEventListener('change', (e) => {
                        const provider = e.target.value;
                        console.log('[Config] Video generation provider changed to:', provider);
                        
                        this.updateConfig('VIDEO_GENERATION_PROVIDER', provider);
                        updateVideoProviderSettings();
                        this.saveConfig();
                    });
                }
                
                // Handle 3D provider changes (USE_REPLICATE_PROVIDER checkbox)
                const useFal3DCheckbox = document.getElementById('USE_REPLICATE_PROVIDER');
                if (useFal3DCheckbox) {
                    useFal3DCheckbox.addEventListener('change', (e) => {
                        const useFal = e.target.checked;
                        console.log('[Config] 3D provider changed - Use Fal:', useFal);
                        
                        this.updateConfig('USE_REPLICATE_PROVIDER', useFal ? 'true' : 'false');
                        update3DProviderSettings();
                        this.saveConfig();
                    });
                }
                
                // Media Generation field handlers
                const mediaFields = [
                    'NEXT_PUBLIC_MEDIA_GENERATION_MASTER',
                    'MEDIA_DEFAULT_QUALITY',
                    'OPENAI_IMAGE_MODEL',
                    'FAL_IMAGE_MODEL',
                    'FAL_INFERENCE_STEPS',
                    'FAL_GUIDANCE_SCALE',
                    'REPLICATE_IMAGE_MODEL',
                    'REPLICATE_CUSTOM_IMAGE_MODEL',
                    'FAL_VIDEO_MODEL',
                    'FAL_VIDEO_TEXT_MODEL',
                    'FAL_VIDEO_TEXT_FAST_MODEL',
                    'FAL_VIDEO_IMAGE_MODEL',
                    'FAL_VIDEO_IMAGE_FAST_MODEL',
                    'FAL_VIDEO_DURATION',
                    'FAL_VIDEO_FPS',
                    'FAL_VIDEO_RESOLUTION',
                    'REPLICATE_VIDEO_MODEL',
                    'VIDEO_GENERATION_PROVIDER',
                    '3D_GENERATION_PROVIDER',
                    'FAL_3D_MODEL',
                    'REPLICATE_3D_MODEL',
                    '3D_TEXTURE_SIZE',
                    '3D_MESH_SIMPLIFY',
                    '3D_SAMPLING_STEPS',
                    '3D_OUTPUT_FORMAT',
                    'USE_REPLICATE_PROVIDER'
                ];
                
                mediaFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.addEventListener('change', (e) => {
                            const value = field.type === 'checkbox' ? field.checked : field.value;
                            this.updateConfig(fieldId, value);
                            this.saveConfig();
                        });
                    }
                });

                // Auto-save on field changes
                document.addEventListener('change', (e) => {
                    if (e.target.matches('input, select, textarea')) {
                        // Skip file inputs - they should not be saved to config
                        if (e.target.type === 'file') {
                            return;
                        }
                        
                        // Special handling for aiLogoType radio buttons
                        if (e.target.type === 'radio' && e.target.name === 'aiLogoType') {
                            const selectedType = e.target.value;
                            console.log('[Config] AI Logo Type selected:', selectedType);
                            
                            // Update AI_LOGO_TYPE
                            this.updateConfig('NEXT_PUBLIC_AI_LOGO_TYPE', selectedType);
                            
                            // Update AI_RESPONSE_LOGO_URL based on selection
                            let logoUrl = '';
                            if (selectedType === 'custom') {
                                const customInput = document.getElementById('customAiLogoUrl');
                                logoUrl = customInput ? customInput.value : '';
                            } else {
                                logoUrl = `/logos/defaults/${selectedType}.svg`;
                            }
                            this.updateConfig('NEXT_PUBLIC_AI_RESPONSE_LOGO_URL', logoUrl);
                            
                            // Update backward compatibility flag (no longer using lucide)
                            this.updateConfig('NEXT_PUBLIC_USE_DEFAULT_AI_LOGO', 'false');
                            
                            console.log('[Config] Updated config:', {
                                'NEXT_PUBLIC_AI_LOGO_TYPE': selectedType,
                                'NEXT_PUBLIC_AI_RESPONSE_LOGO_URL': logoUrl
                            });
                            
                            // Trigger auto-save
                            clearTimeout(this.saveTimeout);
                            this.saveTimeout = setTimeout(() => {
                                this.saveConfig();
                            }, 1000);
                            
                            return; // Early return to skip the rest
                        }
                        
                        // Special handling for voice provider selection
                        if (e.target.id === 'NEXT_PUBLIC_VOICE_PROVIDER') {
                            const provider = e.target.value;
                            const openaiSettings = document.getElementById('openai-tts-settings');
                            const elevenLabsSettings = document.getElementById('elevenlabs-tts-settings');
                            
                            if (provider === 'elevenlabs') {
                                openaiSettings.style.display = 'none';
                                elevenLabsSettings.style.display = 'block';
                            } else {
                                openaiSettings.style.display = 'block';
                                elevenLabsSettings.style.display = 'none';
                            }
                        }
                        
                        // Special handling for AI provider selection
                        if (e.target.id === 'ai-provider-select') {
                            const provider = e.target.value;
                            this.updateConfig('NEXT_PUBLIC_AI_PROVIDER', provider);
                            
                            // Auto-save after 1 second delay
                            clearTimeout(this.saveTimeout);
                            this.saveTimeout = setTimeout(() => {
                                this.saveConfig();
                            }, 1000);
                            
                            return; // Early return to skip the general handling
                        }
                        
                        // Special handling for token limit configuration
                        if (e.target.id === 'USE_CUSTOM_TOKEN_LIMIT') {
                            const isChecked = e.target.checked;
                            const maxTokensInput = document.getElementById('MAX_COMPLETION_TOKENS');
                            
                            if (!isChecked) {
                                // Remove MAX_COMPLETION_TOKENS from config when disabled
                                delete this.config.MAX_COMPLETION_TOKENS;
                                if (maxTokensInput) {
                                    maxTokensInput.value = '';
                                }
                            }
                            
                            // Continue with normal checkbox handling
                        }
                        
                        if (e.target.id === 'MAX_COMPLETION_TOKENS') {
                            const value = e.target.value;
                            if (value && parseInt(value) > 0) {
                                this.updateConfig('MAX_COMPLETION_TOKENS', value);
                            } else {
                                // Remove from config if empty or invalid
                                delete this.config.MAX_COMPLETION_TOKENS;
                            }
                            
                            // Auto-save after 1 second delay
                            clearTimeout(this.saveTimeout);
                            this.saveTimeout = setTimeout(() => {
                                this.saveConfig();
                            }, 1000);
                            
                            return;
                        }
                        
                        const key = e.target.id;
                        
                        // Skip RAG prompt fields, template modal fields, translation fields, and admin form fields - they have their own save mechanism
                        if (key === 'RAG_PRE_CONTEXT' || key === 'RAG_POST_CONTEXT' || key === 'templateName' || key === 'templateDescription' || key === 'translationTargetLanguage' || key === 'translationProvider' || 
                            key === 'newAdminEmail' || key === 'new-model-id' || key === 'new-model-name' || key === 'ai-provider-select') {
                            return;
                        }
                        
                        let value = e.target.value;
                        
                        if (e.target.type === 'checkbox') {
                            value = e.target.checked.toString();
                        }
                        
                        // Skip template placeholders or values that look like template syntax
                        if (typeof value === 'string' && value.includes('{{') && value.includes('}}')) {
                            console.warn(`[Config UI] Skipping template placeholder value for ${key}: ${value}`);
                            return;
                        }
                        
                        // Skip problematic values
                        if (key === 'Context' || value === '{{context}}') {
                            console.warn(`[Config UI] Skipping problematic value for ${key}: ${value}`);
                            return;
                        }
                        
                        if (key) {
                            this.updateConfig(key, value);
                            
                            // No special handling needed for suggestions toggle - it works at runtime
                            
                            // Auto-save after 1 second delay
                            clearTimeout(this.saveTimeout);
                            this.saveTimeout = setTimeout(() => {
                                this.saveConfig();
                            }, 1000);
                        }
                    }
                });

                // Password reveal buttons
                document.addEventListener('click', (e) => {
                    // Check if the clicked element or its parent is a button with data-for
                    const button = e.target.closest('button[data-for]');
                    if (button) {
                        e.preventDefault();
                        e.stopPropagation();
                        const targetId = button.getAttribute('data-for');
                        const input = document.getElementById(targetId);
                        if (input) {
                            const isPassword = input.type === 'password';
                            input.type = isPassword ? 'text' : 'password';
                            button.textContent = isPassword ? 'üôà' : 'üëÅÔ∏è';
                        }
                    }
                });
                
                // Add event listeners for chat input text size slider
                const chatInputTextSizeSlider = document.getElementById('NEXT_PUBLIC_CHAT_INPUT_TEXT_SIZE');
                const chatInputTextSizeValue = document.getElementById('chatInputTextSizeValue');
                const chatInputPreview = document.getElementById('chatInputPreview');
                
                if (chatInputTextSizeSlider) {
                    chatInputTextSizeSlider.addEventListener('input', (e) => {
                        const size = e.target.value;
                        if (chatInputTextSizeValue) {
                            chatInputTextSizeValue.textContent = `${size}px`;
                        }
                        if (chatInputPreview) {
                            chatInputPreview.style.fontSize = `${size}px`;
                        }
                    });
                    
                    // Initialize value display and preview
                    const initialSize = chatInputTextSizeSlider.value || '18';
                    if (chatInputTextSizeValue) {
                        chatInputTextSizeValue.textContent = `${initialSize}px`;
                    }
                    if (chatInputPreview) {
                        chatInputPreview.style.fontSize = `${initialSize}px`;
                    }
                }
                
                // Add event listeners for ElevenLabs sliders to update displayed values
                const speedSlider = document.getElementById('ELEVENLABS_VOICE_SPEED');
                const speedValue = document.getElementById('speed-value');
                if (speedSlider && speedValue) {
                    speedSlider.addEventListener('input', (e) => {
                        speedValue.textContent = `(${e.target.value})`;
                    });
                    // Initialize value display
                    speedValue.textContent = `(${speedSlider.value})`;
                }
                
                const stabilitySlider = document.getElementById('ELEVENLABS_VOICE_STABILITY');
                const stabilityValue = document.getElementById('stability-value');
                if (stabilitySlider && stabilityValue) {
                    stabilitySlider.addEventListener('input', (e) => {
                        stabilityValue.textContent = `(${e.target.value})`;
                    });
                    // Initialize value display
                    stabilityValue.textContent = `(${stabilitySlider.value})`;
                }
                
                const similaritySlider = document.getElementById('ELEVENLABS_SIMILARITY_BOOST');
                const similarityValue = document.getElementById('similarity-value');
                if (similaritySlider && similarityValue) {
                    similaritySlider.addEventListener('input', (e) => {
                        similarityValue.textContent = `(${e.target.value})`;
                    });
                    // Initialize value display
                    similarityValue.textContent = `(${similaritySlider.value})`;
                }
            }
        }

        // Update mobile menu active state
        function updateMobileMenuActiveState() {
            const activeTab = document.querySelector('.menu .menu-item.active')?.getAttribute('data-tab') || 'features';
            const mobileMenuItems = document.querySelectorAll('.drawer-panel .menu-item');
            
            mobileMenuItems.forEach(item => {
                const itemTab = item.getAttribute('data-tab');
                if (itemTab === activeTab) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // Custom Mobile Drawer Implementation
        window.mobileDrawer = {
            element: null,
            isOpen: false,
            
            init: function() {
                this.element = document.getElementById('mobile-drawer');
                if (!this.element) {
                    console.error('Mobile drawer element not found');
                    return;
                }
                
                // Add click handler to backdrop
                const backdrop = this.element.querySelector('.drawer-backdrop');
                if (backdrop) {
                    backdrop.addEventListener('click', () => this.close());
                }
                
                // Add click handlers to menu items
                const menuItems = this.element.querySelectorAll('.menu-item');
                menuItems.forEach(item => {
                    item.addEventListener('click', () => {
                        // Close drawer when menu item is clicked
                        setTimeout(() => this.close(), 100);
                    });
                });
                
                console.log('Mobile drawer initialized');
            },
            
            open: function() {
                if (this.element) {
                    this.element.classList.add('open');
                    this.isOpen = true;
                    // Prevent body scrolling when drawer is open
                    document.body.style.overflow = 'hidden';
                    console.log('Drawer opened');
                }
            },
            
            close: function() {
                if (this.element) {
                    this.element.classList.remove('open');
                    this.isOpen = false;
                    // Restore body scrolling
                    document.body.style.overflow = '';
                    console.log('Drawer closed');
                }
            },
            
            toggle: function() {
                if (this.isOpen) {
                    this.close();
                } else {
                    this.open();
                }
            }
        };
        
        // Tab switching functionality
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing config UI');
            
            // Initialize the custom mobile drawer
            window.mobileDrawer.init();
            
            // Theme is now restored in the immediate initialization script at the top of the file
            
            // Function to close drawer
            function closeDrawer() {
                // Use the new custom drawer implementation
                if (window.mobileDrawer) {
                    window.mobileDrawer.close();
                }
            }
            
            
            const menuItems = document.querySelectorAll('.menu-item');
            const tabContents = document.querySelectorAll('.tab-content');
            
            console.log('Found menu items:', menuItems.length);
            console.log('Found tab contents:', tabContents.length);
            
            // Debug: Log all menu items
            menuItems.forEach((item, index) => {
                console.log(`Menu item ${index}:`, item.textContent, 'data-tab:', item.getAttribute('data-tab'));
            });
            
            menuItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Menu item clicked:', this.textContent);
                    const targetTab = this.getAttribute('data-tab');
                    console.log('Target tab:', targetTab);
                    
                    // Remove active class from all menu items
                    menuItems.forEach(mi => {
                        mi.classList.remove('active');
                    });
                    // Add active class to clicked item
                    this.classList.add('active');
                    
                    // Update all menu items with the same data-tab
                    document.querySelectorAll(`.menu-item[data-tab="${targetTab}"]`).forEach(item => {
                        item.classList.add('active');
                    });
                    
                    // Hide all tab contents
                    tabContents.forEach(tc => tc.classList.remove('active'));
                    // Show target tab content
                    const targetContent = document.getElementById(targetTab);
                    if (targetContent) {
                        targetContent.classList.add('active');
                        
                        // Close mobile drawer if open
                        closeDrawer();
                        
                        // Initialize specific tab functionality
                        if (targetTab === 'rag-prompt') {
                            // Initialize System Prompt when tab is opened
                            setTimeout(() => {
                                initSystemPrompt();
                            }, 100); // Small delay to ensure DOM is ready
                        } else if (targetTab === 'admin') {
                            // Initialize Admin Management when tab is opened
                            setTimeout(() => {
                                initAdminManagement();
                            }, 100); // Small delay to ensure DOM is ready
                        } else if (targetTab === 'advanced') {
                            // Initialize MCP Config when tab is opened
                            setTimeout(() => {
                                initMcpConfig();
                            }, 100); // Small delay to ensure DOM is ready
                        } else if (targetTab === 'suggestions') {
                            // Initialize Suggestions Manager when tab is opened
                            setTimeout(() => {
                                suggestionsManager.init();
                                
                                // Initialize translation event listeners
                                const translateBtn = document.getElementById('translateAllBtn');
                                const revertBtn = document.getElementById('revertTranslationBtn');
                                const setDefaultBtn = document.getElementById('setAsDefaultBtn');
                                
                                if (translateBtn && !translateBtn.hasAttribute('data-initialized')) {
                                    translateBtn.setAttribute('data-initialized', 'true');
                                    translateBtn.addEventListener('click', () => {
                                        suggestionsManager.translateAll();
                                    });
                                }
                                
                                if (revertBtn && !revertBtn.hasAttribute('data-initialized')) {
                                    revertBtn.setAttribute('data-initialized', 'true');
                                    revertBtn.addEventListener('click', () => {
                                        suggestionsManager.revertTranslation();
                                    });
                                }
                                
                                if (setDefaultBtn && !setDefaultBtn.hasAttribute('data-initialized')) {
                                    setDefaultBtn.setAttribute('data-initialized', 'true');
                                    setDefaultBtn.addEventListener('click', () => {
                                        suggestionsManager.setAsDefault();
                                    });
                                }
                            }, 100); // Small delay to ensure DOM is ready
                        } else if (targetTab === 'document-processing') {
                            // Initialize Document Manager when tab is opened
                            setTimeout(() => {
                                if (window.documentManager) {
                                    window.documentManager.init();
                                }
                            }, 100); // Small delay to ensure DOM is ready
                        } else if (targetTab === 'whatsapp') {
                            // Initialize WhatsApp configuration when tab is opened
                            setTimeout(() => {
                                initWhatsAppConfig();
                                // Add event listener for provider toggle
                                const providerSelect = document.getElementById('whatsapp-provider');
                                if (providerSelect) {
                                    providerSelect.removeEventListener('change', toggleWhatsAppProvider);
                                    providerSelect.addEventListener('change', toggleWhatsAppProvider);
                                }
                            }, 100); // Small delay to ensure DOM is ready
                        }
                    }
                });
            });

            // Theme toggle and save config are now handled by the event delegation system at the top of the file

            // Initialize config manager
            window.configManager = new ConfigManager();
            window.configManager.init();  // Initialize to load config and set up event listeners
            
            // Initialize MCP Config Manager if available
            if (typeof McpConfigManager !== 'undefined') {
                window.mcpManager = new McpConfigManager();
            }
            
            // Initialize Admin Manager
            window.adminManager = {
                async listAdmins() {
                    this.showResult('Loading admin list...');
                    try {
                        const response = await fetch('/api/admin/list');
                        const data = await response.json();
                        this.showResult(`Found ${data.admins?.length || 0} admin users: ${JSON.stringify(data, null, 2)}`);
                    } catch (error) {
                        this.showResult(`Error: ${error.message}`);
                    }
                },
                
                async setupAdmin() {
                    this.showResult('Setting up admin...');
                    try {
                        const email = document.getElementById('ADMIN_EMAIL').value;
                        const password = document.getElementById('ADMIN_PASSWORD').value;
                        
                        if (!email || !password) {
                            this.showResult('Please enter admin email and password first.');
                            return;
                        }
                        
                        const response = await fetch('/api/admin/setup', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email, password })
                        });
                        
                        const data = await response.json();
                        this.showResult(JSON.stringify(data, null, 2));
                    } catch (error) {
                        this.showResult(`Error: ${error.message}`);
                    }
                },
                
                async checkAdmin() {
                    this.showResult('Checking admin status...');
                    try {
                        const email = document.getElementById('ADMIN_EMAIL').value;
                        
                        if (!email) {
                            this.showResult('Please enter admin email first.');
                            return;
                        }
                        
                        const response = await fetch(`/api/admin/check?email=${encodeURIComponent(email)}`);
                        const data = await response.json();
                        this.showResult(JSON.stringify(data, null, 2));
                    } catch (error) {
                        this.showResult(`Error: ${error.message}`);
                    }
                },
                
                showResult(message) {
                    const resultDiv = document.getElementById('adminActionResult');
                    resultDiv.textContent = message;
                    resultDiv.classList.remove('hidden');
                }
            };
            
            // Embed Widget Functions
            window.embedManager = {
                copyToClipboard: function(text) {
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(text).then(function() {
                            console.log('Copied to clipboard');
                        }).catch(function(err) {
                            console.error('Failed to copy: ', err);
                        });
                    }
                },
                
                updateEmbedCodes: function() {
                    var siteUrl = 'https://your-domain.com';
                    var siteUrlInput = document.getElementById('NEXT_PUBLIC_SITE_URL');
                    if (siteUrlInput && siteUrlInput.value) {
                        siteUrl = siteUrlInput.value;
                    }
                    
                    // Get current configuration values
                    var primaryColor = document.getElementById('NEXT_PUBLIC_EMBED_PRIMARY_COLOR')?.value || '#FF6417';
                    var title = document.getElementById('NEXT_PUBLIC_EMBED_TITLE')?.value || 'ChatRAG Assistant';
                    var position = document.getElementById('NEXT_PUBLIC_EMBED_POSITION')?.value || 'bottom-right';
                    var greeting = document.getElementById('NEXT_PUBLIC_EMBED_GREETING')?.value || 'Hello! Development help you today?';
                    var model = document.getElementById('NEXT_PUBLIC_EMBED_MODEL')?.value || 'openai/gpt-4o-mini';
                    
                    // Update script code with data attributes
                    var scriptCode = '<script \n  src="' + siteUrl + '/embed/chat.js"\n';
                    if (primaryColor !== '#FF6417') {
                        scriptCode += '  data-primary-color="' + primaryColor + '"\n';
                    }
                    if (title !== 'ChatRAG Assistant') {
                        scriptCode += '  data-title="' + encodeURIComponent(title) + '"\n';
                    }
                    if (position !== 'bottom-right') {
                        scriptCode += '  data-position="' + position + '"\n';
                    }
                    if (greeting !== 'Hello! Development help you today?') {
                        scriptCode += '  data-greeting="' + encodeURIComponent(greeting) + '"\n';
                    }
                    if (model !== 'openai/gpt-4o-mini') {
                        scriptCode += '  data-model="' + model + '"\n';
                    }
                    scriptCode += '><\/script>';
                    
                    var scriptElement = document.getElementById('embedScriptCode');
                    if (scriptElement) {
                        scriptElement.textContent = scriptCode;
                    }
                }
            };
            
            // Suggestions Manager Functions
            window.suggestionsManager = {
                suggestionGroups: [],
                englishOriginal: null,
                customDefault: null,
                defaultLanguage: 'English',
                currentLanguage: 'English',
                
                init: function() {
                    console.log('Initializing suggestions manager...');
                    this.loadSuggestionGroups();
                },
                
                loadSuggestionGroups: function() {
                    console.log('Loading suggestion groups...');
                    const configValue = configManager.config.NEXT_PUBLIC_SUGGESTION_GROUPS || '';
                    
                    // Default English suggestion groups
                    const defaultEnglishGroups = [
                        {
                            id: 'tell-me-about',
                            label: 'Tell me about',
                            icon: 'FileText',
                            items: [
                                { text: 'ChatRAG and how it works' },
                                { text: 'what\'s included in the ChatRAG package' },
                                { text: 'ChatRAG pricing and plans' },
                                { text: 'the quick start guide' }
                            ]
                        },
                        {
                            id: 'how-do-i',
                            label: 'How do I',
                            icon: 'ListTodo',
                            items: [
                                { text: 'deploy ChatRAG on Vercel' },
                                { text: 'set up environment variables' },
                                { text: 'customize the UI and branding' },
                                { text: 'integrate custom AI models' }
                            ]
                        },
                        {
                            id: 'what-are',
                            label: 'What are',
                            icon: 'Globe',
                            items: [
                                { text: 'RAG capabilities and document processing features' },
                                { text: 'the available AI models and providers' },
                                { text: 'MCP tools and integrations' },
                                { text: 'authentication and user management options' }
                            ]
                        },
                        {
                            id: 'help-me-with',
                            label: 'Help me with',
                            icon: 'Paintbrush',
                            items: [
                                { text: 'understanding the difference between Starter and Professional' },
                                { text: 'troubleshooting common issues' },
                                { text: 'optimizing API costs and usage' },
                                { text: 'Discord community benefits' }
                            ]
                        }
                    ];
                    
                    if (configValue) {
                        try {
                            const parsedConfig = JSON.parse(configValue);
                            
                            // Check if it's the new format with metadata
                            if (parsedConfig.groups && parsedConfig.defaultLanguage !== undefined) {
                                // New format
                                this.suggestionGroups = parsedConfig.groups || [];
                                this.defaultLanguage = parsedConfig.defaultLanguage || 'English';
                                this.englishOriginal = parsedConfig.englishOriginal || defaultEnglishGroups;
                                this.customDefault = parsedConfig.customDefault || null;
                                this.currentLanguage = parsedConfig.currentLanguage || this.defaultLanguage;
                                
                                // Update UI to show default language
                                this.updateDefaultLanguageDisplay();
                            } else {
                                // Old format - migrate to new format
                                this.suggestionGroups = parsedConfig.groups || parsedConfig || [];
                                this.englishOriginal = defaultEnglishGroups;
                                this.defaultLanguage = 'English';
                                this.currentLanguage = 'English';
                                this.customDefault = null;
                            }
                            
                            console.log('Loaded suggestion groups:', this.suggestionGroups);
                            console.log('Default language:', this.defaultLanguage);
                        } catch (error) {
                            console.error('Error parsing NEXT_PUBLIC_SUGGESTION_GROUPS:', error);
                            this.suggestionGroups = defaultEnglishGroups;
                            this.englishOriginal = defaultEnglishGroups;
                            this.defaultLanguage = 'English';
                            this.currentLanguage = 'English';
                        }
                    } else {
                        // No config - use defaults
                        this.suggestionGroups = defaultEnglishGroups;
                        this.englishOriginal = defaultEnglishGroups;
                        this.defaultLanguage = 'English';
                        this.currentLanguage = 'English';
                    }
                    
                    this.renderGroups();
                    this.updateButtonStates();
                },
                
                renderGroups: function() {
                    const container = document.getElementById('suggestionGroupsList');
                    if (!container) return;
                    
                    container.innerHTML = '';
                    
                    if (this.suggestionGroups.length === 0) {
                        container.innerHTML = `
                            <div class="text-center text-base-content/60 py-8">
                                <p>No suggestion groups configured.</p>
                                <button class="btn btn-primary btn-sm mt-4" onclick="suggestionsManager.addGroup()">
                                    Add First Group
                                </button>
                            </div>
                        `;
                        return;
                    }
                    
                    this.suggestionGroups.forEach((group, index) => {
                        const groupEl = document.createElement('div');
                        groupEl.className = 'card bg-base-100 shadow-sm mb-4';
                        groupEl.innerHTML = `
                            <div class="card-body">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="flex items-center gap-3">
                                        <div class="flex items-center justify-center w-10 h-10 text-base-content/70">
                                            ${this.getIconEmoji(group.icon)}
                                        </div>
                                        <div>
                                            <input type="text" class="font-semibold bg-transparent border-b border-transparent hover:border-base-300 focus:border-primary px-1" 
                                                   value="${group.label}" 
                                                   onchange="suggestionsManager.updateGroupLabel(${index}, this.value)"
                                                   placeholder="Group Label">
                                            <div class="text-sm text-base-content/60 mt-1">
                                                Icon: 
                                                <div class="dropdown dropdown-bottom">
                                                    <button type="button" tabindex="0" class="btn btn-xs gap-4" onclick="event.stopPropagation()">
                                                        <span class="w-4 h-4">${this.getIconEmoji(group.icon)}</span>
                                                        <span>${group.icon}</span>
                                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                        </svg>
                                                    </button>
                                                    <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52 z-50">
                                                        <li><a href="#" onclick="event.preventDefault(); suggestionsManager.updateGroupIcon(${index}, 'FileText'); document.activeElement.blur();" class="flex items-center gap-4"><span class="w-4 h-4">${this.getIconEmoji('FileText')}</span><span>FileText</span></a></li>
                                                        <li><a href="#" onclick="event.preventDefault(); suggestionsManager.updateGroupIcon(${index}, 'ListTodo'); document.activeElement.blur();" class="flex items-center gap-4"><span class="w-4 h-4">${this.getIconEmoji('ListTodo')}</span><span>ListTodo</span></a></li>
                                                        <li><a href="#" onclick="event.preventDefault(); suggestionsManager.updateGroupIcon(${index}, 'Globe'); document.activeElement.blur();" class="flex items-center gap-4"><span class="w-4 h-4">${this.getIconEmoji('Globe')}</span><span>Globe</span></a></li>
                                                        <li><a href="#" onclick="event.preventDefault(); suggestionsManager.updateGroupIcon(${index}, 'Paintbrush'); document.activeElement.blur();" class="flex items-center gap-4"><span class="w-4 h-4">${this.getIconEmoji('Paintbrush')}</span><span>Paintbrush</span></a></li>
                                                        <li><a href="#" onclick="event.preventDefault(); suggestionsManager.updateGroupIcon(${index}, 'Search'); document.activeElement.blur();" class="flex items-center gap-4"><span class="w-4 h-4">${this.getIconEmoji('Search')}</span><span>Search</span></a></li>
                                                        <li><a href="#" onclick="event.preventDefault(); suggestionsManager.updateGroupIcon(${index}, 'Heart'); document.activeElement.blur();" class="flex items-center gap-4"><span class="w-4 h-4">${this.getIconEmoji('Heart')}</span><span>Heart</span></a></li>
                                                        <li><a href="#" onclick="event.preventDefault(); suggestionsManager.updateGroupIcon(${index}, 'Star'); document.activeElement.blur();" class="flex items-center gap-4"><span class="w-4 h-4">${this.getIconEmoji('Star')}</span><span>Star</span></a></li>
                                                        <li><a href="#" onclick="event.preventDefault(); suggestionsManager.updateGroupIcon(${index}, 'MessageCircle'); document.activeElement.blur();" class="flex items-center gap-4"><span class="w-4 h-4">${this.getIconEmoji('MessageCircle')}</span><span>MessageCircle</span></a></li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button class="btn btn-ghost btn-sm text-error" onclick="suggestionsManager.removeGroup(${index})">
                                        Remove
                                    </button>
                                </div>
                                
                                <div class="space-y-2">
                                    <div class="text-sm font-medium text-base-content/70">Suggestion Items:</div>
                                    ${(group.items || []).map((item, itemIndex) => `
                                        <div class="flex items-center gap-2">
                                            <span class="text-base-content/50">‚Ä¢</span>
                                            <input type="text" class="input input-sm input-bordered flex-1" 
                                                   value="${item.text}" 
                                                   onchange="suggestionsManager.updateItem(${index}, ${itemIndex}, this.value)"
                                                   placeholder="Suggestion text">
                                            <button class="btn btn-ghost btn-xs text-error" onclick="suggestionsManager.removeItem(${index}, ${itemIndex})">
                                                ‚úï
                                            </button>
                                        </div>
                                    `).join('')}
                                    
                                    <button class="btn btn-outline btn-xs btn-primary mt-2" onclick="suggestionsManager.addItem(${index})">
                                        + Add Item
                                    </button>
                                </div>
                            </div>
                        `;
                        container.appendChild(groupEl);
                    });
                    
                    // Add button for new group
                    const addBtn = document.createElement('div');
                    addBtn.className = 'text-center mt-4';
                    addBtn.innerHTML = `
                        <button class="btn btn-primary btn-sm" onclick="suggestionsManager.addGroup()">
                            + Add New Group
                        </button>
                    `;
                    container.appendChild(addBtn);
                },
                
                getIconEmoji: function(icon) {
                    // Return SVG icons that match the Lucide React icons used in ChatRAG
                    const iconMap = {
                        'FileText': '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>',
                        'ListTodo': '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="5" width="6" height="6" rx="1"></rect><path d="m3 17 2 2 4-4"></path><path d="M13 6h8"></path><path d="M13 12h8"></path><path d="M13 18h8"></path></svg>',
                        'Globe': '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>',
                        'Paintbrush': '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18.37 2.63 14 7l-1.59-1.59a2 2 0 0 0-2.82 0L8 7l9 9 1.59-1.59a2 2 0 0 0 0-2.82L17 10l4.37-4.37a2.12 2.12 0 1 0-3-3Z"></path><path d="M9 8c-2 3-4 3.5-7 4l8 10c2-1 6-5 6-7"></path><path d="M14.5 17.5 4.5 15"></path></svg>',
                        'Search': '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>',
                        'Heart': '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>',
                        'Star': '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>',
                        'MessageCircle': '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>'
                    };
                    return iconMap[icon] || iconMap['FileText'];
                },
                
                addGroup: function() {
                    const newGroup = {
                        id: `group-${Date.now()}`,
                        label: 'New Group',
                        icon: 'FileText',
                        items: [
                            { text: 'Sample suggestion' }
                        ]
                    };
                    this.suggestionGroups.push(newGroup);
                    this.renderGroups();
                    this.saveGroups();
                },
                
                removeGroup: function(index) {
                    if (confirm('Are you sure you want to remove this suggestion group?')) {
                        this.suggestionGroups.splice(index, 1);
                        this.renderGroups();
                        this.saveGroups();
                    }
                },
                
                updateGroupLabel: function(index, value) {
                    this.suggestionGroups[index].label = value;
                    this.saveGroups();
                },
                
                updateGroupIcon: function(index, value) {
                    this.suggestionGroups[index].icon = value;
                    this.renderGroups();
                    this.saveGroups();
                },
                
                addItem: function(groupIndex) {
                    if (!this.suggestionGroups[groupIndex].items) {
                        this.suggestionGroups[groupIndex].items = [];
                    }
                    this.suggestionGroups[groupIndex].items.push({ text: '' });
                    this.renderGroups();
                    this.saveGroups();
                },
                
                removeItem: function(groupIndex, itemIndex) {
                    this.suggestionGroups[groupIndex].items.splice(itemIndex, 1);
                    this.renderGroups();
                    this.saveGroups();
                },
                
                updateItem: function(groupIndex, itemIndex, value) {
                    this.suggestionGroups[groupIndex].items[itemIndex].text = value;
                    this.saveGroups();
                },
                
                saveGroups: function() {
                    // Save the complete structure with metadata
                    const config = {
                        groups: this.suggestionGroups,
                        defaultLanguage: this.defaultLanguage,
                        currentLanguage: this.currentLanguage,
                        englishOriginal: this.englishOriginal,
                        customDefault: this.customDefault
                    };
                    const jsonStr = JSON.stringify(config);
                    configManager.updateConfig('NEXT_PUBLIC_SUGGESTION_GROUPS', jsonStr);
                    
                    // Trigger auto-save
                    clearTimeout(configManager.saveTimeout);
                    configManager.saveTimeout = setTimeout(() => {
                        configManager.saveConfig();
                    }, 1000);
                },
                
                // Translation functionality
                translateAll: async function() {
                    const targetLanguage = document.getElementById('translationTargetLanguage').value.trim();
                    const provider = document.getElementById('translationProvider').value;
                    
                    if (!targetLanguage) {
                        this.showTranslationStatus('Please enter a target language', 'error');
                        return;
                    }
                    
                    // Ensure we have the English original stored
                    if (!this.englishOriginal) {
                        // If current language is English, save it as the original
                        if (this.currentLanguage === 'English') {
                            this.englishOriginal = JSON.parse(JSON.stringify(this.suggestionGroups));
                        }
                    }
                    
                    // Collect all texts to translate
                    const textsToTranslate = [];
                    this.suggestionGroups.forEach(group => {
                        textsToTranslate.push(group.label);
                        if (group.items) {
                            group.items.forEach(item => {
                                textsToTranslate.push(item.text);
                            });
                        }
                    });
                    
                    if (textsToTranslate.length === 0) {
                        this.showTranslationStatus('No texts to translate', 'error');
                        return;
                    }
                    
                    // Show loading state
                    const translateBtn = document.getElementById('translateAllBtn');
                    const originalBtnText = translateBtn.innerHTML;
                    translateBtn.disabled = true;
                    translateBtn.innerHTML = '<span class="loading loading-spinner"></span> Translating...';
                    this.showTranslationStatus(`Translating ${textsToTranslate.length} texts to ${targetLanguage}...`, 'info');
                    
                    try {
                        // Call translation API
                        const response = await fetch('/api/translate', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                targetLanguage,
                                texts: textsToTranslate,
                                provider
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(result.error || 'Translation failed');
                        }
                        
                        // Map translations back to groups
                        let textIndex = 0;
                        this.suggestionGroups.forEach(group => {
                            group.label = result.translations[textIndex++];
                            if (group.items) {
                                group.items.forEach(item => {
                                    item.text = result.translations[textIndex++];
                                });
                            }
                        });
                        
                        // Update UI and save
                        this.currentLanguage = targetLanguage;
                        this.renderGroups();
                        this.saveGroups();
                        
                        // Update button states
                        this.updateButtonStates();
                        
                        this.showTranslationStatus(`Successfully translated to ${targetLanguage}!`, 'success');
                        
                    } catch (error) {
                        console.error('Translation error:', error);
                        this.showTranslationStatus(error.message || 'Translation failed', 'error');
                    } finally {
                        // Restore button state
                        translateBtn.disabled = false;
                        translateBtn.innerHTML = originalBtnText;
                    }
                },
                
                revertTranslation: function() {
                    // Determine what to revert to
                    let revertGroups;
                    let revertLanguage;
                    
                    if (this.defaultLanguage === 'English') {
                        // Revert to English original
                        if (!this.englishOriginal) {
                            this.showTranslationStatus('No English original text found', 'error');
                            return;
                        }
                        revertGroups = this.englishOriginal;
                        revertLanguage = 'English';
                    } else {
                        // Revert to custom default
                        if (!this.customDefault) {
                            // Fallback to English if custom default is missing
                            if (!this.englishOriginal) {
                                this.showTranslationStatus('No default text to revert to', 'error');
                                return;
                            }
                            revertGroups = this.englishOriginal;
                            revertLanguage = 'English';
                        } else {
                            revertGroups = this.customDefault;
                            revertLanguage = this.defaultLanguage;
                        }
                    }
                    
                    // Restore groups
                    this.suggestionGroups = JSON.parse(JSON.stringify(revertGroups));
                    this.currentLanguage = revertLanguage;
                    
                    // Update UI and save
                    this.renderGroups();
                    this.saveGroups();
                    this.updateButtonStates();
                    
                    // Clear translation input if reverting to default
                    if (this.currentLanguage === this.defaultLanguage) {
                        document.getElementById('translationTargetLanguage').value = '';
                    }
                    
                    this.showTranslationStatus(`Reverted to ${revertLanguage}`, 'success');
                },
                
                showTranslationStatus: function(message, type = 'info') {
                    const statusDiv = document.getElementById('translationStatus');
                    const statusText = document.getElementById('translationStatusText');
                    const alertDiv = statusDiv.querySelector('.alert');
                    
                    // Update message
                    statusText.textContent = message;
                    
                    // Update alert class based on type
                    alertDiv.className = 'alert';
                    switch(type) {
                        case 'success':
                            alertDiv.classList.add('alert-success');
                            break;
                        case 'error':
                            alertDiv.classList.add('alert-error');
                            break;
                        default:
                            alertDiv.classList.add('alert-info');
                    }
                    
                    // Show status
                    statusDiv.classList.remove('hidden');
                    
                    // Auto-hide after 5 seconds for success/info
                    if (type !== 'error') {
                        setTimeout(() => {
                            statusDiv.classList.add('hidden');
                        }, 5000);
                    }
                },
                
                setAsDefault: function() {
                    if (this.currentLanguage === 'English') {
                        this.showTranslationStatus('Current language is already English (the original default)', 'info');
                        return;
                    }
                    
                    // Save current groups as custom default
                    this.customDefault = JSON.parse(JSON.stringify(this.suggestionGroups));
                    this.defaultLanguage = this.currentLanguage;
                    
                    // Save to config
                    this.saveGroups();
                    
                    // Update UI
                    this.updateDefaultLanguageDisplay();
                    this.updateButtonStates();
                    
                    this.showTranslationStatus(`${this.currentLanguage} is now set as the default language!`, 'success');
                },
                
                updateDefaultLanguageDisplay: function() {
                    const defaultLangText = document.getElementById('defaultLanguageText');
                    if (defaultLangText) {
                        defaultLangText.textContent = this.defaultLanguage;
                    }
                    
                    // Update revert button text
                    const revertBtnText = document.getElementById('revertBtnText');
                    if (revertBtnText) {
                        revertBtnText.textContent = `Revert to ${this.defaultLanguage}`;
                    }
                },
                
                updateButtonStates: function() {
                    const setDefaultBtn = document.getElementById('setAsDefaultBtn');
                    const revertBtn = document.getElementById('revertTranslationBtn');
                    
                    if (setDefaultBtn) {
                        // Enable "Set as Default" only if current language is different from default
                        // and we're not already on English (which is always the base default)
                        setDefaultBtn.disabled = this.currentLanguage === this.defaultLanguage || 
                                               this.currentLanguage === 'English';
                    }
                    
                    if (revertBtn) {
                        // Enable revert if current language is different from default
                        revertBtn.disabled = this.currentLanguage === this.defaultLanguage;
                    }
                }
            };
            
            // Copy button event listeners
            var copyScriptBtn = document.getElementById('copyScriptBtn');
            if (copyScriptBtn) {
                copyScriptBtn.addEventListener('click', function() {
                    var code = document.getElementById('embedScriptCode');
                    if (code && embedManager.copyToClipboard) {
                        embedManager.copyToClipboard(code.textContent);
                    }
                });
            }
            
            // Update embed codes when site URL changes
            var siteUrlInput = document.getElementById('NEXT_PUBLIC_SITE_URL');
            if (siteUrlInput) {
                siteUrlInput.addEventListener('input', function() {
                    if (embedManager.updateEmbedCodes) {
                        embedManager.updateEmbedCodes();
                    }
                });
            }
            
            // Update embed codes when model changes
            var modelSelect = document.getElementById('NEXT_PUBLIC_EMBED_MODEL');
            if (modelSelect) {
                modelSelect.addEventListener('change', function() {
                    if (embedManager.updateEmbedCodes) {
                        embedManager.updateEmbedCodes();
                    }
                });
            }
            
            // Initialize embed codes
            if (embedManager.updateEmbedCodes) {
                embedManager.updateEmbedCodes();
            }
            
            // Handle branding logo type switching
            const logoTypeSelect = document.getElementById('NEXT_PUBLIC_HEADER_LOGO_TYPE');
            const textGroup = document.getElementById('headerLogoTextGroup');
            const urlGroup = document.getElementById('headerLogoUrlGroup');
            
            function updateLogoFields() {
                const logoType = logoTypeSelect.value;
                if (logoType === 'text') {
                    textGroup.classList.remove('hidden');
                    urlGroup.classList.add('hidden');
                } else {
                    textGroup.classList.add('hidden');
                    urlGroup.classList.remove('hidden');
                }
            }
            
            if (logoTypeSelect) {
                logoTypeSelect.addEventListener('change', updateLogoFields);
                // Initialize on page load
                updateLogoFields();
            }
            
            // Handle file uploads for logos
            const headerLogoFile = document.getElementById('headerLogoFile');
            const aiLogoFile = document.getElementById('aiLogoFile');
            
            if (headerLogoFile) {
                headerLogoFile.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const headerLogoUrl = document.getElementById('NEXT_PUBLIC_HEADER_LOGO_URL');
                            if (headerLogoUrl) {
                                headerLogoUrl.value = e.target.result;
                                // Trigger config update
                                headerLogoUrl.dispatchEvent(new Event('change'));
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
            
            if (aiLogoFile) {
                aiLogoFile.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const customAiLogoUrl = document.getElementById('customAiLogoUrl');
                            const aiLogoUrl = document.getElementById('NEXT_PUBLIC_AI_RESPONSE_LOGO_URL');
                            if (customAiLogoUrl && aiLogoUrl) {
                                customAiLogoUrl.value = e.target.result;
                                aiLogoUrl.value = e.target.result;
                                // Trigger config update
                                aiLogoUrl.dispatchEvent(new Event('change'));
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
            
            // Handle AI Logo Type Radio Buttons  
            const customAiLogoGroup = document.getElementById('customAiLogoGroup');
            const aiLogoTypeRadios = document.querySelectorAll('input[name="aiLogoType"]');
            
            // Handle showing/hiding the custom logo group and update hidden inputs
            const aiLogoTypeInput = document.getElementById('NEXT_PUBLIC_AI_LOGO_TYPE');
            const aiLogoUrlInput = document.getElementById('NEXT_PUBLIC_AI_RESPONSE_LOGO_URL');
            const customAiLogoUrlInput = document.getElementById('customAiLogoUrl');
            
            aiLogoTypeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const selectedType = this.value;
                    
                    // Show/hide custom logo upload
                    if (customAiLogoGroup) {
                        if (selectedType === 'custom') {
                            customAiLogoGroup.classList.remove('hidden');
                        } else {
                            customAiLogoGroup.classList.add('hidden');
                        }
                    }
                    
                    // Update hidden inputs to match
                    if (aiLogoTypeInput) {
                        aiLogoTypeInput.value = selectedType;
                    }
                    
                    if (aiLogoUrlInput) {
                        if (selectedType === 'custom') {
                            aiLogoUrlInput.value = customAiLogoUrlInput ? customAiLogoUrlInput.value : '';
                        } else {
                            aiLogoUrlInput.value = `/logos/defaults/${selectedType}.svg`;
                        }
                    }
                });
            });
            
            // Handle custom logo URL input changes
            if (customAiLogoUrlInput) {
                customAiLogoUrlInput.addEventListener('input', function() {
                    if (aiLogoUrlInput) {
                        aiLogoUrlInput.value = this.value;
                    }
                });
            }
            
            // Handle Welcome Text Customization
            const welcomeTextInput = document.getElementById('NEXT_PUBLIC_WELCOME_TEXT');
            const welcomeTextGradient = document.getElementById('NEXT_PUBLIC_WELCOME_TEXT_GRADIENT');
            const welcomeTextPreview = document.getElementById('welcomeTextPreview');
            // Note: resetWelcomeTextBtn doesn't exist - using resetWelcomeMessagesBtn for both modes
            const translateWelcomeTextBtn = document.getElementById('translateWelcomeTextBtn');
            const welcomeTextModeIndicator = document.getElementById('welcomeTextModeIndicator');
            const welcomeTextTranslationStatus = document.getElementById('welcomeTextTranslationStatus');
            const translationStatusText = document.getElementById('translationStatusText');
            
            // Dynamic messages elements
            const welcomeTextModeSelect = document.getElementById('welcomeTextModeSelect');
            const singleWelcomeTextSection = document.getElementById('singleWelcomeTextSection');
            const dynamicMessagesSection = document.getElementById('dynamicMessagesSection');
            const welcomeMessagesList = document.getElementById('welcomeMessagesList');
            const messagesCountBadge = document.getElementById('messagesCountBadge');
            const newWelcomeMessageInput = document.getElementById('newWelcomeMessageInput');
            const addWelcomeMessageBtn = document.getElementById('addWelcomeMessageBtn');
            const resetWelcomeMessagesBtn = document.getElementById('resetWelcomeMessagesBtn');
            const generateWelcomeMessagesBtn = document.getElementById('generateWelcomeMessagesBtn');
            const translateWelcomeMessagesBtn = document.getElementById('translateWelcomeMessagesBtn');
            const welcomeMessagesStatus = document.getElementById('welcomeMessagesStatus');
            const welcomeMessagesStatusAlert = document.getElementById('welcomeMessagesStatusAlert');
            const welcomeMessagesStatusText = document.getElementById('welcomeMessagesStatusText');
            const refreshPreviewBtn = document.getElementById('refreshPreviewBtn');
            
            // Default welcome messages
            const defaultWelcomeMessages = [
                "Hey, {Username}! What can I help you with today?",
                "Ready when you are.",
                "Good to see you, {Username}.",
                "What's on your mind?",
                "Hi there, {Username}. How can I assist?",
                "Let's get started!",
                "Welcome back, {Username}!",
                "How can I help?",
                "Hey! Ready to dive in?",
                "Hi, {Username}. What would you like to explore today?"
            ];
            
            // Load welcome messages from config
            let welcomeMessages = [];
            try {
                const messagesStr = localStorage.getItem('NEXT_PUBLIC_WELCOME_MESSAGES') || 
                                   this.config?.NEXT_PUBLIC_WELCOME_MESSAGES || 
                                   '[]';
                welcomeMessages = JSON.parse(messagesStr);
                if (!Array.isArray(welcomeMessages) || welcomeMessages.length === 0) {
                    welcomeMessages = defaultWelcomeMessages;
                }
            } catch (e) {
                welcomeMessages = defaultWelcomeMessages;
            }
            
            // Initialize welcome mode sections on load
            const currentMode = localStorage.getItem('NEXT_PUBLIC_WELCOME_TEXT_MODE') || 'custom';
            if (welcomeTextModeSelect) {
                welcomeTextModeSelect.value = currentMode;
            }
            
            // Show/hide sections based on saved mode
            if (singleWelcomeTextSection) {
                singleWelcomeTextSection.style.display = currentMode === 'custom' ? 'block' : 'none';
            }
            if (dynamicMessagesSection) {
                dynamicMessagesSection.style.display = currentMode === 'dynamic' ? 'block' : 'none';
            }
            const manualUsernameSection = document.getElementById('manualUsernameSection');
            if (manualUsernameSection) {
                manualUsernameSection.style.display = currentMode === 'dynamic' ? 'block' : 'none';
            }
            
            // Function to render welcome messages list
            function renderWelcomeMessages() {
                if (!welcomeMessagesList) return;
                
                welcomeMessagesList.innerHTML = '';
                welcomeMessages.forEach((message, index) => {
                    const messageItem = document.createElement('div');
                    messageItem.className = 'flex items-center gap-2 p-2 bg-base-200 rounded-lg';
                    messageItem.innerHTML = `
                        <span class="flex-1 text-sm">${message.replace(/{Username}/g, '<span class="font-semibold text-primary">John</span>')}</span>
                        <button class="btn btn-xs btn-ghost" onclick="editWelcomeMessage(${index})">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <button class="btn btn-xs btn-ghost text-error" onclick="deleteWelcomeMessage(${index})">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 6h18"></path>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    `;
                    welcomeMessagesList.appendChild(messageItem);
                });
                
                // Update count badge
                if (messagesCountBadge) {
                    messagesCountBadge.textContent = `${welcomeMessages.length} message${welcomeMessages.length !== 1 ? 's' : ''}`;
                }
            }
            
            // Global functions for editing and deleting messages
            window.editWelcomeMessage = function(index) {
                const message = welcomeMessages[index];
                const newMessage = prompt('Edit message:', message);
                if (newMessage && newMessage.trim()) {
                    welcomeMessages[index] = newMessage.trim();
                    configManager.updateConfig('NEXT_PUBLIC_WELCOME_MESSAGES', JSON.stringify(welcomeMessages));
                    renderWelcomeMessages();
                    updateWelcomePreview();
                }
            };
            
            window.deleteWelcomeMessage = function(index) {
                if (welcomeMessages.length <= 1) {
                    alert('You must have at least one welcome message.');
                    return;
                }
                if (confirm('Delete this message?')) {
                    welcomeMessages.splice(index, 1);
                    configManager.updateConfig('NEXT_PUBLIC_WELCOME_MESSAGES', JSON.stringify(welcomeMessages));
                    renderWelcomeMessages();
                    updateWelcomePreview();
                }
            };
            
            // Function to update welcome preview
            function updateWelcomePreview() {
                if (!welcomeTextPreview) return;
                
                const mode = welcomeTextModeSelect?.value || 'dynamic';
                
                if (mode === 'dynamic' && welcomeMessages.length > 0) {
                    const randomIndex = Math.floor(Math.random() * welcomeMessages.length);
                    const message = welcomeMessages[randomIndex];
                    const displayMessage = message.replace(/{Username}/g, 'John');
                    welcomeTextPreview.textContent = displayMessage;
                } else if (mode === 'custom') {
                    welcomeTextPreview.textContent = welcomeTextInput?.value || 'What can I help with?';
                } else {
                    welcomeTextPreview.textContent = 'What can I help with?';
                }
                
                updateWelcomeTextPreview(); // Apply gradient
            }
            
            // Handle mode selection
            if (welcomeTextModeSelect) {
                welcomeTextModeSelect.addEventListener('change', function() {
                    const mode = this.value;
                    configManager.updateConfig('NEXT_PUBLIC_WELCOME_TEXT_MODE', mode);
                    
                    // Show/hide sections based on mode
                    if (singleWelcomeTextSection) {
                        singleWelcomeTextSection.style.display = mode === 'custom' ? 'block' : 'none';
                    }
                    if (dynamicMessagesSection) {
                        dynamicMessagesSection.style.display = mode === 'dynamic' ? 'block' : 'none';
                    }
                    // Show manual username section only for dynamic mode
                    const manualUsernameSection = document.getElementById('manualUsernameSection');
                    if (manualUsernameSection) {
                        manualUsernameSection.style.display = mode === 'dynamic' ? 'block' : 'none';
                    }
                    
                    updateWelcomePreview();
                });
            }
            
            // Handle add message button
            if (addWelcomeMessageBtn) {
                addWelcomeMessageBtn.addEventListener('click', function() {
                    const newMessage = newWelcomeMessageInput?.value?.trim();
                    if (newMessage) {
                        welcomeMessages.push(newMessage);
                        configManager.updateConfig('NEXT_PUBLIC_WELCOME_MESSAGES', JSON.stringify(welcomeMessages));
                        renderWelcomeMessages();
                        newWelcomeMessageInput.value = '';
                        updateWelcomePreview();
                    }
                });
            }
            
            // Handle refresh preview button
            if (refreshPreviewBtn) {
                refreshPreviewBtn.addEventListener('click', function() {
                    updateWelcomePreview();
                });
            }
            
            // Handle reset button (works for both single text and dynamic messages)
            if (resetWelcomeMessagesBtn) {
                resetWelcomeMessagesBtn.addEventListener('click', function() {
                    // Check current mode
                    const currentMode = welcomeTextModeSelect?.value || 'custom';
                    
                    if (currentMode === 'custom') {
                        // Reset single welcome text
                        configManager.updateConfig('NEXT_PUBLIC_WELCOME_TEXT_MODE', 'custom');
                        configManager.updateConfig('NEXT_PUBLIC_WELCOME_TEXT', 'What can I help with?');
                        configManager.updateConfig('NEXT_PUBLIC_WELCOME_TEXT_TRANSLATIONS', '{}');
                        
                        // Update UI immediately
                        if (welcomeTextInput) {
                            welcomeTextInput.value = 'What can I help with?';
                            welcomeTextInput.dispatchEvent(new Event('input', { bubbles: true }));
                        }
                        if (welcomeTextPreview) {
                            welcomeTextPreview.textContent = 'What can I help with?';
                        }
                        updateModeIndicator('custom');
                        
                        // Force broadcast
                        try {
                            const bc = new BroadcastChannel('chatrag-config');
                            bc.postMessage({ key: 'NEXT_PUBLIC_WELCOME_TEXT', value: 'What can I help with?' });
                            bc.postMessage({ key: 'NEXT_PUBLIC_WELCOME_TEXT_MODE', value: 'custom' });
                            bc.close();
                        } catch (e) {
                            console.error('Failed to broadcast:', e);
                        }
                        
                        // Save config
                        setTimeout(() => {
                            configManager.saveConfig();
                        }, 100);
                    } else if (currentMode === 'dynamic') {
                        // Reset dynamic messages
                        if (confirm('Reset to default welcome messages?')) {
                            welcomeMessages = [...defaultWelcomeMessages];
                            configManager.updateConfig('NEXT_PUBLIC_WELCOME_MESSAGES', JSON.stringify(welcomeMessages));
                            configManager.updateConfig('NEXT_PUBLIC_WELCOME_MESSAGES_TRANSLATIONS', '{}');
                            renderWelcomeMessages();
                            updateWelcomePreview();
                        }
                    }
                });
            }
            
            // Initialize messages list
            renderWelcomeMessages();
            
            // Handle welcome text input change (for custom mode)
            if (welcomeTextInput) {
                welcomeTextInput.addEventListener('input', function() {
                    // Update preview text
                    if (welcomeTextPreview && welcomeTextModeSelect?.value === 'custom') {
                        welcomeTextPreview.textContent = this.value || 'What can I help with?';
                    }
                    // Update config
                    configManager.updateConfig('NEXT_PUBLIC_WELCOME_TEXT', this.value);
                    
                    // If text changes and we're not in default mode, switch to custom
                    const currentMode = localStorage.getItem('NEXT_PUBLIC_WELCOME_TEXT_MODE') || 'default';
                    if (currentMode === 'default' && this.value !== 'What can I help with?') {
                        configManager.updateConfig('NEXT_PUBLIC_WELCOME_TEXT_MODE', 'custom');
                        updateModeIndicator('custom');
                    }
                });
            }
            
            // Handle gradient selection change
            if (welcomeTextGradient) {
                welcomeTextGradient.addEventListener('change', function() {
                    configManager.updateConfig('NEXT_PUBLIC_WELCOME_TEXT_GRADIENT', this.value);
                    updateWelcomeTextPreview();
                });
            }
            
            // Handle generate welcome messages button
            if (generateWelcomeMessagesBtn) {
                generateWelcomeMessagesBtn.addEventListener('click', async function() {
                    try {
                        // Show loading state
                        this.disabled = true;
                        const originalContent = this.innerHTML;
                        this.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Generating...';
                        welcomeMessagesStatus?.classList.remove('hidden');
                        welcomeMessagesStatusAlert?.classList.add('alert-info');
                        welcomeMessagesStatusAlert?.classList.remove('alert-success', 'alert-error');
                        if (welcomeMessagesStatusText) {
                            welcomeMessagesStatusText.textContent = 'Generating new welcome messages with AI...';
                        }
                        
                        // Call generation API
                        const response = await fetch('/api/generate-welcome-messages', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                count: 10,
                                style: 'friendly and engaging',
                                includeUsername: true
                            })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.messages && Array.isArray(data.messages)) {
                                // Add new messages to existing ones
                                welcomeMessages = [...welcomeMessages, ...data.messages];
                                configManager.updateConfig('NEXT_PUBLIC_WELCOME_MESSAGES', JSON.stringify(welcomeMessages));
                                renderWelcomeMessages();
                                updateWelcomePreview();
                                
                                // Show success
                                welcomeMessagesStatusAlert?.classList.remove('alert-info', 'alert-error');
                                welcomeMessagesStatusAlert?.classList.add('alert-success');
                                if (welcomeMessagesStatusText) {
                                    welcomeMessagesStatusText.textContent = `Successfully generated ${data.messages.length} new messages!`;
                                }
                            }
                        } else {
                            throw new Error('Failed to generate messages');
                        }
                        
                        // Reset button
                        this.innerHTML = originalContent;
                        this.disabled = false;
                        
                        // Hide status after 3 seconds
                        setTimeout(() => {
                            welcomeMessagesStatus?.classList.add('hidden');
                        }, 3000);
                    } catch (error) {
                        console.error('Error generating messages:', error);
                        welcomeMessagesStatusAlert?.classList.remove('alert-info', 'alert-success');
                        welcomeMessagesStatusAlert?.classList.add('alert-error');
                        if (welcomeMessagesStatusText) {
                            welcomeMessagesStatusText.textContent = 'Failed to generate messages. Please try again.';
                        }
                        this.innerHTML = originalContent;
                        this.disabled = false;
                    }
                });
            }
            
            // Handle translate welcome messages button
            if (translateWelcomeMessagesBtn) {
                translateWelcomeMessagesBtn.addEventListener('click', async function() {
                    try {
                        // Show loading state
                        this.disabled = true;
                        const originalContent = this.innerHTML;
                        this.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Translating...';
                        welcomeMessagesStatus?.classList.remove('hidden');
                        welcomeMessagesStatusAlert?.classList.add('alert-info');
                        welcomeMessagesStatusAlert?.classList.remove('alert-success', 'alert-error');
                        
                        const languages = ['es', 'fr', 'de', 'pt', 'ru', 'zh', 'ja', 'ko', 'hi', 'ar', 'lt'];
                        const languageNames = {
                            es: 'Spanish', fr: 'French', de: 'German', pt: 'Portuguese',
                            ru: 'Russian', zh: 'Chinese', ja: 'Japanese', ko: 'Korean',
                            hi: 'Hindi', ar: 'Arabic', lt: 'Lithuanian'
                        };
                        
                        const translations = { en: welcomeMessages };
                        let completed = 0;
                        
                        for (const lang of languages) {
                            if (welcomeMessagesStatusText) {
                                welcomeMessagesStatusText.textContent = `Translating to ${languageNames[lang]}... (${completed + 1}/${languages.length})`;
                            }
                            
                            const response = await fetch('/api/translate', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    targetLanguage: languageNames[lang],
                                    texts: welcomeMessages,
                                    provider: 'openai'
                                })
                            });
                            
                            if (response.ok) {
                                const data = await response.json();
                                if (data.translations && Array.isArray(data.translations)) {
                                    translations[lang] = data.translations;
                                }
                            }
                            completed++;
                        }
                        
                        // Save translations
                        configManager.updateConfig('NEXT_PUBLIC_WELCOME_MESSAGES_TRANSLATIONS', JSON.stringify(translations));
                        
                        // Show success
                        welcomeMessagesStatusAlert?.classList.remove('alert-info', 'alert-error');
                        welcomeMessagesStatusAlert?.classList.add('alert-success');
                        if (welcomeMessagesStatusText) {
                            welcomeMessagesStatusText.textContent = `Successfully translated to ${completed} languages!`;
                        }
                        
                        // Reset button
                        this.innerHTML = originalContent;
                        this.disabled = false;
                        
                        // Hide status after 3 seconds
                        setTimeout(() => {
                            welcomeMessagesStatus?.classList.add('hidden');
                        }, 3000);
                    } catch (error) {
                        console.error('Error translating messages:', error);
                        welcomeMessagesStatusAlert?.classList.remove('alert-info', 'alert-success');
                        welcomeMessagesStatusAlert?.classList.add('alert-error');
                        if (welcomeMessagesStatusText) {
                            welcomeMessagesStatusText.textContent = 'Failed to translate messages. Please try again.';
                        }
                        this.innerHTML = originalContent;
                        this.disabled = false;
                    }
                });
            }
            
            // Note: resetWelcomeTextBtn doesn't exist in HTML - functionality moved to resetWelcomeMessagesBtn above
            
            // Handle translate button
            if (translateWelcomeTextBtn) {
                translateWelcomeTextBtn.addEventListener('click', async function() {
                    const currentText = welcomeTextInput?.value || 'What can I help with?';
                    
                    // Show loading state
                    this.disabled = true;
                    this.textContent = 'Translating...';
                    welcomeTextTranslationStatus?.classList.remove('hidden');
                    
                    // Define all supported languages
                    const languages = ['es', 'fr', 'de', 'pt', 'ru', 'zh', 'ja', 'ko', 'hi', 'ar', 'lt'];
                    const languageNames = {
                        'es': 'Spanish',
                        'fr': 'French',
                        'de': 'German',
                        'pt': 'Portuguese',
                        'ru': 'Russian',
                        'zh': 'Chinese',
                        'ja': 'Japanese',
                        'ko': 'Korean',
                        'hi': 'Hindi',
                        'ar': 'Arabic',
                        'lt': 'Lithuanian'
                    };
                    
                    const translations = { en: currentText };
                    let completed = 0;
                    
                    try {
                        // Translate to each language
                        for (const lang of languages) {
                            if (translationStatusText) {
                                translationStatusText.textContent = `Translating to ${languageNames[lang]}... (${completed + 1}/${languages.length})`;
                            }
                            
                            const response = await fetch('/api/translate', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    targetLanguage: languageNames[lang],
                                    texts: [currentText],
                                    provider: 'openai'
                                })
                            });
                            
                            if (response.ok) {
                                const result = await response.json();
                                if (result.translations && result.translations[0]) {
                                    translations[lang] = result.translations[0];
                                }
                            }
                            
                            completed++;
                        }
                        
                        // Save translations
                        configManager.updateConfig('NEXT_PUBLIC_WELCOME_TEXT_MODE', 'custom');
                        configManager.updateConfig('NEXT_PUBLIC_WELCOME_TEXT_TRANSLATIONS', JSON.stringify(translations));
                        updateModeIndicator('custom');
                        
                        // Save config
                        configManager.saveConfig();
                        
                        // Show success
                        if (translationStatusText) {
                            translationStatusText.textContent = 'Translation completed successfully!';
                        }
                        setTimeout(() => {
                            welcomeTextTranslationStatus?.classList.add('hidden');
                        }, 3000);
                        
                    } catch (error) {
                        console.error('Translation error:', error);
                        if (translationStatusText) {
                            translationStatusText.textContent = 'Translation failed. Please try again.';
                        }
                    } finally {
                        // Reset button
                        this.disabled = false;
                        this.textContent = 'Translate to All Languages';
                    }
                });
            }
            
            // Helper function to update mode indicator
            function updateModeIndicator(mode) {
                if (welcomeTextModeIndicator) {
                    welcomeTextModeIndicator.textContent = mode === 'default' ? 'Default' : 'Custom';
                    welcomeTextModeIndicator.className = mode === 'default' 
                        ? 'badge badge-sm badge-primary' 
                        : 'badge badge-sm badge-secondary';
                }
            }
            
            
            // Update welcome text preview function
            function updateWelcomeTextPreview() {
                if (!welcomeTextPreview) return;
                
                const gradientType = welcomeTextGradient?.value || 'none';
                
                if (gradientType === 'none') {
                    // Reset to default styles
                    welcomeTextPreview.style.background = '';
                    welcomeTextPreview.style.color = '';
                    welcomeTextPreview.style.webkitBackgroundClip = '';
                    welcomeTextPreview.style.webkitTextFillColor = '';
                    welcomeTextPreview.style.backgroundClip = '';
                } else {
                    // Apply gradient
                    const presets = {
                        sunset: 'linear-gradient(to right, #FF6B6B, #FFE66D)',
                        ocean: 'linear-gradient(to right, #4A90E2, #9B59B6)',
                        aurora: 'linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%)',
                        neon: 'linear-gradient(to right, #00FFF0, #FF00FF)',
                        solar: 'linear-gradient(to right, #FDB813, #FF6B6B)',
                        chatbuttons: 'linear-gradient(to right, #3B82F6, #EAB308, #EA580C, #EF4444, #A855F7)'
                    };
                    
                    const gradientCSS = presets[gradientType];
                    
                    if (gradientCSS) {
                        welcomeTextPreview.style.background = gradientCSS;
                        welcomeTextPreview.style.color = 'transparent';
                        welcomeTextPreview.style.webkitBackgroundClip = 'text';
                        welcomeTextPreview.style.webkitTextFillColor = 'transparent';
                        welcomeTextPreview.style.backgroundClip = 'text';
                    }
                }
            }
            
            // Initialize preview on load
            updateWelcomeTextPreview();
            
            // Handle favicon file upload
            const faviconFile = document.getElementById('faviconFile');
            if (faviconFile) {
                faviconFile.addEventListener('change', async function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const formData = new FormData();
                        formData.append('favicon', file);
                        
                        try {
                            // Upload the favicon to the server
                            const response = await fetch('/api/config/upload-favicon', {
                                method: 'POST',
                                body: formData
                            });
                            
                            if (response.ok) {
                                const result = await response.json();
                                // Update the hidden input with the new favicon URL
                                const faviconUrl = document.getElementById('NEXT_PUBLIC_FAVICON_URL');
                                if (faviconUrl) {
                                    faviconUrl.value = result.url || `/favicon.${file.name.split('.').pop()}`;
                                    // Update preview
                                    const preview = document.getElementById('faviconPreview');
                                    if (preview) {
                                        preview.innerHTML = `<img src="${faviconUrl.value}?t=${Date.now()}" alt="Favicon preview" class="w-6 h-6">`;
                                    }
                                    // Update config manager with new favicon URL
                                    if (window.configManager) {
                                        window.configManager.updateConfig('NEXT_PUBLIC_FAVICON_URL', faviconUrl.value);
                                        window.configManager.saveConfig();
                                    }
                                }
                                showNotification('Favicon uploaded successfully', 'success');
                            } else {
                                throw new Error('Failed to upload favicon');
                            }
                        } catch (error) {
                            console.error('Error uploading favicon:', error);
                            showNotification('Failed to upload favicon', 'error');
                        }
                    }
                });
            }
            
            // Global functions for Live Preview (need to be global for onclick handlers)
            window.toggleInlineChat = function() {
                const inlineChatWidget = document.getElementById('inlineChatWidget');
                if (inlineChatWidget) {
                    if (inlineChatWidget.style.display === 'none' || !inlineChatWidget.style.display) {
                        inlineChatWidget.style.display = 'flex';
                        // Auto-focus the input
                        setTimeout(() => {
                            const chatInput = document.getElementById('chatInput');
                            if (chatInput) chatInput.focus();
                        }, 100);
                    } else {
                        inlineChatWidget.style.display = 'none';
                    }
                }
            };
            
            // Store message history for the Live Preview
            let livePreviewMessages = [];
            
            window.sendPreviewMessage = function() {
                const chatInput = document.getElementById('chatInput');
                const chatMessages = document.getElementById('chatMessages');
                
                if (!chatInput || !chatMessages || !chatInput.value.trim()) return;
                
                const userMessage = chatInput.value.trim();
                chatInput.value = '';
                
                // Add user message to display
                const userMessageDiv = document.createElement('div');
                userMessageDiv.style.cssText = `
                    margin-bottom: 12px;
                    text-align: right;
                `;
                
                const userLabel = document.createElement('div');
                userLabel.style.cssText = `
                    color: #666;
                    font-size: 12px;
                    margin-bottom: 4px;
                `;
                userLabel.textContent = 'You';
                
                const bubble = document.createElement('div');
                bubble.style.cssText = `
                    display: inline-block;
                    max-width: 80%;
                    padding: 12px 16px;
                    border-radius: 18px;
                    font-size: 14px;
                    line-height: 1.4;
                    background: #1a1a1a;
                    color: white;
                    border-bottom-right-radius: 4px;
                `;
                bubble.textContent = userMessage;
                
                userMessageDiv.appendChild(userLabel);
                userMessageDiv.appendChild(bubble);
                
                chatMessages.appendChild(userMessageDiv);
                
                // Auto-scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Send real message to ChatRAG API
                sendRealChatMessage(userMessage, chatMessages);
            };
            
            // Format message content: escape HTML, linkify, basic markdown (bold, code), and numeric lists
            function formatMessageWithLinks(text) {
                if (!text) return '';
                
                // Escape HTML
                const esc = (s) => s
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/\"/g, '&quot;')
                    .replace(/'/g, '&#39;');
                
                // Linkify utility
                const linkify = (s) => s.replace(/(https?:\/\/[^\s<>"']+[^\s<>"'.,!?;:])/gi, (url) =>
                    `<a href="${url}" target="_blank" rel="noopener noreferrer" style="color: #1e40af; text-decoration: underline; cursor: pointer;" onmouseover="this.style.color='#1d4ed8'" onmouseout="this.style.color='#1e40af'">${url}</a>`
                );
                
                // Email links
                const emailify = (s) => s.replace(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/gi, (email) =>
                    `<a href="mailto:${email}" style="color: #1e40af; text-decoration: underline; cursor: pointer;" onmouseover="this.style.color='#1d4ed8'" onmouseout="this.style.color='#1e40af'">${email}</a>`
                );
                
                // Inline markdown
                const mdInline = (s) => s
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    .replace(/`([^`]+)`/g, '<code style="background:#f3f4f6;padding:2px 4px;border-radius:4px;">$1</code>');
                
                const lines = text.split(/\r?\n/);
                let out = '';
                let inOL = false; let olBuf = [];
                const flushOL = () => { if (inOL) { out += '<ol style="padding-left:1.25rem;margin:0 0 0.5rem 0;">' + olBuf.map(li => `<li>${li}</li>`).join('') + '</ol>'; inOL = false; olBuf = []; } };
                
                for (const raw of lines) {
                    const m = raw.match(/^\s*(\d+)\.\s+(.*)$/);
                    if (m) {
                        inOL = true;
                        olBuf.push(mdInline(emailify(linkify(esc(m[2])))));
                        continue;
                    }
                    flushOL();
                    if (raw.trim().length) {
                        out += `<div>${mdInline(emailify(linkify(esc(raw))))}</div>`;
                    }
                }
                flushOL();
                return out || mdInline(emailify(linkify(esc(text)))).replace(/\n/g, '<br>');
            }
            
            // Hide typing indicator (EXACT original function)
            function hideTypingIndicator() {
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }
            
            // Send real chat message to ChatRAG API
            async function sendRealChatMessage(userMessage, chatMessages) {
                // Remove any existing typing indicator (use original function)
                hideTypingIndicator();
                
                // Add loading indicator matching production widget
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'typingIndicator';
                loadingDiv.style.cssText = `
                    margin-bottom: 12px;
                    display: flex;
                    justify-content: flex-start;
                `;
                
                const typingBubble = document.createElement('div');
                typingBubble.style.cssText = `
                    padding: 12px 16px;
                    border-radius: 18px;
                    background: white;
                    border: 1px solid #eee;
                    border-bottom-left-radius: 4px;
                    font-size: 14px;
                    color: #666;
                `;
                typingBubble.innerHTML = 'Typing<span style="animation: blink 1.4s infinite;">...</span>';
                
                loadingDiv.appendChild(typingBubble);
                
                // Add typing animation CSS if not already present
                if (!document.getElementById('typingAnimation')) {
                    const style = document.createElement('style');
                    style.id = 'typingAnimation';
                    style.textContent = `
                        @keyframes blink {
                            0%, 50% { opacity: 1; }
                            51%, 100% { opacity: 0; }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                chatMessages.appendChild(loadingDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                try {
                    // Prefer direct call to the Next app (port 3000); fallback to proxy if it fails
                    const directUrl = `${window.location.protocol}//${window.location.hostname}:3000/api/embed/chat`;
                    const payload = {
                        messages: [
                            { role: 'user', content: userMessage }
                        ],
                        model: (document.getElementById('NEXT_PUBLIC_EMBED_MODEL')?.value || 'openai/gpt-4o-mini')
                    };

                    let chatResponse;
                    try {
                        chatResponse = await fetch(directUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Accept': 'text/plain' },
                            body: JSON.stringify(payload),
                            mode: 'cors'
                        });
                        console.log('[Embed Preview] Using direct endpoint', directUrl, 'status', chatResponse.status);
                        if (!chatResponse.ok) throw new Error(`Direct fetch failed ${chatResponse.status}`);
                    } catch (e) {
                        // Fallback to config server proxy
                        console.log('[Embed Preview] Falling back to proxy /api/embed/chat/proxy due to', e?.message);
                        chatResponse = await fetch('/api/embed/chat/proxy', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Accept': 'text/plain' },
                            body: JSON.stringify(payload)
                        });
                        console.log('[Embed Preview] Proxy status', chatResponse.status);
                    }
                    
                    if (!chatResponse.ok) {
                        throw new Error(`HTTP error! status: ${chatResponse.status}`);
                    }
                    
                    // Remove loading indicator (use original function)
                    hideTypingIndicator();
                    
                    // Create assistant message div for streaming response
                    const assistantMessageDiv = document.createElement('div');
                    assistantMessageDiv.style.cssText = `
                        margin-bottom: 12px;
                    `;
                    
                    const assistantLabel = document.createElement('div');
                    assistantLabel.style.cssText = `
                        color: #666;
                        font-size: 12px;
                        margin-bottom: 4px;
                    `;
                    assistantLabel.textContent = 'Assistant';
                    
                    const bubble = document.createElement('div');
                    bubble.style.cssText = `
                        display: inline-block;
                        max-width: 80%;
                        padding: 12px 16px;
                        border-radius: 18px;
                        font-size: 14px;
                        line-height: 1.4;
                        background: white;
                        color: #333;
                        border: 1px solid #eee;
                        border-bottom-left-radius: 4px;
                    `;
                    
                    const contentDiv = document.createElement('div');
                    contentDiv.id = 'streaming-content';
                    bubble.appendChild(contentDiv);
                    
                    assistantMessageDiv.appendChild(assistantLabel);
                    assistantMessageDiv.appendChild(bubble);
                    
                    chatMessages.appendChild(assistantMessageDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    
                    // Handle streaming response (same format as original implementation)
                    // If body streaming is unavailable, fall back to full text and parse once
                    if (!chatResponse.body) {
                        const text = await chatResponse.text();
                        console.log('[Embed Preview] Non-streaming response head:', text.slice(0, 200));
                        const matchAll = text.match(/\n?0:\s*("(?:[^"\\]|\\.)*")/g) || [];
                        let combined = '';
                        for (const m of matchAll) {
                            try { combined += JSON.parse(m.replace(/^\s*0:\s*/, '')); } catch {}
                        }
                        if (combined) {
                            contentDiv.innerHTML = formatMessageWithLinks(combined);
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                            return;
                        }
                        throw new Error('Non-streaming response with no parsable frames');
                    }
                    const reader = chatResponse.body.getReader();
                    const decoder = new TextDecoder();
                    let assistantMessage = '';
                    // Buffer to handle partial lines across chunks
                    let buffer = '';
                    // Raw accumulator for fallback parsing after streaming ends
                    let rawStream = '';
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        const chunk = decoder.decode(value, { stream: true });
                        rawStream += chunk;
                        buffer += chunk;
                        let lines = buffer.split('\n');
                        // Keep the last partial line in the buffer
                        buffer = lines.pop() || '';
                        
                        for (const lineRaw of lines) {
                            const line = lineRaw.trim();
                            if (line === '') continue;
                            
                            try {
                                // Handle AI SDK streaming format
                                if (/^\s*0:/.test(line)) {
                                    // Text content: 0:"content"
                                    const jsonPart = line.slice(2);
                                    const textDelta = JSON.parse(jsonPart);
                                    assistantMessage += textDelta;
                                    if (contentDiv) {
                                        contentDiv.innerHTML = formatMessageWithLinks(assistantMessage);
                                    }
                                    chatMessages.scrollTop = chatMessages.scrollHeight;
                                } else if (/^\s*3:/.test(line)) {
                                    // Error message: 3:"error"
                                    const jsonPart = line.slice(2);
                                    const errorMessage = JSON.parse(jsonPart);
                                    throw new Error(errorMessage);
                                } else if (line.startsWith('data: ')) {
                                    // SSE fallback (supports OpenAI deltas and Vercel AI SDK events)
                                    const data = line.slice(6);
                                    if (data && data !== '[DONE]') {
                                        try {
                                            const parsed = JSON.parse(data);
                                            let content = '';
                                            // OpenAI streaming shape
                                            if (parsed?.choices?.[0]?.delta?.content) {
                                                content = parsed.choices[0].delta.content;
                                            }
                                            // Vercel AI SDK event stream
                                            if (!content && (parsed?.type || parsed?.event)) {
                                                const t = parsed.type || parsed.event;
                                                if (t === 'text-delta') {
                                                    content = parsed.delta ?? parsed.textDelta ?? parsed.content ?? parsed.data?.delta ?? '';
                                                } else if (t === 'text') {
                                                    content = parsed.text ?? '';
                                                }
                                            }
                                            if (typeof content === 'string' && content.length > 0) {
                                                assistantMessage += content;
                                                if (contentDiv) {
                                                    contentDiv.innerHTML = formatMessageWithLinks(assistantMessage);
                                                }
                                                chatMessages.scrollTop = chatMessages.scrollHeight;
                                            }
                                        } catch (e) {
                                            console.debug('Could not parse SSE data:', data, e);
                                        }
                                    }
                                }
                            } catch (e) {
                                console.log('Could not parse line:', line, e);
                            }
                        }
                    }
                    
                    // Flush any remaining buffered line
                    if (/^\s*0:/.test(buffer.trim())) {
                        try {
                            const textDelta = JSON.parse(buffer.trim().slice(2));
                            assistantMessage += textDelta;
                            if (contentDiv) {
                                contentDiv.innerHTML = formatMessageWithLinks(assistantMessage);
                            }
                        } catch {}
                    }
                    
                    // Fallback: try to extract all 0:"..." JSON string segments from the raw stream
                    if (!assistantMessage.trim() && rawStream) {
                        try {
                            const regex = /\n?0:\s*("(?:[^"\\]|\\.)*")/g;
                            let m;
                            while ((m = regex.exec(rawStream)) !== null) {
                                try {
                                    assistantMessage += JSON.parse(m[1]);
                                } catch {}
                            }
                            if (assistantMessage && contentDiv) {
                                contentDiv.innerHTML = formatMessageWithLinks(assistantMessage);
                            }
                        } catch {}
                    }
                    
                    // If still empty, show a fallback
                    if (!assistantMessage.trim()) {
                        if (contentDiv) {
                            contentDiv.textContent = 'Sorry, I received an empty response. Please try again.';
                        }
                        console.log('Preview stream was empty; raw length =', rawStream?.length || 0, 'head:', (rawStream||'').slice(0, 200));
                    }
                    
                } catch (error) {
                    console.error('Error sending chat message:', error);
                    
                    // Remove loading indicator (use original function)
                    hideTypingIndicator();
                    
                    // Show error message
                    const errorDiv = document.createElement('div');
                    errorDiv.style.cssText = `
                        margin-bottom: 12px;
                        display: flex;
                        justify-content: flex-start;
                    `;
                    
                    const errorBubble = document.createElement('div');
                    errorBubble.style.cssText = `
                        max-width: 80%;
                        padding: 12px 16px;
                        border-radius: 18px;
                        font-size: 14px;
                        line-height: 1.4;
                        background: #fee;
                        color: #333;
                        border: 1px solid #fcc;
                        border-bottom-left-radius: 4px;
                    `;
                    
                    errorBubble.innerHTML = `
                        Sorry, I'm having trouble connecting to the chat service. This could be because:
                        <br>‚Ä¢ The chat API is not configured yet
                        <br>‚Ä¢ The server is not running
                        <br>‚Ä¢ Network connectivity issues
                        <br><br>Please check your configuration or try again later.
                    `;
                    
                    errorDiv.appendChild(errorBubble);
                    chatMessages.appendChild(errorDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }
            
            // Update preview styling and positioning in real-time
            function updateLivePreview() {
                const embedButton = document.getElementById('embedPreviewButton');
                const chatHeader = document.getElementById('chatHeader');
                const chatTitle = document.getElementById('chatTitle');
                const welcomeMessage = document.getElementById('welcomeMessage');
                const sendButton = document.querySelector('#inlineChatWidget button[onclick="sendPreviewMessage()"]');
                const inlineChatWidget = document.getElementById('inlineChatWidget');
                
                // Get current values
                const title = document.getElementById('NEXT_PUBLIC_EMBED_TITLE')?.value || 'ChatRAG Assistant';
                const greeting = document.getElementById('NEXT_PUBLIC_EMBED_GREETING')?.value || 'Hello! Development help you today?';
                const primaryColor = document.getElementById('NEXT_PUBLIC_EMBED_PRIMARY_COLOR')?.value || '#FF6417';
                const position = document.getElementById('NEXT_PUBLIC_EMBED_POSITION')?.value || 'bottom-right';
                
                // Update colors - using configured primary color
                if (embedButton) embedButton.style.background = primaryColor;
                if (chatHeader) chatHeader.style.background = primaryColor;
                if (sendButton) sendButton.style.background = primaryColor;
                
                // Update text content
                if (chatTitle) chatTitle.textContent = title;
                if (welcomeMessage) welcomeMessage.textContent = greeting;
                
                // Update position
                if (embedButton && inlineChatWidget) {
                    // Reset all positions
                    embedButton.style.top = 'auto';
                    embedButton.style.bottom = 'auto';
                    embedButton.style.left = 'auto';
                    embedButton.style.right = 'auto';
                    
                    inlineChatWidget.style.top = 'auto';
                    inlineChatWidget.style.bottom = 'auto';
                    inlineChatWidget.style.left = 'auto';
                    inlineChatWidget.style.right = 'auto';
                    
                    switch (position) {
                        case 'bottom-right':
                            embedButton.style.bottom = '20px';
                            embedButton.style.right = '20px';
                            inlineChatWidget.style.bottom = '90px';
                            inlineChatWidget.style.right = '20px';
                            break;
                        case 'bottom-left':
                            embedButton.style.bottom = '20px';
                            embedButton.style.left = '20px';
                            inlineChatWidget.style.bottom = '90px';
                            inlineChatWidget.style.left = '20px';
                            break;
                        case 'top-right':
                            embedButton.style.top = '20px';
                            embedButton.style.right = '20px';
                            inlineChatWidget.style.top = '90px';
                            inlineChatWidget.style.right = '20px';
                            break;
                        case 'top-left':
                            embedButton.style.top = '20px';
                            embedButton.style.left = '20px';
                            inlineChatWidget.style.top = '90px';
                            inlineChatWidget.style.left = '20px';
                            break;
                    }
                }
            }
            
            // Add event listeners for real-time preview updates
            const previewUpdateFields = [
                'NEXT_PUBLIC_EMBED_TITLE',
                'NEXT_PUBLIC_EMBED_GREETING', 
                'NEXT_PUBLIC_EMBED_PRIMARY_COLOR',
                'NEXT_PUBLIC_EMBED_POSITION'
            ];
            
            previewUpdateFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', () => {
                        updateLivePreview();
                        if (embedManager.updateEmbedCodes) {
                            embedManager.updateEmbedCodes();
                        }
                    });
                    field.addEventListener('change', () => {
                        updateLivePreview();
                        if (embedManager.updateEmbedCodes) {
                            embedManager.updateEmbedCodes();
                        }
                    });
                }
            });
            
            // Initialize live preview
            setTimeout(updateLivePreview, 500);
            
            // Initialize RAG Settings functionality
            initRagSettings();
            
            // Initialize Document Processing functionality
            initDocumentProcessing();
        });
        
        // RAG Settings initialization and functionality
        function initRagSettings() {
            console.log('Initializing RAG Settings...');
            
            // Initialize slider value displays
            // updateSliderValues(); // Function was removed with optimization features
            
            // Initialize tooltip system
            initTooltips();
            
            // Initialize model cards
            updateModelCards();
            
            // Also update model cards after a delay to ensure config is loaded
            setTimeout(() => {
                updateModelCards();
            }, 100);
            
            // Initialize parsing mode info
            updateParsingModeInfo();
            
            // Initialize configuration preview
            updateConfigPreview();
            
            // Initialize performance indicators
            updatePerformanceIndicators();
            
            // Add event listeners for sliders
            const chunkSizeSlider = document.getElementById('LLAMACLOUD_CHUNK_SIZE');
            const chunkOverlapSlider = document.getElementById('LLAMACLOUD_CHUNK_OVERLAP');
            
            if (chunkSizeSlider) {
                chunkSizeSlider.addEventListener('input', function() {
                    document.getElementById('chunk-size-value').textContent = this.value;
                    updateConfigPreview();
                    updatePerformanceIndicators();
                });
            }
            
            if (chunkOverlapSlider) {
                chunkOverlapSlider.addEventListener('input', function() {
                    document.getElementById('chunk-overlap-value').textContent = this.value;
                    updateConfigPreview();
                    updatePerformanceIndicators();
                });
            }
            
            // Add event listeners for other RAG settings
            const ragSettingFields = [
                'LLAMACLOUD_PARSING_MODE',
                'LLAMACLOUD_CHUNK_STRATEGY',
                'OPENAI_EMBEDDING_MODEL'
            ];
            
            ragSettingFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('change', function() {
                        updateConfigPreview();
                        updatePerformanceIndicators();
                        if (fieldId === 'OPENAI_EMBEDDING_MODEL') {
                            updateModelCards();
                        }
                        if (fieldId === 'LLAMACLOUD_PARSING_MODE') {
                            updateParsingModeInfo();
                        }
                    });
                }
            });
        }
        
        // Initialize tooltip system
        function initTooltips() {
            const tooltipTriggers = document.querySelectorAll('.tooltip-trigger');
            
            tooltipTriggers.forEach(trigger => {
                let tooltip = null;
                
                trigger.addEventListener('mouseenter', function() {
                    const tooltipId = this.getAttribute('data-tooltip');
                    const tooltipContent = document.getElementById(`tooltip-${tooltipId}`);
                    
                    if (tooltipContent) {
                        // Create tooltip element
                        tooltip = document.createElement('div');
                        tooltip.className = 'fixed z-50 p-3 bg-base-100 border border-base-300 rounded-lg shadow-lg text-sm max-w-xs';
                        tooltip.innerHTML = tooltipContent.innerHTML;
                        tooltip.style.visibility = 'hidden'; // Hide initially to calculate dimensions
                        
                        document.body.appendChild(tooltip);
                        
                        // Position tooltip with smart positioning
                        const rect = this.getBoundingClientRect();
                        const tooltipRect = tooltip.getBoundingClientRect();
                        const tooltipWidth = tooltipRect.width;
                        const tooltipHeight = tooltipRect.height;
                        const padding = 10;
                        
                        // Default position: to the right of the element
                        let left = rect.right + padding;
                        let top = rect.top + (rect.height / 2) - (tooltipHeight / 2); // Center vertically
                        
                        // Check if tooltip would go off right edge
                        if (left + tooltipWidth > window.innerWidth - padding) {
                            // Position to the left instead
                            left = rect.left - tooltipWidth - padding;
                        }
                        
                        // Check if tooltip would still go off left edge
                        if (left < padding) {
                            // Position below the element instead
                            left = rect.left + (rect.width / 2) - (tooltipWidth / 2);
                            top = rect.bottom + padding;
                            
                            // Check if it would go off bottom
                            if (top + tooltipHeight > window.innerHeight - padding) {
                                // Position above the element
                                top = rect.top - tooltipHeight - padding;
                            }
                        }
                        
                        // Ensure tooltip stays within viewport bounds
                        left = Math.max(padding, Math.min(left, window.innerWidth - tooltipWidth - padding));
                        top = Math.max(padding, Math.min(top, window.innerHeight - tooltipHeight - padding));
                        
                        // Apply positioning and show tooltip
                        tooltip.style.left = left + 'px';
                        tooltip.style.top = top + 'px';
                        tooltip.style.visibility = 'visible';
                    }
                });
                
                trigger.addEventListener('mouseleave', function() {
                    if (tooltip) {
                        tooltip.remove();
                        tooltip = null;
                    }
                });
            });
        }
        
        // Update model cards highlighting
        function updateModelCards() {
            const selectedModel = document.getElementById('OPENAI_EMBEDDING_MODEL')?.value;
            const modelCards = document.querySelectorAll('.model-card');
            
            modelCards.forEach(card => {
                const cardModel = card.getAttribute('data-model');
                if (cardModel === selectedModel) {
                    card.classList.remove('border-base-300');
                    card.classList.add('border-primary');
                } else {
                    card.classList.remove('border-primary');
                    card.classList.add('border-base-300');
                }
            });
        }
        
        // LlamaCloud Model Cost Information (matching LlamaCloud exactly)
        const llamaCloudModelCosts = {
            'openai-gpt-4-1-mini': { credits: 10, name: 'OpenAI GPT-4.1 Mini', badge: 'üí∞ Most Economical' },
            'gemini-2.0-flash': { credits: 30, name: 'Gemini 2.0 Flash', badge: '‚ö° Fast & Affordable' },
            'openai-gpt-4-1': { credits: 45, name: 'OpenAI GPT-4.1', badge: 'üéØ Balanced' },
            'anthropic-sonnet-3.5': { credits: 45, name: 'Anthropic Sonnet 3.5', badge: 'üöÄ High Performance' },
            'gemini-2.5-pro': { credits: 45, name: 'Gemini 2.5 Pro', badge: '‚≠ê Premium' },
            'anthropic-sonnet-4.0': { credits: 90, name: 'Anthropic Sonnet 4.0', badge: 'üîÆ Most Advanced' }
        };

        // Update model cost display when selection changes
        function updateModelCostDisplay() {
            const modelSelect = document.getElementById('LLAMACLOUD_PARSE_MODEL');
            const costDisplay = document.getElementById('model-cost-display');
            const qualityDisplay = document.getElementById('model-quality-display');
            
            if (!modelSelect) return;
            
            const selectedModel = modelSelect.value;
            const modelInfo = llamaCloudModelCosts[selectedModel];
            
            if (modelInfo) {
                // Update the cost display
                if (costDisplay) {
                    costDisplay.textContent = `Cost: ${modelInfo.credits} credits/page`;
                }
                
                // Update the quality display
                if (qualityDisplay) {
                    const qualityText = {
                        'üí∞ Most Economical': 'Most economical choice',
                        '‚ö° Fast & Affordable': 'Fast and affordable',
                        'üéØ Balanced': 'Balanced performance',
                        'üöÄ High Performance': 'High performance',
                        '‚≠ê Premium': 'Premium quality',
                        'üîÆ Most Advanced': 'Most advanced capabilities'
                    };
                    qualityDisplay.textContent = qualityText[modelInfo.badge] || 'Quality parsing';
                }
                
                // Also update in the info area if it exists
                const infoArea = document.querySelector('.parsing-model-info');
                if (infoArea) {
                    infoArea.innerHTML = `
                        <div class="alert alert-info mt-4">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <div>
                                <div class="font-semibold">Selected Model: ${modelInfo.name}</div>
                                <div class="text-sm">Cost: ${modelInfo.credits} credits per page processed</div>
                                <div class="text-xs mt-1">${modelInfo.badge}</div>
                            </div>
                        </div>
                    `;
                }
            }
        }

        // Initialize model cost display and parse mode on page load
        document.addEventListener('DOMContentLoaded', () => {
            const modelSelect = document.getElementById('LLAMACLOUD_PARSE_MODEL');
            const parseModeSelect = document.getElementById('LLAMACLOUD_PARSE_MODE');
            
            if (modelSelect) {
                modelSelect.addEventListener('change', updateModelCostDisplay);
            }
            
            if (parseModeSelect) {
                parseModeSelect.addEventListener('change', () => {
                    updateParsingModeInfo();
                    // Update config when parse mode changes
                    if (window.configManager) {
                        window.configManager.updateConfig('LLAMACLOUD_PARSE_MODE', parseModeSelect.value);
                    }
                });
            }
            
            // Initial updates
            updateParsingModeInfo();
            updateModelCostDisplay();
        });

        // Update parsing mode information
        function updateParsingModeInfo() {
            const parseModeSelect = document.getElementById('LLAMACLOUD_PARSE_MODE');
            const descriptionElement = document.getElementById('parse-mode-description');
            const modelSelectDiv = document.getElementById('LLAMACLOUD_PARSE_MODEL')?.parentElement;
            
            if (!parseModeSelect) return;
            
            const parseMode = parseModeSelect.value;
            
            const modeInfo = {
                'parse_page_with_agent': {
                    description: 'AI-powered parsing with OCR, plus image and table extraction. Complex documents with tables and images.',
                    showModelSelect: true,
                    creditsRange: '10-90 credits/page depending on model'
                },
                'parse_page_with_llm': {
                    description: 'Cost-effective parsing for documents with images. Best for simple documents.',
                    showModelSelect: false,
                    creditsRange: '3 credits/page'
                }
            };
            
            const info = modeInfo[parseMode] || modeInfo['parse_page_with_agent'];
            
            if (descriptionElement) {
                descriptionElement.textContent = info.description;
            }
            
            // Show/hide model selection based on parse mode
            if (modelSelectDiv) {
                modelSelectDiv.style.display = info.showModelSelect ? 'block' : 'none';
            }
            
            // Update cost display
            const costDisplay = document.getElementById('model-cost-display');
            if (costDisplay && parseMode === 'parse_page_with_llm') {
                costDisplay.textContent = 'Cost: 3 credits/page';
            } else if (parseMode === 'parse_page_with_agent') {
                updateModelCostDisplay(); // Update based on selected model
            }
        }
        
        // Update parsing mode information (legacy function for compatibility)
        function updateParsingModeInfoLegacy() {
            const parsingMode = document.getElementById('LLAMACLOUD_PARSING_MODE')?.value || 'balanced';
            const costElement = document.getElementById('parsing-mode-cost');
            const descriptionElement = document.getElementById('parsing-mode-description-legacy');
            
            const modeInfo = {
                fast: {
                    cost: '~$0.045/page',
                    description: 'Text-only extraction, no multimodal processing'
                },
                balanced: {
                    cost: '~$0.003/page',
                    description: 'LLM processing with basic table support'
                },
                premium: {
                    cost: '~$0.075/page',
                    description: 'Full multimodal with advanced visual processing'
                }
            };
            
            if (costElement && descriptionElement) {
                costElement.textContent = modeInfo[parsingMode].cost;
                descriptionElement.textContent = modeInfo[parsingMode].description;
            }
        }
        
        // Update configuration preview
        function updateConfigPreview() {
            const parsingMode = document.getElementById('LLAMACLOUD_PARSING_MODE')?.value || 'balanced';
            const strategy = document.getElementById('LLAMACLOUD_CHUNK_STRATEGY')?.value || 'sentence';
            const chunkSize = document.getElementById('LLAMACLOUD_CHUNK_SIZE')?.value || '768';
            const chunkOverlap = document.getElementById('LLAMACLOUD_CHUNK_OVERLAP')?.value || '416';
            const embeddingModel = document.getElementById('OPENAI_EMBEDDING_MODEL')?.value || 'text-embedding-3-small';
            
            // Update preview text
            const parsingModeText = parsingMode.charAt(0).toUpperCase() + parsingMode.slice(1);
            const strategyText = strategy === 'sentence' ? 'Sentence-based' : 
                               strategy === 'element' ? 'Element-based' : 'Basic';
            const modelText = embeddingModel.includes('3-small') ? '3-small' : 
                             embeddingModel.includes('3-large') ? '3-large' : 'Ada-002';
            
            if (document.getElementById('config-preview-parsing')) {
                document.getElementById('config-preview-parsing').textContent = parsingModeText;
            }
            if (document.getElementById('config-preview-strategy')) {
                document.getElementById('config-preview-strategy').textContent = strategyText;
            }
            if (document.getElementById('config-preview-size')) {
                document.getElementById('config-preview-size').textContent = chunkSize + ' chars';
            }
            if (document.getElementById('config-preview-overlap')) {
                document.getElementById('config-preview-overlap').textContent = chunkOverlap + ' chars';
            }
            if (document.getElementById('config-preview-model')) {
                document.getElementById('config-preview-model').textContent = modelText;
            }
        }
        
        // Update performance indicators
        function updatePerformanceIndicators() {
            const parsingMode = document.getElementById('LLAMACLOUD_PARSING_MODE')?.value || 'balanced';
            const chunkSize = parseInt(document.getElementById('LLAMACLOUD_CHUNK_SIZE')?.value || '768');
            const chunkOverlap = parseInt(document.getElementById('LLAMACLOUD_CHUNK_OVERLAP')?.value || '416');
            const strategy = document.getElementById('LLAMACLOUD_CHUNK_STRATEGY')?.value || 'sentence';
            const embeddingModel = document.getElementById('OPENAI_EMBEDDING_MODEL')?.value || 'text-embedding-3-small';
            
            // Calculate performance scores (simplified algorithm)
            let speed = 100;
            let precision = 50;
            let cost = 100;
            
            // Chunk size impact
            if (chunkSize <= 512) {
                speed += 15;
                precision += 20;
                cost += 10;
            } else if (chunkSize >= 1536) {
                speed -= 10;
                precision += 15;
                cost -= 5;
            }
            
            // Chunk overlap impact
            if (chunkOverlap === 0) {
                speed += 20;
                cost += 15;
                precision -= 10;
            } else if (chunkOverlap >= 256) {
                speed -= 15;
                cost -= 20;
                precision += 15;
            }
            
            // Strategy impact
            if (strategy === 'sentence') {
                precision += 20;
                speed -= 5;
            } else if (strategy === 'element') {
                precision += 35;  // Best for structured docs
                speed -= 10;      // Slightly slower due to structure analysis
            }
            
            // Model impact
            if (embeddingModel.includes('3-small')) {
                cost += 30;
                precision += 10;
            } else if (embeddingModel.includes('3-large')) {
                cost -= 20;
                precision += 25;
                speed -= 5;
            } else if (embeddingModel.includes('ada-002')) {
                cost -= 10;
                precision -= 5;
            }
            
            // Parsing mode impact
            if (parsingMode === 'fast') {
                speed += 25;
                cost += 20;
                precision -= 15;
            } else if (parsingMode === 'premium') {
                speed -= 25;
                cost -= 30;
                precision += 25;
            }
            
            // Normalize scores (0-100)
            speed = Math.max(0, Math.min(100, speed));
            precision = Math.max(0, Math.min(100, precision));
            cost = Math.max(0, Math.min(100, cost));
            
            // Update indicators
            updateIndicator('speed', speed);
            updateIndicator('precision', precision);
            updateIndicator('cost', cost);
        }
        
        // Update individual performance indicator
        function updateIndicator(type, value) {
            const indicator = document.getElementById(`${type}-indicator`);
            const bar = document.getElementById(`${type}-bar`);
            
            if (indicator) {
                indicator.textContent = Math.round(value) + '%';
            }
            if (bar) {
                bar.style.width = value + '%';
                
                // Update color based on performance
                bar.className = bar.className.replace(/bg-(success|warning|error)/, '');
                if (value >= 80) {
                    bar.classList.add('bg-success');
                } else if (value >= 60) {
                    bar.classList.add('bg-warning');
                } else {
                    bar.classList.add('bg-error');
                }
            }
        }
        
        // Document Processing functionality
        function initDocumentProcessing() {
            console.log('Initializing Document Processing...');
            
            // Initialize document processor
            window.documentProcessor = new DocumentProcessor();
            
            // Initialize drag and drop
            initDragAndDrop();
            
            // Initialize event listeners
            initDocumentEventListeners();
            
            // Initialize monitor toggle
            initMonitorToggle();
        }
        
        // Document processor class
        class DocumentProcessor {
            constructor() {
                this.queue = [];
                this.processing = false;
                this.currentFile = null;
                this.results = [];
                this.stats = {
                    processedToday: 0,
                    successRate: 100
                };
            }
            
            addFiles(files) {
                for (const file of files) {
                    if (this.validateFile(file)) {
                        const fileItem = {
                            id: Date.now() + Math.random(),
                            file: file,
                            name: file.name,
                            size: this.formatFileSize(file.size),
                            status: 'queued',
                            progress: 0,
                            error: null
                        };
                        this.queue.push(fileItem);
                    }
                }
                this.updateQueueDisplay();
                this.updateStatus();
            }
            
            validateFile(file) {
                const maxSize = 20 * 1024 * 1024; // 20MB
                const allowedTypes = [
                    'application/pdf',
                    'application/msword',
                    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                    'text/plain',
                    'text/markdown',
                    'application/rtf',
                    'application/vnd.oasis.opendocument.text'
                ];
                
                if (file.size > maxSize) {
                    this.showError(`File ${file.name} is too large (max 20MB)`);
                    return false;
                }
                
                if (!allowedTypes.includes(file.type) && !this.isTextFile(file.name)) {
                    this.showError(`File type not supported: ${file.name}`);
                    return false;
                }
                
                return true;
            }
            
            isTextFile(filename) {
                const textExtensions = ['.txt', '.md', '.rtf', '.odt'];
                return textExtensions.some(ext => filename.toLowerCase().endsWith(ext));
            }
            
            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            async startProcessing() {
                if (this.processing || this.queue.length === 0) return;
                
                this.processing = true;
                this.updateStatus();
                this.logActivity('Started processing queue');
                
                while (this.queue.length > 0 && this.processing) {
                    const fileItem = this.queue.shift();
                    await this.processFile(fileItem);
                }
                
                this.processing = false;
                this.currentFile = null;
                this.updateStatus();
                this.updateQueueDisplay();
                this.updateCurrentProcessing();
                this.logActivity('Finished processing queue');
            }
            
            async processFile(fileItem) {
                this.currentFile = fileItem;
                fileItem.status = 'processing';
                this.updateQueueDisplay();
                this.updateCurrentProcessing();
                this.logActivity(`Processing ${fileItem.name}`);
                
                try {
                    const formData = new FormData();
                    formData.append('file', fileItem.file);
                    
                    const response = await fetch('/api/process-document', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        fileItem.status = 'completed';
                        fileItem.progress = 100;
                        this.results.push({
                            ...fileItem,
                            result: result,
                            timestamp: new Date().toLocaleString()
                        });
                        this.stats.processedToday++;
                        this.logActivity(`‚úÖ Successfully processed ${fileItem.name}`);
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    fileItem.status = 'failed';
                    fileItem.error = error.message;
                    this.logActivity(`‚ùå Failed to process ${fileItem.name}: ${error.message}`);
                    this.updateSuccessRate();
                }
                
                this.updateQueueDisplay();
                this.updateCurrentProcessing();
                this.updateResultsDisplay();
                this.updateStatus();
            }
            
            pauseProcessing() {
                this.processing = false;
                this.logActivity('Processing paused');
                this.updateStatus();
            }
            
            resumeProcessing() {
                if (this.queue.length > 0) {
                    this.startProcessing();
                }
            }
            
            clearQueue() {
                this.queue = [];
                this.currentFile = null;
                this.processing = false;
                this.updateQueueDisplay();
                this.updateStatus();
                this.updateCurrentProcessing();
                this.logActivity('Queue cleared');
            }
            
            clearResults() {
                this.results = [];
                this.updateResultsDisplay();
                this.logActivity('Results history cleared');
            }
            
            updateStatus() {
                document.getElementById('queue-status').textContent = 
                    this.processing ? 'Processing' : 'Ready';
                document.getElementById('files-in-queue').textContent = this.queue.length;
                document.getElementById('processed-today').textContent = this.stats.processedToday;
                document.getElementById('success-rate').textContent = this.stats.successRate + '%';
                
                // Update button states
                const startBtn = document.getElementById('start-processing-btn');
                const clearBtn = document.getElementById('clear-queue-btn');
                const pauseBtn = document.getElementById('pause-btn');
                const resumeBtn = document.getElementById('resume-btn');
                
                startBtn.disabled = this.queue.length === 0 || this.processing;
                clearBtn.disabled = this.queue.length === 0 && !this.processing;
                
                if (this.processing) {
                    pauseBtn.classList.remove('hidden');
                    resumeBtn.classList.add('hidden');
                } else {
                    pauseBtn.classList.add('hidden');
                    resumeBtn.classList.add('hidden');
                }
            }
            
            updateQueueDisplay() {
                const emptyState = document.getElementById('queue-empty-state');
                const queueItems = document.getElementById('queue-items');
                
                if (this.queue.length === 0 && !this.currentFile) {
                    emptyState.classList.remove('hidden');
                    queueItems.classList.add('hidden');
                } else {
                    emptyState.classList.add('hidden');
                    queueItems.classList.remove('hidden');
                    
                    queueItems.innerHTML = this.queue.map(item => this.createQueueItemHTML(item)).join('');
                }
            }
            
            createQueueItemHTML(item) {
                const statusIcon = {
                    'queued': '‚è≥',
                    'processing': 'üîÑ',
                    'completed': '‚úÖ',
                    'failed': '‚ùå'
                }[item.status];
                
                const statusColor = {
                    'queued': 'text-warning',
                    'processing': 'text-info',
                    'completed': 'text-success',
                    'failed': 'text-error'
                }[item.status];
                
                return `
                    <div class="bg-base-100 p-4 rounded-lg">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <span class="text-lg">${statusIcon}</span>
                                <div>
                                    <div class="font-medium">${item.name}</div>
                                    <div class="text-sm text-base-content/60">${item.size}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="${statusColor} font-medium capitalize">${item.status}</div>
                                ${item.error ? `<div class="text-xs text-error">${item.error}</div>` : ''}
                            </div>
                        </div>
                        ${item.status === 'processing' ? `
                        <div class="w-full bg-base-300 rounded-full h-2 mt-2">
                            <div class="bg-primary h-2 rounded-full transition-all duration-300" style="width: ${item.progress}%"></div>
                        </div>
                        ` : ''}
                    </div>
                `;
            }
            
            updateCurrentProcessing() {
                const currentProcessing = document.getElementById('current-processing');

                if (this.currentFile) {
                    currentProcessing.classList.remove('hidden');
                    document.getElementById('current-file-name').textContent = this.currentFile.name;
                } else {
                    currentProcessing.classList.add('hidden');
                }
            }
            
            updateResultsDisplay() {
                const emptyState = document.getElementById('results-empty-state');
                const resultsList = document.getElementById('results-list');
                
                if (this.results.length === 0) {
                    emptyState.classList.remove('hidden');
                    resultsList.classList.add('hidden');
                } else {
                    emptyState.classList.add('hidden');
                    resultsList.classList.remove('hidden');
                    
                    resultsList.innerHTML = this.results.map(result => this.createResultHTML(result)).join('');
                }
            }
            
            createResultHTML(result) {
                const statusIcon = result.status === 'completed' ? '‚úÖ' : '‚ùå';
                const statusColor = result.status === 'completed' ? 'text-success' : 'text-error';
                
                return `
                    <div class="bg-base-100 p-4 rounded-lg">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <span class="text-lg">${statusIcon}</span>
                                <div>
                                    <div class="font-medium">${result.name}</div>
                                    <div class="text-sm text-base-content/60">${result.timestamp}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="${statusColor} font-medium capitalize">${result.status}</div>
                                ${result.error ? `<div class="text-xs text-error">${result.error}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            updateSuccessRate() {
                const total = this.results.length;
                if (total > 0) {
                    const successful = this.results.filter(r => r.status === 'completed').length;
                    this.stats.successRate = Math.round((successful / total) * 100);
                }
            }
            
            logActivity(message) {
                const activityLog = document.getElementById('activity-log');
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = 'text-sm mb-1';
                logEntry.innerHTML = `<span class="text-base-content/60">[${timestamp}]</span> ${message}`;
                
                if (activityLog.children.length > 0 && activityLog.children[0].textContent.includes('No activity yet')) {
                    activityLog.innerHTML = '';
                }
                
                activityLog.insertBefore(logEntry, activityLog.firstChild);
                
                // Keep only last 50 entries
                while (activityLog.children.length > 50) {
                    activityLog.removeChild(activityLog.lastChild);
                }
            }
            
            showError(message) {
                console.error('Document Processing Error:', message);
                this.logActivity(`‚ùå Error: ${message}`);
            }
        }
        
        // Initialize drag and drop functionality
        function initDragAndDrop() {
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-input');
            
            // Click to select files
            dropZone.addEventListener('click', () => fileInput.click());
            
            // Drag and drop events
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('border-primary', 'bg-primary/10');
            });
            
            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-primary', 'bg-primary/10');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-primary', 'bg-primary/10');
                
                const files = Array.from(e.dataTransfer.files);
                window.documentProcessor.addFiles(files);
            });
            
            // File input change
            fileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                window.documentProcessor.addFiles(files);
                e.target.value = ''; // Reset input
            });
        }
        
        // Initialize event listeners
        function initDocumentEventListeners() {
            document.getElementById('select-files-btn').addEventListener('click', () => {
                document.getElementById('file-input').click();
            });
            
            document.getElementById('start-processing-btn').addEventListener('click', () => {
                window.documentProcessor.startProcessing();
            });
            
            document.getElementById('clear-queue-btn').addEventListener('click', () => {
                window.documentProcessor.clearQueue();
            });
            
            document.getElementById('pause-btn').addEventListener('click', () => {
                window.documentProcessor.pauseProcessing();
            });
            
            document.getElementById('resume-btn').addEventListener('click', () => {
                window.documentProcessor.resumeProcessing();
            });
            
            document.getElementById('clear-history-btn').addEventListener('click', () => {
                window.documentProcessor.clearResults();
            });
        }
        
        // Initialize monitor toggle
        function initMonitorToggle() {
            const toggleBtn = document.getElementById('toggle-monitor');
            const monitorPanel = document.getElementById('monitor-panel');

            toggleBtn.addEventListener('click', () => {
                if (monitorPanel.classList.contains('hidden')) {
                    monitorPanel.classList.remove('hidden');
                    toggleBtn.textContent = 'üìä Hide Details';
                } else {
                    monitorPanel.classList.add('hidden');
                    toggleBtn.textContent = 'üìä Show Details';
                }
            });

            // Initialize enhanced monitor features
            initEnhancedMonitor();
        }

        // Enhanced monitoring features
        function initEnhancedMonitor() {
            let activityLog = [];
            let processingStats = {
                startTime: null,
                processedDocs: 0,
                totalDocs: 0
            };

            // Export log functionality
            const exportBtn = document.getElementById('export-log-btn');
            if (exportBtn) {
                exportBtn.addEventListener('click', () => {
                    const dataStr = JSON.stringify(activityLog, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                    const exportFileDefaultName = `processing-log-${new Date().toISOString()}.json`;

                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', exportFileDefaultName);
                    linkElement.click();
                });
            }

            // Clear log functionality
            const clearBtn = document.getElementById('clear-log-btn');
            if (clearBtn) {
                clearBtn.addEventListener('click', () => {
                    if (confirm('Clear all activity logs?')) {
                        activityLog = [];
                        const logDiv = document.getElementById('activity-log');
                        logDiv.innerHTML = '<div class="text-sm text-base-content/60">No activity yet</div>';
                    }
                });
            }

            // Removed cancel button since processing is too fast to cancel

            // Update processing speed
            function updateProcessingSpeed() {
                const speedElement = document.getElementById('processing-speed');
                if (speedElement && processingStats.startTime && processingStats.processedDocs > 0) {
                    const elapsed = (Date.now() - processingStats.startTime) / 60000; // minutes
                    const speed = (processingStats.processedDocs / elapsed).toFixed(1);
                    speedElement.textContent = `Speed: ${speed} docs/min`;
                }
            }

            // Update last update timestamp
            function updateLastUpdate() {
                const element = document.getElementById('last-update');
                if (element) {
                    const now = new Date().toLocaleTimeString();
                    element.textContent = `Last update: ${now}`;
                }
            }

            // Add activity to log with color coding
            window.updateActivityLog = function(message, type = 'info') {
                const logDiv = document.getElementById('activity-log');
                const timestamp = new Date().toLocaleTimeString();

                // Add to log array
                activityLog.push({ timestamp, message, type });

                // Create colored log entry
                const colors = {
                    'info': 'text-base-content',
                    'success': 'text-success',
                    'error': 'text-error',
                    'warning': 'text-warning',
                    'processing': 'text-info'
                };

                const entry = document.createElement('div');
                entry.className = `text-sm ${colors[type] || colors.info} mb-1`;
                entry.innerHTML = `<span class="text-xs opacity-60">[${timestamp}]</span> ${message}`;

                // Clear "No activity" message if present
                if (logDiv.querySelector('.text-base-content\\/60')) {
                    logDiv.innerHTML = '';
                }

                logDiv.appendChild(entry);
                logDiv.scrollTop = logDiv.scrollHeight;

                updateLastUpdate();
                updateProcessingSpeed();
            };

            // Simulate webhook status updates
            function updateWebhookStatus(connected) {
                const statusBadge = document.getElementById('webhook-status');
                if (statusBadge) {
                    const indicator = statusBadge.querySelector('.rounded-full');
                    if (connected) {
                        indicator.className = 'w-2 h-2 rounded-full bg-success mr-1 animate-pulse';
                        statusBadge.innerHTML = '<span class="w-2 h-2 rounded-full bg-success mr-1 animate-pulse"></span>Connected';
                        statusBadge.className = 'badge badge-sm badge-success';
                    } else {
                        indicator.className = 'w-2 h-2 rounded-full bg-gray-400 mr-1';
                        statusBadge.innerHTML = '<span class="w-2 h-2 rounded-full bg-gray-400 mr-1"></span>Disconnected';
                        statusBadge.className = 'badge badge-sm';
                    }
                }
            }

            // Simplified - no longer tracking stages, progress, or ETA
            window.updateProcessingFile = function(fileName) {
                const fileNameElement = document.getElementById('current-file-name');
                if (fileNameElement) {
                    fileNameElement.textContent = fileName;
                }
            };

            // Hook into document processor events
            if (window.documentProcessor) {
                const originalProcess = window.documentProcessor.processFile;
                window.documentProcessor.processFile = async function(fileItem) {
                    updateActivityLog(`Starting: ${fileItem.file.name}`, 'processing');
                    processingStats.totalDocs++;
                    if (!processingStats.startTime) {
                        processingStats.startTime = Date.now();
                    }

                    try {
                        const result = await originalProcess.call(this, fileItem);
                        processingStats.processedDocs++;
                        updateActivityLog(`‚úì Completed: ${fileItem.file.name}`, 'success');

                        // Auto-refresh document list after successful processing
                        if (window.documentManager && window.documentManager.loadDocuments) {
                            setTimeout(() => {
                                window.documentManager.loadDocuments();
                                updateActivityLog('üìã Document list refreshed', 'info');
                            }, 1000); // Small delay to ensure database is updated
                        }

                        return result;
                    } catch (error) {
                        updateActivityLog(`‚úó Failed: ${fileItem.file.name} - ${error.message}`, 'error');
                        throw error;
                    }
                };

                // Also hook into the startProcessing method to detect batch completion
                const originalStart = window.documentProcessor.startProcessing;
                window.documentProcessor.startProcessing = async function() {
                    const result = await originalStart.call(this);

                    // Batch processing completed - do a final refresh
                    updateActivityLog('‚úÖ All documents processed', 'success');
                    if (window.documentManager && window.documentManager.loadDocuments) {
                        setTimeout(() => {
                            window.documentManager.loadDocuments();
                            updateActivityLog('üìã Final document list refresh', 'info');
                        }, 1500);
                    }

                    return result;
                };
            }

            // Initial webhook status
            updateWebhookStatus(false);

            // Simulate webhook connection after 2 seconds (for demo)
            setTimeout(() => {
                updateWebhookStatus(true);
                updateActivityLog('Webhook connected to LlamaCloud', 'success');
            }, 2000);
        }

        // =========== RAG System Prompt functionality - SPLIT INTERFACE ===========
        // Initialize the RAG system prompt tab with split interface
        const ragPreContextArea = document.getElementById('RAG_PRE_CONTEXT');
        const ragPostContextArea = document.getElementById('RAG_POST_CONTEXT');
        const ragLivePreview = document.getElementById('PROMPT_LIVE_PREVIEW');
        const savePromptBtn = document.getElementById('savePromptBtn');
        const resetPromptBtn = document.getElementById('resetPromptBtn');
        const loadTemplateBtn = document.getElementById('loadTemplateBtn');
        const templateModal = document.getElementById('templateModal');
        const applyTemplateBtn = document.getElementById('applyTemplateBtn');
        const cancelTemplateBtn = document.getElementById('cancelTemplateBtn');
        const saveTemplateBtn = document.getElementById('saveTemplateBtn');
        const saveTemplateModal = document.getElementById('saveTemplateModal');
        const confirmSaveTemplateBtn = document.getElementById('confirmSaveTemplateBtn');
        const cancelSaveTemplateBtn = document.getElementById('cancelSaveTemplateBtn');
        const templateName = document.getElementById('templateName');
        const templateDescription = document.getElementById('templateDescription');
        
        // Template definitions
        const promptTemplates = {
            helpful: {
                preContext: `You are a helpful and friendly AI assistant. Your primary goal is to provide accurate, useful information based on the documents and knowledge available to you.

When answering questions:
1. ALWAYS check the context first for relevant information
2. Use a warm, approachable tone while maintaining professionalism
3. Cite specific documents or sources when referencing the context
4. Break down complex topics into easy-to-understand explanations
5. If information isn't in the context, acknowledge this clearly`,
                postContext: `Based on the context provided, offer comprehensive and helpful answers. If specific information is missing, suggest how the user might rephrase their question or what additional information would be helpful.`
            },
            professional: {
                preContext: `You are a professional business consultant and expert advisor. Your role is to provide formal, precise, and business-oriented guidance.

When providing information:
1. ALWAYS reference the context for business data and insights
2. Maintain a formal, professional tone throughout
3. Structure answers with clear logical organization
4. Cite specific sources and documents from the context
5. Focus on actionable insights and practical recommendations
6. Use industry-standard terminology and best practices`,
                postContext: `Based on the business context provided, deliver data-driven recommendations. If the context lacks specific information, professionally indicate this and suggest appropriate business channels for obtaining the required data.`
            },
            educational: {
                preContext: `You are an experienced educator and tutor. Your mission is to help users learn and understand topics thoroughly using available educational resources.

When teaching:
1. FIRST consult the context for educational materials and information
2. Use clear language appropriate for the learner's level
3. Provide step-by-step explanations for complex topics
4. Include examples and analogies from the context
5. Reference specific educational sources
6. Break down information into digestible segments
7. Encourage critical thinking`,
                postContext: `Using the educational context provided, create engaging learning experiences. If specific information is missing from the context, guide learners toward appropriate resources and encourage focused questions.`
            },
            technical: {
                preContext: `You are a senior technical specialist and software development expert. Your responses must be precise, accurate, and technically sound.

When providing technical guidance:
1. ALWAYS consult the context for technical documentation first
2. Use precise technical terminology and industry standards
3. Provide code examples from the context when available
4. Reference official documentation and sources
5. Include implementation details and best practices
6. Highlight potential pitfalls to avoid
7. Structure responses clearly (overview, implementation, examples)`,
                postContext: `Based on the technical context provided, deliver accurate solutions and implementations. If specific technical details are missing, recommend official documentation or suggest more targeted technical queries.`
            },
            chatragSales: {
                preContext: `You are ChatRAG Sales Assistant, representing the ChatRAG intelligent document management platform.

When engaging with prospects:
1. ALWAYS reference the context for product details, pricing, and features
2. Highlight ChatRAG's capabilities: RAG technology, document processing, vector search
3. Use specific examples and case studies from the context
4. Address security and privacy concerns with facts from documentation
5. Explain pricing tiers clearly using context information
6. Guide prospects through deployment options
7. Maintain enthusiastic yet professional tone
8. Provide personalized recommendations based on needs`,
                postContext: `Using the product context provided, demonstrate ChatRAG's value proposition. If specific details are missing from the context, offer to connect prospects with our sales team for personalized demonstrations.`
            },
            customerSupport: {
                preContext: `You are a dedicated customer support specialist. Your mission is to resolve issues quickly and effectively with empathy.

When assisting customers:
1. FIRST search the context for solutions and documentation
2. Begin with empathy and acknowledge concerns
3. Use context to find solutions to issues
4. Provide clear, step-by-step instructions
5. Anticipate and address follow-up questions
6. Maintain patient, understanding tone
7. Cite relevant documentation from context
8. Escalate complex issues when appropriate`,
                postContext: `Using the support context provided, resolve customer issues effectively. If solutions aren't in the context, provide alternative support channels and ensure customers feel heard and valued.`
            },
            researchAssistant: {
                preContext: `You are an academic research assistant conducting thorough, objective research.

When supporting research:
1. PRIMARILY use the context for research materials and data
2. Approach topics with academic rigor and objectivity
3. Identify relevant papers and studies from the context
4. Critically evaluate source credibility
5. Synthesize information from multiple sources
6. Use proper academic citations for context sources
7. Highlight methodologies and limitations
8. Maintain scholarly objectivity`,
                postContext: `Based on the research context provided, synthesize findings objectively. If the context lacks specific information, identify gaps and suggest academic databases or methodologies to fill them.`
            },
            codeAssistant: {
                preContext: `You are an expert software development assistant helping developers write better code.

When assisting with code:
1. ALWAYS check the context for documentation and examples first
2. Analyze problems systematically using context information
3. Provide clean code examples from the context
4. Explain reasoning behind solutions
5. Consider performance, security, and maintainability
6. Reference official documentation from context
7. Suggest multiple approaches with trade-offs
8. Include error handling considerations`,
                postContext: `Using the technical context provided, deliver robust code solutions. If specific examples are missing from the context, suggest official documentation and general best practices.`
            },
            legalAnalyst: {
                preContext: `You are a legal document analyst providing information (not legal advice) based on available resources.

When analyzing legal content:
1. IMPORTANT: Use only the context - this is information, not legal advice
2. Identify relevant legal concepts from the context
3. Break down complex legal language clearly
4. Highlight important clauses and conditions
5. Reference specific document sections from context
6. Identify areas of importance
7. Maintain objectivity
8. Emphasize need for qualified legal counsel`,
                postContext: `Based on the legal context provided, explain concepts clearly. If information is missing from the context, strongly recommend consulting qualified legal professionals for advice.`
            },
            medicalInformation: {
                preContext: `You are a medical information specialist providing educational health information ONLY (not medical advice).

When discussing health topics:
1. DISCLAIMER: This is educational information from the context only - NOT medical advice
2. Use only evidence-based information from the context
3. Explain medical concepts in accessible language
4. Reference medical sources from the context
5. Emphasize consulting healthcare professionals
6. Never diagnose or recommend treatments
7. Present balanced medical perspectives
8. Include statistics from context only`,
                postContext: `Based strictly on the medical context provided, offer educational information. If the context lacks specific health information, emphasize consulting qualified healthcare professionals immediately.`
            },
            whatsappConversational: {
                preContext: `You are a friendly WhatsApp AI assistant. Keep responses mobile-friendly and concise.

When messaging:
1. CHECK the context first for information
2. Keep responses short for mobile reading
3. Use simple, conversational language
4. Break info into brief paragraphs
5. Prefer numbered lists over bullets
6. Summarize instead of long URLs
7. Present context info clearly and briefly
8. Occasional emoji is okay üòä`,
                postContext: `Using the context, provide brief, helpful answers. If information isn't in the context, acknowledge briefly and suggest simpler phrasing.`
            }
        };
        
        // Safe decode function to handle multiple layers of URL encoding
        function safeDecodeText(text) {
            if (!text) return text;
            try {
                // Recursively decode until no more encoding detected
                let decoded = text;
                let previous = '';
                let iterations = 0;
                const maxIterations = 10; // Prevent infinite loops
                
                while (decoded !== previous && decoded.includes('%') && iterations < maxIterations) {
                    previous = decoded;
                    try {
                        decoded = decodeURIComponent(decoded);
                        iterations++;
                    } catch (e) {
                        console.warn('Decoding iteration failed:', e);
                        break;
                    }
                }
                
                if (iterations > 0) {
                    console.log(`[safeDecodeText] Successfully decoded text after ${iterations} iterations`);
                }
                
                return decoded;
            } catch (e) {
                console.warn('Safe decoding failed, returning original text:', e);
                return text;
            }
        }

        // Load the RAG system prompt with split interface
        function fetchRagPrompt() {
            fetch('/api/config/rag-prompt')
                .then(response => response.json())
                .then(data => {
                    console.log('Fetched RAG prompt data:', data);
                    
                    if (data.warning) {
                        showToast(data.warning, 'warning');
                    }
                    
                    // Populate the split interface with safe decoding
                    if (ragPreContextArea) {
                        const decodedPreContext = safeDecodeText(data.preContext || '');
                        ragPreContextArea.value = decodedPreContext;
                        console.log('[fetchRagPrompt] Pre-context decoded and populated');
                    }
                    if (ragPostContextArea) {
                        const decodedPostContext = safeDecodeText(data.postContext || '');
                        ragPostContextArea.value = decodedPostContext;
                        console.log('[fetchRagPrompt] Post-context decoded and populated');
                    }
                    
                    // Update live preview
                    updateLivePreview();
                })
                .catch(error => {
                    console.error('Error fetching RAG system prompt:', error);
                    showToast('Error loading RAG system prompt', 'error');
                    
                    // Set default values
                    if (ragPreContextArea) {
                        ragPreContextArea.value = `You are a helpful AI assistant with access to a knowledge base. When answering questions:

1. If the context contains relevant information, use it to provide accurate and specific answers
2. If information is not available in the context, say so clearly and suggest alternative approaches  
3. Always cite your sources when referencing specific documents
4. Provide balanced, objective information rather than opinions
5. For technical topics, include practical steps or examples when appropriate`;
                    }
                    if (ragPostContextArea) {
                        ragPostContextArea.value = '';
                    }
                    updateLivePreview();
                });
        }
        
        // Update the live preview
        function updateLivePreview() {
            if (!ragLivePreview) {
                console.warn('Live preview element not found');
                return;
            }
            
            const preContext = ragPreContextArea?.value.trim() || '';
            const postContext = ragPostContextArea?.value.trim() || '';
            
            let fullPrompt = preContext;
            if (fullPrompt) fullPrompt += '\n\n';
            fullPrompt += 'Context:\n{{context}}';
            if (postContext) {
                fullPrompt += '\n\n' + postContext;
            }
            
            ragLivePreview.textContent = fullPrompt;
            console.log('Live preview updated with content:', fullPrompt.length, 'characters');
        }
        
        // Save the RAG system prompt with split interface
        async function saveRagPrompt(showSuccessToast = true) {
            const preContext = ragPreContextArea?.value.trim() || '';
            const postContext = ragPostContextArea?.value.trim() || '';
            
            if (!preContext) {
                showToast('Pre-context instructions are required', 'error');
                return false;
            }
            
            try {
                const response = await fetch('/api/config/rag-prompt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        preContext: preContext,
                        postContext: postContext
                    })
                });
                
                // Check if the response is OK before parsing JSON
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    if (showSuccessToast) {
                        showToast('RAG system prompt saved successfully!', 'success');
                    }
                    updateLivePreview();
                    return true;
                } else {
                    console.error('[saveRagPrompt] Save failed:', data.error);
                    showToast('Error saving RAG system prompt: ' + (data.error || 'Unknown error'), 'error');
                    return false;
                }
            } catch (error) {
                console.error('[saveRagPrompt] Error saving RAG system prompt:', error);
                showToast('Error saving RAG system prompt: ' + error.message, 'error');
                return false;
            }
        }

        // Reset the RAG system prompt to default
        function resetRagPrompt() {
            if (confirm('Are you sure you want to reset the RAG system prompt to the default?')) {
                if (ragPreContextArea) {
                    ragPreContextArea.value = `You are a helpful AI assistant with access to a knowledge base. When answering questions:

1. If the context contains relevant information, use it to provide accurate and specific answers
2. If information is not available in the context, say so clearly and suggest alternative approaches
3. Always cite your sources when referencing specific documents
4. Provide balanced, objective information rather than opinions
5. For technical topics, include practical steps or examples when appropriate`;
                }
                if (ragPostContextArea) {
                    ragPostContextArea.value = `Based on the context provided, deliver clear and comprehensive answers. If the requested information is not available in the context, acknowledge this limitation and suggest alternative approaches or clarify what additional information would be needed.`;
                }
                updateLivePreview();
                saveRagPrompt().then(success => {
                    if (success) {
                        console.log('[resetRagPrompt] Default prompt saved successfully');
                    }
                });
            }
        }
        
        // Template modal functions
        function showTemplateModal() {
            if (templateModal) {
                templateModal.classList.add('modal-open');
                
                // Clear previous selections
                document.querySelectorAll('.template-option').forEach(option => {
                    option.classList.remove('border-primary', 'bg-primary/10');
                });
                
                // Load custom templates
                refreshCustomTemplatesDisplay();
            }
        }
        
        function hideTemplateModal() {
            const modal = document.getElementById('templateModal');
            if (modal) {
                modal.classList.remove('modal-open');
                // Force close by removing any inline styles that might have been added
                modal.style.display = '';
                modal.style.opacity = '';
                modal.style.visibility = '';
                // Ensure body scroll is restored
                document.body.style.overflow = '';
                // Find and click the backdrop if it exists (DaisyUI modals use this)
                const backdrop = modal.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.click();
                }
            }
        }
        
        // Custom template management functions
        function getCustomTemplates() {
            const stored = localStorage.getItem('ragCustomTemplates');
            return stored ? JSON.parse(stored) : {};
        }
        
        function saveCustomTemplate(name, description, preContext, postContext) {
            const customTemplates = getCustomTemplates();
            const templateId = 'custom_' + Date.now();
            
            customTemplates[templateId] = {
                name: name,
                description: description || '',
                preContext: preContext,
                postContext: postContext,
                created: new Date().toISOString()
            };
            
            localStorage.setItem('ragCustomTemplates', JSON.stringify(customTemplates));
            return templateId;
        }
        
        function deleteCustomTemplate(templateId) {
            const customTemplates = getCustomTemplates();
            delete customTemplates[templateId];
            localStorage.setItem('ragCustomTemplates', JSON.stringify(customTemplates));
        }
        
        function refreshCustomTemplatesDisplay() {
            const customTemplates = getCustomTemplates();
            const customSection = document.getElementById('customTemplatesSection');
            const customContainer = document.getElementById('customTemplatesContainer');
            
            if (Object.keys(customTemplates).length > 0) {
                customSection.classList.remove('hidden');
                customContainer.innerHTML = Object.entries(customTemplates).map(([id, template]) => `
                    <div class="template-option card bg-base-200 cursor-pointer hover:bg-base-300 transition-colors" data-template="${id}">
                        <div class="card-body py-3">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-medium">${template.name}</div>
                                    <div class="text-sm text-base-content/70">${template.description}</div>
                                </div>
                                <button class="btn btn-ghost btn-xs text-error" onclick="deleteCustomTemplateAndRefresh('${id}')">‚úï</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                customSection.classList.add('hidden');
            }
        }
        
        function deleteCustomTemplateAndRefresh(templateId) {
            if (confirm('Delete this custom template?')) {
                deleteCustomTemplate(templateId);
                refreshCustomTemplatesDisplay();
            }
        }
        
        function showSaveTemplateModal() {
            if (templateName) templateName.value = '';
            if (templateDescription) templateDescription.value = '';
            if (saveTemplateModal) saveTemplateModal.classList.add('modal-open');
        }
        
        function hideSaveTemplateModal() {
            if (saveTemplateModal) saveTemplateModal.classList.remove('modal-open');
        }
        
        function confirmSaveTemplate() {
            const name = templateName?.value?.trim();
            const description = templateDescription?.value?.trim();
            const preContext = ragPreContextArea?.value?.trim();
            const postContext = ragPostContextArea?.value?.trim();
            
            if (!name) {
                showToast('Please enter a template name', 'warning');
                return;
            }
            
            if (!preContext && !postContext) {
                showToast('Please enter some content for the template', 'warning');
                return;
            }
            
            try {
                const templateId = saveCustomTemplate(name, description, preContext || '', postContext || '');
                hideSaveTemplateModal();
                refreshCustomTemplatesDisplay();
                showToast('Template saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving template:', error);
                showToast('Error saving template', 'error');
            }
        }
        
        // Export templates functionality
        function exportTemplates() {
            try {
                const customTemplates = getCustomTemplates();
                const exportData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    templates: customTemplates
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `chatrag-templates-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showToast(`Exported ${Object.keys(customTemplates).length} templates`, 'success');
            } catch (error) {
                console.error('Error exporting templates:', error);
                showToast('Error exporting templates', 'error');
            }
        }
        
        // Import templates functionality
        function handleImportTemplates(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    // Validate import data structure
                    if (!importData.templates || typeof importData.templates !== 'object') {
                        throw new Error('Invalid template file format');
                    }
                    
                    const currentTemplates = getCustomTemplates();
                    const importedTemplates = importData.templates;
                    let importCount = 0;
                    let skipCount = 0;
                    
                    // Process each imported template
                    for (const [id, template] of Object.entries(importedTemplates)) {
                        // Check if template already exists by name
                        const existingTemplate = Object.values(currentTemplates).find(
                            t => t.name === template.name
                        );
                        
                        if (existingTemplate) {
                            // Ask user about overwriting
                            if (confirm(`Template "${template.name}" already exists. Overwrite?`)) {
                                // Find and remove existing template
                                const existingId = Object.keys(currentTemplates).find(
                                    key => currentTemplates[key].name === template.name
                                );
                                if (existingId) {
                                    delete currentTemplates[existingId];
                                }
                                currentTemplates[id] = template;
                                importCount++;
                            } else {
                                skipCount++;
                            }
                        } else {
                            currentTemplates[id] = template;
                            importCount++;
                        }
                    }
                    
                    // Save updated templates
                    localStorage.setItem('ragCustomTemplates', JSON.stringify(currentTemplates));
                    refreshCustomTemplatesDisplay();
                    
                    let message = `Imported ${importCount} templates`;
                    if (skipCount > 0) {
                        message += ` (skipped ${skipCount} existing)`;
                    }
                    showToast(message, 'success');
                    
                } catch (error) {
                    console.error('Error importing templates:', error);
                    showToast('Error importing templates: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
            // Reset the file input
            event.target.value = '';
        }
        
        // Share current prompt functionality
        function shareCurrentPrompt() {
            try {
                const preContext = ragPreContextArea?.value?.trim() || '';
                const postContext = ragPostContextArea?.value?.trim() || '';
                
                if (!preContext && !postContext) {
                    showToast('No prompt content to share', 'warning');
                    return;
                }
                
                const shareData = {
                    preContext: preContext,
                    postContext: postContext,
                    timestamp: new Date().toISOString()
                };
                
                // Compress and encode the data
                const jsonStr = JSON.stringify(shareData);
                const compressed = btoa(encodeURIComponent(jsonStr));
                
                // Create shareable URL
                const currentUrl = new URL(window.location.href);
                currentUrl.searchParams.set('sharedPrompt', compressed);
                
                // Copy to clipboard
                navigator.clipboard.writeText(currentUrl.toString()).then(() => {
                    showToast('Share link copied to clipboard!', 'success');
                    
                    // Also show a modal with the link
                    showShareModal(currentUrl.toString());
                }).catch((err) => {
                    console.error('Failed to copy to clipboard:', err);
                    // Fallback: show modal with link for manual copying
                    showShareModal(currentUrl.toString());
                });
                
            } catch (error) {
                console.error('Error sharing prompt:', error);
                showToast('Error creating share link', 'error');
            }
        }
        
        // Show share modal with link
        function showShareModal(shareUrl) {
            // Create a simple modal to display the share link
            const modal = document.createElement('div');
            modal.className = 'modal modal-open';
            modal.innerHTML = `
                <div class="modal-box">
                    <h3 class="font-bold text-lg mb-4">Share System Prompt</h3>
                    <p class="mb-4">Share this link to let others use your system prompt:</p>
                    <div class="form-control">
                        <input type="text" value="${shareUrl}" class="input input-bordered" readonly>
                    </div>
                    <div class="modal-action">
                        <button class="btn btn-primary" onclick="navigator.clipboard.writeText('${shareUrl}').then(() => showToast('Copied!', 'success'))">Copy Link</button>
                        <button class="btn" onclick="this.closest('.modal').remove()">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Check for shared template in URL
        function checkForSharedTemplate() {
            const urlParams = new URLSearchParams(window.location.search);
            const sharedPrompt = urlParams.get('sharedPrompt');
            
            if (sharedPrompt) {
                try {
                    // Decode and decompress the data
                    const decoded = decodeURIComponent(atob(sharedPrompt));
                    const shareData = JSON.parse(decoded);
                    
                    // Show confirmation modal
                    const modal = document.createElement('div');
                    modal.className = 'modal modal-open';
                    modal.innerHTML = `
                        <div class="modal-box">
                            <h3 class="font-bold text-lg mb-4">Import Shared System Prompt?</h3>
                            <p class="mb-4">Someone shared a system prompt with you. Would you like to load it?</p>
                            <div class="bg-base-200 p-4 rounded-lg mb-4">
                                <p class="text-sm text-base-content/70 mb-2">Preview:</p>
                                <p class="text-sm whitespace-pre-wrap max-h-32 overflow-auto">${shareData.preContext.substring(0, 200)}${shareData.preContext.length > 200 ? '...' : ''}</p>
                            </div>
                            <div class="modal-action">
                                <button class="btn btn-primary" id="acceptSharedPrompt">Load Prompt</button>
                                <button class="btn" id="rejectSharedPrompt">Cancel</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    
                    // Handle acceptance
                    document.getElementById('acceptSharedPrompt').addEventListener('click', () => {
                        // Switch to the System Prompt tab
                        const promptTab = document.querySelector('[data-tab="rag-prompt"]');
                        if (promptTab) {
                            promptTab.click();
                        }
                        
                        // Load the shared prompt
                        if (ragPreContextArea) ragPreContextArea.value = shareData.preContext || '';
                        if (ragPostContextArea) ragPostContextArea.value = shareData.postContext || '';
                        updateLivePreview();
                        
                        modal.remove();
                        showToast('Shared prompt loaded successfully!', 'success');
                        
                        // Remove the parameter from URL
                        urlParams.delete('sharedPrompt');
                        const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
                        window.history.replaceState({}, '', newUrl);
                    });
                    
                    // Handle rejection
                    document.getElementById('rejectSharedPrompt').addEventListener('click', () => {
                        modal.remove();
                        // Remove the parameter from URL
                        urlParams.delete('sharedPrompt');
                        const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
                        window.history.replaceState({}, '', newUrl);
                    });
                    
                } catch (error) {
                    console.error('Error loading shared prompt:', error);
                    showToast('Error loading shared prompt', 'error');
                }
            }
        }
        
        // System Prompt Translation Manager (Inline Version)
        const systemPromptTranslationManager = {
            translatedContent: null,
            
            async translateCurrentPrompt() {
                const targetLanguage = document.getElementById('promptTranslationLanguage').value.trim();
                const provider = document.getElementById('promptTranslationProvider').value;
                const preContext = document.getElementById('RAG_PRE_CONTEXT').value;
                const postContext = document.getElementById('RAG_POST_CONTEXT').value;
                
                if (!targetLanguage) {
                    throw new Error('Please enter a target language');
                }
                
                if (!preContext && !postContext) {
                    throw new Error('No prompt content to translate');
                }
                
                // Check if running on config server
                const isConfigServer = window.location.port === '3333';
                
                if (isConfigServer) {
                    // Use the config server's /api/translate endpoint
                    const textsToTranslate = [];
                    if (preContext) textsToTranslate.push(preContext);
                    if (postContext) textsToTranslate.push(postContext);
                    
                    const response = await fetch('/api/translate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            targetLanguage,
                            texts: textsToTranslate,
                            provider
                        })
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Translation failed');
                    }
                    
                    const result = await response.json();
                    
                    // Reassemble the translated parts
                    let translatedPreContext = '';
                    let translatedPostContext = '';
                    
                    if (preContext && result.translations[0]) {
                        translatedPreContext = result.translations[0];
                    }
                    
                    if (postContext && result.translations[preContext ? 1 : 0]) {
                        translatedPostContext = result.translations[preContext ? 1 : 0];
                    }
                    
                    // Ensure {{context}} placeholder is preserved
                    const hasContextInOriginal = preContext.includes('{{context}}') || postContext?.includes('{{context}}');
                    const hasContextInTranslation = translatedPreContext.includes('{{context}}') || translatedPostContext.includes('{{context}}');
                    
                    if (hasContextInOriginal && !hasContextInTranslation) {
                        // If context was lost in translation, add it back
                        if (preContext.includes('{{context}}') && !translatedPreContext.includes('{{context}}')) {
                            translatedPreContext += '\n\nContext:\n{{context}}';
                        }
                    }
                    
                    // Return in the same format as the main app endpoint
                    return {
                        success: true,
                        translated: {
                            preContext: translatedPreContext,
                            postContext: translatedPostContext
                        },
                        metadata: {
                            hasContext: translatedPreContext.includes('{{context}}') || translatedPostContext.includes('{{context}}')
                        }
                    };
                    
                } else {
                    // Use the main app's specialized endpoint
                    const requestBody = {
                        templateKey: 'current',
                        targetLanguage,
                        provider,
                        preContext: preContext || '',
                        postContext: postContext || ''
                    };
                    
                    const response = await fetch('/api/config/system-prompts/translate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Translation failed');
                    }
                    
                    const result = await response.json();
                    return result;
                }
            },
            
            // New inline translation methods
            async performInlineTranslation() {
                const translateBtn = document.getElementById('translatePromptBtn');
                const statusDiv = document.getElementById('promptTranslationStatus');
                const statusText = document.getElementById('promptTranslationMessage');  // Fixed ID
                const previewDiv = document.getElementById('promptTranslationPreview');
                const previewContent = document.getElementById('promptTranslationResult');  // Fixed ID
                const applyBtn = document.getElementById('applyTranslationBtn');
                const cancelBtn = document.getElementById('cancelTranslationBtn');
                
                try {
                    // Update UI for loading state
                    translateBtn.disabled = true;
                    translateBtn.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Translating...';
                    statusDiv.classList.remove('hidden');
                    statusDiv.querySelector('.alert').className = 'alert alert-info';
                    statusText.textContent = 'Translating system prompt...';
                    
                    // Perform translation using existing method
                    const result = await this.translateCurrentPrompt();
                    
                    // Store translated content
                    this.translatedContent = result.translated;
                    
                    // Show preview - combine pre and post context for display
                    let fullTranslatedPrompt = '';
                    const preContext = result.translated.preContext || '';
                    const postContext = result.translated.postContext || '';
                    
                    // Check if {{context}} exists in either part
                    const hasContextPlaceholder = preContext.includes('{{context}}') || postContext.includes('{{context}}');
                    
                    if (hasContextPlaceholder) {
                        // If {{context}} exists, highlight it
                        fullTranslatedPrompt = preContext + (postContext ? '\n\n' + postContext : '');
                        fullTranslatedPrompt = fullTranslatedPrompt.replace(
                            /\{\{context\}\}/g,
                            '<span class="bg-yellow-300 text-black px-1 rounded font-semibold">{{context}}</span>'
                        );
                    } else {
                        // If no {{context}} placeholder, add a visual separator showing where it would go
                        fullTranslatedPrompt = preContext;
                        if (preContext && postContext) {
                            fullTranslatedPrompt += '\n\n<div class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-center font-semibold my-2">[CONTEXT WILL BE INSERTED HERE]</div>\n\n';
                            fullTranslatedPrompt += postContext;
                        } else if (preContext && !postContext) {
                            fullTranslatedPrompt += '\n\n<div class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-center font-semibold my-2">[CONTEXT WILL BE INSERTED HERE]</div>';
                        } else if (!preContext && postContext) {
                            fullTranslatedPrompt = '<div class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-center font-semibold my-2">[CONTEXT WILL BE INSERTED HERE]</div>\n\n' + postContext;
                        }
                    }
                    
                    previewContent.innerHTML = fullTranslatedPrompt;
                    previewDiv.classList.remove('hidden');
                    
                    // Update status
                    statusDiv.querySelector('.alert').className = 'alert alert-success';
                    const targetLanguage = document.getElementById('promptTranslationLanguage').value;
                    statusText.textContent = `Successfully translated to ${targetLanguage}`;
                    
                    // Show action buttons
                    applyBtn.classList.remove('hidden');
                    cancelBtn.classList.remove('hidden');
                    translateBtn.classList.add('hidden');
                    
                } catch (error) {
                    console.error('Translation error:', error);
                    statusDiv.querySelector('.alert').className = 'alert alert-error';
                    statusText.textContent = `Translation failed: ${error.message}`;
                    translateBtn.disabled = false;
                    translateBtn.innerHTML = '<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path></svg> Translate';
                }
            },
            
            applyInlineTranslation() {
                if (!this.translatedContent) return;
                
                // Apply translated content to the form fields
                const preContextArea = document.getElementById('RAG_PRE_CONTEXT');
                const postContextArea = document.getElementById('RAG_POST_CONTEXT');
                
                if (preContextArea) {
                    preContextArea.value = this.translatedContent.preContext || '';
                }
                
                if (postContextArea) {
                    postContextArea.value = this.translatedContent.postContext || '';
                }
                
                // Update live preview
                updateLivePreview();
                
                // Reset translation UI
                this.cancelInlineTranslation();
                
                // Show success message
                showToast('Translation applied successfully', 'success');
            },
            
            cancelInlineTranslation() {
                // Reset UI elements
                const translateBtn = document.getElementById('translatePromptBtn');
                const applyBtn = document.getElementById('applyTranslationBtn');
                const cancelBtn = document.getElementById('cancelTranslationBtn');
                const previewDiv = document.getElementById('promptTranslationPreview');
                const statusDiv = document.getElementById('promptTranslationStatus');
                
                // Reset buttons
                translateBtn.classList.remove('hidden');
                translateBtn.disabled = false;
                translateBtn.innerHTML = '<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path></svg> Translate';
                applyBtn.classList.add('hidden');
                cancelBtn.classList.add('hidden');
                
                // Hide preview and status
                previewDiv.classList.add('hidden');
                statusDiv.classList.add('hidden');
                
                // Clear stored translation
                this.translatedContent = null;
            },
            
            showTranslateModal(templateKey) {
                const modal = document.getElementById('translateTemplateModal');
                const label = document.getElementById('translatingTemplateLabel');
                
                // Get template data
                const template = promptTemplates[templateKey];
                if (!template) {
                    showToast('Template not found', 'error');
                    return;
                }
                
                this.currentTemplate = { key: templateKey, data: template };
                
                // Update modal UI
                const templateNames = {
                    helpful: 'Helpful Assistant',
                    professional: 'Professional Expert',
                    educational: 'Educational Tutor',
                    technical: 'Technical Specialist',
                    chatragSales: 'ChatRAG Sales Assistant',
                    customerSupport: 'Customer Support Specialist',
                    researchAssistant: 'Research Assistant',
                    codeAssistant: 'Code Assistant',
                    legalAnalyst: 'Legal Document Analyst',
                    medicalInformation: 'Medical Information Specialist',
                    whatsappConversational: 'WhatsApp Conversational'
                };
                
                label.textContent = templateNames[templateKey] || templateKey;
                
                // Reset modal state
                document.getElementById('translateTargetLanguage').value = '';
                document.getElementById('translateProvider').value = 'openai';
                document.getElementById('translateStatus').classList.add('hidden');
                document.getElementById('translatePreview').classList.add('hidden');
                document.getElementById('applyTranslationBtn').classList.add('hidden');
                document.getElementById('performTranslateBtn').classList.remove('hidden');
                document.getElementById('performTranslateBtnText').textContent = 'Translate';
                
                // Show modal
                modal.classList.add('modal-open');
            },
            
            hideTranslateModal() {
                const modal = document.getElementById('translateTemplateModal');
                modal.classList.remove('modal-open');
                this.currentTemplate = null;
                this.translatedContent = null;
            },
            
            async performTranslation() {
                if (!this.currentTemplate) return;
                
                const performBtn = document.getElementById('performTranslateBtn');
                const performBtnText = document.getElementById('performTranslateBtnText');
                const statusDiv = document.getElementById('translateStatus');
                const statusText = document.getElementById('translateStatusText');
                const previewDiv = document.getElementById('translatePreview');
                const previewContent = document.getElementById('translatedPromptPreview');
                const applyBtn = document.getElementById('applyTranslationBtn');
                
                try {
                    // Update UI for loading state
                    performBtn.disabled = true;
                    performBtnText.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Translating...';
                    statusDiv.classList.remove('hidden');
                    statusDiv.querySelector('.alert').className = 'alert alert-info';
                    statusText.textContent = 'Translating template...';
                    
                    // Perform translation
                    const result = await this.translateTemplate(
                        this.currentTemplate.key,
                        this.currentTemplate.data
                    );
                    
                    // Store translated content
                    this.translatedContent = result.translated;
                    
                    // Show preview
                    const assembledPrompt = result.translated.preContext + 
                        (result.translated.postContext ? '\n\n' + result.translated.postContext : '');
                    previewContent.textContent = assembledPrompt;
                    previewDiv.classList.remove('hidden');
                    
                    // Update status
                    statusDiv.querySelector('.alert').className = 'alert alert-success';
                    statusText.textContent = `Successfully translated to ${document.getElementById('translateTargetLanguage').value}`;
                    
                    // Show apply button, hide translate button
                    applyBtn.classList.remove('hidden');
                    performBtn.classList.add('hidden');
                    
                } catch (error) {
                    console.error('Translation error:', error);
                    statusDiv.querySelector('.alert').className = 'alert alert-error';
                    statusText.textContent = `Translation failed: ${error.message}`;
                    performBtn.disabled = false;
                    performBtnText.textContent = 'Translate';
                }
            },
            
            applyTranslation() {
                if (!this.translatedContent) return;
                
                // Apply translated content to the form
                const preContextArea = document.getElementById('RAG_PRE_CONTEXT');
                const postContextArea = document.getElementById('RAG_POST_CONTEXT');
                
                if (preContextArea) {
                    preContextArea.value = this.translatedContent.preContext;
                }
                if (postContextArea) {
                    postContextArea.value = this.translatedContent.postContext;
                }
                
                // Update live preview
                updateLivePreview();
                
                // Close modal
                this.hideTranslateModal();
                
                // Show success message
                const targetLang = document.getElementById('translateTargetLanguage').value;
                showToast(`Applied ${targetLang} translation. Remember to save your changes!`, 'success');
            }
        };
        
        // Track initialization to prevent multiple calls
        let systemPromptInitialized = false;
        
        // Initialize System Prompt functionality
        function initSystemPrompt() {
            if (systemPromptInitialized) {
                console.log('System Prompt already initialized, updating preview');
                updateLivePreview();
                return;
            }
            
            console.log('Initializing System Prompt functionality');
            systemPromptInitialized = true;
            
            // Set initial preview immediately (even before API loads)
            updateLivePreview();
            
            // Load current prompt on tab activation
            fetchRagPrompt();
            
            // Add event listeners for live preview updates
            if (ragPreContextArea) {
                ragPreContextArea.addEventListener('input', updateLivePreview);
            }
            if (ragPostContextArea) {
                ragPostContextArea.addEventListener('input', updateLivePreview);
            }
            
            // Button event listeners
            if (savePromptBtn) {
                savePromptBtn.addEventListener('click', async () => {
                    // Disable button and show loading state
                    const originalHTML = savePromptBtn.innerHTML;
                    savePromptBtn.disabled = true;
                    savePromptBtn.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Saving...';
                    
                    try {
                        // Save the prompt
                        await saveRagPrompt();
                    } catch (error) {
                        console.error('[savePromptBtn] Error during save:', error);
                    } finally {
                        // Always re-enable button and restore text
                        savePromptBtn.disabled = false;
                        savePromptBtn.innerHTML = originalHTML;
                    }
                });
            }
            if (resetPromptBtn) {
                resetPromptBtn.addEventListener('click', resetRagPrompt);
            }
            if (loadTemplateBtn) {
                loadTemplateBtn.addEventListener('click', showTemplateModal);
            }
            if (saveTemplateBtn) {
                saveTemplateBtn.addEventListener('click', showSaveTemplateModal);
            }
            
            // Template modal event listeners
            if (cancelTemplateBtn) {
                cancelTemplateBtn.addEventListener('click', hideTemplateModal);
            }
            
            // Translation button event listeners
            document.querySelectorAll('.translate-template-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const templateKey = btn.dataset.template;
                    systemPromptTranslationManager.showTranslateModal(templateKey);
                });
            });
            
            // Translation modal event listeners
            const performTranslateBtn = document.getElementById('performTranslateBtn');
            const applyTranslationBtn = document.getElementById('applyTranslationBtn');
            const cancelTranslateBtn = document.getElementById('cancelTranslateBtn');
            
            if (performTranslateBtn) {
                performTranslateBtn.addEventListener('click', () => {
                    systemPromptTranslationManager.performTranslation();
                });
            }
            
            if (applyTranslationBtn) {
                applyTranslationBtn.addEventListener('click', () => {
                    systemPromptTranslationManager.applyTranslation();
                });
            }
            
            if (cancelTranslateBtn) {
                cancelTranslateBtn.addEventListener('click', () => {
                    systemPromptTranslationManager.hideTranslateModal();
                });
            }
            
            // Inline translation event listeners for System Prompt section
            const translatePromptBtn = document.getElementById('translatePromptBtn');
            const applyInlineTranslationBtn = document.getElementById('applyTranslationBtn');
            const cancelInlineTranslationBtn = document.getElementById('cancelTranslationBtn');
            
            if (translatePromptBtn) {
                translatePromptBtn.addEventListener('click', () => {
                    systemPromptTranslationManager.performInlineTranslation();
                });
            }
            
            if (applyInlineTranslationBtn) {
                applyInlineTranslationBtn.addEventListener('click', () => {
                    systemPromptTranslationManager.applyInlineTranslation();
                });
            }
            
            if (cancelInlineTranslationBtn) {
                cancelInlineTranslationBtn.addEventListener('click', () => {
                    systemPromptTranslationManager.cancelInlineTranslation();
                });
            }
            
            if (applyTemplateBtn) {
                applyTemplateBtn.addEventListener('click', async () => {
                    const selectedOption = document.querySelector('.template-option.border-primary');
                    if (!selectedOption) {
                        showToast('Please select a template first', 'warning');
                        return;
                    }
                    
                    const templateType = selectedOption.dataset.template;
                    const originalText = applyTemplateBtn.textContent;
                    
                    // Enhanced logging for debugging
                    console.log('[applyTemplate] Starting template application:', {
                        templateType,
                        selectedOption: selectedOption.textContent?.trim(),
                        timestamp: new Date().toISOString()
                    });
                    
                    try {
                        // Disable the button and show enhanced loading state
                        applyTemplateBtn.disabled = true;
                        applyTemplateBtn.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Applying...';
                        
                        // Load template content
                        let template = null;
                        if (templateType.startsWith('custom_')) {
                            // Custom template
                            const customTemplates = getCustomTemplates();
                            template = customTemplates[templateType];
                            console.log('[applyTemplate] Loading custom template:', templateType, template ? 'found' : 'not found');
                        } else {
                            // Built-in template
                            template = promptTemplates[templateType];
                            console.log('[applyTemplate] Loading built-in template:', templateType, template ? 'found' : 'not found');
                        }
                        
                        if (!template) {
                            throw new Error(`Template "${templateType}" not found`);
                        }
                        
                        // Apply template content to form fields
                        const preContext = template.preContext || '';
                        const postContext = template.postContext || '';
                        
                        console.log('[applyTemplate] Applying template content:', {
                            preContextLength: preContext.length,
                            postContextLength: postContext.length,
                            hasPreContext: !!preContext,
                            hasPostContext: !!postContext
                        });
                        
                        ragPreContextArea.value = preContext;
                        ragPostContextArea.value = postContext;
                        
                        // Update live preview
                        updateLivePreview();
                        
                        // Show saving indicator
                        showToast('Template loaded - now saving...', 'info');
                        
                        // Hide modal first
                        hideTemplateModal();
                        
                        // Enhanced saving with retry mechanism
                        const maxRetries = 3;
                        let saveSuccess = false;
                        let lastError = null;
                        
                        for (let attempt = 1; attempt <= maxRetries; attempt++) {
                            try {
                                console.log(`[applyTemplate] Save attempt ${attempt}/${maxRetries}`);
                                applyTemplateBtn.innerHTML = `<span class="loading loading-spinner loading-sm"></span> Saving (${attempt}/${maxRetries})...`;
                                
                                // Add timeout to prevent hanging
                                const savePromise = saveRagPrompt(false);
                                const timeoutPromise = new Promise((_, reject) => {
                                    setTimeout(() => reject(new Error('Save operation timed out')), 10000);
                                });
                                
                                saveSuccess = await Promise.race([savePromise, timeoutPromise]);
                                
                                if (saveSuccess) {
                                    console.log(`[applyTemplate] Save successful on attempt ${attempt}`);
                                    break;
                                } else {
                                    lastError = new Error(`Save failed on attempt ${attempt}`);
                                    console.warn(`[applyTemplate] Save failed on attempt ${attempt}, retrying...`);
                                }
                            } catch (error) {
                                lastError = error;
                                console.error(`[applyTemplate] Save error on attempt ${attempt}:`, error);
                                
                                if (attempt < maxRetries) {
                                    // Wait before retrying
                                    await new Promise(resolve => setTimeout(resolve, 1000));
                                }
                            }
                        }
                        
                        // Verify save by reading back the data
                        if (saveSuccess) {
                            try {
                                console.log('[applyTemplate] Verifying save by reading back data...');
                                const verifyResponse = await fetch('/api/config/rag-prompt', {
                                    method: 'GET',
                                    headers: { 'Content-Type': 'application/json' }
                                });
                                
                                if (verifyResponse.ok) {
                                    const verifyData = await verifyResponse.json();
                                    const isVerified = verifyData.preContext === preContext && verifyData.postContext === postContext;
                                    
                                    console.log('[applyTemplate] Save verification:', {
                                        isVerified,
                                        expectedPreLength: preContext.length,
                                        actualPreLength: verifyData.preContext?.length || 0,
                                        expectedPostLength: postContext.length,
                                        actualPostLength: verifyData.postContext?.length || 0
                                    });
                                    
                                    if (isVerified) {
                                        showToast(`‚úÖ "${selectedOption.textContent?.trim()}" template applied and saved successfully!`, 'success');
                                    } else {
                                        showToast('‚ö†Ô∏è Template applied but save verification failed. Please check the settings.', 'warning');
                                    }
                                } else {
                                    console.warn('[applyTemplate] Save verification request failed');
                                    showToast('‚úÖ Template applied and saved (verification unavailable)', 'success');
                                }
                            } catch (verifyError) {
                                console.error('[applyTemplate] Save verification error:', verifyError);
                                showToast('‚úÖ Template applied and saved (verification failed)', 'success');
                            }
                        } else {
                            console.error('[applyTemplate] All save attempts failed:', lastError);
                            showToast(`‚ùå Template applied but failed to save after ${maxRetries} attempts. Please try saving manually.`, 'error');
                        }
                        
                    } catch (error) {
                        console.error('[applyTemplate] Critical error during template application:', {
                            error: error.message,
                            stack: error.stack,
                            templateType,
                            timestamp: new Date().toISOString()
                        });
                        
                        // Show detailed error information
                        const errorMessage = error.message || 'Unknown error occurred';
                        showToast(`‚ùå Error applying template: ${errorMessage}`, 'error');
                        
                        // Try to restore the original form state if possible
                        try {
                            fetchRagPrompt();
                        } catch (restoreError) {
                            console.error('[applyTemplate] Failed to restore original state:', restoreError);
                        }
                        
                    } finally {
                        // Always restore button state
                        if (applyTemplateBtn) {
                            applyTemplateBtn.disabled = false;
                            applyTemplateBtn.innerHTML = originalText;
                        }
                        
                        console.log('[applyTemplate] Template application completed:', {
                            templateType,
                            timestamp: new Date().toISOString()
                        });
                    }
                });
            }
            
            // Save template modal event listeners
            if (cancelSaveTemplateBtn) {
                cancelSaveTemplateBtn.addEventListener('click', hideSaveTemplateModal);
            }
            if (confirmSaveTemplateBtn) {
                confirmSaveTemplateBtn.addEventListener('click', confirmSaveTemplate);
            }
            
            // New export/import/share event listeners
            const exportTemplatesBtn = document.getElementById('exportTemplatesBtn');
            const importTemplatesBtn = document.getElementById('importTemplatesBtn');
            const shareCurrentBtn = document.getElementById('shareCurrentBtn');
            const importTemplateFile = document.getElementById('importTemplateFile');
            
            if (exportTemplatesBtn) {
                exportTemplatesBtn.addEventListener('click', exportTemplates);
            }
            if (importTemplatesBtn) {
                importTemplatesBtn.addEventListener('click', () => {
                    importTemplateFile.click();
                });
            }
            if (importTemplateFile) {
                importTemplateFile.addEventListener('change', handleImportTemplates);
            }
            if (shareCurrentBtn) {
                shareCurrentBtn.addEventListener('click', shareCurrentPrompt);
            }
            
            // Check for shared template in URL on page load
            checkForSharedTemplate();
            
            // Template selection handling
            document.addEventListener('click', (e) => {
                if (e.target.closest('.template-option')) {
                    // Clear previous selections
                    document.querySelectorAll('.template-option').forEach(option => {
                        option.classList.remove('border-primary', 'bg-primary/10');
                    });
                    
                    // Select clicked template
                    const option = e.target.closest('.template-option');
                    option.classList.add('border-primary', 'bg-primary/10');
                }
            });
            
            // Modal backdrop close handling
            if (templateModal) {
                templateModal.addEventListener('click', (e) => {
                    if (e.target === templateModal) {
                        hideTemplateModal();
                    }
                });
            }
            if (saveTemplateModal) {
                saveTemplateModal.addEventListener('click', (e) => {
                    if (e.target === saveTemplateModal) {
                        hideSaveTemplateModal();
                    }
                });
            }
            
            console.log('System Prompt functionality initialized');
        }
        
        // System Prompt initialization is now handled by tab switching
        // No automatic initialization - only when user opens the tab
        
        // =========== End RAG System Prompt functionality ===========

        // =========== WhatsApp Configuration functionality ===========
        let whatsappConfigInitialized = false;
        
        // Initialize WhatsApp configuration
        function initWhatsAppConfig() {
            if (whatsappConfigInitialized) {
                console.log('WhatsApp config already initialized, refreshing values');
                loadWhatsAppConfig();
                return;
            }
            
            console.log('Initializing WhatsApp configuration');
            whatsappConfigInitialized = true;
            
            // Load current configuration
            loadWhatsAppConfig();
        }
        
        // Handle provider toggle
        function toggleWhatsAppProvider() {
            const provider = document.getElementById('whatsapp-provider').value;
            const koyebConfig = document.getElementById('koyeb-config');
            const flyioConfig = document.getElementById('flyio-config');
            const flyioApiKeySection = document.getElementById('flyio-api-key-section');
            
            if (provider === 'koyeb') {
                koyebConfig.classList.remove('hidden');
                flyioConfig.classList.add('hidden');
                if (flyioApiKeySection) {
                    flyioApiKeySection.classList.add('hidden');
                }
            } else if (provider === 'flyio') {
                koyebConfig.classList.add('hidden');
                flyioConfig.classList.remove('hidden');
                if (flyioApiKeySection) {
                    flyioApiKeySection.classList.remove('hidden');
                }
            }
        }
        
        // Load WhatsApp configuration values
        async function loadWhatsAppConfig() {
            try {
                const response = await fetch('/api/config');
                const data = await response.json();
                const config = data.config || {};
                
                // Set provider dropdown
                const providerSelect = document.getElementById('whatsapp-provider');
                if (providerSelect) {
                    providerSelect.value = config.WHATSAPP_PROVIDER || 'koyeb';
                    toggleWhatsAppProvider(); // Update visibility
                }
                
                // Set checkbox values
                const whatsappEnabled = document.getElementById('whatsapp-enabled');
                if (whatsappEnabled) {
                    whatsappEnabled.checked = config.NEXT_PUBLIC_WHATSAPP_ENABLED === 'true';
                }
                
                const mcpEnabled = document.getElementById('whatsapp-enable-mcp');
                if (mcpEnabled) {
                    mcpEnabled.checked = config.WHATSAPP_ENABLE_MCP === 'true';
                }
                
                const webSearchEnabled = document.getElementById('whatsapp-enable-web-search');
                if (webSearchEnabled) {
                    webSearchEnabled.checked = config.WHATSAPP_ENABLE_WEB_SEARCH === 'true';
                }
                
                // Set text input values
                const fields = [
                    'koyeb-baileys-url',
                    'koyeb-api-key',
                    'flyio-baileys-url',
                    'flyio-api-key',
                    'whatsapp-webhook-secret',
                    'whatsapp-webhook-url',
                    'whatsapp-max-tokens',
                    'whatsapp-system-prompt-suffix',
                    'whatsapp-max-sessions',
                    'whatsapp-queue-size'
                ];
                
                fields.forEach(fieldId => {
                    const element = document.getElementById(fieldId);
                    if (element) {
                        const key = element.getAttribute('data-key');
                        if (key && config[key]) {
                            element.value = config[key];
                        }
                    }
                });
                
                // Set model dropdown
                const modelSelect = document.getElementById('whatsapp-default-model');
                if (modelSelect && config.WHATSAPP_DEFAULT_MODEL) {
                    modelSelect.value = config.WHATSAPP_DEFAULT_MODEL;
                }
                
            } catch (error) {
                console.error('Error loading WhatsApp configuration:', error);
                showToast('Failed to load WhatsApp configuration', 'error');
            }
        }
        
        // Save WhatsApp configuration
        async function saveWhatsAppConfig() {
            // Get button reference at the start
            const saveButton = document.querySelector('#whatsapp button.btn-primary');
            let originalText = 'Save WhatsApp Configuration';
            
            try {
                // Show loading state
                if (saveButton) {
                    originalText = saveButton.textContent;
                    saveButton.disabled = true;
                    saveButton.textContent = 'Saving...';
                }
                
                // Collect all WhatsApp-related values
                const updates = {};
                
                // Get checkbox values
                const whatsappEnabled = document.getElementById('whatsapp-enabled');
                if (whatsappEnabled) {
                    updates.NEXT_PUBLIC_WHATSAPP_ENABLED = whatsappEnabled.checked ? 'true' : 'false';
                }
                
                const mcpEnabled = document.getElementById('whatsapp-enable-mcp');
                if (mcpEnabled) {
                    updates.WHATSAPP_ENABLE_MCP = mcpEnabled.checked ? 'true' : 'false';
                }
                
                const webSearchEnabled = document.getElementById('whatsapp-enable-web-search');
                if (webSearchEnabled) {
                    updates.WHATSAPP_ENABLE_WEB_SEARCH = webSearchEnabled.checked ? 'true' : 'false';
                }
                
                // Get provider value
                const providerSelect = document.getElementById('whatsapp-provider');
                if (providerSelect) {
                    updates.WHATSAPP_PROVIDER = providerSelect.value;
                }
                
                // Get text input values
                const fields = [
                    'koyeb-baileys-url',
                    'koyeb-api-key',
                    'flyio-baileys-url',
                    'flyio-api-key',
                    'whatsapp-webhook-secret',
                    'whatsapp-webhook-url',
                    'whatsapp-max-tokens',
                    'whatsapp-system-prompt-suffix',
                    'whatsapp-max-sessions',
                    'whatsapp-queue-size'
                ];
                
                fields.forEach(fieldId => {
                    const element = document.getElementById(fieldId);
                    if (element) {
                        const key = element.getAttribute('data-key');
                        if (key) {
                            updates[key] = element.value || '';
                        }
                    }
                });
                
                // Get model dropdown value
                const modelSelect = document.getElementById('whatsapp-default-model');
                if (modelSelect) {
                    updates.WHATSAPP_DEFAULT_MODEL = modelSelect.value;
                }
                
                // Update ConfigManager's internal config to prevent stale values
                if (window.configManager) {
                    Object.assign(window.configManager.config, updates);
                }
                
                // Save configuration
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updates)
                });
                
                if (!response.ok) {
                    throw new Error('Failed to save configuration');
                }
                
                const result = await response.json();
                
                // Show success message
                showToast('WhatsApp configuration saved successfully!', 'success');

                // Dispatch custom event to notify components
                window.dispatchEvent(new Event('whatsapp-config-changed'));
                window.dispatchEvent(new Event('config-saved'));

                // Restore button state
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.textContent = originalText;
                }
                
            } catch (error) {
                console.error('Error saving WhatsApp configuration:', error);
                showToast('Failed to save WhatsApp configuration: ' + error.message, 'error');
                
                // Restore button state
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.textContent = originalText;
                }
            }
        }
        
        // Make saveWhatsAppConfig available globally
        window.saveWhatsAppConfig = saveWhatsAppConfig;
        
        // =========== End WhatsApp Configuration functionality ===========
        
        // === Shared helpers ===

        // =========== Admin Management functionality ===========
        let adminManagementInitialized = false;
        
        // Initialize admin management functionality
        function initAdminManagement() {
            if (adminManagementInitialized) {
                console.log('Admin management already initialized, checking status');
                checkAdminStatus();
                fetchAdminUsers();
                return;
            }
            
            console.log('Initializing admin management functionality');
            adminManagementInitialized = true;
            
            // Elements
            const adminUsersList = document.getElementById('adminUsersList');
            const adminSetupStatus = document.getElementById('adminSetupStatus');
            const adminCountStatus = document.getElementById('adminCountStatus');
            const checkAdminBtn = document.getElementById('checkAdminBtn');
            const adminActionResult = document.getElementById('adminActionResult');
            const addAdminForm = document.getElementById('addAdminForm');
            
            // Check admin status immediately
            checkAdminStatus();
            
            // Setup event listeners
            if (checkAdminBtn) {
                checkAdminBtn.addEventListener('click', runCheckAdmin);
            }
            
            if (addAdminForm) {
                console.log('Setting up add admin form handler');
                addAdminForm.addEventListener('submit', handleAddAdmin);
            }
            
            // Fetch admin users
            fetchAdminUsers();
            
            async function checkAdminStatus() {
                try {
                    console.log('Checking admin status...');
                    updateStatusIndicator(adminSetupStatus, 'loading', 'Checking...');
                    updateStatusIndicator(adminCountStatus, 'loading', 'Checking...');
                    
                    const response = await fetch('/api/config/admin/status');
                    console.log('Admin status response received');
                    
                    if (!response.ok) {
                        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('Admin status data:', data);
                    
                    // Update status indicators
                    updateStatusIndicator(adminSetupStatus, 
                        data.isSetup ? 'success' : 'error',
                        data.isSetup ? 'Configured' : 'Not Configured');
                    
                    updateStatusIndicator(adminCountStatus, 
                        data.adminCount > 0 ? 'success' : 'warning',
                        `${data.adminCount} admin(s)`);
                    
                    // If there's an error, display it
                    if (data.hasError) {
                        console.warn('Admin status check reported an error:', data.errorMessage);
                        showAdminResult(`Status Check Error: ${data.errorMessage}`, 'error');
                    }
                    
                } catch (error) {
                    console.error('Error checking admin status:', error);
                    updateStatusIndicator(adminSetupStatus, 'error', 'Error');
                    updateStatusIndicator(adminCountStatus, 'error', 'Error');
                    showAdminResult(`Error checking admin status: ${error.message}`, 'error');
                }
            }
            
            function updateStatusIndicator(element, status, text) {
                if (!element) {
                    console.error('Status element not found');
                    return;
                }
                
                // Clear existing content
                element.innerHTML = '';
                
                // Add status indicator
                if (status === 'loading') {
                    element.innerHTML = `
                        <span class="loading loading-spinner loading-xs"></span>
                        <span class="ml-2">${text}</span>
                    `;
                    element.className = 'stat-value text-sm text-warning';
                } else if (status === 'success') {
                    element.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline"><polyline points="20 6 9 17 4 12"/></svg>
                        <span class="ml-2">${text}</span>
                    `;
                    element.className = 'stat-value text-sm text-success';
                } else if (status === 'error') {
                    element.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                        <span class="ml-2">${text}</span>
                    `;
                    element.className = 'stat-value text-sm text-error';
                } else if (status === 'warning') {
                    element.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                        <span class="ml-2">${text}</span>
                    `;
                    element.className = 'stat-value text-sm text-warning';
                }
            }
            
            async function fetchAdminUsers() {
                try {
                    console.log('Fetching admin users...');
                    if (!adminUsersList) {
                        console.error('Admin users list element not found');
                        return;
                    }
                    
                    adminUsersList.innerHTML = `
                        <div class="flex items-center gap-2 text-sm text-base-content/60">
                            <span class="loading loading-spinner loading-xs"></span>
                            Loading admin users...
                        </div>
                    `;
                    
                    const response = await fetch('/api/config/admin/users');
                    console.log('Admin users response received');
                    
                    if (!response.ok) {
                        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('Admin users data:', data);
                    
                    if (data.error) {
                        adminUsersList.innerHTML = `<div class="text-error text-sm">Error: ${data.error}</div>`;
                        return;
                    }
                    
                    if (data.users && data.users.length > 0) {
                        adminUsersList.innerHTML = '';
                        data.users.forEach(user => {
                            const userDiv = document.createElement('div');
                            userDiv.className = 'flex justify-between items-center p-3 bg-base-100 rounded-lg border';
                            userDiv.innerHTML = `
                                <div class="flex-1">
                                    <div class="font-medium text-sm">${user.email || 'Unknown Email'}</div>
                                    <div class="text-xs text-base-content/60">ID: ${user.id}</div>
                                </div>
                                <div class="flex-shrink-0">
                                    <button class="btn btn-outline btn-xs text-error" 
                                            ${user.id === 'from-env-file' ? 'disabled title="Cannot remove primary admin"' : `onclick="removeAdmin('${user.id}', '${user.email}')"`}>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                        Remove
                                    </button>
                                </div>
                            `;
                            adminUsersList.appendChild(userDiv);
                        });
                    } else {
                        adminUsersList.innerHTML = '<div class="text-base-content/60 text-sm">No admin users found.</div>';
                    }
                    
                    // Show partial data warning if needed
                    if (data.isPartial) {
                        const warningDiv = document.createElement('div');
                        warningDiv.className = 'text-warning text-sm mt-2';
                        warningDiv.textContent = `Note: Showing partial data. ${data.message || ''}`;
                        adminUsersList.appendChild(warningDiv);
                    }
                } catch (error) {
                    console.error('Error fetching admin users:', error);
                    adminUsersList.innerHTML = `<div class="text-error text-sm">Error loading admin users: ${error.message}</div>`;
                }
            }
            
            async function runAdminScript(script, loadingText) {
                try {
                    console.log(`Running admin script: ${script}`);
                    
                    // Show loading state
                    showAdminResult(loadingText, 'loading');
                    
                    // Disable buttons while script is running
                    setAdminButtonsDisabled(true);
                    
                    const response = await fetch('/api/config/admin/script', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ script })
                    });
                    
                    const data = await response.json();
                    console.log(`Script ${script} response:`, data);
                    
                    if (response.ok) {
                        showAdminResult(data.output || 'Operation completed successfully', 'success');
                        
                        // Refresh status and user list after operations
                        setTimeout(() => {
                            checkAdminStatus();
                            fetchAdminUsers();
                        }, 1000);
                    } else {
                        showAdminResult(`Error: ${data.error || 'Unknown error'}`, 'error');
                    }
                    
                } catch (error) {
                    console.error(`Error running ${script}:`, error);
                    showAdminResult(`Error: ${error.message || 'Failed to execute script'}`, 'error');
                } finally {
                    // Re-enable buttons
                    setAdminButtonsDisabled(false);
                }
            }
            
            function setAdminButtonsDisabled(disabled) {
                if (checkAdminBtn) {
                    checkAdminBtn.disabled = disabled;
                }
            }
            
            function showAdminResult(message, type = 'info') {
                if (!adminActionResult) return;
                
                adminActionResult.classList.remove('hidden');
                adminActionResult.innerHTML = '';
                
                let icon = '';
                let className = 'p-4 bg-base-100 rounded-lg border';
                
                if (type === 'success') {
                    icon = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-success inline mr-2"><polyline points="20 6 9 17 4 12"/></svg>';
                    className += ' border-success';
                } else if (type === 'error') {
                    icon = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-error inline mr-2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>';
                    className += ' border-error';
                } else if (type === 'loading') {
                    icon = '<span class="loading loading-spinner loading-sm text-warning inline mr-2"></span>';
                    className += ' border-warning';
                } else {
                    icon = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-info inline mr-2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>';
                    className += ' border-info';
                }
                
                adminActionResult.className = className;
                adminActionResult.innerHTML = `${icon}<span class="text-sm">${message}</span>`;
            }
            
            // Admin operation functions
            async function runCheckAdmin() {
                await runAdminScript('check-admin', 'Checking admin setup...');
            }
            
            // Password reset function removed - no longer needed in passwordless system
            
            async function handleAddAdmin(e) {
                e.preventDefault();
                console.log('Add admin form submitted');
                
                const emailField = document.getElementById('newAdminEmail');
                
                if (!emailField) {
                    showAdminResult('Email field not found', 'error');
                    return;
                }
                
                const email = emailField.value.trim();
                
                if (!email) {
                    showAdminResult('Email is required', 'error');
                    return;
                }
                
                try {
                    showAdminResult('Adding new admin...', 'loading');
                    
                    const response = await fetch('/api/config/admin/add', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ email })
                    });
                    
                    const data = await response.json();
                    console.log('Add admin response:', data);
                    
                    if (response.ok) {
                        showAdminResult('Admin user added successfully!', 'success');
                        emailField.value = '';
                        
                        // Refresh admin users list
                        setTimeout(() => {
                            fetchAdminUsers();
                            checkAdminStatus();
                        }, 1000);
                    } else {
                        showAdminResult(`Error adding admin: ${data.error || 'Unknown error'}`, 'error');
                    }
                    
                } catch (error) {
                    console.error('Error adding admin:', error);
                    showAdminResult(`Error adding admin: ${error.message}`, 'error');
                }
            }
            
            // Make removeAdmin global so it can be called from inline onclick
            window.removeAdmin = async function(adminId, email) {
                if (!adminId) {
                    showAdminResult('Admin ID is required', 'error');
                    return;
                }
                
                if (!confirm(`Are you sure you want to remove admin ${email}?`)) {
                    return;
                }
                
                try {
                    showAdminResult('Removing admin...', 'loading');
                    
                    const response = await fetch('/api/config/admin/remove', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ adminId })
                    });
                    
                    const data = await response.json();
                    console.log('Remove admin response:', data);
                    
                    if (response.ok) {
                        showAdminResult('Admin user removed successfully!', 'success');
                        
                        // Refresh admin users list
                        setTimeout(() => {
                            fetchAdminUsers();
                            checkAdminStatus();
                        }, 1000);
                    } else {
                        showAdminResult(`Error removing admin: ${data.error || 'Unknown error'}`, 'error');
                    }
                    
                } catch (error) {
                    console.error('Error removing admin:', error);
                    showAdminResult(`Error removing admin: ${error.message}`, 'error');
                }
            };
            
            console.log('Admin management functionality initialized');
        }
        
        // =========== End Admin Management functionality ===========

        // =========== MCP Config Management functionality ===========
        let mcpConfigInitialized = false;
        
        // Initialize MCP Config functionality
        function initMcpConfig() {
            if (mcpConfigInitialized) {
                console.log('MCP Config already initialized, refreshing data');
                if (window.mcpConfig) {
                    window.mcpConfig.loadServers();
                    window.mcpConfig.renderServerList();
                    updateMcpStats();
                }
                return;
            }
            
            console.log('Initializing MCP Config functionality');
            mcpConfigInitialized = true;
            
            // Wait for MCP Config manager to be available
            if (typeof McpConfigManager === 'undefined') {
                console.log('MCP Config Manager not available, waiting...');
                setTimeout(() => {
                    initMcpConfig();
                }, 500);
                return;
            }
            
            // Initialize MCP Config Manager if not already done
            if (!window.mcpConfig) {
                window.mcpConfig = new McpConfigManager();

                // Add discover built-in servers function
                window.mcpConfig.discoverBuiltinServers = function() {
                    this.showInfo('Built-in servers (Zapier) can be configured via environment variables. Check your .env.local file for MCP_ZAPIER_ENDPOINT settings.');
                };

                console.log('MCP Config Manager initialized');
            } else {
                // If already initialized, refresh the data
                window.mcpConfig.loadServers().then(() => {
                    window.mcpConfig.renderServerList();
                    updateMcpStats();
                });
            }
        }
        
        // Update MCP statistics in the dashboard
        function updateMcpStats() {
            if (!window.mcpConfig) return;

            // Use the counts stored from the API response
            const totalServers = window.mcpConfig.totalCount || 0;
            const builtinServers = window.mcpConfig.builtinCount || 0;

            // Calculate active servers from the servers array
            const servers = window.mcpConfig.servers || [];
            const activeServers = servers.filter(s => s.enabled).length;

            // Update the DOM elements
            const totalElement = document.getElementById('mcp-total-servers');
            const activeElement = document.getElementById('mcp-active-servers');
            const builtinElement = document.getElementById('mcp-builtin-servers');

            if (totalElement) totalElement.textContent = totalServers;
            if (activeElement) activeElement.textContent = activeServers;
            if (builtinElement) builtinElement.textContent = builtinServers;

            console.log(`[MCP Stats] Total: ${totalServers}, Active: ${activeServers}, Built-in: ${builtinServers}`);
        }
        
        // =========== End Suggestions Configuration Management ===========
        
        // =========== AI Model Configuration Management ===========
        let modelConfig = {
            provider: 'openrouter',
            openaiModels: [],
            openrouterModels: []
        };
        
        // Initialize model configuration when AI tab is opened
        document.addEventListener('click', (e) => {
            if (e.target.matches('[data-tab="ai"]') || e.target.closest('[data-tab="ai"]')) {
                setTimeout(() => {
                    initModelConfiguration();
                }, 100);
            }
        });
        
        async function initModelConfiguration() {
            try {
                // Load current configuration - use relative URL to work on any port
                const response = await fetch('../api/config/models');
                if (!response.ok) {
                    // If API fails, use defaults from environment
                    console.warn('API not available, using default configuration');
                    
                    // Get defaults from the config manager if available
                    const defaultProvider = window.configManager?.config?.NEXT_PUBLIC_AI_PROVIDER || 'openrouter';
                    const defaultOpenAIModels = window.configManager?.config?.NEXT_PUBLIC_OPENAI_MODELS || JSON.stringify([
                        { id: 'gpt-4.1-mini', displayName: 'GPT-4.1 Mini' },
                        { id: 'gpt-4.1', displayName: 'GPT-4.1' },
                        { id: 'o3', displayName: 'o3' },
                        { id: 'o4-mini', displayName: 'o4 Mini' }
                    ]);
                    const defaultOpenRouterModels = window.configManager?.config?.NEXT_PUBLIC_OPENROUTER_MODELS || JSON.stringify([
{ id: 'anthropic/claude-sonnet-4.5', displayName: 'Claude Sonnet 4.5', isDefault: true },
                        { id: 'openai/gpt-4.1-mini', displayName: 'GPT-4.1 Mini' },
                        { id: 'openai/gpt-4.1', displayName: 'GPT-4.1' },
                        { id: 'anthropic/claude-opus-4.1', displayName: 'Claude Opus 4.1' },
                        { id: 'google/gemini-2.5-flash-lite', displayName: 'Gemini 2.5 Flash Lite' },
                        { id: 'google/gemini-2.5-flash', displayName: 'Gemini 2.5 Flash' },
                        { id: 'meta-llama/llama-4-maverick', displayName: 'Llama 4 Maverick', isOpenSource: true },
                        { id: 'cognitivecomputations/dolphin-mistral-24b-venice-edition:free', displayName: 'Venice: Uncensored', isFree: true, isOpenSource: true, isUncensored: true }
                    ]);
                    
                    // Safe JSON parsing helper
                    const safeJsonParse = (value, fallback = []) => {
                        if (typeof value === 'object' && value !== null) {
                            return value; // Already parsed
                        }
                        if (typeof value === 'string') {
                            try {
                                return JSON.parse(value);
                            } catch (e) {
                                console.warn('Failed to parse JSON value:', value, e);
                                return fallback;
                            }
                        }
                        return fallback;
                    };
                    
                    modelConfig = {
                        provider: defaultProvider,
                        openaiModels: safeJsonParse(defaultOpenAIModels, [
                            { id: 'gpt-4.1-mini', displayName: 'GPT-4.1 Mini' },
                            { id: 'gpt-4.1', displayName: 'GPT-4.1' },
                            { id: 'o3', displayName: 'o3' },
                            { id: 'o4-mini', displayName: 'o4 Mini' }
                        ]),
                        openrouterModels: safeJsonParse(defaultOpenRouterModels, [
{ id: 'anthropic/claude-sonnet-4.5', displayName: 'Claude Sonnet 4.5', isDefault: true },
                            { id: 'openai/gpt-4.1-mini', displayName: 'GPT-4.1 Mini' },
                            { id: 'openai/gpt-4.1', displayName: 'GPT-4.1' },
                            { id: 'anthropic/claude-opus-4.1', displayName: 'Claude Opus 4.1' },
                            { id: 'google/gemini-2.5-flash-lite', displayName: 'Gemini 2.5 Flash Lite' },
                            { id: 'google/gemini-2.5-flash', displayName: 'Gemini 2.5 Flash' },
                            { id: 'meta-llama/llama-4-maverick', displayName: 'Llama 4 Maverick', isOpenSource: true },
                            { id: 'cognitivecomputations/dolphin-mistral-24b-venice-edition:free', displayName: 'Venice: Uncensored', isFree: true, isOpenSource: true, isUncensored: true }
                        ])
                    };
                } else {
                    modelConfig = await response.json();
                }
                
                // Set provider selector
                const providerSelect = document.getElementById('ai-provider-select');
                if (providerSelect) {
                    providerSelect.value = modelConfig.provider;
                    // Remove existing listeners to avoid duplicates
                    const newSelect = providerSelect.cloneNode(true);
                    providerSelect.parentNode.replaceChild(newSelect, providerSelect);
                    
                    newSelect.addEventListener('change', (e) => {
                        modelConfig.provider = e.target.value;
                        renderModels();
                    });
                }
                
                // Render models
                renderModels();
            } catch (error) {
                console.error('Failed to load model configuration:', error);
                
                // Determine error type for better user feedback
                let errorMessage = 'Using default model configuration';
                if (error.name === 'SyntaxError') {
                    errorMessage = 'JSON parsing error - using defaults. Check .env.local model configurations.';
                } else if (error.message?.includes('fetch')) {
                    errorMessage = 'API connection error - using defaults. Check if server is running.';
                } else {
                    errorMessage = `Configuration error: ${error.message} - using defaults.`;
                }
                
                // Use defaults on error
                modelConfig = {
                    provider: 'openrouter',
                    openaiModels: [
                        { id: 'gpt-4.1-mini', displayName: 'GPT-4.1 Mini' },
                        { id: 'gpt-4.1', displayName: 'GPT-4.1' },
                        { id: 'o3', displayName: 'o3' },
                        { id: 'o4-mini', displayName: 'o4 Mini' }
                    ],
                    openrouterModels: [
{ id: 'anthropic/claude-sonnet-4.5', displayName: 'Claude Sonnet 4.5', isDefault: true },
                        { id: 'openai/gpt-4.1-mini', displayName: 'GPT-4.1 Mini' },
                        { id: 'openai/gpt-4.1', displayName: 'GPT-4.1' },
                        { id: 'anthropic/claude-opus-4.1', displayName: 'Claude Opus 4.1' },
                        { id: 'google/gemini-2.5-flash-lite', displayName: 'Gemini 2.5 Flash Lite' },
                        { id: 'google/gemini-2.5-flash', displayName: 'Gemini 2.5 Flash' },
                        { id: 'meta-llama/llama-4-maverick', displayName: 'Llama 4 Maverick', isOpenSource: true },
                        { id: 'cognitivecomputations/dolphin-mistral-24b-venice-edition:free', displayName: 'Venice: Uncensored', isFree: true, isOpenSource: true, isUncensored: true }
                    ]
                };
                
                renderModels();
                showToast(errorMessage, 'warning');
                
                // Add error indicator to the UI
                const providerSelect = document.getElementById('ai-provider-select');
                if (providerSelect) {
                    providerSelect.style.borderColor = '#f59e0b'; // warning color
                    providerSelect.title = 'Configuration loaded with defaults due to: ' + error.message;
                }
            }
        }
        
        // Drag and Drop State
        let draggedElement = null;
        let draggedIndex = null;
        
        function handleDragStart(e) {
            draggedElement = e.currentTarget;
            draggedIndex = parseInt(draggedElement.dataset.index);
            draggedElement.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', draggedElement.innerHTML);
        }
        
        function handleDragEnd(e) {
            e.currentTarget.classList.remove('dragging');
            
            // Remove all drag-over classes
            document.querySelectorAll('.model-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        }
        
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }
        
        function handleDragEnter(e) {
            if (e.currentTarget !== draggedElement) {
                e.currentTarget.classList.add('drag-over');
            }
        }
        
        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }
        
        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            const dropTarget = e.currentTarget;
            const dropIndex = parseInt(dropTarget.dataset.index);
            
            // Don't do anything if dropping on itself
            if (draggedIndex === dropIndex) {
                return false;
            }
            
            // Get the models array
            const models = modelConfig.provider === 'openai' ? modelConfig.openaiModels : modelConfig.openrouterModels;
            
            // Remove dragged item and insert at new position
            const draggedModel = models.splice(draggedIndex, 1)[0];
            models.splice(dropIndex, 0, draggedModel);
            
            // Update the modelConfig
            if (modelConfig.provider === 'openai') {
                modelConfig.openaiModels = models;
            } else {
                modelConfig.openrouterModels = models;
            }
            
            // Re-render models with new order
            renderModels();
            
            // Show feedback
            showToast('Models reordered! Click "Save Model Configuration" to persist changes.', 'info');
            
            return false;
        }
        
        function renderModels() {
            const container = document.getElementById('models-container');
            if (!container) return;
            
            const models = modelConfig.provider === 'openai' ? modelConfig.openaiModels : modelConfig.openrouterModels;
            
            container.innerHTML = '';
            
            if (models.length === 0) {
                container.innerHTML = '<p class="text-base-content/70">No models configured for this provider.</p>';
                return;
            }
            
            models.forEach((model, index) => {
                const modelDiv = document.createElement('div');
                const isDefault = model.isDefault === true;
                modelDiv.className = `model-item flex items-center gap-2 p-2 rounded ${isDefault ? 'bg-primary/10 border-2 border-primary' : 'bg-base-300'}`;
                modelDiv.draggable = true;
                modelDiv.dataset.index = index;
                
                // Define theme-aware colors FIRST (before using them)
                const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                const purpleColor = isDark ? '#c084fc' : '#9333ea';
                const blueColor = isDark ? '#60a5fa' : '#2563eb';
                const redColor = isDark ? '#f472b6' : '#dc2626';
                const orangeColor = isDark ? '#fb923c' : '#ea580c';
                
                // Add brain icon for reasoning models (SVG to match other icons)
                const reasoningIndicator = model.supportsReasoning 
                    ? `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block ml-2" style="color: ${orangeColor}; vertical-align: middle;" title="Supports ${model.reasoningMethod || 'reasoning'}"><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/><path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/><path d="M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4"/><path d="M17.599 6.5a3 3 0 0 0 .399-1.375"/><path d="M6.003 5.125A3 3 0 0 0 6.401 6.5"/><path d="M3.477 10.896a4 4 0 0 1 .585-.396"/><path d="M19.938 10.5a4 4 0 0 1 .585.396"/><path d="M6 18a4 4 0 0 1-1.967-.516"/><path d="M19.967 17.484A4 4 0 0 1 18 18"/></svg>` 
                    : '';
                
                // Add gift icon for free models (using SVG to match main app)
                const freeIndicator = model.isFree 
                    ? `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block ml-2" style="color: ${purpleColor}; vertical-align: middle;" title="Free on OpenRouter"><path d="M12 7v14"/><path d="M16 3a4 4 0 0 0-8 0"/><path d="M7 12h10"/><rect x="3" y="7" width="18" height="14" rx="2"/></svg>`
                    : '';
                const openSourceIndicator = model.isOpenSource
                    ? `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block ml-2" style="color: ${blueColor}; vertical-align: middle;" title="Open Source"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>`
                    : '';
                const uncensoredIndicator = model.isUncensored
                    ? `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block ml-2" style="color: ${redColor}; vertical-align: middle;" title="Uncensored Model"><path d="M9 17H7A5 5 0 0 1 7 7h2"/><path d="M15 7h2a5 5 0 1 1 0 10h-2"/><line x1="8" x2="8" y1="12" y2="12"/><line x1="16" x2="16" y1="12" y2="12"/></svg>`
                    : '';
                
                // Default indicator (star icon for first model)
                const defaultBadge = isDefault 
                    ? `<span class="badge badge-primary badge-sm ml-2" title="Default Model">‚≠ê Default</span>` 
                    : '';
                
                // Set as default button (only show for non-default models)
                const setDefaultButton = !isDefault 
                    ? `<button onclick="setAsDefault(${index})" class="btn btn-sm btn-outline" title="Set as default model">‚≠ê Set Default</button>` 
                    : '';
                
                modelDiv.innerHTML = `
                    <div class="drag-handle mr-2" style="font-size: 1.2rem; line-height: 1;" title="Drag to reorder">
                        ‚ò∞
                    </div>
                    <div class="flex-1">
                        <span class="font-medium">${model.displayName}</span>
                        <span class="text-sm text-base-content/70 ml-2">(${model.id})</span>
                        ${reasoningIndicator}
                        ${freeIndicator}
                        ${openSourceIndicator}
                        ${uncensoredIndicator}
                        ${defaultBadge}
                    </div>
                    <div class="flex gap-2">
                        ${setDefaultButton}
                        <button onclick="removeModel(${index})" class="btn btn-sm btn-error btn-outline">Remove</button>
                    </div>
                `;
                
                // Add drag event listeners
                modelDiv.addEventListener('dragstart', handleDragStart);
                modelDiv.addEventListener('dragend', handleDragEnd);
                modelDiv.addEventListener('dragover', handleDragOver);
                modelDiv.addEventListener('drop', handleDrop);
                modelDiv.addEventListener('dragenter', handleDragEnter);
                modelDiv.addEventListener('dragleave', handleDragLeave);
                
                container.appendChild(modelDiv);
            });
        }
        
        function toggleTokenLimitSettings() {
            const checkbox = document.getElementById('USE_CUSTOM_TOKEN_LIMIT');
            const settings = document.getElementById('token-limit-settings');
            
            if (checkbox && settings) {
                settings.style.display = checkbox.checked ? 'block' : 'none';
            }
        }
        
        // =========== Auto-Fetch Model Info Functions ===========
        
        function toggleReasoningConfig() {
            const checkbox = document.getElementById('new-model-reasoning');
            const config = document.getElementById('reasoning-config');
            
            if (checkbox && config) {
                config.style.display = checkbox.checked ? 'block' : 'none';
            }
        }
        
        async function fetchModelInfo() {
            const idInput = document.getElementById('new-model-id');
            const fetchBtn = document.getElementById('fetch-model-btn');
            const fetchBtnText = document.getElementById('fetch-btn-text');
            const statusDiv = document.getElementById('model-fetch-status');
            
            if (!idInput || !fetchBtn || !fetchBtnText || !statusDiv) return;
            
            const modelId = idInput.value.trim();
            if (!modelId) {
                showToast('Please enter a Model ID first', 'error');
                return;
            }
            
            // Enhanced client-side logging
            console.log(`\nüîç === Config UI Model Fetch Request ===`);
            console.log(`üìä Timestamp: ${new Date().toISOString()}`);
            console.log(`üÜî Model ID: "${modelId}"`);
            console.log(`üåê Current URL: ${window.location.href}`);
            console.log(`üîó Base URL: ${window.location.origin}`);
            
            // Show loading state
            fetchBtn.disabled = true;
            fetchBtnText.textContent = '‚è≥ Fetching...';
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<span class="text-blue-600">üîç Looking up model information from OpenRouter...</span>';
            
            try {
                // Fix API URL - check if we're on config server (port 3333) or main app (port 3000)
                const isConfigServer = window.location.port === '3333';
                const apiUrl = isConfigServer 
                    ? `../api/config/openrouter-model-info?modelId=${encodeURIComponent(modelId)}`
                    : `/api/config/openrouter-model-info?modelId=${encodeURIComponent(modelId)}`;
                    
                console.log(`üì° Calling API: ${apiUrl} (Config Server: ${isConfigServer})`);
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        // Add browser-specific headers that might be needed
                    }
                });
                
                console.log(`üìä Response Status: ${response.status} ${response.statusText}`);
                console.log(`üìä Response Headers:`, Object.fromEntries(response.headers.entries()));
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`‚ùå API Error Response:`, errorText);
                    
                    if (response.status === 404) {
                        throw new Error(`Model '${modelId}' not found in OpenRouter catalog`);
                    }
                    throw new Error(`API request failed: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.model) {
                    // Auto-fill all the form fields
                    fillModelForm(data.model);
                    
                    // Show success status with enhanced visual feedback
                    const confidence = data.model.confidence;
                    const confidenceEmoji = confidence === 'high' ? 'üéØ' : confidence === 'medium' ? '‚ö°' : 'üí°';
                    const reasoningStatus = data.model.supportsReasoning 
                        ? `üß† Reasoning: ${data.model.reasoningMethod} (${confidence} confidence)`
                        : '‚ùå No reasoning support detected';
                    
                    statusDiv.innerHTML = `
                        <div class="alert alert-success shadow-lg" style="animation: slideIn 0.3s ease-out;">
                            <div>
                                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <div>
                                    <div class="font-bold">‚úÖ Model found! ${confidenceEmoji} Auto-filled successfully</div>
                                    <div class="text-sm">üìù ${data.model.displayName}</div>
                                    <div class="text-sm">üî¢ ${data.model.contextLength.toLocaleString()} tokens | ${data.model.isFree ? `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block" style="color: ${document.documentElement.getAttribute('data-theme') === 'dark' ? '#c084fc' : '#9333ea'}; vertical-align: middle;"><path d="M12 7v14"/><path d="M16 3a4 4 0 0 0-8 0"/><path d="M7 12h10"/><rect x="3" y="7" width="18" height="14" rx="2"/></svg> Free` : 'üí∞ Paid'}</div>
                                    <div class="text-sm">${reasoningStatus}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Add animation styles if not already present
                    if (!document.querySelector('#slideInAnimation')) {
                        const style = document.createElement('style');
                        style.id = 'slideInAnimation';
                        style.textContent = `
                            @keyframes slideIn {
                                from {
                                    opacity: 0;
                                    transform: translateY(-10px);
                                }
                                to {
                                    opacity: 1;
                                    transform: translateY(0);
                                }
                            }
                        `;
                        document.head.appendChild(style);
                    }
                    
                    showToast('Model information fetched and auto-filled successfully!', 'success');
                } else {
                    throw new Error(data.error || 'Unknown error occurred');
                }
                
            } catch (error) {
                console.error('Error fetching model info:', error);
                
                // Enhanced error handling with better visual feedback
                const errorMessage = error.message || 'Unknown error occurred';
                statusDiv.innerHTML = `
                    <div class="alert alert-warning shadow-lg" style="animation: slideIn 0.3s ease-out;">
                        <div>
                            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                            <div>
                                <div class="font-bold">‚ö†Ô∏è Auto-fetch couldn't find the model</div>
                                <div class="text-sm">${errorMessage}</div>
                                <div class="mt-2">
                                    <span class="text-sm">üí° You can still add it manually:</span>
                                    <div class="btn-group mt-1">
                                        <button onclick="enableManualMode()" class="btn btn-xs btn-secondary">
                                            ‚öôÔ∏è Manual Setup
                                        </button>
                                        <button onclick="retryAutoFetch()" class="btn btn-xs btn-primary">
                                            üîÑ Retry
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add animation styles if not already present
                if (!document.querySelector('#slideInAnimation')) {
                    const style = document.createElement('style');
                    style.id = 'slideInAnimation';
                    style.textContent = `
                        @keyframes slideIn {
                            from {
                                opacity: 0;
                                transform: translateY(-10px);
                            }
                            to {
                                opacity: 1;
                                transform: translateY(0);
                            }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                showToast('Auto-fetch failed, but you can add the model manually', 'warning');
            } finally {
                // Restore button state
                fetchBtn.disabled = false;
                fetchBtnText.textContent = 'üîç Auto-Fill';
            }
        }
        
        function fillModelForm(modelInfo) {
            // Fill basic fields
            document.getElementById('new-model-name').value = modelInfo.displayName || '';
            document.getElementById('new-model-context').value = modelInfo.contextLength || '';
            document.getElementById('new-model-description').value = modelInfo.description || '';
            
            // Set checkboxes
            document.getElementById('new-model-free').checked = modelInfo.isFree || false;
            document.getElementById('new-model-opensource').checked = modelInfo.isOpenSource || false;
            document.getElementById('new-model-uncensored').checked = modelInfo.isUncensored || false;
            document.getElementById('new-model-reasoning').checked = modelInfo.supportsReasoning || false;
            
            // Toggle reasoning config visibility
            toggleReasoningConfig();
            
            // Fill reasoning configuration if supported
            if (modelInfo.supportsReasoning) {
                if (modelInfo.reasoningMethod) {
                    document.getElementById('reasoning-method').value = modelInfo.reasoningMethod;
                }
                if (modelInfo.defaultEffort) {
                    document.getElementById('default-effort').value = modelInfo.defaultEffort;
                }
                if (modelInfo.maxTokensLimit) {
                    document.getElementById('max-tokens-limit').value = modelInfo.maxTokensLimit;
                }
                if (modelInfo.minTokens) {
                    document.getElementById('min-tokens').value = modelInfo.minTokens;
                }
            }
        }
        
        function resetModelForm() {
            // Reset all form fields
            document.getElementById('new-model-id').value = '';
            document.getElementById('new-model-name').value = '';
            document.getElementById('new-model-context').value = '';
            document.getElementById('new-model-description').value = '';
            
            document.getElementById('new-model-free').checked = false;
            document.getElementById('new-model-opensource').checked = false;
            document.getElementById('new-model-uncensored').checked = false;
            document.getElementById('new-model-reasoning').checked = false;
            
            document.getElementById('reasoning-method').value = 'max_tokens';
            document.getElementById('default-effort').value = 'medium';
            document.getElementById('max-tokens-limit').value = '';
            document.getElementById('min-tokens').value = '';
            
            // Hide reasoning config and status
            document.getElementById('reasoning-config').style.display = 'none';
            document.getElementById('model-fetch-status').style.display = 'none';
            
            showToast('Form reset', 'info');
        }
        
        function enableManualMode() {
            const statusDiv = document.getElementById('model-fetch-status');
            const modelId = document.getElementById('new-model-id').value.trim();
            
            // Auto-fill what we can from the model ID
            if (!document.getElementById('new-model-name').value && modelId) {
                // Generate a reasonable display name from model ID
                const displayName = modelId.split('/').pop()
                    .replace(/-/g, ' ')
                    .replace(/\b\w/g, l => l.toUpperCase());
                document.getElementById('new-model-name').value = displayName;
            }
            
            statusDiv.innerHTML = `
                <div class="text-yellow-600">
                    ‚öôÔ∏è Manual mode enabled. Please configure the model settings below:
                    <div class="text-sm mt-1">
                        üí° If this is a reasoning model, check "üß† Supports Reasoning" and configure the settings
                    </div>
                </div>
            `;
            
            showToast('Manual mode enabled - configure the model as needed', 'info');
        }
        
        function retryAutoFetch() {
            // Simply call fetchModelInfo again
            fetchModelInfo();
        }
        
        async function testOpenRouterConnection() {
            const statusDiv = document.getElementById('model-fetch-status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<span class="text-blue-600">üîß Testing OpenRouter API connection...</span>';
            
            try {
                console.log(`üîß Testing OpenRouter API connection...`);
                
                // Fix API URL for config server vs main app
                const isConfigServer = window.location.port === '3333';
                const testUrl = isConfigServer 
                    ? '../api/config/test-openrouter'
                    : '/api/config/test-openrouter';
                
                console.log(`üì° Calling test API: ${testUrl} (Config Server: ${isConfigServer})`);
                
                const response = await fetch(testUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log(`‚úÖ OpenRouter API test successful:`, data);
                    
                    const testResults = data.testModels.map(model => 
                        `${model.found ? '‚úÖ' : '‚ùå'} ${model.id}`
                    ).join('<br>');
                    
                    statusDiv.innerHTML = `
                        <div class="text-green-600">
                            ‚úÖ OpenRouter API connection successful!<br>
                            üìä Total models available: ${data.totalModels}<br>
                            <div class="text-xs mt-1">
                                <strong>Test Models:</strong><br>
                                ${testResults}
                            </div>
                        </div>
                    `;
                    
                    showToast('OpenRouter API connection test passed!', 'success');
                } else {
                    console.error(`‚ùå OpenRouter API test failed:`, data);
                    
                    statusDiv.innerHTML = `
                        <div class="text-red-600">
                            ‚ùå OpenRouter API test failed:<br>
                            ${data.error}<br>
                            <div class="text-xs mt-1">${data.details}</div>
                        </div>
                    `;
                    
                    showToast('OpenRouter API connection test failed: ' + data.error, 'error');
                }
                
            } catch (error) {
                console.error('Connection test error:', error);
                statusDiv.innerHTML = `
                    <div class="text-red-600">
                        ‚ùå Connection test failed: ${error.message}<br>
                        <div class="text-xs mt-1">Check browser console for details</div>
                    </div>
                `;
                showToast('Connection test failed: ' + error.message, 'error');
            }
        }
        
        // =========== End Auto-Fetch Functions ===========
        
        function addModel() {
            const idInput = document.getElementById('new-model-id');
            const nameInput = document.getElementById('new-model-name');
            const freeCheckbox = document.getElementById('new-model-free');
            const openSourceCheckbox = document.getElementById('new-model-opensource');
            const uncensoredCheckbox = document.getElementById('new-model-uncensored');
            const reasoningCheckbox = document.getElementById('new-model-reasoning');
            
            if (!idInput || !nameInput || !freeCheckbox || !openSourceCheckbox || !uncensoredCheckbox || !reasoningCheckbox) return;
            
            const id = idInput.value.trim();
            const displayName = nameInput.value.trim();
            const isFree = freeCheckbox.checked;
            const isOpenSource = openSourceCheckbox.checked;
            const isUncensored = uncensoredCheckbox.checked;
            const supportsReasoning = reasoningCheckbox.checked;
            
            if (!id || !displayName) {
                showToast('Please fill in both Model ID and Display Name', 'error');
                return;
            }
            
            // Build the model object with all fields
            const newModel = { 
                id, 
                displayName,
                ...(isFree && { isFree: true }),
                ...(isOpenSource && { isOpenSource: true }),
                ...(isUncensored && { isUncensored: true }),
                ...(document.getElementById('new-model-context').value && { 
                    contextLength: parseInt(document.getElementById('new-model-context').value) 
                }),
                ...(document.getElementById('new-model-description').value && { 
                    description: document.getElementById('new-model-description').value 
                })
            };
            
            // Add reasoning configuration if enabled
            if (supportsReasoning) {
                newModel.supportsReasoning = true;
                
                const reasoningMethod = document.getElementById('reasoning-method').value;
                if (reasoningMethod) {
                    newModel.reasoningMethod = reasoningMethod;
                }
                
                const defaultEffort = document.getElementById('default-effort').value;
                if (defaultEffort) {
                    newModel.defaultEffort = defaultEffort;
                }
                
                const maxTokensLimit = document.getElementById('max-tokens-limit').value;
                if (maxTokensLimit) {
                    newModel.maxTokensLimit = parseInt(maxTokensLimit);
                }
                
                const minTokens = document.getElementById('min-tokens').value;
                if (minTokens) {
                    newModel.minTokens = parseInt(minTokens);
                }
            }
            
            if (modelConfig.provider === 'openai') {
                modelConfig.openaiModels.push(newModel);
            } else {
                modelConfig.openrouterModels.push(newModel);
            }
            
            // Reset the form
            resetModelForm();
            
            renderModels();
            
            const reasoningStatus = supportsReasoning 
                ? ` with üß† ${newModel.reasoningMethod} reasoning`
                : '';
            showToast(`Model '${displayName}' added successfully${reasoningStatus}!`, 'success');
        }
        
        function removeModel(index) {
            if (modelConfig.provider === 'openai') {
                modelConfig.openaiModels.splice(index, 1);
            } else {
                modelConfig.openrouterModels.splice(index, 1);
            }
            
            renderModels();
            showToast('Model removed successfully', 'success');
        }
        
        function setAsDefault(index) {
            // Get the models array for the current provider
            const models = modelConfig.provider === 'openai' ? modelConfig.openaiModels : modelConfig.openrouterModels;
            
            // Remove isDefault flag from all models
            models.forEach(model => {
                delete model.isDefault;
            });
            
            // Set the selected model as default
            models[index].isDefault = true;
            
            // Update the modelConfig
            if (modelConfig.provider === 'openai') {
                modelConfig.openaiModels = models;
            } else {
                modelConfig.openrouterModels = models;
            }
            
            // Re-render the models list to show the new default
            renderModels();
            
            // Show success message
            showToast(`'${models[index].displayName}' is now the default model! üåü`, 'success');
            
            // Show info about saving
            setTimeout(() => {
                showToast('Remember to click "Save Model Configuration" to apply changes to .env.local', 'info');
            }, 1500);
        }
        
        async function saveModelConfiguration() {
            try {
                // Log the configuration being saved for debugging
                console.log('üìù Saving model configuration:', modelConfig);
                console.log(`üìä Total models to save: OpenAI=${modelConfig.openaiModels.length}, OpenRouter=${modelConfig.openrouterModels.length}`);
                
                // Show saving state
                const saveButton = event.target;
                const originalText = saveButton?.textContent || 'Save Model Configuration';
                if (saveButton) {
                    saveButton.disabled = true;
                    saveButton.textContent = '‚è≥ Saving to .env.local...';
                }
                
                const response = await fetch('../api/config/models', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(modelConfig)
                });
                
                console.log(`üì° Save response status: ${response.status}`);
                
                if (!response.ok) {
                    const errorData = await response.text();
                    console.error('‚ùå Save failed:', errorData);
                    throw new Error(`Failed to save: ${response.status} - ${errorData}`);
                }
                
                const result = await response.json();
                console.log('‚úÖ Save successful:', result);
                
                if (result.success) {
                    showToast('Model configuration saved successfully to .env.local!', 'success');
                    
                    // Show the updated values in console for reference
                    console.log('Model configuration saved automatically to .env.local:');
                    console.log('NEXT_PUBLIC_AI_PROVIDER=' + result.config.provider);
                    console.log('NEXT_PUBLIC_OPENAI_MODELS=' + JSON.stringify(result.config.openaiModels));
                    console.log('NEXT_PUBLIC_OPENROUTER_MODELS=' + JSON.stringify(result.config.openrouterModels));
                    
                    // Restore button state BEFORE showing alerts
                    if (saveButton) {
                        saveButton.disabled = false;
                        saveButton.textContent = originalText;
                    }
                    
                    // Now reload environment variables in the main app
                    try {
                        console.log('üîÑ Reloading environment variables in main ChatRAG app...');
                        const reloadResponse = await fetch('../api/config/reload', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            }
                        });
                        
                        if (reloadResponse.ok) {
                            const reloadResult = await reloadResponse.json();
                            console.log('‚úÖ Environment variables reloaded successfully:', reloadResult);
                            
                            // Show enhanced success message
                            const successMessage = `
‚úÖ Model configuration updated successfully!

Saved to .env.local:
‚Ä¢ Provider: ${result.config.provider}
‚Ä¢ OpenAI Models: ${result.config.openaiModels.length} models configured
‚Ä¢ OpenRouter Models: ${result.config.openrouterModels.length} models configured

üîÑ Environment variables reloaded in main app
‚Ä¢ Updated ${reloadResult.updatedKeys?.length || 0} environment variables  
‚Ä¢ Models refreshed automatically in main app

‚úÖ New models are now available immediately!
Go to your ChatRAG app and check the model dropdown - your new models should appear within 5 seconds.
                            `;
                            alert(successMessage);
                        } else {
                            console.warn('‚ö†Ô∏è Failed to reload environment variables');
                            // Fallback to original message
                            const successMessage = `
‚úÖ Model configuration saved to .env.local!

Updated values:
‚Ä¢ Provider: ${result.config.provider}
‚Ä¢ OpenAI Models: ${result.config.openaiModels.length} models configured
‚Ä¢ OpenRouter Models: ${result.config.openrouterModels.length} models configured

‚ö†Ô∏è Auto-reload failed. Please restart your ChatRAG application manually.
Run 'npm run dev' again in your terminal to pick up the new model configuration.
                            `;
                            alert(successMessage);
                        }
                    } catch (reloadError) {
                        console.error('Failed to reload environment variables:', reloadError);
                        // Fallback to original message
                        const successMessage = `
‚úÖ Model configuration saved to .env.local!

Updated values:
‚Ä¢ Provider: ${result.config.provider}
‚Ä¢ OpenAI Models: ${result.config.openaiModels.length} models configured
‚Ä¢ OpenRouter Models: ${result.config.openrouterModels.length} models configured

‚ö†Ô∏è Auto-reload failed. Please restart your ChatRAG application manually.
Run 'npm run dev' again in your terminal to pick up the new model configuration.
                        `;
                        alert(successMessage);
                    }
                }
            } catch (error) {
                console.error('‚ùå Failed to save model configuration:', error);
                
                // Restore button state if exists
                const saveButtons = document.querySelectorAll('button');
                saveButtons.forEach(btn => {
                    if (btn.textContent.includes('Saving')) {
                        btn.disabled = false;
                        btn.textContent = 'Save Model Configuration';
                    }
                });
                
                // Show detailed error message with troubleshooting
                const errorMessage = `
‚ùå Failed to save model configuration

Error: ${error.message}

Troubleshooting:
1. Make sure the main ChatRAG app is running (npm run dev)
2. Check that port 3000 is accessible
3. Verify .env.local file permissions
4. Try refreshing the page and saving again

If the issue persists, you can manually add models to .env.local:
NEXT_PUBLIC_OPENROUTER_MODELS=[{"id":"model-id","displayName":"Model Name"}]
                `;
                
                // Show both toast and alert for visibility
                showToast('Failed to save model configuration - see console for details', 'error');
                console.error(errorMessage);
                
                // Offer to verify current configuration
                if (confirm('Failed to save. Would you like to verify the current .env.local configuration?')) {
                    verifyEnvFile();
                }
            }
        }
        
        // Helper function to verify .env.local file
        async function verifyEnvFile() {
            try {
                console.log('üîç Verifying .env.local file...');
                const response = await fetch('../api/config/models');
                
                if (!response.ok) {
                    throw new Error(`Failed to read config: ${response.status}`);
                }
                
                const data = await response.json();
                
                console.log('üìã Current configuration from .env.local:');
                console.log(`‚úÖ Provider: ${data.provider}`);
                console.log(`‚úÖ OpenAI Models: ${data.openaiModels.length}`);
                console.log(`‚úÖ OpenRouter Models: ${data.openrouterModels.length}`);
                console.log('üìù Full config:', data);
                
                const message = `Current .env.local configuration:
‚Ä¢ Provider: ${data.provider}
‚Ä¢ OpenAI Models: ${data.openaiModels.length}
‚Ä¢ OpenRouter Models: ${data.openrouterModels.length}
                
Check console for full details.`;
                
                alert(message);
                showToast(`Verified: ${data.openaiModels.length + data.openrouterModels.length} models in .env.local`, 'success');
                
                // Update local modelConfig to match server
                modelConfig = data;
                renderModels();
                
            } catch (error) {
                console.error('‚ùå Error verifying .env.local:', error);
                showToast('Could not verify .env.local file - ensure main app is running', 'error');
            }
        }
        
        // =========== End AI Model Configuration Management ===========
        
        // =========== Global Reasoning Settings Management ===========
        
        // Update reasoning tokens display
        function updateReasoningTokensDisplay(value) {
            const display = document.getElementById('reasoning-tokens-display');
            const costEstimate = document.getElementById('reasoning-cost-estimate');
            const costMultiplier = parseFloat(document.getElementById('REASONING_COST_MULTIPLIER')?.value || 1.5);
            
            if (display) {
                display.textContent = `${value} tokens`;
            }
            
            if (costEstimate) {
                // Rough estimate: $0.015 per 1k reasoning tokens (based on OpenAI o-series pricing)
                const estimatedCost = (value / 1000) * 0.015 * costMultiplier;
                costEstimate.textContent = `Estimated cost: ~$${estimatedCost.toFixed(2)} per message at ${value} tokens`;
            }
        }
        
        // Update cost multiplier display
        function updateCostMultiplierDisplay(value) {
            const display = document.getElementById('cost-multiplier-display');
            if (display) {
                display.textContent = `${value}x`;
            }
            // Also update the cost estimate
            const tokensValue = document.getElementById('NEXT_PUBLIC_MAX_REASONING_TOKENS')?.value;
            if (tokensValue) {
                updateReasoningTokensDisplay(tokensValue);
            }
        }
        
        // Set reasoning preset
        // Media Generation Functions
        function updateImageProviderSettings() {
            const provider = document.getElementById('IMAGE_GENERATION_PROVIDER').value;
            
            // Hide all provider settings
            document.getElementById('openai-image-settings').style.display = 'none';
            document.getElementById('fal-image-settings').style.display = 'none';
            document.getElementById('replicate-image-settings').style.display = 'none';
            
            // Show selected provider settings
            if (provider === 'openai') {
                document.getElementById('openai-image-settings').style.display = 'block';
            } else if (provider === 'fal') {
                document.getElementById('fal-image-settings').style.display = 'block';
            } else if (provider === 'replicate') {
                document.getElementById('replicate-image-settings').style.display = 'block';
            }
        }
        
        function updateVideoProviderSettings() {
            const provider = document.getElementById('VIDEO_GENERATION_PROVIDER').value;
            
            // Hide all provider settings
            document.getElementById('fal-video-settings').style.display = 'none';
            document.getElementById('replicate-video-settings').style.display = 'none';
            
            // Show selected provider settings
            if (provider === 'fal') {
                document.getElementById('fal-video-settings').style.display = 'block';
            } else if (provider === 'replicate') {
                document.getElementById('replicate-video-settings').style.display = 'block';
            }
        }
        
        function update3DProviderSettings() {
            const checkbox = document.getElementById('USE_REPLICATE_PROVIDER');
            if (!checkbox) return;
            
            const useFalProvider = checkbox.checked;
            const falSettings = document.getElementById('fal-3d-settings');
            const replicateSettings = document.getElementById('replicate-3d-settings');
            
            if (falSettings && replicateSettings) {
                // Hide all provider settings
                falSettings.style.display = 'none';
                replicateSettings.style.display = 'none';
                
                // Show selected provider settings
                if (useFalProvider) {
                    falSettings.style.display = 'block';
                } else {
                    replicateSettings.style.display = 'block';
                }
            }
        }
        
        function updateReplicateImageModel() {
            const model = document.getElementById('REPLICATE_IMAGE_MODEL').value;
            const customDiv = document.getElementById('replicate-custom-model');
            
            if (model === 'custom') {
                customDiv.style.display = 'block';
            } else {
                customDiv.style.display = 'none';
            }
        }
        
        function testAPIKey(provider) {
            let apiKey = '';
            let testEndpoint = '';
            
            if (provider === 'fal') {
                apiKey = document.getElementById('FAL_API_KEY').value;
                if (!apiKey) {
                    showToast('Please enter a Fal.ai API key first', 'error');
                    return;
                }
                // Simple test - we'll just check if the key format is valid
                if (apiKey.startsWith('fal-')) {
                    showToast('Fal.ai API key format looks valid', 'success');
                } else {
                    showToast('Invalid Fal.ai API key format (should start with "fal-")', 'error');
                }
            } else if (provider === 'replicate') {
                apiKey = document.getElementById('REPLICATE_API_TOKEN').value;
                if (!apiKey) {
                    showToast('Please enter a Replicate API token first', 'error');
                    return;
                }
                // Simple test - check token format
                if (apiKey.startsWith('r8_') || apiKey.startsWith('r_')) {
                    showToast('Replicate API token format looks valid', 'success');
                } else {
                    showToast('Invalid Replicate token format (should start with "r8_" or "r_")', 'error');
                }
            }
        }
        
        
        function switchToTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            const targetTab = document.getElementById(tabName);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // Update menu items
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelectorAll(`.menu-item[data-tab="${tabName}"]`).forEach(item => {
                item.classList.add('active');
            });
        }

        function setReasoningPreset(preset) {
            const configs = {
                'cost': {
                    effort: 'low',
                    tokens: 2000,
                    ragEnabled: false,
                    showByDefault: false
                },
                'balanced': {
                    effort: 'medium',
                    tokens: 8000,
                    ragEnabled: true,
                    showByDefault: false
                },
                'performance': {
                    effort: 'high',
                    tokens: 16000,
                    ragEnabled: true,
                    showByDefault: true
                }
            };
            
            const config = configs[preset];
            if (!config) return;
            
            // Apply preset values
            const effortSelect = document.getElementById('NEXT_PUBLIC_DEFAULT_REASONING_EFFORT');
            const tokensSlider = document.getElementById('NEXT_PUBLIC_MAX_REASONING_TOKENS');
            const ragToggle = document.getElementById('NEXT_PUBLIC_RAG_REASONING_ENABLED');
            const showToggle = document.getElementById('NEXT_PUBLIC_SHOW_REASONING_BY_DEFAULT');
            
            if (effortSelect) effortSelect.value = config.effort;
            if (tokensSlider) {
                tokensSlider.value = config.tokens;
                updateReasoningTokensDisplay(config.tokens);
            }
            if (ragToggle) ragToggle.checked = config.ragEnabled;
            if (showToggle) showToggle.checked = config.showByDefault;
            
            // Save changes
            saveReasoningSettings();
            
            // Show feedback
            showToast(`Applied ${preset} preset`, 'success');
        }
        
        // Save reasoning settings
        async function saveReasoningSettings() {
            const settings = {
                NEXT_PUBLIC_REASONING_ENABLED: document.getElementById('NEXT_PUBLIC_REASONING_ENABLED')?.checked ? 'true' : 'false',
                NEXT_PUBLIC_DEFAULT_REASONING_EFFORT: document.getElementById('NEXT_PUBLIC_DEFAULT_REASONING_EFFORT')?.value || 'medium',
                NEXT_PUBLIC_MAX_REASONING_TOKENS: document.getElementById('NEXT_PUBLIC_MAX_REASONING_TOKENS')?.value || '8000',
                NEXT_PUBLIC_SHOW_REASONING_BY_DEFAULT: document.getElementById('NEXT_PUBLIC_SHOW_REASONING_BY_DEFAULT')?.checked ? 'true' : 'false',
                NEXT_PUBLIC_RAG_REASONING_ENABLED: document.getElementById('NEXT_PUBLIC_RAG_REASONING_ENABLED')?.checked ? 'true' : 'false',
                REASONING_COST_MULTIPLIER: document.getElementById('REASONING_COST_MULTIPLIER')?.value || '1.5'
            };
            
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });
                
                if (!response.ok) {
                    throw new Error('Failed to save reasoning settings');
                }
                
                showToast('Reasoning settings saved', 'success');
            } catch (error) {
                console.error('Error saving reasoning settings:', error);
                showToast('Failed to save reasoning settings', 'error');
            }
        }
        
        // Load reasoning settings
        async function loadReasoningSettings() {
            try {
                const response = await fetch('/api/config');
                const data = await response.json();
                
                // Set values from loaded config
                const reasoningEnabled = document.getElementById('NEXT_PUBLIC_REASONING_ENABLED');
                if (reasoningEnabled && data.NEXT_PUBLIC_REASONING_ENABLED !== undefined) {
                    reasoningEnabled.checked = data.NEXT_PUBLIC_REASONING_ENABLED === 'true';
                }
                
                const effortSelect = document.getElementById('NEXT_PUBLIC_DEFAULT_REASONING_EFFORT');
                if (effortSelect && data.NEXT_PUBLIC_DEFAULT_REASONING_EFFORT) {
                    effortSelect.value = data.NEXT_PUBLIC_DEFAULT_REASONING_EFFORT;
                }
                
                const tokensSlider = document.getElementById('NEXT_PUBLIC_MAX_REASONING_TOKENS');
                if (tokensSlider && data.NEXT_PUBLIC_MAX_REASONING_TOKENS) {
                    tokensSlider.value = data.NEXT_PUBLIC_MAX_REASONING_TOKENS;
                    updateReasoningTokensDisplay(data.NEXT_PUBLIC_MAX_REASONING_TOKENS);
                }
                
                const showByDefault = document.getElementById('NEXT_PUBLIC_SHOW_REASONING_BY_DEFAULT');
                if (showByDefault && data.NEXT_PUBLIC_SHOW_REASONING_BY_DEFAULT !== undefined) {
                    showByDefault.checked = data.NEXT_PUBLIC_SHOW_REASONING_BY_DEFAULT === 'true';
                }
                
                const ragEnabled = document.getElementById('NEXT_PUBLIC_RAG_REASONING_ENABLED');
                if (ragEnabled && data.NEXT_PUBLIC_RAG_REASONING_ENABLED !== undefined) {
                    ragEnabled.checked = data.NEXT_PUBLIC_RAG_REASONING_ENABLED === 'true';
                }
                
                const costMultiplier = document.getElementById('REASONING_COST_MULTIPLIER');
                if (costMultiplier && data.REASONING_COST_MULTIPLIER) {
                    costMultiplier.value = data.REASONING_COST_MULTIPLIER;
                    updateCostMultiplierDisplay(data.REASONING_COST_MULTIPLIER);
                }
                
                // RAG settings are now handled by unified checkbox system
                
                const debugRagToggle = document.getElementById('DEBUG_RAG');
                if (debugRagToggle && data.DEBUG_RAG !== undefined) {
                    debugRagToggle.checked = data.DEBUG_RAG === 'true';
                }
                
            } catch (error) {
                console.error('Error loading reasoning settings:', error);
            }
        }
        
        // Initialize reasoning settings on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Handle unified RAG settings checkboxes
            const ragCheckboxes = [
                'RAG_MULTI_PASS',
                'RAG_ADAPTIVE_RETRIEVAL',
                'RAG_QUERY_ENHANCEMENT', 
                'RAG_RERANKING',
                'RAG_ADJACENT_CHUNKS',
                'RAG_CACHE_ENABLED'
            ];
            
            ragCheckboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.addEventListener('change', function() {
                        if (window.configManager) {
                            window.configManager.updateConfig(id, this.checked ? 'true' : 'false');
                        }
                    });
                }
            });
            
            // Handle DEBUG_RAG toggle
            const debugRagToggle = document.getElementById('DEBUG_RAG');
            if (debugRagToggle) {
                debugRagToggle.addEventListener('change', function() {
                    if (window.configManager) {
                        window.configManager.updateConfig('DEBUG_RAG', this.checked ? 'true' : 'false');
                    }
                });
            }
            
            // Load settings
            loadReasoningSettings();
            
            // Add event listeners for reasoning settings
            const reasoningTokensSlider = document.getElementById('NEXT_PUBLIC_MAX_REASONING_TOKENS');
            if (reasoningTokensSlider) {
                reasoningTokensSlider.addEventListener('input', (e) => {
                    updateReasoningTokensDisplay(e.target.value);
                });
                reasoningTokensSlider.addEventListener('change', saveReasoningSettings);
            }
            
            const costMultiplierSlider = document.getElementById('REASONING_COST_MULTIPLIER');
            if (costMultiplierSlider) {
                costMultiplierSlider.addEventListener('input', (e) => {
                    updateCostMultiplierDisplay(e.target.value);
                });
                costMultiplierSlider.addEventListener('change', saveReasoningSettings);
            }
            
            // Add change listeners to all reasoning settings
            const reasoningInputs = [
                'NEXT_PUBLIC_REASONING_ENABLED',
                'NEXT_PUBLIC_DEFAULT_REASONING_EFFORT',
                'NEXT_PUBLIC_SHOW_REASONING_BY_DEFAULT',
                'NEXT_PUBLIC_RAG_REASONING_ENABLED'
            ];
            
            reasoningInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', saveReasoningSettings);
                }
            });
        });
        
        // Make setReasoningPreset available globally
        window.setReasoningPreset = setReasoningPreset;
        
        // =========== End Global Reasoning Settings Management ===========
        
        // =========== Embed Widget Suggestions Management ===========
        
        // Global array to hold embed suggestions
        let embedSuggestions = [];
        
        // Initialize embed suggestions from config
        function initEmbedSuggestions() {
            if (!window.configManager || !window.configManager.config) return;
            
            const suggestionsConfig = window.configManager.config.NEXT_PUBLIC_EMBED_SUGGESTIONS;
            
            try {
                if (suggestionsConfig && suggestionsConfig.trim()) {
                    embedSuggestions = JSON.parse(suggestionsConfig);
                } else {
                    // Default suggestions
                    embedSuggestions = [
                        "What can you help me with?",
                        "How does this work?",
                        "Tell me about your features",
                        "Get started guide"
                    ];
                }
            } catch (e) {
                console.error('Failed to parse NEXT_PUBLIC_EMBED_SUGGESTIONS:', e);
                embedSuggestions = [
                    "What can you help me with?",
                    "How does this work?",
                    "Tell me about your features",
                    "Get started guide"
                ];
            }
            
            renderEmbedSuggestions();
        }
        
        // Render embed suggestions list
        function renderEmbedSuggestions() {
            const listContainer = document.getElementById('embed-suggestions-list');
            if (!listContainer) return;
            
            listContainer.innerHTML = '';
            
            embedSuggestions.forEach((suggestion, index) => {
                const suggestionItem = document.createElement('div');
                suggestionItem.className = 'flex items-center gap-2 p-2 bg-base-300 rounded';
                suggestionItem.innerHTML = `
                    <input 
                        type="text" 
                        class="input input-sm input-bordered flex-1" 
                        value="${suggestion}" 
                        onchange="updateEmbedSuggestion(${index}, this.value)"
                        placeholder="Enter suggestion text"
                    />
                    <button 
                        class="btn btn-sm btn-error btn-square" 
                        onclick="removeEmbedSuggestion(${index})"
                        title="Remove suggestion"
                    >
                        ‚ùå
                    </button>
                `;
                listContainer.appendChild(suggestionItem);
            });
            
            // Update preview
            updateSuggestionsPreview();
        }
        
        // Update the preview suggestions in the live widget preview
        function updateSuggestionsPreview() {
            const previewContainer = document.getElementById('preview-suggestions');
            const suggestionsEnabled = document.getElementById('NEXT_PUBLIC_EMBED_SUGGESTIONS_ENABLED');
            const primaryColor = document.getElementById('NEXT_PUBLIC_EMBED_PRIMARY_COLOR');

            if (!previewContainer) return;

            // Clear existing pills
            previewContainer.innerHTML = '';

            // Check if suggestions are enabled
            if (suggestionsEnabled && suggestionsEnabled.checked && embedSuggestions.length > 0) {
                previewContainer.style.display = 'flex';

                const color = primaryColor ? primaryColor.value : '#FF6417';

                embedSuggestions.forEach((suggestion) => {
                    const pill = document.createElement('button');
                    pill.textContent = suggestion;
                    pill.style.cssText = `
                        padding: 8px 14px;
                        border-radius: 20px;
                        border: 1px solid #ddd;
                        background: white;
                        color: #333;
                        font-size: 13px;
                        cursor: pointer;
                        transition: all 0.2s;
                        white-space: nowrap;
                    `;

                    // Hover effects
                    pill.addEventListener('mouseenter', function() {
                        this.style.background = color;
                        this.style.color = 'white';
                        this.style.borderColor = color;
                    });

                    pill.addEventListener('mouseleave', function() {
                        this.style.background = 'white';
                        this.style.color = '#333';
                        this.style.borderColor = '#ddd';
                    });

                    // Click handler (preview only) - auto-send, keep suggestions visible
                    pill.addEventListener('click', function() {
                        const input = document.getElementById('chatInput');
                        if (input) {
                            input.value = suggestion;
                            // Auto-send the preview message (suggestions remain visible)
                            if (typeof sendPreviewMessage === 'function') {
                                sendPreviewMessage();
                            }
                        }
                    });

                    previewContainer.appendChild(pill);
                });
            } else {
                previewContainer.style.display = 'none';
            }
        }
        
        // Add a new embed suggestion
        function addEmbedSuggestion() {
            embedSuggestions.push('New suggestion');
            renderEmbedSuggestions();
            saveEmbedSuggestions();
        }
        
        // Update an existing embed suggestion
        function updateEmbedSuggestion(index, value) {
            if (index >= 0 && index < embedSuggestions.length) {
                embedSuggestions[index] = value;
                saveEmbedSuggestions();
            }
        }
        
        // Remove an embed suggestion
        function removeEmbedSuggestion(index) {
            if (index >= 0 && index < embedSuggestions.length) {
                embedSuggestions.splice(index, 1);
                renderEmbedSuggestions();
                saveEmbedSuggestions();
            }
        }
        
        // Save embed suggestions to config
        function saveEmbedSuggestions() {
            if (!window.configManager) return;
            
            const suggestionsJson = JSON.stringify(embedSuggestions);
            window.configManager.updateConfig('NEXT_PUBLIC_EMBED_SUGGESTIONS', suggestionsJson);
            window.configManager.saveConfig();
        }
        
        // Initialize embed suggestions when embed tab becomes active
        document.addEventListener('DOMContentLoaded', function() {
            // Watch for tab switches to embed tab
            const embedTab = document.querySelector('[data-tab="embed"]');
            if (embedTab) {
                embedTab.addEventListener('click', function() {
                    setTimeout(() => {
                        initEmbedSuggestions();
                    }, 100);
                });
            }
            
            // Also initialize if we're already on embed tab
            const embedContent = document.getElementById('embed');
            if (embedContent && embedContent.classList.contains('active')) {
                setTimeout(() => {
                    initEmbedSuggestions();
                }, 500);
            }
            
            // Watch for suggestions enabled toggle
            const suggestionsToggle = document.getElementById('NEXT_PUBLIC_EMBED_SUGGESTIONS_ENABLED');
            if (suggestionsToggle) {
                suggestionsToggle.addEventListener('change', function() {
                    updateSuggestionsPreview();
                });
            }
            
            // Watch for primary color changes
            const primaryColorInput = document.getElementById('NEXT_PUBLIC_EMBED_PRIMARY_COLOR');
            if (primaryColorInput) {
                primaryColorInput.addEventListener('change', function() {
                    updateSuggestionsPreview();
                });
            }
        });
        
        // Make functions globally available
        window.addEmbedSuggestion = addEmbedSuggestion;
        window.updateEmbedSuggestion = updateEmbedSuggestion;
        window.removeEmbedSuggestion = removeEmbedSuggestion;
        window.initEmbedSuggestions = initEmbedSuggestions;
        
        // =========== End Embed Widget Suggestions Management ===========
        
    </script>
</body>
</html>